Sliver.ChanceManager=Ext.extend(Ext.app.Module,{moduleType:"chance",moduleId:"chance-manager",init:function(){this.launcher={handler:this.createWindow,iconCls:"chance-manager-icon",scope:this,shortcutIconCls:"chance-manager-shortcut",text:SliverData.chanceManager.title,tooltip:SliverData.chanceManager.tooltip}},createWindow:function(){var desktop=this.app.getDesktop();var win=desktop.getWindow(this.moduleId);if(!win){var winWidth=desktop.getWinWidth()/1.1;var winHeight=desktop.getWinHeight()/1.1;var store=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:"chance/listChanceByAll.action"}),reader:new Ext.data.JsonReader({root:"list",totalProperty:"total",id:"chanceID",fields:["chanceID","chanceDate","chanceSource","chanceState","chancePercent","chanceTitle","chanceContent","chanceTotal","groupName","userName"]}),remoteSort:true});store.setDefaultSort("chanceID","DESC");var expander=new Ext.grid.RowExpander({tpl:new Ext.Template("<p><b>"+SliverData.chance.requirement+"</b>{chanceContent}</p>")});function renderTitle(v){return Ext.util.Format.ellipsis(v,12)}function renderCustomer(v){return Ext.util.Format.ellipsis(v,15)}function renderPercent(v){if(v){return v.toString()+"%"}else{return""}}var cm=new Ext.grid.ColumnModel([expander,{header:"编号",dataIndex:"chanceID",width:30},{header:"客户",dataIndex:"groupName",width:120},{header:"主题",dataIndex:"chanceTitle",renderer:renderTitle,width:120},{header:"来源",dataIndex:"chanceSource",width:40},{header:"状态",dataIndex:"chanceState",width:50},{header:"概率",dataIndex:"chancePercent",renderer:renderPercent,width:30},{header:"总金额",dataIndex:"chanceTotal",renderer:SliverUtil.cnMoney,align:"right",width:40},{header:"所属帐户",dataIndex:"userName",width:60,align:"right"},{header:"记录日期",dataIndex:"chanceDate",align:"right",width:40}]);cm.defaultSortable=true;var chanceFilterParams={"chance.chanceSource":"","chance.chanceTitle":"","chance.chanceContent":"","chance.chanceDate":"","chance.chanceState":"","chance.groupName":""};var chanceGridFilterMenu=new Ext.menu.Menu({items:[{text:"客户名称",checked:true,checkHandler:function(){operateChanceParams(this.checked,"chance.groupName")}},{text:"名称",checked:true,checkHandler:function(){operateChanceParams(this.checked,"chance.chanceTitle")}},{text:"需求",checked:true,checkHandler:function(){operateChanceParams(this.checked,"chance.chanceContent")}},{text:"来源",checked:true,checkHandler:function(){operateChanceParams(this.checked,"chance.chanceSource")}},{text:"状态",checked:true,checkHandler:function(){operateChanceParams(this.checked,"chance.chanceState")}},{text:"日期",checked:true,checkHandler:function(){operateChanceParams(this.checked,"chance.chanceDate")}}]});function operateChanceParams(status,name){if(status===true){chanceFilterParams[name]=""}else{chanceFilterParams[name]=null}}var filterField=new Ext.form.TextField({});var filterButton=new Ext.Button({iconCls:"icon-search",tooltip:"开始搜索",handler:function(){if(null!==chanceFilterParams["chance.chanceSource"]){chanceFilterParams["chance.chanceSource"]=filterField.getValue()}if(null!==chanceFilterParams["chance.chanceTitle"]){chanceFilterParams["chance.chanceTitle"]=filterField.getValue()}if(null!==chanceFilterParams["chance.chanceContent"]){chanceFilterParams["chance.chanceContent"]=filterField.getValue()}if(null!==chanceFilterParams["chance.chanceDate"]){chanceFilterParams["chance.chanceDate"]=filterField.getValue()}if(null!==chanceFilterParams["chance.chanceState"]){chanceFilterParams["chance.chanceState"]=filterField.getValue()}if(null!==chanceFilterParams["chance.groupName"]){chanceFilterParams["chance.groupName"]=filterField.getValue()}store.baseParams=chanceFilterParams;store.setDefaultSort("chanceID","DESC");store.load({params:{start:0,limit:pageSizePlugin.getPageSize()}})}});var clearButton=new Ext.Button({iconCls:"icon-clear",tooltip:"清空",handler:function(){filterField.reset();store.baseParams={};store.setDefaultSort("chanceID","DESC");store.load({params:{start:0,limit:pageSizePlugin.getPageSize()}})}});var sm=new Ext.grid.RowSelectionModel({singleSelect:true});var pageSizePlugin=new Ext.ux.Andrie.pPageSize();var grid=new Ext.grid.GridPanel({border:false,viewConfig:{forceFit:true},store:store,cm:cm,sm:sm,plugins:expander,loadMask:true,bbar:new Ext.PagingToolbar({plugins:pageSizePlugin,pageSize:20,store:store,displayInfo:true,items:["-",{text:"搜索范围",menu:chanceGridFilterMenu},filterField,filterButton,clearButton]})});grid.on("render",function(){store.load({params:{start:0,limit:pageSizePlugin.getPageSize()}})});var updateChanceView=function(){var record=sm.getSelected();if(record){var tabID=main.id+"-chance-"+record.data.chanceID;var temp=main.getComponent(tabID);if(!temp){var temp=new Ext.Panel({id:tabID,iconCls:"chance-manager-icon",autoScroll:true,title:"销售机会["+record.data.chanceID+"]",closable:true});temp.on("render",function(){temp.load({scripts:true,method:"post",params:{"chance.chanceID":record.data.chanceID,containerID:temp.body.id},url:"chance/updateChanceManagerView.action"})});var p=main.add(temp);main.setActiveTab(p)}else{temp.setTitle("销售机会["+record.data.chanceID+"]");temp.setIconClass("chance-manager-icon");temp.body.getUpdater().update({scripts:true,method:"post",params:{"chance.chanceID":record.data.chanceID,containerID:temp.body.id},url:"chance/updateChanceManagerView.action"});main.setActiveTab(temp)}}else{Sliver.getDesktop().msg({title:"警告",iconCls:"icon-warn",html:"没有销售机会被选中,请选择表格中销售机会！"})}};var insertChanceView=function(){var tabID=main.id+"-chance-"+Ext.id();var temp=new Ext.Panel({id:tabID,iconCls:"chance-manager-icon",autoScroll:true,title:"新的销售机会",closable:true});temp.on("render",function(){temp.load({scripts:true,method:"post",params:{containerID:temp.body.id},url:"chance/insertChanceManagerView.action"})});var p=main.add(temp);main.setActiveTab(p)};var removeChanceView=function(){var record=sm.getSelected();if(record){Ext.MessageBox.confirm("删除销售机会","您确定要删除销售机会?",function(btn){if(btn=="yes"){Ext.Ajax.request({url:"chance/removeChanceManagerAction.action",method:"post",params:{"chance.chanceID":record.data.chanceID},success:function(response){var result=Ext.decode(response.responseText);if(true===result.success){store.remove(record)}}})}})}else{Sliver.getDesktop().msg({title:"警告",iconCls:"icon-warn",html:"没有销售机会被选中,请选择表格中销售机会！"})}};var genOrderView=function(){var record=sm.getSelected();if(record){var tabID=Ext.id();var temp=new Ext.Panel({id:tabID,iconCls:"icon-order-add",autoScroll:true,title:"添加订单",closable:true});temp.on("render",function(){temp.load({scripts:true,method:"post",params:{containerID:temp.body.id,"chance.chanceID":record.data.chanceID},url:"chance/insertOrderManagerViewByChance.action"})});var p=main.add(temp);main.setActiveTab(p)}else{Sliver.getDesktop().msg({title:"警告",iconCls:"icon-warn",html:"没有销售机会被选中,请选择表格中销售机会！"})}};var genOfferView=function(){var record=sm.getSelected();if(record){var tabID=Ext.id();var temp=new Ext.Panel({id:tabID,iconCls:"icon-offer-add",autoScroll:true,title:"创建报价单",closable:true});temp.on("render",function(){temp.load({scripts:true,method:"post",params:{containerID:temp.body.id,"chance.chanceID":record.data.chanceID},url:"chance/insertOfferManagerViewByChance.action"})});var p=main.add(temp);main.setActiveTab(p)}else{Sliver.getDesktop().msg({title:"警告",iconCls:"icon-warn",html:"没有销售机会被选中,请选择表格中销售机会！"})}};var getChanceStateView=function(){var tab=Ext.getCmp("chance-manager-bar");if(tab){main.setActiveTab(tab)}else{var centerID=Ext.id();var center=new Ext.Panel({id:centerID,border:true,region:"center",autoScroll:true});center.on("render",function(){center.load({scripts:true,method:"post",params:{containerID:centerID+"-bar",width:600,height:400,"chance.chanceDate":Ext.util.Format.date(new Date(Date.parse("01/01/"+new Date().getFullYear())),"Y-m-d"),"chance.chanceTitle":Ext.util.Format.date(new Date(Date.parse("12/31/"+new Date().getFullYear())),"Y-m-d")},url:"chance/getAllChanceStateInformation.jsp"})});var west=new Ext.grid.PropertyGrid({border:true,region:"west",split:true,collapseMode:"mini",autoScroll:true,collapsible:true,width:225,minSize:175,maxSize:400,layout:"fit",source:{"起始日期":new Date(Date.parse("01/01/"+new Date().getFullYear())),"终止日期":new Date(Date.parse("12/31/"+new Date().getFullYear())),"报表高度":400,"报表宽度":600},bbar:["-",{tooltip:"刷新报表",iconCls:"icon-reload",handler:function(){var ps=west.getStore();center.body.getUpdater().update({scripts:true,method:"post",params:{containerID:centerID+"-bar",width:ps.getById("报表宽度").data.value,height:ps.getById("报表高度").data.value,"chance.chanceDate":Ext.util.Format.date(ps.getById("起始日期").data.value,"Y-m-d"),"chance.chanceTitle":Ext.util.Format.date(ps.getById("终止日期").data.value,"Y-m-d")},url:"chance/getAllChanceStateInformation.jsp"})}}]});var content=new Ext.Panel({id:"chance-manager-bar",iconCls:"icon-chart-bar",autoScroll:true,closable:true,title:"机会状态统计",border:false,buttonAlign:"right",viewConfig:{forceFit:true},layout:"border",items:[center,west]});var p=main.add(content);main.setActiveTab(p)}};var getChanceStatePieView=function(){var tab=Ext.getCmp("chance-manager-statepie");if(tab){main.setActiveTab(tab)}else{var centerID=Ext.id();var center=new Ext.Panel({id:centerID,border:true,region:"center",autoScroll:true});center.on("render",function(){center.load({scripts:true,method:"post",params:{containerID:centerID+"-pie",width:600,height:400,"chance.chanceDate":Ext.util.Format.date(new Date(Date.parse("01/01/"+new Date().getFullYear())),"Y-m-d"),"chance.chanceTitle":Ext.util.Format.date(new Date(Date.parse("12/31/"+new Date().getFullYear())),"Y-m-d")},url:"chance/getAllChanceStatePieInformation.jsp"})});var west=new Ext.grid.PropertyGrid({border:true,region:"west",split:true,collapseMode:"mini",autoScroll:true,collapsible:true,width:225,minSize:175,maxSize:400,layout:"fit",source:{"起始日期":new Date(Date.parse("01/01/"+new Date().getFullYear())),"终止日期":new Date(Date.parse("12/31/"+new Date().getFullYear())),"报表高度":400,"报表宽度":600},bbar:["-",{tooltip:"刷新报表",iconCls:"icon-reload",handler:function(){var ps=west.getStore();center.body.getUpdater().update({scripts:true,method:"post",params:{containerID:centerID+"-pie",width:ps.getById("报表宽度").data.value,height:ps.getById("报表高度").data.value,"chance.chanceDate":Ext.util.Format.date(ps.getById("起始日期").data.value,"Y-m-d"),"chance.chanceTitle":Ext.util.Format.date(ps.getById("终止日期").data.value,"Y-m-d")},url:"chance/getAllChanceStatePieInformation.jsp"})}}]});var content=new Ext.Panel({id:"chance-manager-statepie",iconCls:"icon-chart-pie",autoScroll:true,closable:true,title:"机会状态统计",border:false,buttonAlign:"right",viewConfig:{forceFit:true},layout:"border",items:[center,west]});var p=main.add(content);main.setActiveTab(p)}};grid.on("rowdblclick",updateChanceView);var chanceContextMenu;grid.on("rowcontextmenu",function(grid,rowindex,e){grid.getSelectionModel().selectRow(rowindex,false);if(!chanceContextMenu){chanceContextMenu=new Ext.menu.Menu([{text:"添加销售机会",handler:insertChanceView},{text:"更新销售机会",handler:updateChanceView},"-",{text:"创建报价单",handler:genOfferView},{text:"创建订单",handler:genOrderView},"-",{text:"删除销售机会",handler:removeChanceView}])}chanceContextMenu.showAt(e.getPoint());e.stopEvent()});var main=new Ext.TabPanel({id:"chance-manager-body",region:"center",margins:"0 0 0 0",resizeTabs:true,minTabWidth:135,tabWidth:160,plugins:new Ext.ux.TabCloseMenu(),enableTabScroll:true,border:true,activeTab:0,autoDestroy:true,items:[{closable:false,title:"销售机会列表",autoScroll:true,layout:"fit",items:grid,iconCls:"chance-manager-icon"}]});win=desktop.createWindow({id:this.moduleId,title:SliverData.chanceManager.title,width:winWidth,height:winHeight,x:desktop.getWinX(winWidth),y:desktop.getWinY(winHeight),iconCls:"chance-manager-icon",shim:false,animCollapse:false,constrainHeader:true,minimizable:true,maximizable:true,border:false,layout:"border",tbar:["-",{tooltip:"新增销售机会",iconCls:"chance-manager-icon-add",handler:insertChanceView},{tooltip:"查看销售机会",iconCls:"chance-manager-icon",handler:updateChanceView},{tooltip:"删除选中的销售机会",iconCls:"chance-manager-icon-remove",handler:removeChanceView},"-",{tooltip:"销售机会数量统计",iconCls:"icon-chart-bar",handler:getChanceStateView},{tooltip:"销售机会概率统计",iconCls:"icon-chart-pie",handler:getChanceStatePieView},"-",{tooltip:"为销售机会创建报价单",iconCls:"icon-offer-add",handler:genOfferView},{tooltip:"为销售机会创建订单",iconCls:"icon-order-add",handler:genOrderView},"-",{tooltip:"添加客户",iconCls:"icon-customer",handler:function(){var tabID=Ext.id();var temp=new Ext.Panel({id:tabID,iconCls:"icon-customer",autoScroll:true,title:"添加客户",closable:true});temp.on("render",function(){temp.load({scripts:true,method:"post",params:{"contactGroup.groupID":"",containerID:temp.body.id},url:"chance/insertCustomerByAllView.action"})});var p=main.add(temp);main.setActiveTab(p)}},{tooltip:"添加目录",iconCls:"icon-group",handler:function(){Ext.Ajax.request({url:"customer/insertGroupView.action",method:"post",params:{"contactGroup.groupID":""},success:function(response){eval(response.responseText)}})}},{tooltip:"添加联系人",iconCls:"icon-contact",handler:function(){var tabID=Ext.id();var temp=new Ext.Panel({id:tabID,iconCls:"icon-contact",autoScroll:true,title:"添加联系人",closable:true});temp.on("render",function(){temp.load({scripts:true,method:"post",params:{"contactGroup.groupID":"",containerID:temp.body.id},url:"chance/insertContactByAllView.action"})});var p=main.add(temp);main.setActiveTab(p)}}],items:main,taskbuttonTooltip:SliverData.chanceManager.tooltip})}win.show()}});Sliver.ChanceOwner=Ext.extend(Ext.app.Module,{moduleType:"chance",moduleId:"chance-owner",init:function(){this.launcher={handler:this.createWindow,iconCls:"chance-owner-icon",scope:this,shortcutIconCls:"chance-owner-shortcut",text:SliverData.chance.title,tooltip:SliverData.chance.tooltip}},createWindow:function(){var desktop=this.app.getDesktop();var win=desktop.getWindow(this.moduleId);if(!win){var winWidth=desktop.getWinWidth()/1.1;var winHeight=desktop.getWinHeight()/1.1;var store=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:"chance/listChance.action"}),reader:new Ext.data.JsonReader({root:"list",totalProperty:"total",id:"chanceID",fields:["chanceID","chanceDate","chanceSource","chanceState","chancePercent","chanceTitle","chanceContent","chanceTotal","groupName"]}),remoteSort:true});store.setDefaultSort("chanceID","DESC");var expander=new Ext.grid.RowExpander({tpl:new Ext.Template("<p><b>"+SliverData.chance.requirement+"</b>{chanceContent}</p>")});function renderTitle(v){return Ext.util.Format.ellipsis(v,12)}function renderCustomer(v){return Ext.util.Format.ellipsis(v,15)}function renderPercent(v){if(v){return v.toString()+"%"}else{return""}}var cm=new Ext.grid.ColumnModel([expander,{header:"编号",dataIndex:"chanceID",width:30},{header:"客户",dataIndex:"groupName",width:120},{header:"主题",dataIndex:"chanceTitle",renderer:renderTitle,width:120},{header:"来源",dataIndex:"chanceSource",width:40},{header:"状态",dataIndex:"chanceState",width:50},{header:"概率",dataIndex:"chancePercent",renderer:renderPercent,width:30},{header:"总金额",dataIndex:"chanceTotal",renderer:SliverUtil.cnMoney,align:"right",width:40},{header:"记录日期",dataIndex:"chanceDate",align:"right",width:40}]);cm.defaultSortable=true;var chanceFilterParams={"chance.chanceSource":"","chance.chanceTitle":"","chance.chanceContent":"","chance.chanceDate":"","chance.chanceState":"","chance.groupName":""};var chanceGridFilterMenu=new Ext.menu.Menu({items:[{text:"客户名称",checked:true,checkHandler:function(){operateChanceParams(this.checked,"chance.groupName")}},{text:"名称",checked:true,checkHandler:function(){operateChanceParams(this.checked,"chance.chanceTitle")}},{text:"需求",checked:true,checkHandler:function(){operateChanceParams(this.checked,"chance.chanceContent")}},{text:"来源",checked:true,checkHandler:function(){operateChanceParams(this.checked,"chance.chanceSource")}},{text:"状态",checked:true,checkHandler:function(){operateChanceParams(this.checked,"chance.chanceState")}},{text:"日期",checked:true,checkHandler:function(){operateChanceParams(this.checked,"chance.chanceDate")}}]});function operateChanceParams(status,name){if(status===true){chanceFilterParams[name]=""}else{chanceFilterParams[name]=null}}var filterField=new Ext.form.TextField({});var filterButton=new Ext.Button({iconCls:"icon-search",tooltip:"开始搜索",handler:function(){if(null!==chanceFilterParams["chance.chanceSource"]){chanceFilterParams["chance.chanceSource"]=filterField.getValue()}if(null!==chanceFilterParams["chance.chanceTitle"]){chanceFilterParams["chance.chanceTitle"]=filterField.getValue()}if(null!==chanceFilterParams["chance.chanceContent"]){chanceFilterParams["chance.chanceContent"]=filterField.getValue()}if(null!==chanceFilterParams["chance.chanceDate"]){chanceFilterParams["chance.chanceDate"]=filterField.getValue()}if(null!==chanceFilterParams["chance.chanceState"]){chanceFilterParams["chance.chanceState"]=filterField.getValue()}if(null!==chanceFilterParams["chance.groupName"]){chanceFilterParams["chance.groupName"]=filterField.getValue()}store.baseParams=chanceFilterParams;store.setDefaultSort("chanceID","DESC");store.load({params:{start:0,limit:pageSizePlugin.getPageSize()}})}});var clearButton=new Ext.Button({iconCls:"icon-clear",tooltip:"清空",handler:function(){filterField.reset();store.baseParams={};store.setDefaultSort("chanceID","DESC");store.load({params:{start:0,limit:pageSizePlugin.getPageSize()}})}});var sm=new Ext.grid.RowSelectionModel({singleSelect:true});var pageSizePlugin=new Ext.ux.Andrie.pPageSize();var grid=new Ext.grid.GridPanel({border:false,viewConfig:{forceFit:true},store:store,cm:cm,sm:sm,plugins:expander,loadMask:true,bbar:new Ext.PagingToolbar({plugins:pageSizePlugin,pageSize:20,store:store,displayInfo:true,items:["-",{text:"搜索范围",menu:chanceGridFilterMenu},filterField,filterButton,clearButton]})});grid.on("render",function(){store.load({params:{start:0,limit:pageSizePlugin.getPageSize()}})});var getChanceView=function(){var record=sm.getSelected();if(record){var tabID=main.id+"-chance-"+record.data.chanceID;var temp=main.getComponent(tabID);if(!temp){var temp=new Ext.Panel({id:tabID,iconCls:"chance-owner-icon",autoScroll:true,title:"销售机会["+record.data.chanceID+"]",closable:true});temp.on("render",function(){temp.load({scripts:true,method:"post",params:{"chance.chanceID":record.data.chanceID,containerID:temp.body.id},url:"chance/updateChanceView.action"})});var p=main.add(temp);main.setActiveTab(p)}else{temp.setTitle("销售机会["+record.data.chanceID+"]");temp.setIconClass("chance-owner-icon");temp.body.getUpdater().update({scripts:true,method:"post",params:{"chance.chanceID":record.data.chanceID,containerID:temp.body.id},url:"chance/updateChanceView.action"});main.setActiveTab(temp)}}};var insertChanceView=function(){var tabID=main.id+"-chance-"+Ext.id();var temp=new Ext.Panel({id:tabID,iconCls:"chance-owner-icon",autoScroll:true,title:"新的销售机会",closable:true});temp.on("render",function(){temp.load({scripts:true,method:"post",params:{containerID:temp.body.id},url:"chance/insertChanceView.action"})});var p=main.add(temp);main.setActiveTab(p)};var removeChanceView=function(){var record=sm.getSelected();if(record){Ext.MessageBox.confirm("删除销售机会","您确定要删除销售机会?",function(btn){if(btn=="yes"){Ext.Ajax.request({url:"chance/removeChanceAction.action",method:"post",params:{"chance.chanceID":record.data.chanceID},success:function(response){var result=Ext.decode(response.responseText);if(true===result.success){store.remove(record)}}})}})}};var genOrderView=function(){var record=sm.getSelected();if(record){var tabID=Ext.id();var temp=new Ext.Panel({id:tabID,iconCls:"icon-order-add",autoScroll:true,title:"添加订单",closable:true});temp.on("render",function(){temp.load({scripts:true,method:"post",params:{containerID:temp.body.id,"chance.chanceID":record.data.chanceID},url:"chance/insertOrderViewByChance.action"})});var p=main.add(temp);main.setActiveTab(p)}else{Sliver.getDesktop().msg({title:"警告",iconCls:"icon-warn",html:"没有销售机会被选中,请选择表格中销售机会！"})}};var genOfferView=function(){var record=sm.getSelected();if(record){var tabID=Ext.id();var temp=new Ext.Panel({id:tabID,iconCls:"icon-offer-add",autoScroll:true,title:"创建报价单",closable:true});temp.on("render",function(){temp.load({scripts:true,method:"post",params:{containerID:temp.body.id,"chance.chanceID":record.data.chanceID},url:"chance/insertOfferViewByChance.action"})});var p=main.add(temp);main.setActiveTab(p)}else{Sliver.getDesktop().msg({title:"警告",iconCls:"icon-warn",html:"没有销售机会被选中,请选择表格中销售机会！"})}};var getChanceStateView=function(){var tab=Ext.getCmp("chance-owner-bar");if(tab){main.setActiveTab(tab)}else{var centerID=Ext.id();var center=new Ext.Panel({id:centerID,border:true,region:"center",autoScroll:true});center.on("render",function(){center.load({scripts:true,method:"post",params:{containerID:centerID+"-bar",width:600,height:400,"chance.chanceDate":Ext.util.Format.date(new Date(Date.parse("01/01/"+new Date().getFullYear())),"Y-m-d"),"chance.chanceTitle":Ext.util.Format.date(new Date(Date.parse("12/31/"+new Date().getFullYear())),"Y-m-d")},url:"chance/getChanceStateInformation.jsp"})});var west=new Ext.grid.PropertyGrid({border:true,region:"west",split:true,collapseMode:"mini",autoScroll:true,collapsible:true,width:225,minSize:175,maxSize:400,layout:"fit",source:{"起始日期":new Date(Date.parse("01/01/"+new Date().getFullYear())),"终止日期":new Date(Date.parse("12/31/"+new Date().getFullYear())),"报表高度":400,"报表宽度":600},bbar:["-",{tooltip:"刷新报表",iconCls:"icon-reload",handler:function(){var ps=west.getStore();center.body.getUpdater().update({scripts:true,method:"post",params:{containerID:centerID+"-bar",width:ps.getById("报表宽度").data.value,height:ps.getById("报表高度").data.value,"chance.chanceDate":Ext.util.Format.date(ps.getById("起始日期").data.value,"Y-m-d"),"chance.chanceTitle":Ext.util.Format.date(ps.getById("终止日期").data.value,"Y-m-d")},url:"chance/getChanceStateInformation.jsp"})}}]});var content=new Ext.Panel({id:"chance-owner-statebar",iconCls:"icon-chart-bar",autoScroll:true,closable:true,title:"机会状态统计",border:false,buttonAlign:"right",viewConfig:{forceFit:true},layout:"border",items:[center,west]});var p=main.add(content);main.setActiveTab(p)}};var getChanceStatePieView=function(){var tab=Ext.getCmp("chance-owner-statepie");if(tab){main.setActiveTab(tab)}else{var centerID=Ext.id();var center=new Ext.Panel({id:centerID,border:true,region:"center",autoScroll:true});center.on("render",function(){center.load({scripts:true,method:"post",params:{containerID:centerID+"-pie",width:600,height:400,"chance.chanceDate":Ext.util.Format.date(new Date(Date.parse("01/01/"+new Date().getFullYear())),"Y-m-d"),"chance.chanceTitle":Ext.util.Format.date(new Date(Date.parse("12/31/"+new Date().getFullYear())),"Y-m-d")},url:"chance/getChanceStatePieInformation.jsp"})});var west=new Ext.grid.PropertyGrid({border:true,region:"west",split:true,collapseMode:"mini",autoScroll:true,collapsible:true,width:225,minSize:175,maxSize:400,layout:"fit",source:{"起始日期":new Date(Date.parse("01/01/"+new Date().getFullYear())),"终止日期":new Date(Date.parse("12/31/"+new Date().getFullYear())),"报表高度":400,"报表宽度":600},bbar:["-",{tooltip:"刷新报表",iconCls:"icon-reload",handler:function(){var ps=west.getStore();center.body.getUpdater().update({scripts:true,method:"post",params:{containerID:centerID+"-pie",width:ps.getById("报表宽度").data.value,height:ps.getById("报表高度").data.value,"chance.chanceDate":Ext.util.Format.date(ps.getById("起始日期").data.value,"Y-m-d"),"chance.chanceTitle":Ext.util.Format.date(ps.getById("终止日期").data.value,"Y-m-d")},url:"chance/getChanceStatePieInformation.jsp"})}}]});var content=new Ext.Panel({id:"chance-owner-statepie",iconCls:"icon-chart-pie",autoScroll:true,closable:true,title:"机会状态统计",border:false,buttonAlign:"right",viewConfig:{forceFit:true},layout:"border",items:[center,west]});var p=main.add(content);main.setActiveTab(p)}};grid.on("rowdblclick",getChanceView);var chanceContextMenu;grid.on("rowcontextmenu",function(grid,rowindex,e){grid.getSelectionModel().selectRow(rowindex,false);if(!chanceContextMenu){chanceContextMenu=new Ext.menu.Menu([{text:"添加销售机会",handler:insertChanceView},{text:"更新销售机会",handler:getChanceView},"-",{text:"创建报价单",handler:genOfferView},{text:"创建订单",handler:genOrderView},"-",{text:"删除销售机会",handler:removeChanceView}])}chanceContextMenu.showAt(e.getPoint());e.stopEvent()});var main=new Ext.TabPanel({id:"chance-owner-body",region:"center",margins:"0 0 0 0",resizeTabs:true,minTabWidth:135,tabWidth:160,plugins:new Ext.ux.TabCloseMenu(),enableTabScroll:true,border:true,activeTab:0,autoDestroy:true,items:[{closable:false,title:"销售机会列表",autoScroll:true,layout:"fit",items:grid,iconCls:"chance-owner-icon"}]});win=desktop.createWindow({id:this.moduleId,title:SliverData.chance.title,width:winWidth,height:winHeight,x:desktop.getWinX(winWidth),y:desktop.getWinY(winHeight),iconCls:"chance-owner-icon",shim:false,animCollapse:false,constrainHeader:true,minimizable:true,maximizable:true,border:false,layout:"border",tbar:["-",{tooltip:"新增销售机会",iconCls:"chance-owner-icon-add",handler:insertChanceView},{tooltip:"查看销售机会",iconCls:"chance-owner-icon",handler:getChanceView},{tooltip:"删除选中的销售机会",iconCls:"chance-owner-icon-remove",handler:removeChanceView},"-",{tooltip:"销售机会数量统计",iconCls:"icon-chart-bar",handler:getChanceStateView},{tooltip:"销售机会概率统计",iconCls:"icon-chart-pie",handler:getChanceStatePieView},"-",{tooltip:"为销售机会创建报价单",iconCls:"icon-offer-add",handler:genOfferView},{tooltip:"为销售机会创建订单",iconCls:"icon-order-add",handler:genOrderView},"-",{tooltip:"添加客户",iconCls:"icon-customer",handler:function(){var tabID=Ext.id();var temp=new Ext.Panel({id:tabID,iconCls:"icon-customer",autoScroll:true,title:"添加客户",closable:true});temp.on("render",function(){temp.load({scripts:true,method:"post",params:{"contactGroup.groupID":"",containerID:temp.body.id},url:"chance/insertCustomerView.action"})});var p=main.add(temp);main.setActiveTab(p)}},{tooltip:"添加目录",iconCls:"icon-group",handler:function(){Ext.Ajax.request({url:"customer/insertGroupView.action",method:"post",params:{"contactGroup.groupID":""},success:function(response){eval(response.responseText)}})}},{tooltip:"添加联系人",iconCls:"icon-contact",handler:function(){var tabID=Ext.id();var temp=new Ext.Panel({id:tabID,iconCls:"icon-contact",autoScroll:true,title:"添加联系人",closable:true});temp.on("render",function(){temp.load({scripts:true,method:"post",params:{"contactGroup.groupID":"",containerID:temp.body.id},url:"chance/insertContactView.action"})});var p=main.add(temp);main.setActiveTab(p)}}],items:main,taskbuttonTooltip:SliverData.chance.tooltip})}win.show()}});Sliver.ComplainManager=Ext.extend(Ext.app.Module,{moduleType:"complain",moduleId:"complain-manager",init:function(){this.launcher={handler:this.createWindow,iconCls:"icon-tag",scope:this,shortcutIconCls:"customer-complain-shortcut",text:"客户投诉",tooltip:"<b>客户投诉</b><br />客户投诉记录处理"}},createWindow:function(){var X=this.app.getDesktop();var E=X.getWindow(this.moduleId);if(!E){var Q=X.getWinWidth()/1.1;var C=X.getWinHeight()/1.1;var H=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:"complain/listComplain.action"}),reader:new Ext.data.JsonReader({root:"list",totalProperty:"total",id:"complainID",fields:["complainID","complainDate","complainDescription","complainID","complainTitle","productionID","productionSerial","productionName","customerID","customerName","contactID","contactName","contactGender","contactPhone","contactAddress","complainState","complainResult"]}),remoteSort:true});H.setDefaultSort("complainID","DESC");var N=new Ext.grid.RowExpander({tpl:new Ext.Template("<p><b>描述 : </b>{complainDescription}</p>")});var V=new Ext.form.ComboBox({store:new Ext.data.SimpleStore({fields:["complainState"],data:SliverData.complainState}),fieldLabel:"状态",displayField:"complainState",editable:false,emptyText:SliverData.complainState[0],mode:"local",anchor:"95%",triggerAction:"all",selectOnFocus:true,name:"complain.complainState"});var J=new Ext.form.ComboBox({store:new Ext.data.SimpleStore({fields:["complainResult"],data:SliverData.result}),fieldLabel:"结果",displayField:"complainResult",editable:false,anchor:"95%",mode:"local",triggerAction:"all",selectOnFocus:true,name:"complain.complainResult"});function R(b){return Ext.util.Format.ellipsis(b,12)}function W(b){return Ext.util.Format.ellipsis(b,15)}function K(b){return Ext.util.Format.ellipsis(b,15)}var L=new Ext.grid.ColumnModel([N,{header:"编号",dataIndex:"complainID",width:30},{header:"产品编号",hidden:true,dataIndex:"productionSerial",width:60},{header:"产品名称",hidden:true,dataIndex:"productionName",width:60},{header:"主题",dataIndex:"complainTitle",renderer:R,width:120},{header:"客户",dataIndex:"customerName",renderer:W,width:90},{header:"投诉人",dataIndex:"contactName",width:60},{header:"性别",renderer:SliverUtil.renderGender,dataIndex:"contactGender",width:30},{header:"联系方式",dataIndex:"contactPhone",width:80},{header:"地址",hidden:true,dataIndex:"contactAddress",renderer:K,width:120},{header:"日期",dataIndex:"complainDate",width:60},{header:"状态",align:"right",editor:V,dataIndex:"complainState",width:50},{header:"结果",align:"right",editor:J,dataIndex:"complainResult",width:50}]);L.defaultSortable=true;var Y={"complain.complainDate":"","complain.complainTitle":"","complain.productionSerial":"","complain.productionName":"","complain.customerName":"","complain.contactName":"","complain.contactPhone":"","complain.contactAddress":""};var a=new Ext.menu.Menu({items:[{text:"投诉日期",checked:true,checkHandler:function(){O(this.checked,"complain.complainDate")}},{text:"标题",checked:true,checkHandler:function(){O(this.checked,"complain.complainTitle")}},{text:"产品编号",checked:true,checkHandler:function(){O(this.checked,"complain.productionSerial")}},{text:"产品名称",checked:true,checkHandler:function(){O(this.checked,"complain.productionName")}},{text:"客户名称",checked:true,checkHandler:function(){O(this.checked,"complain.customerName")}},{text:"联系人",checked:true,checkHandler:function(){O(this.checked,"complain.contactName")}},{text:"联系方式",checked:true,checkHandler:function(){O(this.checked,"complain.contactPhone")}},{text:"地址",checked:true,checkHandler:function(){O(this.checked,"complain.contactAddress")}}]});function O(b,c){if(b===true){Y[c]=""}else{Y[c]=null}}var I=new Ext.form.TextField({});var T=new Ext.Button({iconCls:"icon-search",tooltip:"开始搜索",handler:function(){if(null!==Y["complain.complainDate"]){Y["complain.complainDate"]=I.getValue()}if(null!==Y["complain.complainTitle"]){Y["complain.complainTitle"]=I.getValue()}if(null!==Y["complain.productionSerial"]){Y["complain.productionSerial"]=I.getValue()}if(null!==Y["complain.productionName"]){Y["complain.productionName"]=I.getValue()}if(null!==Y["complain.customerName"]){Y["complain.customerName"]=I.getValue()}if(null!==Y["complain.contactName"]){Y["complain.contactName"]=I.getValue()}if(null!==Y["complain.contactPhone"]){Y["complain.contactPhone"]=I.getValue()}if(null!==Y["complain.contactAddress"]){Y["complain.contactAddress"]=I.getValue()}H.baseParams=Y;H.setDefaultSort("complainID","DESC");H.load({params:{start:0,limit:B.getPageSize()}})}});var M=new Ext.Button({iconCls:"icon-clear",tooltip:"清空",handler:function(){I.reset();H.baseParams={};H.setDefaultSort("complainID","DESC");H.load({params:{start:0,limit:B.getPageSize()}})}});var U=new Ext.grid.RowSelectionModel({singleSelect:true});var B=new Ext.ux.Andrie.pPageSize();var A=new Ext.grid.EditorGridPanel({border:false,viewConfig:{forceFit:true},store:H,cm:L,sm:U,plugins:N,loadMask:true,clicksToEdit:1,bbar:new Ext.PagingToolbar({plugins:B,pageSize:20,store:H,displayInfo:true,items:["-",{text:"搜索范围",menu:a},I,T,M]})});A.on("beforeedit",function(b){U.selectRow(b.row)});A.on("afteredit",function(c){var b=U.getSelected();if(b){Ext.Ajax.request({url:"complain/updateComplain.action",params:{"complain.complainID":b.data.complainID,"complain.contactName":b.data.contactName,"complain.contactGender":b.data.contactGender,"complain.contactPhone":b.data.contactPhone,"complain.complainDate":b.data.complainDate,"complain.complainTitle":b.data.complainTitle,"complain.complainDescription":b.data.complainDescription,"complain.complainState":b.data.complainState,"complain.complainResult":b.data.complainResult},method:"post",success:function(d){}})}});A.on("render",function(){H.load({params:{start:0,limit:B.getPageSize()}})});var Z=function(){var b=U.getSelected();if(b){var d=G.id+"-complain-"+b.data.complainID;var c=G.getComponent(d);if(!c){var c=new Ext.Panel({id:d,iconCls:"icon-tag",autoScroll:true,title:"客诉"+b.data.complainID,closable:true});c.on("render",function(){c.load({scripts:true,method:"post",params:{"complain.complainID":b.data.complainID,containerID:c.body.id},url:"complain/getComplain.action"})});var e=G.add(c);G.setActiveTab(e)}else{c.setTitle("客诉"+b.data.complainID);c.setIconClass("icon-tag");c.body.getUpdater().update({scripts:true,method:"post",params:{"complain.complainID":b.data.complainID,containerID:c.body.id},url:"complain/getComplain.action"});G.setActiveTab(c)}}};var S=function(){var b=U.getSelected();if(b){var d=G.id+"-complain-"+b.data.complainID;var c=G.getComponent(d);if(!c){var c=new Ext.Panel({id:d,iconCls:"icon-tag",autoScroll:true,title:"客诉"+b.data.complainID,closable:true});c.on("render",function(){c.load({scripts:true,method:"post",params:{"complain.complainID":b.data.complainID,containerID:c.body.id},url:"complain/updateComplainView.action"})});var e=G.add(c);G.setActiveTab(e)}else{c.setTitle("客诉"+b.data.complainID);c.setIconClass("icon-tag");c.body.getUpdater().update({scripts:true,method:"post",params:{"complain.complainID":b.data.complainID,containerID:c.body.id},url:"complain/updateComplainView.action"});G.setActiveTab(c)}}};var D=function(){var c=G.id+"-complain-"+Ext.id();var b=new Ext.Panel({id:c,iconCls:"icon-tag-add",autoScroll:true,title:"新投诉",closable:true});b.on("render",function(){b.load({scripts:true,method:"post",params:{containerID:b.body.id},url:"complain/insertComplainView.action"})});var d=G.add(b);G.setActiveTab(d)};var F=function(){var b=U.getSelected();if(b){Ext.MessageBox.confirm("删除客户投诉","您确定要删除客户投诉?",function(c){if(c=="yes"){Ext.Ajax.request({url:"complain/removeComplain.action",method:"post",params:{"complain.complainID":b.data.complainID},success:function(e){var d=Ext.decode(e.responseText);if(true===d.success){H.remove(b)}}})}})}};A.on("rowdblclick",Z);var P;A.on("rowcontextmenu",function(c,b,d){c.getSelectionModel().selectRow(b,false);if(!P){P=new Ext.menu.Menu([{text:"添加客户投诉",handler:D},{text:"更新客户投诉",handler:S},{text:"查看客户投诉",handler:Z},"-",{text:"删除客户投诉",handler:F}])}P.showAt(d.getPoint());d.stopEvent()});var G=new Ext.TabPanel({id:"complain-manager-body",region:"center",margins:"0 0 0 0",resizeTabs:true,minTabWidth:135,tabWidth:160,plugins:new Ext.ux.TabCloseMenu(),enableTabScroll:true,border:true,activeTab:0,autoDestroy:true,items:[{closable:false,title:"客户投诉",autoScroll:true,layout:"fit",items:A,iconCls:"icon-tag"}]});E=X.createWindow({id:this.moduleId,title:"客户投诉",width:Q,height:C,x:X.getWinX(Q),y:X.getWinY(C),iconCls:"icon-tag",shim:false,animCollapse:false,constrainHeader:true,minimizable:true,maximizable:true,border:false,layout:"border",tbar:["-",{iconCls:"icon-tag-add",tooltip:"新客户投诉记录",handler:D},{iconCls:"icon-tag-edit",tooltip:"更新户投诉记录",handler:S},{iconCls:"icon-tag-remove",tooltip:"删除户投诉记录",handler:F},{iconCls:"icon-tag",tooltip:"浏览客户投诉记录",handler:Z}],items:G,taskbuttonTooltip:"<b>客户投诉</b><br />客户投诉记录处理"})}E.show()}});Sliver.CustomerManager=Ext.extend(Ext.app.Module,{moduleType:"customer",moduleId:"customer-manager",init:function(){this.launcher={handler:this.createWindow,iconCls:"icon-contact",scope:this,shortcutIconCls:"customer-manager-shortcut",text:"客户资料",tooltip:"<b>客户资料</b><br />客户、联系人，联系记录"}},createWindow:function(){var AG=this.app.getDesktop();var v=AG.getWindow(this.moduleId);if(!v){var E=AG.getWinWidth();var q=AG.getWinHeight();var C=new Ext.tree.TreePanel({useArrows:true,autoScroll:true,animate:true,dropConfig:{appendOnly:true},enableDD:true,containerScroll:true,rootVisible:true,loader:new Ext.tree.SliverTreeLoader({dataUrl:"system/listGroupTree.action"}),root:new Ext.tree.AsyncTreeNode({id:"group-0",text:"组织架构",draggable:false,expanded:true,singleClickExpand:false}),tbar:[{tooltip:"重新加载",iconCls:"icon-reload",handler:function(){C.getRootNode().reload()}},"-",{iconCls:"icon-expand-all",tooltip:"全部展开",handler:function(){C.getRootNode().expand(true)}},{iconCls:"icon-collapse-all",tooltip:"全部折叠",handler:function(){C.getRootNode().collapse(true)}},"-",{iconCls:"icon-customer",tooltip:"显示所有客户",handler:function(){f.reset();o.baseParams={};o.load({params:{start:0,limit:S.getPageSize()}});D.setActiveTab(D.getComponent("contact-manager-customer"))}},{iconCls:"icon-contact",tooltip:"显示所有联系人",handler:function(){Z.reset();B.baseParams={};B.setDefaultSort("id","desc");B.load({params:{start:0,limit:Y.getPageSize()}});D.setActiveTab(D.getComponent("contact-manager-contact"))}}],region:"west",collapseMode:"mini",autoScroll:true,collapsible:true,margins:"0 0 0 0",split:true,border:true,width:parseFloat(E*0.3)<201?parseFloat(E*0.3):200});var B=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:"customer/listAllContact.action"}),reader:new Ext.data.JsonReader({root:"contacts",totalProperty:"total",id:"id",fields:["userID","userName","id","groupID","groupName","name","organization","department","role","nameDisplayed","email","email2","email3","emailDisplayed","web","imType","imValue","imType2","imValue2","telKey","telValue","telKey2","telValue2","telKey3","telValue3","telKey4","telValue4","telKey5","telValue5","telKey6","telValue6","country","province","city","address","zipcode","country2","province2","city2","address2","zipcode2","note","create","update"]}),remoteSort:true});B.setDefaultSort("id","desc");var w=new Ext.grid.CheckboxSelectionModel({singleSelect:false});var d=new Ext.grid.ColumnModel([w,{header:"姓名",dataIndex:"name",width:50},{header:"所属客户",dataIndex:"groupName",hidden:false,width:100},{header:"称谓",hidden:true,dataIndex:"nameDisplayed",width:40},{header:"职位",dataIndex:"role",width:50},{header:"部门",dataIndex:"department",width:40},{hidden:true,header:"单位（组织）",dataIndex:"organization",width:140},{header:"电话",dataIndex:"telValue",width:70},{header:"传真",hidden:true,dataIndex:"telValue2",width:50},{header:"移动电话",hidden:true,dataIndex:"telValue3",width:80},{header:"电子邮件",hidden:true,dataIndex:"email",width:80},{header:"所属帐户",align:"right",dataIndex:"userName",width:45},{header:"创建日期",hidden:true,dataIndex:"create",width:50},{header:"更新日期",dataIndex:"update",align:"right",width:50}]);d.defaultSortable=true;var H={"contact.groupName":"","contact.name":"","contact.telValue":"","contact.email":"","contact.address":"","contact.city":"","contact.province":"","contact.country":""};var j=new Ext.menu.Menu({id:"contactGridFilterMenu",items:[{text:"客户/目录名称",checked:true,checkHandler:function(){AE(this.checked,"contact.groupName")}},{text:"联系人姓名",checked:true,checkHandler:function(){AE(this.checked,"contact.name")}},{text:"电话",checked:true,checkHandler:function(){AE(this.checked,"contact.telValue")}},{text:"电子邮件",checked:true,checkHandler:function(){AE(this.checked,"contact.mail")}},{text:"地址",checked:true,checkHandler:function(){AE(this.checked,"contact.address")}},{text:"城市",checked:true,checkHandler:function(){AE(this.checked,"contact.city")}},{text:"省份",checked:true,checkHandler:function(){AE(this.checked,"contact.province")}},{text:"国家地区",checked:true,checkHandler:function(){AE(this.checked,"contact.country")}}]});function AE(AI,AJ){if(AI===true){H[AJ]=""}else{H[AJ]=null}}var m=new Ext.Button({iconCls:"icon-search",tooltip:"开始搜索",handler:function(){if(null!==H["contact.groupName"]){H["contact.groupName"]=Z.getValue()}if(null!==H["contact.name"]){H["contact.name"]=Z.getValue()}if(null!==H["contact.telValue"]){H["contact.telValue"]=Z.getValue()}if(null!==H["contact.email"]){H["contact.email"]=Z.getValue()}if(null!==H["contact.address"]){H["contact.address"]=Z.getValue()}if(null!==H["contact.city"]){H["contact.city"]=Z.getValue()}if(null!==H["contact.province"]){H["contact.province"]=Z.getValue()}if(null!==H["contact.country"]){H["contact.country"]=Z.getValue()}B.baseParams=H;B.setDefaultSort("id","desc");B.load({params:{start:0,limit:Y.getPageSize()}})}});var Z=new Ext.form.TextField({});var V=new Ext.Button({iconCls:"icon-clear",tooltip:"清空",handler:function(){Z.reset();B.baseParams={};B.setDefaultSort("id","desc");B.load({params:{start:0,limit:Y.getPageSize()}})}});var Y=new Ext.ux.Andrie.pPageSize();var t=new Ext.grid.GridPanel({border:false,viewConfig:{forceFit:true},store:B,cm:d,sm:w,loadMask:true,bbar:new Ext.PagingToolbar({plugins:Y,pageSize:20,store:B,displayInfo:true,items:["-",{text:"查询范围",menu:j},Z,m,V,"-",{iconCls:"icon-pdf",tooltip:"将表格导出为PDF文件",handler:function(){var AI="";if(B.lastOptions){AI+=Ext.urlEncode(B.lastOptions)}if(B.baseParams){if(AI===""){AI+=Ext.urlEncode(B.baseParams)}else{AI+="&";AI+=Ext.urlEncode(B.baseParams)}}if(""!==AI){AI="?"+AI}window.open("customer/exportAllContacts.action"+AI,"_blank")}},{iconCls:"icon-xls",tooltip:"将表格导出为XLS文件",handler:function(){var AI="";if(B.lastOptions){AI+=Ext.urlEncode(B.lastOptions)}if(B.baseParams){if(AI===""){AI+=Ext.urlEncode(B.baseParams)}else{AI+="&";AI+=Ext.urlEncode(B.baseParams)}}if(""===AI){AI="?type=xls"}else{AI="?"+AI+"&type=xls"}window.open("customer/exportAllContacts.action"+AI)}},"-",{iconCls:"icon-contact",tooltip:"将选中联系人资料导出为PDF文件",handler:function(){var AI=w.getSelected();if(AI){window.open("customer/exportContactByAll.action?contact.id="+AI.data.id+"&contact.userID="+AI.data.userID)}}},{iconCls:"icon-xls",tooltip:"将选中联系人资料导出为Excel文件",handler:function(){var AI=w.getSelected();if(AI){window.open("customer/exportContactByAll.action?type=xls&contact.id="+AI.data.id+"&contact.userID="+AI.data.userID)}}}]})});t.on("render",function(){B.load({params:{start:0,limit:Y.getPageSize()}})});t.on("rowdblclick",function(){var AI=w.getSelected();if(AI){J(AI.data.id,AI.data.userID,AI.data.name)}});var F=function(){var AI=w.getSelected();if(AI){J(AI.data.id,AI.data.userID,AI.data.name)}};var N=function(){var AI=w.getSelected();if(AI){W(AI.data.id,AI.data.userID,AI.data.name)}};var p;t.on("rowcontextmenu",function(AJ,AI,AK){AJ.getSelectionModel().selectRow(AI,false);if(!p){p=new Ext.menu.Menu([{id:"updateContactGridViewMenu",text:"更新联系人资料",handler:F},"-",{id:"removeContactRecordGridContextView",text:"删除联系人",handler:N}])}p.showAt(AK.getPoint());AK.stopEvent()});var o=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:"customer/listAllCustomer.action"}),reader:new Ext.data.JsonReader({root:"customers",totalProperty:"total",id:"groupID",fields:["userID","userName","groupID","groupPID","groupName","groupCustomer","tel","tel2","fax","email","email2","web","employees","source","state","nature","sale","level","category","type","create","userID","userName","country","province","city","address","zipcode","country2","province2","city2","address2","zipcode2","bankName","bankAccount","bankNumber","bankTax","payType","creditLimit","orderTotal","orderAmount","note","input","update"]}),remoteSort:true});o.setDefaultSort("groupID","DESC");var M=new Ext.grid.CheckboxSelectionModel({singleSelect:false});var AB=new Ext.grid.ColumnModel([M,{header:"编号",dataIndex:"groupID",width:40},{header:"客户名称",dataIndex:"groupName",width:100},{header:"来源",dataIndex:"source",width:40},{header:"类型",hidden:true,dataIndex:"type",width:40},{header:"电话",dataIndex:"tel",width:60},{header:"传真",dataIndex:"fax",width:60},{header:"网站",dataIndex:"web",hidden:true,width:100},{header:"城市",hidden:true,dataIndex:"city",width:40},{header:"省份",hidden:true,dataIndex:"province",width:40},{header:"行业",align:"right",dataIndex:"category",width:45},{header:"客户等级",align:"right",dataIndex:"level",renderer:function(AI){return SliverData.customerLevel[AI+1][0]},width:45},{header:"所属帐户",align:"right",dataIndex:"userName",width:45},{header:"创建日期",align:"right",hidden:true,dataIndex:"input",width:60},{header:"更新时间",align:"right",hidden:true,dataIndex:"update",width:60}]);AB.defaultSortable=true;var z=new Ext.menu.Menu({id:"customerGridFilterMenu",items:[{text:"客户名称",checked:true,checkHandler:function(){b(this.checked,"customer.groupName")}},{text:"电话",checked:true,checkHandler:function(){b(this.checked,"customer.tel")}},{text:"传真",checked:true,checkHandler:function(){b(this.checked,"customer.fax")}},{text:"网站",checked:true,checkHandler:function(){b(this.checked,"customer.web")}},{text:"电子邮件",checked:true,checkHandler:function(){b(this.checked,"customer.email")}},{text:"城市",checked:true,checkHandler:function(){b(this.checked,"customer.city")}},{text:"省份",checked:true,checkHandler:function(){b(this.checked,"customer.province")}},{text:"国家",checked:true,checkHandler:function(){b(this.checked,"customer.country")}},{text:"地址",checked:true,checkHandler:function(){b(this.checked,"customer.address")}}]});var a={"customer.groupName":"","customer.tel":"","customer.fax":"","customer.email":"","customer.web":"","customer.city":"","customer.province":"","customer.country":"","customer.address":""};function b(AI,AJ){if(AI===true){a[AJ]=""}else{a[AJ]=null}}var f=new Ext.form.TextField({});var u=new Ext.Button({iconCls:"icon-search",tooltip:"开始搜索",handler:function(){if(null!==a["customer.groupName"]){a["customer.groupName"]=f.getValue()}if(null!==a["customer.tel"]){a["customer.tel"]=f.getValue()}if(null!==a["customer.fax"]){a["customer.fax"]=f.getValue()}if(null!==a["customer.web"]){a["customer.web"]=f.getValue()}if(null!==a["customer.email"]){a["customer.email"]=f.getValue()}if(null!==a["customer.city"]){a["customer.city"]=f.getValue()}if(null!==a["customer.province"]){a["customer.province"]=f.getValue()}if(null!==a["customer.country"]){a["customer.country"]=f.getValue()}if(null!==a["customer.address"]){a["customer.address"]=f.getValue()}o.baseParams=a;o.setDefaultSort("groupID","DESC");o.load({params:{start:0,limit:S.getPageSize()}})}});var AH=new Ext.Button({iconCls:"icon-clear",tooltip:"清空",handler:function(){f.reset();o.baseParams={};o.load({params:{start:0,limit:S.getPageSize()}})}});var S=new Ext.ux.Andrie.pPageSize();var Q=new Ext.grid.GridPanel({border:false,viewConfig:{forceFit:true},store:o,cm:AB,sm:M,loadMask:true,bbar:new Ext.PagingToolbar({plugins:S,pageSize:20,store:o,displayInfo:true,items:["-",{text:"查询范围",menu:z},f,u,AH,"-",{iconCls:"icon-pdf",tooltip:"将表格导出为PDF文件",handler:function(){var AI="";if(o.lastOptions){AI+=Ext.urlEncode(o.lastOptions)}if(o.baseParams){if(AI===""){AI+=Ext.urlEncode(o.baseParams)}else{AI+="&";AI+=Ext.urlEncode(o.baseParams)}}if(""!==AI){AI="?"+AI}window.open("customer/exportAllCustomers.action"+AI)}},{iconCls:"icon-xls",tooltip:"将表格导出为XLS文件",handler:function(){var AI="";if(o.lastOptions){AI+=Ext.urlEncode(o.lastOptions)}if(B.baseParams){if(AI===""){AI+=Ext.urlEncode(o.baseParams)}else{AI+="&";AI+=Ext.urlEncode(o.baseParams)}}if(""===AI){AI="?type=xls"}else{AI="?"+AI+"&type=xls"}window.open("customer/exportAllCustomers.action"+AI)}},"-",{iconCls:"icon-customer",tooltip:"将选中客户资料导出为PDF文件",handler:function(){var AI=M.getSelected();if(AI){window.open("customer/exportCustomerByAll.action?customer.groupID="+AI.data.groupID+"&customer.userID="+AI.data.userID)}}},{iconCls:"icon-xls",tooltip:"将选中客户资料导出为Excel文件",handler:function(){var AI=M.getSelected();if(AI){window.open("customer/exportCustomerByAll.action?type=xls&customer.groupID="+AI.data.groupID+"&customer.userID="+AI.data.userID)}}}]})});Q.on("render",function(){o.load({params:{start:0,limit:S.getPageSize()}})});Q.on("rowdblclick",function(){var AI=M.getSelected();if(AI){k(AI.data.groupID,AI.data.userID,AI.data.groupName)}});var g;Q.on("rowcontextmenu",function(AJ,AI,AK){AJ.getSelectionModel().selectRow(AI,false);if(!g){g=new Ext.menu.Menu([{id:"insertCustomerContextMenu",text:"新建客户",handler:function(){var AL=M.getSelected();if(AL){r(AL.data.groupPID)}}},{id:"updateCustomerContextMenu",text:"更新客户",handler:function(){var AL=M.getSelected();if(AL){k(AL.data.groupID,AL.data.userID,AL.data.groupName)}}},{id:"addContactViewContextMenu",text:"新建联系人",handler:function(){var AL=M.getSelected();if(AL){l(AL.data.groupID)}}},"-",{id:"removeCustomerContextMenu",text:"删除客户",handler:function(){var AL=M.getSelected();if(AL){O(AL.data.groupID,AL.data.userID,AL.data.groupName)}}}])}g.showAt(AK.getPoint());AK.stopEvent()});var c=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:"customer/listAllContactRecord.action"}),reader:new Ext.data.JsonReader({root:"records",totalProperty:"total",id:"recordID",fields:["contactID","contactName","userID","userName","recordID","recordTitle","recordType","recordCommunicateType","recordContent","recordFile","createTimestamp","updateTimestamp"]}),remoteSort:true});c.setDefaultSort("recordID","DESC");var T=new Ext.grid.RowExpander({tpl:new Ext.Template("<p><b>联系内容:</b> {recordContent}</p>")});var i=new Ext.grid.ColumnModel([T,{header:"序号",dataIndex:"recordID",width:40},{header:"附件",dataIndex:"recordFile",renderer:SliverUtil.renderFile,width:20},{header:"联系人",dataIndex:"contactName",width:50},{header:"来源",hidden:true,dataIndex:"recordType",width:60},{header:"联系方式",dataIndex:"recordCommunicateType",width:60},{header:"标题",dataIndex:"recordTitle",renderer:function(AI){return Ext.util.Format.ellipsis(AI,25)},width:160},{header:"所属帐户",dataIndex:"userName",width:45},{header:"创建时间",align:"right",dataIndex:"createTimestamp",width:80},{header:"更新时间",align:"right",hidden:true,dataIndex:"updateTimestamp",width:80}]);i.defaultSortable=true;var x=new Ext.menu.Menu({id:"recordGridFilterMenu",items:[{text:"联系人姓名",checked:true,checkHandler:function(){U(this.checked,"record.contactName")}},{text:"联系事由",checked:true,checkHandler:function(){U(this.checked,"record.type")}},{text:"标题",checked:true,checkHandler:function(){U(this.checked,"record.title")}},{text:"沟通方式",checked:true,checkHandler:function(){U(this.checked,"record.recordCommunicateType")}},{text:"内容",checked:true,checkHandler:function(){U(this.checked,"record.recordContent")}}]});var e={"record.contactName":"","record.type":"","record.title":"","record.recordCommunicateType":"","record.recordContent":""};function U(AI,AJ){if(AI===true){e[AJ]=""}else{e[AJ]=null}}var n=new Ext.form.TextField({});var y=new Ext.Button({iconCls:"icon-search",tooltip:"开始搜索",handler:function(){if(null!==e["record.contactName"]){e["record.contactName"]=n.getValue()}if(null!==e["record.type"]){e["record.type"]=n.getValue()}if(null!==e["record.title"]){e["record.title"]=n.getValue()}if(null!==e["record.recordCommunicateType"]){e["record.recordCommunicateType"]=n.getValue()}if(null!==e["record.recordContent"]){e["record.recordContent"]=n.getValue()}c.baseParams=e;c.setDefaultSort("recordID","DESC");c.load({params:{start:0,limit:L.getPageSize()}})}});var R=new Ext.Button({iconCls:"icon-clear",tooltip:"清空",handler:function(){f.reset();c.baseParams={};c.load({params:{start:0,limit:L.getPageSize()}})}});var G=function(){var AI=P.getSelected();if(AI){X(AI.data.recordID,AI.data.userID,AI.data.contactID,AI.data.contactName)}};var P=new Ext.grid.RowSelectionModel({singleSelect:true});var L=new Ext.ux.Andrie.pPageSize();var AA=new Ext.grid.GridPanel({border:false,viewConfig:{forceFit:true},store:c,cm:i,sm:P,plugins:T,loadMask:true,bbar:new Ext.PagingToolbar({plugins:L,pageSize:20,store:c,displayInfo:true,displayMsg:"显示 {0} - {1} 共{2}",emptyMsg:"",items:["-",{text:"查询范围",menu:x},n,y,R]})});AA.on("render",function(){c.load({params:{start:0,limit:L.getPageSize()}})});AA.on("rowcontextmenu",function(AI,AJ,AK){AK.stopEvent()});AA.on("rowdblclick",G);var AD=new Ext.Panel({id:"owner-manager-view",iconCls:"icon-contact",autoScroll:false,baseCls:"x-plain",title:"客户移交",border:false,frame:false,closable:false});AD.on("render",function(){AD.load({scripts:true,method:"post",params:{containerID:AD.body.id},url:"customer/managerOwnerView.jsp"})});var D=new Ext.TabPanel({id:"contact-manager-body",region:"center",margins:"0 0 0 0",resizeTabs:true,minTabWidth:135,plugins:new Ext.ux.TabCloseMenu(),enableTabScroll:true,border:true,activeTab:0,autoDestroy:true,items:[{id:"contact-manager-customer",closable:false,title:"所有客户",autoScroll:true,layout:"fit",items:Q,iconCls:"icon-customer"},{id:"contact-manager-contact",closable:false,title:"所有联系人",autoScroll:true,layout:"fit",items:t,iconCls:"icon-contact"},{id:"contact-manager-record",closable:false,title:"所有联系记录",autoScroll:true,layout:"fit",items:AA,iconCls:"icon-comments"},AD]});C.on("contextMenu",function(AJ,AI){AI.stopEvent()});C.on("click",function(AI,AJ){if(!AI.isSelected()){AI.select()}if(true===AI.isLeaf()){o.baseParams={"customer.userID":AI.id.substring(AI.id.lastIndexOf("-")+1)};o.setDefaultSort("groupID","desc");o.load({params:{start:0,limit:20}});D.setActiveTab(D.getComponent("contact-manager-customer"))}});C.on("dblclick",function(AI,AJ){if(!AI.isSelected()){AI.select()}if(true===AI.isLeaf()){B.baseParams={"contact.userID":AI.id.substring(AI.id.lastIndexOf("-")+1)};B.setDefaultSort("id","desc");B.load({params:{start:0,limit:20}});D.setActiveTab(D.getComponent("contact-manager-contact"))}});function h(){var AI=sm.getSelectedNode();if(AI){AI.reload()}else{C.getRootNode().reload();sm.select(C.getRootNode())}}function AF(){var AI=sm.getSelectedNode();if(AI){AI.expand()}else{C.getRootNode().expand();sm.select(C.getRootNode())}}function K(){var AI=sm.getSelectedNode();if(AI){AI.collapse()}else{C.getRootNode().collapse();sm.select(C.getRootNode())}}function l(AL){var AJ=Ext.id();var AI=new Ext.Panel({id:AJ,iconCls:"icon-contact",autoScroll:true,title:"添加联系人",closable:true});AI.on("render",function(){AI.load({scripts:true,method:"post",params:{"group.groupID":AL,containerID:AI.body.id},url:"customer/insertContactAllView.action"})});var AK=D.add(AI);D.setActiveTab(AK)}function J(AO,AK,AN){var AJ=D.id+"-contact-"+AO;var AL=D.getComponent(AJ);if(AL){AL.body.getUpdater().update({scripts:true,method:"post",params:{"contact.id":AO,containerID:AL.body.id,"contact.userID":AK},url:"customer/updateContactAllView.action"});D.setActiveTab(AL)}else{var AI=new Ext.Panel({id:AJ,autoScroll:true,iconCls:"icon-contact",title:AN,closable:true});AI.on("render",function(){AI.load({scripts:true,method:"post",params:{"contact.id":AO,containerID:AI.body.id,"contact.userID":AK},url:"customer/updateContactAllView.action"})});var AM=D.add(AI);D.setActiveTab(AM)}}var W=function(AK,AI,AJ){Ext.MessageBox.confirm("删除联系人","您确定要删除该联系人 <b>"+AJ+"</b>?",function(AL){if(AL=="yes"){Ext.Ajax.request({url:"customer/removeContactByAll.action",params:{"contact.id":AK,"contact.userID":AI},success:function(AN){var AO=Ext.decode(AN.responseText);if(AO.success===true){var AM=D.id+"-contact-"+AK;var AP=D.getComponent(AM);if(AP){D.remove(AP,true)}B.reload();var AQ=C.getNodeById("contact-"+AK);if(AQ){AQ.remove()}}}})}})};var r=function(AL){var AJ=Ext.id();var AI=new Ext.Panel({id:AJ,iconCls:"icon-customer",autoScroll:true,title:"添加客户",closable:true});AI.on("render",function(){AI.load({scripts:true,method:"post",params:{"group.groupID":AL,containerID:AI.body.id},url:"customer/insertCustomerAllView.action"})});var AK=D.add(AI);D.setActiveTab(AK)};var k=function(AO,AK,AM){var AJ=D.id+"-customer-"+AO;var AL=D.getComponent(AJ);if(AL){AL.body.getUpdater().update({scripts:true,method:"post",params:{"customer.groupID":AO,"customer.userID":AK,containerID:AL.body.id,parentName:AM},url:"customer/updateCustomerAllView.action"});D.setActiveTab(AL)}else{var AI=new Ext.Panel({id:AJ,autoScroll:true,iconCls:"icon-customer",title:AM,closable:true});AI.on("render",function(){AI.load({scripts:true,method:"post",params:{"customer.groupID":AO,"customer.userID":AK,containerID:AI.body.id,parentName:AM},url:"customer/updateCustomerAllView.action"})});var AN=D.add(AI);D.setActiveTab(AN)}};var O=function(AK,AI,AJ){Ext.MessageBox.confirm("删除客户","您确定要删除客户 <b>"+AJ+" ?",function(AL){if(AL=="yes"){Ext.Ajax.request({url:"customer/removeCustomerByAll.action",params:{"customer.groupID":AK,"customer.userID":AI},success:function(AM){var AN=C.getNodeById("guestGroup-"+AK);if(AN){AN.remove()}o.reload()}})}})};var I=function(){var AI=sm.getSelectedNode();if(AI){if(AI.id.substring(AI.id.lastIndexOf("-")+1)!=="0"){if(AI.isLeaf()){W(AI.id.substring(AI.id.lastIndexOf("-")+1),AI.userID,AI.text)}else{if(AI.isCustomer()>=0){O(AI.id.substring(AI.id.lastIndexOf("-")+1),AI.userID,AI.text)}}}}};var s=function(){var AI=sm.getSelectedNode();if(AI){if(AI.isLeaf()){J(AI.id.substring(AI.id.lastIndexOf("-")+1),AI.userID,AI.parentNodetext)}else{if(AI.isCustomer()>=0){k(AI.id.substring(AI.id.lastIndexOf("-")+1),AI.userID,AI.parentNode.text)}}}};var X=function(AP,AK,AM,AO){var AJ=D.id+"-contactrecord-"+AP;var AL=D.getComponent(AJ);if(AL){AL.body.getUpdater().update({scripts:true,method:"post",params:{"record.userID":AK,"record.recordID":AP,"record.contactID":AM,containerID:AL.body.id},url:"customer/updateContactRecordAllView.action"});AL.setIconClass("icon-comment-edit");D.setActiveTab(AL)}else{var AI=new Ext.Panel({id:AJ,autoScroll:true,iconCls:"icon-comment-edit",title:"["+AO+"]联系记录",closable:true});AI.on("render",function(){AI.load({scripts:true,method:"post",params:{"record.userID":AK,"record.recordID":AP,"record.contactID":AM,containerID:AI.body.id},url:"customer/updateContactRecordAllView.action"})});var AN=D.add(AI);D.setActiveTab(AN)}};var AC=function(){var AJ=D.id+"-contactState";var AI=D.getComponent(AJ);if(!AI){var AI=new Ext.Panel({id:AJ,iconCls:"icon-chart-pie",autoScroll:true,title:" 联系人份额统计",closable:true});AI.on("render",function(){AI.load({scripts:true,method:"post",params:{containerID:AI.body.id},url:"order/contactStatePanel.jsp"})});var AK=D.add(AI);D.setActiveTab(AK)}else{AI.body.getUpdater().update({scripts:true,method:"post",params:{containerID:AI.body.id},url:"order/contactStatePanel.jsp"});D.setActiveTab(AI)}};var A=function(){var AJ=D.id+"-groupState";var AI=D.getComponent(AJ);if(!AI){var AI=new Ext.Panel({id:AJ,iconCls:"icon-chart-bar",autoScroll:true,title:" 客户(分组)份额统计",closable:true});AI.on("render",function(){AI.load({scripts:true,method:"post",params:{containerID:AI.body.id},url:"order/groupStatePanel.jsp"})});var AK=D.add(AI);D.setActiveTab(AK)}else{AI.body.getUpdater().update({scripts:true,method:"post",params:{containerID:AI.body.id},url:"order/groupStatePanel.jsp"});D.setActiveTab(AI)}};v=AG.createWindow({id:this.moduleId,title:"所有客户",width:E,height:q,x:AG.getWinX(E),y:AG.getWinY(q),iconCls:"icon-contact",shim:false,animCollapse:false,constrainHeader:true,minimizable:true,maximizable:true,border:false,layout:"border",items:[C,D],tbar:["-",{text:"新建",menu:new Ext.menu.Menu({items:[{text:"新建客户",iconCls:"icon-customer",handler:r},{text:"新建联系人",iconCls:"icon-contact",handler:l}]})},"-",{text:"统计报表",menu:new Ext.menu.Menu({items:[{text:"联系人统计",iconCls:"icon-chart-pie",handler:AC},{text:"客户统计",iconCls:"icon-chart-bar",handler:A}]})},"-","图例","-",{iconCls:"icon-shield-0",tooltip:"潜在客户"},{iconCls:"icon-shield-1",tooltip:"有意向客户"},{iconCls:"icon-shield-2",tooltip:"成交客户"},{iconCls:"icon-shield-3",tooltip:"失败客户"},{iconCls:"icon-shield-4",tooltip:"无状态客户"}],taskbuttonTooltip:"<b>所有客户</b><br/>所有客户、联系人资料，联系记录"})}v.show()}});Sliver.CustomerOwner=Ext.extend(Ext.app.Module,{moduleType:"customer",moduleId:"customer-owner",init:function(){this.launcher={handler:this.createWindow,iconCls:"icon-contact",scope:this,shortcutIconCls:"customer-shortcut",text:"我的客户",tooltip:"<b>我的客户</b><br />我的客户资料，联系记录"}},createWindow:function(){var desktop=this.app.getDesktop();var win=desktop.getWindow(this.moduleId);if(!win){var winWidth=desktop.getWinWidth();var winHeight=desktop.getWinHeight();var groupTree=new Ext.tree.TreePanel({region:"west",split:true,collapseMode:"mini",useArrows:true,autoScroll:true,animate:true,dropConfig:{appendOnly:true},enableDD:true,containerScroll:true,rootVisible:true,loader:new Ext.tree.ContactTreeLoader({dataUrl:"customer/listContactTree.action"}),root:new Ext.tree.contactNode({id:"guestGroup-1",text:"客户和联系人",iconCls:"icon-customer",draggable:false,expanded:true,isCustomer:false,singleClickExpand:false}),tbar:[{tooltip:"重新加载",iconCls:"icon-reload",handler:function(){groupTree.getRootNode().reload()}},"-",{iconCls:"icon-expand-all",tooltip:"全部展开",handler:function(){groupTree.getRootNode().expand(true)}},{iconCls:"icon-collapse-all",tooltip:"全部折叠",handler:function(){groupTree.getRootNode().collapse(true)}},"->","-",{iconCls:"icon-add",menu:new Ext.menu.Menu({items:[{text:"新建目录",iconCls:"icon-group-add",handler:function(){var node=sm.getSelectedNode();if(node){insertGroupView(node.id.substring(node.id.lastIndexOf("-")+1))}else{insertGroupView()}}},{text:"新建客户",iconCls:"icon-customer",handler:function(){var node=sm.getSelectedNode();if(node){insertCustomerView(node.id.substring(node.id.lastIndexOf("-")+1))}else{insertCustomerView()}}},{text:"新建联系人",iconCls:"icon-contact-add",handler:function(){var node=sm.getSelectedNode();if(node){insertContactView(node.id.substring(node.id.lastIndexOf("-")+1))}else{insertContactView()}}}]})}],autoScroll:true,margins:"0 0 0 0",width:parseFloat(winWidth*0.3)<201?parseFloat(winWidth*0.3):200});var store=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:"customer/listContact.action"}),reader:new Ext.data.JsonReader({root:"contacts",totalProperty:"total",id:"id",fields:["userID","userName","id","groupID","groupName","name","organization","department","role","nameDisplayed","email","email2","email3","emailDisplayed","web","imType","imValue","imType2","imValue2","telKey","telValue","telKey2","telValue2","telKey3","telValue3","telKey4","telValue4","telKey5","telValue5","telKey6","telValue6","country","province","city","address","zipcode","country2","province2","city2","address2","zipcode2","note","create","update"]}),remoteSort:true});store.setDefaultSort("id","desc");var gridsm=new Ext.grid.CheckboxSelectionModel({singleSelect:false});var cm=new Ext.grid.ColumnModel([gridsm,{header:"姓名",dataIndex:"name",width:50},{header:"所属客户",dataIndex:"groupName",hidden:false,width:100},{header:"称谓",hidden:true,dataIndex:"nameDisplayed",width:40},{header:"职位",dataIndex:"role",width:50},{header:"部门",dataIndex:"department",width:40},{hidden:true,header:"单位（组织）",dataIndex:"organization",width:140},{header:"电话",dataIndex:"telValue",width:100},{header:"传真",hidden:true,dataIndex:"telValue2",width:50},{header:"移动电话",hidden:true,dataIndex:"telValue3",width:80},{header:"电子邮件",hidden:true,dataIndex:"email",width:80},{header:"创建日期",hidden:true,dataIndex:"create",width:40},{header:"更新日期",dataIndex:"update",align:"right",width:40}]);cm.defaultSortable=true;var filterContactParams={"contact.groupName":"","contact.name":"","contact.telValue":"","contact.email":"","contact.address":"","contact.city":"","contact.province":"","contact.country":""};var contactGridFilterMenu=new Ext.menu.Menu({id:"contactGridFilterMenu",items:[{text:"客户/目录名称",checked:true,checkHandler:function(){operateContactGridParams(this.checked,"contact.groupName")}},{text:"联系人姓名",checked:true,checkHandler:function(){operateContactGridParams(this.checked,"contact.name")}},{text:"电话",checked:true,checkHandler:function(){operateContactGridParams(this.checked,"contact.telValue")}},{text:"电子邮件",checked:true,checkHandler:function(){operateContactGridParams(this.checked,"contact.mail")}},{text:"地址",checked:true,checkHandler:function(){operateContactGridParams(this.checked,"contact.address")}},{text:"城市",checked:true,checkHandler:function(){operateContactGridParams(this.checked,"contact.city")}},{text:"省份",checked:true,checkHandler:function(){operateContactGridParams(this.checked,"contact.province")}},{text:"国家地区",checked:true,checkHandler:function(){operateContactGridParams(this.checked,"contact.country")}}]});function operateContactGridParams(status,name){if(status===true){filterContactParams[name]=""}else{filterContactParams[name]=null}}var filterButton=new Ext.Button({iconCls:"icon-search",tooltip:"开始搜索",handler:function(){if(null!==filterContactParams["contact.groupName"]){filterContactParams["contact.groupName"]=filterField.getValue()}if(null!==filterContactParams["contact.name"]){filterContactParams["contact.name"]=filterField.getValue()}if(null!==filterContactParams["contact.telValue"]){filterContactParams["contact.telValue"]=filterField.getValue()}if(null!==filterContactParams["contact.email"]){filterContactParams["contact.email"]=filterField.getValue()}if(null!==filterContactParams["contact.address"]){filterContactParams["contact.address"]=filterField.getValue()}if(null!==filterContactParams["contact.city"]){filterContactParams["contact.city"]=filterField.getValue()}if(null!==filterContactParams["contact.province"]){filterContactParams["contact.province"]=filterField.getValue()}if(null!==filterContactParams["contact.country"]){filterContactParams["contact.country"]=filterField.getValue()}store.baseParams=filterContactParams;store.setDefaultSort("id","desc");store.load({params:{start:0,limit:pageSizePlugin.getPageSize()}})}});var filterField=new Ext.form.TextField({});var clearButton=new Ext.Button({iconCls:"icon-clear",tooltip:"清空",handler:function(){filterField.reset();store.baseParams={};store.setDefaultSort("id","desc");store.load({params:{start:0,limit:pageSizePlugin.getPageSize()}})}});var pageSizePlugin=new Ext.ux.Andrie.pPageSize();var grid=new Ext.grid.GridPanel({border:false,viewConfig:{forceFit:true},store:store,cm:cm,sm:gridsm,loadMask:true,bbar:new Ext.PagingToolbar({plugins:pageSizePlugin,pageSize:20,store:store,displayInfo:true,items:["-",{text:"查询范围",menu:contactGridFilterMenu},filterField,filterButton,clearButton,"-",{iconCls:"icon-pdf",tooltip:"将表格导出为PDF文件",handler:function(){var s="";if(store.lastOptions){s+=Ext.urlEncode(store.lastOptions)}if(store.baseParams){if(s===""){s+=Ext.urlEncode(store.baseParams)}else{s+="&";s+=Ext.urlEncode(store.baseParams)}}if(""!==s){s="?"+s}window.open("customer/exportContacts.action"+s,"_blank")}},{iconCls:"icon-xls",tooltip:"将表格导出为XLS文件",handler:function(){var s="";if(store.lastOptions){s+=Ext.urlEncode(store.lastOptions)}if(store.baseParams){if(s===""){s+=Ext.urlEncode(store.baseParams)}else{s+="&";s+=Ext.urlEncode(store.baseParams)}}if(""===s){s="?type=xls"}else{s="?"+s+"&type=xls"}window.open("customer/exportContacts.action"+s)}},"-",{iconCls:"icon-contact",tooltip:"将选中联系人资料导出为PDF文件",handler:function(){var record=gridsm.getSelected();if(record){window.open("customer/exportContact.action?contact.id="+record.data.id)}}},{iconCls:"icon-xls",tooltip:"将选中联系人资料导出为Excel文件",handler:function(){var record=gridsm.getSelected();if(record){window.open("customer/exportContact.action?type=xls&contact.id="+record.data.id)}}}]})});grid.on("render",function(){store.load({params:{start:0,limit:pageSizePlugin.getPageSize()}})});grid.on("rowdblclick",function(){var record=gridsm.getSelected();if(record){updateContactView(record.data.id,record.data.name)}});var updateContactGridView=function(){var record=gridsm.getSelected();if(record){updateContactView(record.data.id,record.data.name)}};var deleteContactGridView=function(){var record=gridsm.getSelected();if(record){removeContactView(record.data.id,record.data.name)}};var insertContactRecordGridView=function(){var record=gridsm.getSelected();if(record){insertContactRecordView(record.data.id,record.data.name)}};var cMenu;grid.on("rowcontextmenu",function(grid,rowindex,e){grid.getSelectionModel().selectRow(rowindex,false);if(!cMenu){cMenu=new Ext.menu.Menu([{id:"updateContactGridViewMenu",text:"更新联系人资料",handler:updateContactGridView},{id:"addContactRecordGridViewMenu",text:"新建联系记录",handler:insertContactRecordGridView},"-",{id:"removeContactRecordGridContextView",text:"删除联系人",handler:deleteContactGridView}])}cMenu.showAt(e.getPoint());e.stopEvent()});var customerstore=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:"customer/listCustomer.action"}),reader:new Ext.data.JsonReader({root:"customers",totalProperty:"total",id:"groupID",fields:["userID","userName","groupID","groupPID","groupName","groupCustomer","tel","tel2","fax","email","email2","web","employees","source","state","nature","sale","level","category","type","create","userID","userName","country","province","city","address","zipcode","country2","province2","city2","address2","zipcode2","bankName","bankAccount","bankNumber","bankTax","payType","creditLimit","orderTotal","orderAmount","note","input","update"]}),remoteSort:true});customerstore.setDefaultSort("groupID","DESC");var customergridsm=new Ext.grid.CheckboxSelectionModel({singleSelect:false});var customercm=new Ext.grid.ColumnModel([customergridsm,{header:"编号",dataIndex:"groupID",width:40},{header:"客户名称",dataIndex:"groupName",width:100},{header:"来源",dataIndex:"source",width:40},{header:"类型",hidden:true,dataIndex:"type",width:40},{header:"电话",dataIndex:"tel",width:80},{header:"传真",dataIndex:"fax",width:60},{header:"网站",dataIndex:"web",hidden:true,width:100},{header:"城市",hidden:true,dataIndex:"city",width:40},{header:"省份",hidden:true,dataIndex:"province",width:40},{header:"行业",align:"right",dataIndex:"category",width:45},{header:"客户等级",align:"right",dataIndex:"level",renderer:function(v){return SliverData.customerLevel[v+1][0]},width:45},{header:"创建日期",align:"right",hidden:true,dataIndex:"input",width:60},{header:"更新时间",align:"right",hidden:true,dataIndex:"update",width:60}]);customercm.defaultSortable=true;var customerGridFilterMenu=new Ext.menu.Menu({id:"customerGridFilterMenu",items:[{text:"客户名称",checked:true,checkHandler:function(){operateCustomerGridParams(this.checked,"customer.groupName")}},{text:"电话",checked:true,checkHandler:function(){operateCustomerGridParams(this.checked,"customer.tel")}},{text:"传真",checked:true,checkHandler:function(){operateCustomerGridParams(this.checked,"customer.fax")}},{text:"网站",checked:true,checkHandler:function(){operateCustomerGridParams(this.checked,"customer.web")}},{text:"电子邮件",checked:true,checkHandler:function(){operateCustomerGridParams(this.checked,"customer.email")}},{text:"城市",checked:true,checkHandler:function(){operateCustomerGridParams(this.checked,"customer.city")}},{text:"省份",checked:true,checkHandler:function(){operateCustomerGridParams(this.checked,"customer.province")}},{text:"国家",checked:true,checkHandler:function(){operateCustomerGridParams(this.checked,"customer.country")}},{text:"地址",checked:true,checkHandler:function(){operateCustomerGridParams(this.checked,"customer.address")}}]});var customerGridFilterParams={"customer.groupName":"","customer.tel":"","customer.fax":"","customer.email":"","customer.web":"","customer.city":"","customer.province":"","customer.country":"","customer.address":""};function operateCustomerGridParams(status,name){if(status===true){customerGridFilterParams[name]=""}else{customerGridFilterParams[name]=null}}var filterCustomerField=new Ext.form.TextField({});var filterCustomerButton=new Ext.Button({iconCls:"icon-search",tooltip:"开始搜索",handler:function(){if(null!==customerGridFilterParams["customer.groupName"]){customerGridFilterParams["customer.groupName"]=filterCustomerField.getValue()}if(null!==customerGridFilterParams["customer.tel"]){customerGridFilterParams["customer.tel"]=filterCustomerField.getValue()}if(null!==customerGridFilterParams["customer.fax"]){customerGridFilterParams["customer.fax"]=filterCustomerField.getValue()}if(null!==customerGridFilterParams["customer.web"]){customerGridFilterParams["customer.web"]=filterCustomerField.getValue()}if(null!==customerGridFilterParams["customer.email"]){customerGridFilterParams["customer.email"]=filterCustomerField.getValue()}if(null!==customerGridFilterParams["customer.city"]){customerGridFilterParams["customer.city"]=filterCustomerField.getValue()}if(null!==customerGridFilterParams["customer.province"]){customerGridFilterParams["customer.province"]=filterCustomerField.getValue()}if(null!==customerGridFilterParams["customer.country"]){customerGridFilterParams["customer.country"]=filterCustomerField.getValue()}if(null!==customerGridFilterParams["customer.address"]){customerGridFilterParams["customer.address"]=filterCustomerField.getValue()}customerstore.baseParams=customerGridFilterParams;customerstore.setDefaultSort("groupID","DESC");customerstore.load({params:{start:0,limit:customerPageSizePlugin.getPageSize()}})}});var clearCustomerButton=new Ext.Button({iconCls:"icon-clear",tooltip:"清空",handler:function(){filterCustomerField.reset();customerstore.baseParams={};customerstore.load({params:{start:0,limit:customerPageSizePlugin.getPageSize()}})}});var customerPageSizePlugin=new Ext.ux.Andrie.pPageSize();var customergrid=new Ext.grid.GridPanel({border:false,viewConfig:{forceFit:true},store:customerstore,cm:customercm,sm:customergridsm,loadMask:true,bbar:new Ext.PagingToolbar({plugins:customerPageSizePlugin,pageSize:20,store:customerstore,displayInfo:true,items:["-",{text:"查询范围",menu:customerGridFilterMenu},filterCustomerField,filterCustomerButton,clearCustomerButton,"-",{iconCls:"icon-pdf",tooltip:"将表格导出为PDF文件",handler:function(){var s="";if(customerstore.lastOptions){s+=Ext.urlEncode(customerstore.lastOptions)}if(customerstore.baseParams){if(s===""){s+=Ext.urlEncode(customerstore.baseParams)}else{s+="&";s+=Ext.urlEncode(customerstore.baseParams)}}if(""!==s){s="?"+s}window.open("customer/exportCustomers.action"+s)}},{iconCls:"icon-xls",tooltip:"将表格导出为XLS文件",handler:function(){var s="";if(customerstore.lastOptions){s+=Ext.urlEncode(customerstore.lastOptions)}if(store.baseParams){if(s===""){s+=Ext.urlEncode(customerstore.baseParams)}else{s+="&";s+=Ext.urlEncode(customerstore.baseParams)}}if(""===s){s="?type=xls"}else{s="?"+s+"&type=xls"}window.open("customer/exportCustomers.action"+s)}},"-",{iconCls:"icon-customer",tooltip:"将选中客户资料导出为PDF文件",handler:function(){var record=customergridsm.getSelected();if(record){window.open("customer/exportCustomer.action?customer.groupID="+record.data.groupID)}}},{iconCls:"icon-xls",tooltip:"将选中客户资料导出为Excel文件",handler:function(){var record=customergridsm.getSelected();if(record){window.open("customer/exportCustomer.action?type=xls&customer.groupID="+record.data.groupID)}}}]})});customergrid.on("render",function(){customerstore.load({params:{start:0,limit:customerPageSizePlugin.getPageSize()}})});customergrid.on("rowdblclick",function(){var record=customergridsm.getSelected();if(record){updateCustomerView(record.data.groupID,record.data.groupName)}});var customerContextMenu;customergrid.on("rowcontextmenu",function(customergrid,rowindex,e){customergrid.getSelectionModel().selectRow(rowindex,false);if(!customerContextMenu){customerContextMenu=new Ext.menu.Menu([{id:"insertCustomerContextMenu",text:"新建客户",handler:function(){var record=customergridsm.getSelected();if(record){insertCustomerView(record.data.groupPID)}}},{id:"updateCustomerContextMenu",text:"更新客户",handler:function(){var record=customergridsm.getSelected();if(record){updateCustomerView(record.data.groupID,record.data.groupName)}}},{id:"addContactViewContextMenu",text:"新建联系人",handler:function(){var record=customergridsm.getSelected();if(record){insertContactView(record.data.groupID)}}},"-",{id:"removeCustomerContextMenu",text:"删除客户",handler:function(){var record=customergridsm.getSelected();if(record){removeCustomerView(record.data.groupID,record.data.groupName)}}}])}customerContextMenu.showAt(e.getPoint());e.stopEvent()});var recordstore=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:"customer/listContactRecord.action"}),reader:new Ext.data.JsonReader({root:"records",totalProperty:"total",id:"recordID",fields:["contactID","contactName","recordID","recordTitle","recordType","recordCommunicateType","recordContent","recordFile","createTimestamp","updateTimestamp"]}),remoteSort:true});recordstore.setDefaultSort("recordID","DESC");var recordExpander=new Ext.grid.RowExpander({tpl:new Ext.Template("<p><b>联系内容:</b> {recordContent}</p>")});var recordcm=new Ext.grid.ColumnModel([recordExpander,{header:"序号",dataIndex:"recordID",width:40},{header:"附件",dataIndex:"recordFile",renderer:SliverUtil.renderFile,width:20},{header:"联系人",dataIndex:"contactName",width:50},{header:"来源",hidden:true,dataIndex:"recordType",width:60},{header:"联系方式",dataIndex:"recordCommunicateType",width:60},{header:"标题",dataIndex:"recordTitle",renderer:function(v){return Ext.util.Format.ellipsis(v,25)},width:160},{header:"创建时间",align:"right",dataIndex:"createTimestamp",width:80},{header:"更新时间",align:"right",hidden:true,dataIndex:"updateTimestamp",width:80}]);recordcm.defaultSortable=true;var recordGridFilterMenu=new Ext.menu.Menu({id:"recordGridFilterMenu",items:[{text:"联系人姓名",checked:true,checkHandler:function(){operateRecordGridParams(this.checked,"record.contactName")}},{text:"联系事由",checked:true,checkHandler:function(){operateRecordGridParams(this.checked,"record.type")}},{text:"标题",checked:true,checkHandler:function(){operateRecordGridParams(this.checked,"record.title")}},{text:"沟通方式",checked:true,checkHandler:function(){operateRecordGridParams(this.checked,"record.recordCommunicateType")}},{text:"内容",checked:true,checkHandler:function(){operateRecordGridParams(this.checked,"record.recordContent")}}]});var recordGridFilterParams={"record.contactName":"","record.type":"","record.title":"","record.recordCommunicateType":"","record.recordContent":""};function operateRecordGridParams(status,name){if(status===true){recordGridFilterParams[name]=""}else{recordGridFilterParams[name]=null}}var filterRecordField=new Ext.form.TextField({});var filterRecordButton=new Ext.Button({iconCls:"icon-search",tooltip:"开始搜索",handler:function(){if(null!==recordGridFilterParams["record.contactName"]){recordGridFilterParams["record.contactName"]=filterRecordField.getValue()}if(null!==recordGridFilterParams["record.type"]){recordGridFilterParams["record.type"]=filterRecordField.getValue()}if(null!==recordGridFilterParams["record.title"]){recordGridFilterParams["record.title"]=filterRecordField.getValue()}if(null!==recordGridFilterParams["record.recordCommunicateType"]){recordGridFilterParams["record.recordCommunicateType"]=filterRecordField.getValue()}if(null!==recordGridFilterParams["record.recordContent"]){recordGridFilterParams["record.recordContent"]=filterRecordField.getValue()}recordstore.baseParams=recordGridFilterParams;recordstore.setDefaultSort("recordID","DESC");recordstore.load({params:{start:0,limit:recordPageSizePlugin.getPageSize()}})}});var clearRecordButton=new Ext.Button({iconCls:"icon-clear",tooltip:"清空",handler:function(){filterCustomerField.reset();recordstore.baseParams={};recordstore.load({params:{start:0,limit:recordPageSizePlugin.getPageSize()}})}});var updateContactRecordGrid=function(){var record=recordgridsm.getSelected();if(record){updateContactRecordView(record.data.recordID,record.data.contactID,record.data.contactName)}};var insertContactRecordGrid=function(){var record=recordgridsm.getSelected();if(record){insertContactRecordView(record.data.contactID,record.data.contactName)}};var removeContactRecordGrid=function(){var record=recordgridsm.getSelected();if(record){removeContactRecordView(record.data.recordID)}};var recordgridsm=new Ext.grid.RowSelectionModel({singleSelect:true});var recordPageSizePlugin=new Ext.ux.Andrie.pPageSize();var recordgrid=new Ext.grid.GridPanel({border:false,viewConfig:{forceFit:true},store:recordstore,cm:recordcm,sm:recordgridsm,plugins:recordExpander,loadMask:true,bbar:new Ext.PagingToolbar({plugins:recordPageSizePlugin,pageSize:20,store:recordstore,displayInfo:true,displayMsg:"显示 {0} - {1} 共{2}",emptyMsg:"",items:["-",{text:"查询范围",menu:recordGridFilterMenu},filterRecordField,filterRecordButton,clearRecordButton,"-",{tooltip:"新建联系记录",iconCls:"icon-comment-add",handler:insertContactRecordGrid},{tooltip:"编辑联系记录",iconCls:"icon-comment-edit",handler:updateContactRecordGrid},{tooltip:"删除联系记录",iconCls:"icon-comment-remove",handler:removeContactRecordGrid}]})});recordgrid.on("render",function(){recordstore.load({params:{start:0,limit:recordPageSizePlugin.getPageSize()}})});var gmenu;recordgrid.on("rowcontextmenu",function(recordgrid,rowindex,e){recordgrid.getSelectionModel().selectRow(rowindex,false);if(!gmenu){gmenu=new Ext.menu.Menu([{id:"addContactRecordGridContextView",text:"添加联系记录",handler:insertContactRecordGrid},{id:"updateContactRecordGridContextView",text:"编辑联系记录",handler:updateContactRecordGrid},"-",{id:"removeContactRecordGridContextView",text:"删除联系记录",handler:removeContactRecordGrid}])}gmenu.showAt(e.getPoint());e.stopEvent()});recordgrid.on("rowdblclick",updateContactRecordGrid);var main=new Ext.TabPanel({id:"contact-owner-body",region:"center",margins:"0 0 0 0",resizeTabs:true,minTabWidth:135,tabWidth:160,plugins:new Ext.ux.TabCloseMenu(),enableTabScroll:true,border:true,activeTab:0,autoDestroy:true,items:[{id:"contact-owner-customer",closable:false,title:"我的客户",autoScroll:true,layout:"fit",items:customergrid,iconCls:"icon-customer"},{id:"contact-owner-contact",closable:false,title:"我的联系人",autoScroll:true,layout:"fit",items:grid,iconCls:"icon-contact"},{id:"contact-owner-record",closable:false,title:"我的联系记录",autoScroll:true,layout:"fit",items:recordgrid,iconCls:"icon-comments"}]});groupTree.on("click",function(node,e){if(!node.isSelected()){node.select()}if(true!==node.isLeaf()){store.baseParams={"contact.groupID":node.id.substring(node.id.lastIndexOf("-")+1)};store.setDefaultSort("id","desc");store.load({params:{start:0,limit:25}});main.setActiveTab(main.getComponent("contact-owner-contact"))}else{recordstore.baseParams={"record.contactID":node.id.substring(node.id.lastIndexOf("-")+1)};recordstore.setDefaultSort("recordID","desc");recordstore.load({params:{start:0,limit:recordPageSizePlugin.getPageSize()}});main.setActiveTab(main.getComponent("contact-owner-record"))}});groupTree.on("dblclick",function(node,e){if(!node.isSelected()){node.select()}node=sm.getSelectedNode();if(node.isLeaf()){e.stopEvent();updateContactView(node.id.substring(node.id.lastIndexOf("-")+1),node.text)}else{if(0<=node.isCustomer()){e.stopEvent();updateCustomerView(node.id.substring(node.id.lastIndexOf("-")+1),node.text)}else{e.stopEvent();updateGroupView(node.id.substring(node.id.lastIndexOf("-")+1),node.text)}}});var sm=groupTree.getSelectionModel();var cmenu;groupTree.on("contextMenu",function(n,e){e.stopEvent();if(!n.isSelected()){n.select()}if(!cmenu){cmenu=new Ext.menu.Menu([{id:"expandContacttreeItem",text:"展开",handler:expandNode},{id:"collapseContacttreeItem",text:"折叠",handler:collapseNode},"-",{id:"reloadContacttreeNode",text:"刷新",handler:reloadNode},"-",{text:"新建",id:"createInContacttree",menu:{items:[{id:"addContactGroupView",iconCls:"icon-group-add",text:"目录",handler:function(){var node=sm.getSelectedNode();if(node){insertGroupView(node.id.substring(node.id.lastIndexOf("-")+1))}}},{id:"addCustomerView",iconCls:"icon-customer",text:"客户",handler:function(){var node=sm.getSelectedNode();if(node){insertCustomerView(node.id.substring(node.id.lastIndexOf("-")+1))}}},{id:"addContactView",iconCls:"icon-contact-add",text:"联系人",handler:function(){var node=sm.getSelectedNode();if(node){insertContactView(node.id.substring(node.id.lastIndexOf("-")+1))}}}]}},{id:"addContactRecordView",text:"添加联系记录",handler:function(){var node=sm.getSelectedNode();if(node){insertContactRecordView(node.id.substring(node.id.lastIndexOf("-")+1),node.text)}}},{id:"updateContacttreeItem",text:"修改",handler:updateNode},"-",{id:"deleteContacttreeItem",text:"删除",handler:deleteNode}])}var is=cmenu.items;if(n.isLeaf()){is.get("createInContacttree").hide();is.get("addContactRecordView").show();is.get("reloadContacttreeNode").setDisabled(true);is.get("expandContacttreeItem").setDisabled(true);is.get("collapseContacttreeItem").setDisabled(true)}else{is.get("createInContacttree").show();is.get("addContactRecordView").hide();is.get("reloadContacttreeNode").setDisabled(false);is.get("expandContacttreeItem").setDisabled(n.isExpanded());is.get("collapseContacttreeItem").setDisabled(!n.isExpanded())}cmenu.showAt(e.getPoint())});groupTree.on("movenode",function(groupTree,node,oldParent,newParent,index){if(node){if(node.isLeaf()){moveContact(groupTree,node,oldParent,newParent,index)}else{moveGroup(groupTree,node,oldParent,newParent,index)}}});function reloadNode(){var node=sm.getSelectedNode();if(node){node.reload()}else{groupTree.getRootNode().reload();sm.select(groupTree.getRootNode())}}function expandNode(){var node=sm.getSelectedNode();if(node){node.expand()}else{groupTree.getRootNode().expand();sm.select(groupTree.getRootNode())}}function collapseNode(){var node=sm.getSelectedNode();if(node){node.collapse()}else{groupTree.getRootNode().collapse();sm.select(groupTree.getRootNode())}}function insertContactView(id){var tabID=Ext.id();var temp=new Ext.Panel({id:tabID,iconCls:"icon-contact",autoScroll:true,title:"添加联系人",closable:true});temp.on("render",function(){temp.load({scripts:true,method:"post",params:{"group.groupID":id,containerID:temp.body.id},url:"customer/insertContactView.action"})});var p=main.add(temp);main.setActiveTab(p)}function updateContactView(id,title){var tabID=main.id+"-contact-"+id;var tab=main.getComponent(tabID);if(tab){tab.body.getUpdater().update({scripts:true,method:"post",params:{"contact.id":id,containerID:tab.body.id},url:"customer/updateContactView.action"});main.setActiveTab(tab)}else{var temp=new Ext.Panel({id:tabID,autoScroll:true,iconCls:"icon-contact",title:title,closable:true});temp.on("render",function(){temp.load({scripts:true,method:"post",params:{"contact.id":id,containerID:temp.body.id},url:"customer/updateContactView.action"})});var p=main.add(temp);main.setActiveTab(p)}}var removeContactView=function(id,title){Ext.MessageBox.confirm("删除联系人","您确定要删除该联系人 <b>"+title+"</b>?",function(btn){if(btn=="yes"){Ext.Ajax.request({url:"customer/removeContact.action",params:{"contact.id":id},success:function(response){var j=Ext.decode(response.responseText);if(j.success===true){var tabID=main.id+"-contact-"+id;var tab=main.getComponent(tabID);if(tab){main.remove(tab,true)}store.reload();var n=groupTree.getNodeById("contact-"+id);if(n){n.remove()}}}})}})};var deliverContactView=function(id){Ext.Ajax.request({url:"customer/deliverContactView.action",params:{"contact.id":id},success:function(response){eval(response.responseText)}})};var insertCustomerView=function(id){var tabID=Ext.id();var temp=new Ext.Panel({id:tabID,iconCls:"icon-customer",autoScroll:true,title:"添加客户",closable:true});temp.on("render",function(){temp.load({scripts:true,method:"post",params:{"group.groupID":id,containerID:temp.body.id},url:"customer/insertCustomerView.action"})});var p=main.add(temp);main.setActiveTab(p)};var updateCustomerView=function(id,tt){var tabID=main.id+"-customer-"+id;var tab=main.getComponent(tabID);if(tab){tab.body.getUpdater().update({scripts:true,method:"post",params:{"customer.groupID":id,containerID:tab.body.id,parentName:tt},url:"customer/updateCustomerView.action"});main.setActiveTab(tab)}else{var temp=new Ext.Panel({id:tabID,autoScroll:true,iconCls:"icon-customer",title:tt,closable:true});temp.on("render",function(){temp.load({scripts:true,method:"post",params:{"customer.groupID":id,containerID:temp.body.id,parentName:tt},url:"customer/updateCustomerView.action"})});var p=main.add(temp);main.setActiveTab(p)}};var updateGroupView=function(id,tt){if(id!=="1"){Ext.Ajax.request({url:"customer/updateGroupView.action",params:{"group.groupID":id,parentName:tt},success:function(response){eval(response.responseText)}})}};var insertGroupView=function(id){Ext.Ajax.request({url:"customer/insertGroupView.action",method:"post",params:{"group.groupID":id},success:function(response){eval(response.responseText)}})};var removeGroupView=function(id,title){Ext.MessageBox.confirm("删除目录","您确定要删除目录 <b>"+title+"</b>?",function(btn){if(btn=="yes"){Ext.Ajax.request({url:"customer/removeGroupAction.action",params:{"group.groupID":id},success:function(response){var result=Ext.decode(response.responseText);if(true===result.success){var node=groupTree.getNodeById("guestGroup-"+id);if(node){node.remove()}}}})}})};var removeCustomerView=function(id,title){Ext.MessageBox.confirm("删除客户","您确定要删除客户 <b>"+title+" ?",function(btn){if(btn=="yes"){Ext.Ajax.request({url:"customer/removeCustomer.action",params:{"customer.groupID":id},success:function(response){var n=groupTree.getNodeById("guestGroup-"+id);if(n){n.remove()}customerstore.reload()}})}})};var deleteNode=function(){var node=sm.getSelectedNode();if(node){if(node.id.substring(node.id.lastIndexOf("-")+1)!=="0"){if(node.isLeaf()){removeContactView(node.id.substring(node.id.lastIndexOf("-")+1),node.text)}else{if(node.isCustomer()>=0){removeCustomerView(node.id.substring(node.id.lastIndexOf("-")+1),node.text)}else{if(node.isCustomer()<0){removeGroupView(node.id.substring(node.id.lastIndexOf("-")+1),node.text)}}}}}};var updateNode=function(){var node=sm.getSelectedNode();if(node){if(node.isLeaf()){updateContactView(node.id.substring(node.id.lastIndexOf("-")+1),node.parentNode.text)}else{if(node.isCustomer()>=0){updateCustomerView(node.id.substring(node.id.lastIndexOf("-")+1),node.parentNode.text)}else{if(node.isCustomer()<0){updateGroupView(node.id.substring(node.id.lastIndexOf("-")+1),node.parentNode.text)}}}}};var moveGroup=function(groupTree,node,oldParent,newParent,index){if(oldParent.id!=newParent.id){Ext.Ajax.request({url:"customer/moveGroupAction.action",params:{"group.groupID":node.id.substring(node.id.lastIndexOf("-")+1),"group.groupPID":newParent.id.substring(node.id.lastIndexOf("-")+1)},success:function(response){var s=Ext.decode(response.responseText);if(s.success){}}})}};var moveContact=function(groupTree,node,oldParent,newParent,index){if(oldParent.id!=newParent.id){Ext.Ajax.request({url:"customer/moveContact.action",params:{"contact.id":node.id.substring(node.id.lastIndexOf("-")+1),"contact.groupID":newParent.id.substring(newParent.id.lastIndexOf("-")+1)},success:function(response){var s=Ext.decode(response.responseText);if(s.success){var tabID=main.id+"-"+node.id;var tab=main.getComponent(tabID);if(tab){tab.body.getUpdater().update({scripts:true,method:"post",params:{"contact.id":node.id.substring(node.id.lastIndexOf("-")+1)},url:"customer/getContactByID.action"});main.setActiveTab(tab)}}}})}};var insertContactRecordView=function(id,title){var tabID=Ext.id();var temp=new Ext.Panel({id:tabID,iconCls:"icon-comment-add",autoScroll:true,title:"["+title+"]联系记录",closable:true});temp.on("render",function(){temp.load({scripts:true,method:"post",params:{"contact.id":(id)?id:1,"contact.contactName":title,containerID:temp.body.id},url:"customer/insertContactRecordView.action"})});var p=main.add(temp);main.setActiveTab(p)};var updateContactRecordView=function(id,contactID,title){var tabID=main.id+"-contactrecord-"+id;var tab=main.getComponent(tabID);if(tab){tab.body.getUpdater().update({scripts:true,method:"post",params:{"record.recordID":id,"record.contactID":contactID,containerID:tab.body.id},url:"customer/updateContactRecordView.action"});tab.setIconClass("icon-comment-edit");main.setActiveTab(tab)}else{var temp=new Ext.Panel({id:tabID,autoScroll:true,iconCls:"icon-comment-edit",title:"["+title+"]联系记录",closable:true});temp.on("render",function(){temp.load({scripts:true,method:"post",params:{"record.recordID":id,"record.contactID":contactID,containerID:temp.body.id},url:"customer/updateContactRecordView.action"})});var p=main.add(temp);main.setActiveTab(p)}};var removeContactRecordView=function(id){var record=recordgridsm.getSelected();if(record){Ext.MessageBox.confirm("删除记录","您确定要删除本条联系记录?",function(btn){if(btn=="yes"){Ext.Ajax.request({url:"customer/removeContactRecord.action",params:{"record.recordID":id},method:"post",success:function(response){var j=Ext.decode(response.responseText);if(j.success===true){var tabID=main.id+"-contactrecord-"+id;var tab=main.getComponent(tabID);main.remove(tab);recordstore.reload()}}})}})}};var contactStateView=function(){var tabID=main.id+"-contactState";var temp=main.getComponent(tabID);if(!temp){var temp=new Ext.Panel({id:tabID,iconCls:"icon-chart-pie",autoScroll:true,title:" 联系人份额统计",closable:true});temp.on("render",function(){temp.load({scripts:true,method:"post",params:{containerID:temp.body.id},url:"order/contactStatePanel.jsp"})});var p=main.add(temp);main.setActiveTab(p)}else{temp.body.getUpdater().update({scripts:true,method:"post",params:{containerID:temp.body.id},url:"order/contactStatePanel.jsp"});main.setActiveTab(temp)}};var groupStateView=function(){var tabID=main.id+"-groupState";var temp=main.getComponent(tabID);if(!temp){var temp=new Ext.Panel({id:tabID,iconCls:"icon-chart-bar",autoScroll:true,title:" 客户(分组)份额统计",closable:true});temp.on("render",function(){temp.load({scripts:true,method:"post",params:{containerID:temp.body.id},url:"order/groupStatePanel.jsp"})});var p=main.add(temp);main.setActiveTab(p)}else{temp.body.getUpdater().update({scripts:true,method:"post",params:{containerID:temp.body.id},url:"order/groupStatePanel.jsp"});main.setActiveTab(temp)}};win=desktop.createWindow({id:this.moduleId,title:"我的客户",width:winWidth,height:winHeight,x:desktop.getWinX(winWidth),y:desktop.getWinY(winHeight),iconCls:"icon-contact",shim:false,animCollapse:false,constrainHeader:true,minimizable:true,maximizable:true,border:false,layout:"border",items:[groupTree,main],tbar:["-",{text:"新建",menu:new Ext.menu.Menu({items:[{text:"新建目录",iconCls:"icon-group",handler:insertGroupView},{text:"新建客户",iconCls:"icon-customer",handler:insertCustomerView},{text:"新建联系人",iconCls:"icon-contact",handler:insertContactView}]})},"-",{text:"统计报表",menu:new Ext.menu.Menu({items:[{text:"联系人统计",iconCls:"icon-chart-pie",handler:contactStateView},{text:"客户统计",iconCls:"icon-chart-bar",handler:groupStateView}]})},"-","图例","-",{iconCls:"icon-shield-0",tooltip:"潜在客户"},{iconCls:"icon-shield-1",tooltip:"有意向客户"},{iconCls:"icon-shield-2",tooltip:"成交客户"},{iconCls:"icon-shield-3",tooltip:"失败客户"},{iconCls:"icon-shield-4",tooltip:"无状态客户"}],taskbuttonTooltip:"<b>我的客户</b><br/>我的客户资料，联系记录"})}win.show()}});Sliver.OrderAuditManager=Ext.extend(Ext.app.Module,{moduleType:"order",moduleId:"order-audit-manager",init:function(){this.launcher={handler:this.createWindow,iconCls:"icon-order-edit",scope:this,shortcutIconCls:"order-audit-shortcut",text:"订单审核",tooltip:"<b>订单审核</b><br />报价单、订单审核"}},createWindow:function(){var x=this.app.getDesktop();var p=x.getWindow(this.moduleId);if(!p){var H=x.getWinWidth()/1.1;var l=x.getWinHeight()/1.1;var v=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:"order/listAllOffer.action"}),reader:new Ext.data.JsonReader({root:"offerList",totalProperty:"total",id:"offerID",fields:["offerID","contactID","contactName","contactBusinessphone","contactFax","contactMobilephone","contactCustomer","auditID","auditName","ownerID","ownerName","offerState","offerTotal","offerPaymode","offerDescription","createDate","expiryDate"]}),remoteSort:true});v.setDefaultSort("offerID","desc");var t=new Ext.grid.RowExpander({tpl:new Ext.Template("<p><b>付款方式:</b>{offerPaymode}</p>","<p><b>备注:</b> {offerDescription}</p>")});var U=new Ext.form.ComboBox({store:new Ext.data.SimpleStore({fields:["offerStateName","offerState"],data:SliverData.offerState}),displayField:"offerStateName",valueField:"offerState",editable:false,mode:"local",triggerAction:"all",selectOnFocus:true,name:"offer.offerState"});var g=new Ext.grid.ColumnModel([t,{header:"报价单号",dataIndex:"offerID",css:"background-color:#F1F2F4;",width:30},{header:"联系人",dataIndex:"contactName",css:"background-color:#F1F2F4;",width:40},{header:"分组（客户）",dataIndex:"contactCustomer",css:"background-color:#F1F2F4;",width:80},{header:"联系人电话",dataIndex:"contactBusinessphone",css:"background-color:#F1F2F4;",width:80},{header:"传真",hidden:true,dataIndex:"contactFax",css:"background-color:#F1F2F4;",width:40},{header:"移动电话",hidden:true,dataIndex:"contactMobilephone",css:"background-color:#F1F2F4;",width:40},{header:"经办人",align:"right",dataIndex:"ownerName",css:"background-color:#F1F2F4;",width:30},{header:"状态",align:"right",dataIndex:"offerState",renderer:SliverUtil.renderOfferState,width:30,editor:U},{header:"合计金额",align:"right",dataIndex:"offerTotal",css:"background-color:#F1F2F4;",renderer:SliverUtil.cnMoney,width:60},{header:"创建日期",align:"right",css:"background-color:#F1F2F4;",dataIndex:"createDate",width:40},{header:"有效日期",align:"right",dataIndex:"expiryDate",css:"background-color:#F1F2F4;",width:40}]);g.defaultSortable=true;var E={"offer.contactName":"","offer.contactCustomer":"","offer.contactBusinessphone":"","offer.contactFax":"","offer.contactMobilephone":"","offer.ownerName":"","offer.offerState":"","offer.offerPaymode":"","offer.offerDescription":"","offer.createDate":"","offer.expiryDate":""};var L=new Ext.menu.Menu({items:[{text:"联系人",checked:true,checkHandler:function(){Q(this.checked,"offer.contactName")}},{text:"客户",checked:true,checkHandler:function(){Q(this.checked,"offer.contactCustomer")}},{text:"联系人电话",checked:true,checkHandler:function(){Q(this.checked,"offer.contactBusinessphone")}},{text:"联系人传真",checked:true,checkHandler:function(){Q(this.checked,"offer.contactFax")}},{text:"联系人手机",checked:true,checkHandler:function(){Q(this.checked,"offer.contactMobilephone")}},{text:"经办人",checked:true,checkHandler:function(){Q(this.checked,"offer.ownerName")}},{text:"付款方式",checked:true,checkHandler:function(){Q(this.checked,"offer.offerPaymode")}},{text:"创建日期",checked:true,checkHandler:function(){Q(this.checked,"offer.createDate")}},{text:"过期日期",checked:true,checkHandler:function(){Q(this.checked,"offer.expiryDate")}},{text:"备注",checked:true,checkHandler:function(){Q(this.checked,"offer.offerDescription")}}]});function Q(z,AA){if(z===true){E[AA]=""}else{E[AA]=null}}var c=new Ext.form.TextField({});var j=new Ext.Button({iconCls:"icon-search",tooltip:"开始搜索",handler:function(){if(null!==E["offer.contactName"]){E["offer.contactName"]=c.getValue()}if(null!==E["offer.contactCustomer"]){E["offer.contactCustomer"]=c.getValue()}if(null!==E["offer.contactBusinessphone"]){E["offer.contactBusinessphone"]=c.getValue()}if(null!==E["offer.contactFax"]){E["offer.contactFax"]=c.getValue()}if(null!==E["offer.contactMobilephone"]){E["offer.contactMobilephone"]=c.getValue()}if(null!==E["offer.ownerName"]){E["offer.ownerName"]=c.getValue()}if(null!==E["offer.offerPaymode"]){E["offer.offerPaymode"]=c.getValue()}if(null!==E["offer.createDate"]){E["offer.createDate"]=c.getValue()}if(null!==E["offer.expiryDate"]){E["offer.expiryDate"]=c.getValue()}if(null!==E["offer.offerDescription"]){E["offer.offerDescription"]=c.getValue()}v.baseParams=E;v.setDefaultSort("offerID","DESC");v.load({params:{start:0,limit:b.getPageSize()}})}});var Y=new Ext.Button({iconCls:"icon-clear",tooltip:"清空",handler:function(){c.reset();v.baseParams={};v.setDefaultSort("offerID","DESC");v.load({params:{start:0,limit:b.getPageSize()}})}});var h=new Ext.grid.RowSelectionModel({singleSelect:true});var b=new Ext.ux.Andrie.pPageSize();var u=new Ext.grid.EditorGridPanel({border:false,viewConfig:{forceFit:true},store:v,cm:g,sm:h,plugins:t,loadMask:true,clicksToEdit:1,bbar:new Ext.PagingToolbar({plugins:b,pageSize:20,store:v,displayInfo:true,displayMsg:"显示 {0} - {1} 共{2}",emptyMsg:"",items:["-",{text:"搜索范围",menu:L},c,j,Y,"-",{tooltip:"将选中订单导出为PDF格式",iconCls:"icon-pdf",handler:function(){var z=h.getSelected();if(z){window.open("order/exportAuditOfferPDF.action?offer.offerID="+z.data.offerID)}}},{tooltip:"将选中订单导出为xls格式",iconCls:"icon-xls",handler:function(){var z=h.getSelected();if(z){window.open("order/exportAuditOfferPDF.action?offer.offerID="+z.data.offerID+"&type=xls")}}}]})});u.on("render",function(){v.load({params:{start:0,limit:b.getPageSize()}})});u.on("beforeedit",function(z){h.selectRow(z.row)});u.on("afteredit",function(AA){var z=h.getSelected();if(z){Ext.Ajax.request({url:"order/updateOfferState.action",params:{"offer.offerID":z.data.offerID,"offer.offerState":z.data.offerState},success:function(AB){}})}});var i=function(){var AA=Ext.id();var z=new Ext.Panel({id:AA,iconCls:"icon-offer-add",autoScroll:true,title:"创建报价单",closable:true});z.on("render",function(){z.load({scripts:true,method:"post",params:{containerID:z.body.id},url:"order/insertOfferByAuditView.action"})});var AB=F.add(z);F.setActiveTab(AB)};var f=function(z){var z=h.getSelected();if(z){var AB="auditoffer-"+z.data.offerID;var AA=F.getComponent(AB);if(!AA){var AA=new Ext.Panel({id:AB,iconCls:"icon-offer",autoScroll:true,title:"报价单"+z.data.offerID,closable:true});AA.on("render",function(){AA.load({scripts:true,method:"post",params:{"offer.offerID":z.data.offerID,containerID:AA.body.id},url:"order/getOfferAuditView.action"})});var AC=F.add(AA);F.setActiveTab(AC)}else{AA.setTitle("报价单"+z.data.offerID);AA.setIconClass("icon-offer");AA.body.getUpdater().update({scripts:true,method:"post",params:{"offer.offerID":z.data.offerID,containerID:AA.body.id},url:"order/getOfferAuditView.action"});F.setActiveTab(AA)}}};var n=function(z){var z=h.getSelected();if(z){var AB="offerauditorder-"+z.data.offerID;var AA=F.getComponent(AB);if(!AA){var AA=new Ext.Panel({id:AB,iconCls:"icon-order-add",autoScroll:true,title:z.data.offerID+"转为订单",closable:true});AA.on("render",function(){AA.load({scripts:true,method:"post",params:{"offer.offerID":z.data.offerID,containerID:AA.body.id},url:"order/copyToOrderAuditView.action"})});var AC=F.add(AA);F.setActiveTab(AC)}else{title:z.data.offerID+"转为订单",AA.setIconClass("icon-order-add");AA.body.getUpdater().update({scripts:true,method:"post",params:{"offer.offerID":z.data.offerID,containerID:AA.body.id},url:"order/copyToOrderAuditView.action"});F.setActiveTab(AA)}}};var Z=function(){var z=h.getSelected();if(z){if(SliverData.offerState[3][1]===z.data.offerState){Ext.MessageBox.alert("警告","报价单["+z.data.offerID+"]已经锁定");return }var AB="auditoffer-"+z.data.offerID;var AA=F.getComponent(AB);if(!AA){var AA=new Ext.Panel({id:AB,iconCls:"icon-offer-edit",autoScroll:true,title:"报价单"+z.data.offerID,closable:true});AA.on("render",function(){AA.load({scripts:true,method:"post",params:{"offer.offerID":z.data.offerID,containerID:AA.body.id},url:"order/updateOfferByAuditView.action"})});var AC=F.add(AA);F.setActiveTab(AC)}else{AA.setTitle("报价单"+z.data.offerID);AA.setIconClass("icon-offer-edit");AA.body.getUpdater().update({scripts:true,method:"post",params:{"offer.offerID":z.data.offerID,containerID:AA.body.id},url:"order/updateOfferByAuditView.action"});F.setActiveTab(AA)}}};var W=function(){var z=h.getSelected();if(z){if(SliverData.offerState[3][1]===z.data.offerState){Ext.MessageBox.alert("警告","报价单["+z.data.offerID+"]已经锁定");return }Ext.MessageBox.confirm("删除报价单","您确定要删除选中报价单?",function(AA){if(AA=="yes"){Ext.Ajax.request({url:"order/removeOfferByAudit.action",params:{"offer.offerID":z.data.offerID,"offer.offerState":z.data.offerState},method:"post",success:function(AC){var AD=Ext.decode(AC.responseText);if(AD.success===true){var AB="auditoffer-"+z.data.offerID;v.remove(z);var AE=F.getComponent(AB);if(AE){F.remove(AE)}}}})}})}};u.on("rowdblclick",f);var I;u.on("rowcontextmenu",function(z,AA,AB){z.getSelectionModel().selectRow(AA,false);if(!I){I=new Ext.menu.Menu([{id:"addOfferContextMenu",text:"添加报价单",handler:i},{id:"copyOfferToOrderAuditContextMenu",text:"转换为订单",handler:n},{id:"updateOfferContextMenu",text:"更新报价单",handler:Z},"-",{id:"removeOfferContextMenu",text:"删除报价单",handler:W}])}I.showAt(AB.getPoint());AB.stopEvent()});var P=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:"order/listAllOrder.action"}),reader:new Ext.data.JsonReader({root:"orderList",totalProperty:"total",id:"orderID",fields:["orderID","contactID","contactName","contactBusinessphone","contactFax","contactMobilephone","contactCustomer","auditID","auditName","ownerID","ownerName","orderLevel","orderState","orderTotal","orderPaymode","orderDescription","createDate","expiryDate"]}),remoteSort:true});P.setDefaultSort("orderID","desc");var K=new Ext.grid.RowExpander({tpl:new Ext.Template("<p><b>付款方式:</b>{orderPaymode}</p>","<p><b>备注:</b> {orderDescription}</p>")});var a=new Ext.form.ComboBox({store:new Ext.data.SimpleStore({fields:["orderStateName","orderState"],data:SliverData.orderState}),displayField:"orderStateName",valueField:"orderState",editable:false,mode:"local",triggerAction:"all",selectOnFocus:true,name:"order.orderState"});var k=new Ext.grid.ColumnModel([K,{header:"订单号",dataIndex:"orderID",css:"background-color:#F1F2F4;",width:30},{header:"联系人",dataIndex:"contactName",css:"background-color:#F1F2F4;",width:40},{header:"客户",dataIndex:"contactCustomer",css:"background-color:#F1F2F4;",width:80},{header:"联系人电话",dataIndex:"contactBusinessphone",css:"background-color:#F1F2F4;",width:80},{header:"传真",hidden:true,dataIndex:"contactFax",css:"background-color:#F1F2F4;",width:40},{header:"移动电话",hidden:true,dataIndex:"contactMobilephone",css:"background-color:#F1F2F4;",width:40},{align:"right",header:"经办人",dataIndex:"ownerName",css:"background-color:#F1F2F4;",width:30},{header:"状态",align:"right",dataIndex:"orderState",renderer:SliverUtil.renderOrderState,editor:a,width:30},{header:"订单等级",align:"right",dataIndex:"orderLevel",css:"background-color:#F1F2F4;",width:40},{header:"合计金额",align:"right",dataIndex:"orderTotal",css:"background-color:#F1F2F4;",renderer:SliverUtil.cnMoney,width:60},{header:"创建日期",align:"right",dataIndex:"createDate",css:"background-color:#F1F2F4;",width:40},{header:'<font style="color:red;font-weight:bold;">交付日期</font>',align:"right",dataIndex:"expiryDate",css:"background-color:#F1F2F4;",width:40}]);k.defaultSortable=true;var r={"order.contactName":"","order.contactCustomer":"","order.contactBusinessphone":"","order.contactFax":"","order.contactMobilephone":"","order.contactAddress":"","order.contactZipcode":"","order.ownerName":"","order.orderState":"","order.orderPaymode":"","order.orderLeval":"","order.orderDescription":"","order.createDate":"","order.expiryDate":""};var J=new Ext.menu.Menu({items:[{text:"联系人",checked:true,checkHandler:function(){y(this.checked,"order.contactName")}},{text:"客户",checked:true,checkHandler:function(){y(this.checked,"order.contactCustomer")}},{text:"联系人电话",checked:true,checkHandler:function(){y(this.checked,"order.contactBusinessphone")}},{text:"联系人传真",checked:true,checkHandler:function(){y(this.checked,"order.contactFax")}},{text:"联系人手机",checked:true,checkHandler:function(){y(this.checked,"order.contactMobilephone")}},{text:"发货地址",checked:true,checkHandler:function(){y(this.checked,"order.contactAddress")}},{text:"发货地址邮编",checked:true,checkHandler:function(){y(this.checked,"offer.contactZipcode")}},{text:"订单等级",checked:true,checkHandler:function(){y(this.checked,"order.orderLevel")}},{text:"经办人",checked:true,checkHandler:function(){y(this.checked,"order.ownerName")}},{text:"付款方式",checked:true,checkHandler:function(){y(this.checked,"order.orderPaymode")}},{text:"创建日期",checked:true,checkHandler:function(){y(this.checked,"order.createDate")}},{text:"过期日期",checked:true,checkHandler:function(){y(this.checked,"order.expiryDate")}},{text:"备注",checked:true,checkHandler:function(){y(this.checked,"order.orderDescription")}}]});function y(z,AA){if(z===true){r[AA]=""}else{r[AA]=null}}var O=new Ext.form.TextField({});var d=new Ext.Button({iconCls:"icon-search",tooltip:"开始搜索",handler:function(){if(null!==r["order.contactName"]){r["order.contactName"]=O.getValue()}if(null!==r["order.contactCustomer"]){r["order.contactCustomer"]=O.getValue()}if(null!==r["order.contactBusinessphone"]){r["order.contactBusinessphone"]=O.getValue()}if(null!==r["order.contactFax"]){r["order.contactFax"]=O.getValue()}if(null!==r["order.contactMobilephone"]){r["order.contactMobilephone"]=O.getValue()}if(null!==r["order.contactAddress"]){r["order.contactAddress"]=O.getValue()}if(null!==r["order.contactZipcode"]){r["order.contactZipcode"]=O.getValue()}if(null!==r["order.ownerName"]){r["order.ownerName"]=O.getValue()}if(null!==r["order.orderState"]){r["order.orderState"]=O.getValue()}if(null!==r["order.orderPaymode"]){r["order.orderPaymode"]=O.getValue()}if(null!==r["order.orderLeval"]){r["order.orderLeval"]=O.getValue()}if(null!==r["order.createDate"]){r["order.createDate"]=O.getValue()}if(null!==r["order.expiryDate"]){r["order.expiryDate"]=O.getValue()}if(null!==r["order.orderDescription"]){r["order.orderDescription"]=O.getValue()}P.baseParams=r;P.setDefaultSort("orderID","DESC");P.load({params:{start:0,limit:B.getPageSize()}})}});var N=new Ext.Button({iconCls:"icon-clear",tooltip:"清空",handler:function(){O.reset();P.baseParams={};P.setDefaultSort("orderID","DESC");P.load({params:{start:0,limit:B.getPageSize()}})}});var G=new Ext.grid.RowSelectionModel({singleSelect:true});var B=new Ext.ux.Andrie.pPageSize();var T=new Ext.grid.EditorGridPanel({border:false,viewConfig:{forceFit:true},store:P,cm:k,sm:G,clicksToEdit:1,plugins:K,loadMask:true,bbar:new Ext.PagingToolbar({plugins:B,pageSize:20,store:P,displayInfo:true,items:["-",{text:"搜索范围",menu:J},O,d,N,"-",{tooltip:"将选中订单导出为PDF格式",iconCls:"icon-pdf",handler:function(){var z=G.getSelected();if(z){window.open("order/exportAuditOrderPDF.action?order.orderID="+z.data.orderID)}}},{tooltip:"将选中订单导出为xls格式",iconCls:"icon-xls",handler:function(){var z=G.getSelected();if(z){window.open("order/exportAuditOrderPDF.action?order.orderID="+z.data.orderID+"&type=xls")}}}]})});T.on("render",function(){P.load({params:{start:0,limit:B.getPageSize()}})});var D=function(){var AA=Ext.id();var z=new Ext.Panel({id:AA,iconCls:"icon-order-add",autoScroll:true,title:"添加订单",closable:true});z.on("render",function(){z.load({scripts:true,method:"post",params:{containerID:z.body.id},url:"order/insertOrderByAuditView.action"})});var AB=F.add(z);F.setActiveTab(AB)};var R=function(z){var z=G.getSelected();if(z){var AB="auditorder-"+z.data.orderID;var AA=F.getComponent(AB);if(!AA){var AA=new Ext.Panel({id:AB,iconCls:"icon-order",autoScroll:true,title:"订单"+z.data.orderID,closable:true});AA.on("render",function(){AA.load({scripts:true,method:"post",params:{"order.orderID":z.data.orderID,containerID:AA.body.id},url:"order/getOrderByAuditView.action"})});var AC=F.add(AA);F.setActiveTab(AC)}else{AA.setTitle("订单"+z.data.orderID);AA.setIconClass("icon-order");AA.body.getUpdater().update({scripts:true,method:"post",params:{"order.orderID":z.data.orderID,containerID:AA.body.id},url:"order/getOrderByAuditView.action"});F.setActiveTab(AA)}}};var m=function(){var z=G.getSelected();if(z){if(SliverData.offerState[3][1]===z.data.orderState){Ext.MessageBox.alert("警告","订单["+z.data.orderID+"]已经锁定");return }var AB="auditorder-"+z.data.orderID;var AA=F.getComponent(AB);if(!AA){var AA=new Ext.Panel({id:AB,iconCls:"icon-order-edit",autoScroll:true,title:"订单"+z.data.orderID,closable:true});AA.on("render",function(){AA.load({scripts:true,method:"post",params:{"order.orderID":z.data.orderID,containerID:AA.body.id},url:"order/updateOrderAuditView.action"})});var AC=F.add(AA);F.setActiveTab(AC)}else{AA.setTitle("订单"+z.data.orderID);AA.setIconClass("icon-order-edit");AA.body.getUpdater().update({scripts:true,method:"post",params:{"order.orderID":z.data.orderID,containerID:AA.body.id},url:"order/updateOrderAuditView.action"});F.setActiveTab(AA)}}};var s=function(){var z=G.getSelected();if(z){if(SliverData.offerState[3][1]===z.data.orderState){Ext.MessageBox.alert("警告","订单["+z.data.orderID+"]已经锁定");return }Ext.MessageBox.confirm("删除订单","您确定要删除选中订单?",function(AA){if(AA=="yes"){Ext.Ajax.request({url:"order/removeOrderByAudit.action",params:{"order.orderID":z.data.orderID,"order.orderState":z.data.orderState},method:"post",success:function(AC){var AD=Ext.decode(AC.responseText);if(AD.success===true){var AB="order-"+z.data.orderID;var AE=F.getComponent(AB);F.remove(AE);P.remove(z)}}})}})}};T.on("rowdblclick",R);var o;T.on("rowcontextmenu",function(AB,z,AA){AB.getSelectionModel().selectRow(z,false);if(!o){o=new Ext.menu.Menu([{id:"addOrderAuditContextMenu",text:"添加订单",handler:D},{id:"updateOrderAuditContextMenu",text:"更新订单",handler:m},"-",{id:"removeOrderAuditContextMenu",text:"删除订单",handler:s}])}o.showAt(AA.getPoint());AA.stopEvent()});T.on("beforeedit",function(z){G.selectRow(z.row)});T.on("afteredit",function(AA){var z=G.getSelected();if(z){Ext.Ajax.request({url:"order/updateOrderState.action",params:{"order.orderID":z.data.orderID,"order.orderState":z.data.orderState},success:function(AB){}})}});var q=function(){var AA=F.id+"-saleState";var z=F.getComponent(AA);if(!z){var z=new Ext.Panel({id:AA,iconCls:"icon-chart-line",autoScroll:true,title:"销售业绩",closable:true});z.on("render",function(){z.load({scripts:true,method:"post",params:{containerID:z.body.id},url:"order/allSaleStatePanel.jsp"})});var AB=F.add(z);F.setActiveTab(AB)}else{z.body.getUpdater().update({scripts:true,method:"post",params:{containerID:z.body.id},url:"order/allSaleStatePanel.jsp"});F.setActiveTab(z)}};var S=function(){var AA=F.id+"-orderState";var z=F.getComponent(AA);if(!z){var z=new Ext.Panel({id:AA,iconCls:"icon-chart-curve",autoScroll:true,title:" 业务数量",closable:true});z.on("render",function(){z.load({scripts:true,method:"post",params:{containerID:z.body.id},url:"order/allOrderStatePanel.jsp"})});var AB=F.add(z);F.setActiveTab(AB)}else{z.body.getUpdater().update({scripts:true,method:"post",params:{containerID:z.body.id},url:"order/allOrderStatePanel.jsp"});F.setActiveTab(z)}};var w=function(){var AA=F.id+"-contactState";var z=F.getComponent(AA);if(!z){var z=new Ext.Panel({id:AA,iconCls:"icon-chart-pie",autoScroll:true,title:" 联系人份额统计",closable:true});z.on("render",function(){z.load({scripts:true,method:"post",params:{containerID:z.body.id},url:"order/allContactStatePanel.jsp"})});var AB=F.add(z);F.setActiveTab(AB)}else{z.body.getUpdater().update({scripts:true,method:"post",params:{containerID:z.body.id},url:"order/allContactStatePanel.jsp"});F.setActiveTab(z)}};var C=function(){var AA=F.id+"-groupState";var z=F.getComponent(AA);if(!z){var z=new Ext.Panel({id:AA,iconCls:"icon-chart-pie",autoScroll:true,title:" 客户(分组)份额统计",closable:true});z.on("render",function(){z.load({scripts:true,method:"post",params:{containerID:z.body.id},url:"order/allGroupStatePanel.jsp"})});var AB=F.add(z);F.setActiveTab(AB)}else{z.body.getUpdater().update({scripts:true,method:"post",params:{containerID:z.body.id},url:"order/allGroupStatePanel.jsp"});F.setActiveTab(z)}};var e=function(){var AA=F.id+"-contactRank";var z=F.getComponent(AA);if(!z){var z=new Ext.Panel({id:AA,iconCls:"icon-chart-bar",autoScroll:true,title:" 联系人订单排名统计",closable:true});z.on("render",function(){z.load({scripts:true,method:"post",params:{containerID:z.body.id,moduleID:"order-manager"},url:"order/allContactRankPanel.jsp"})});var AB=F.add(z);F.setActiveTab(AB)}else{z.body.getUpdater().update({scripts:true,method:"post",params:{containerID:z.body.id,moduleID:"order-manager"},url:"order/allContactRankPanel.jsp"});F.setActiveTab(z)}};var M=function(){var AA=F.id+"-groupRank";var z=F.getComponent(AA);if(!z){var z=new Ext.Panel({id:AA,iconCls:"icon-chart-bar",autoScroll:true,title:" 客户订单排名统计",closable:true});z.on("render",function(){z.load({scripts:true,method:"post",params:{containerID:z.body.id,moduleID:"order-manager"},url:"order/allGroupRankPanel.jsp"})});var AB=F.add(z);F.setActiveTab(AB)}else{z.body.getUpdater().update({scripts:true,method:"post",params:{containerID:z.body.id,moduleID:"order-manager"},url:"order/allGroupRankPanel.jsp"});F.setActiveTab(z)}};var A=function(){var AA=F.id+"-productionSaleRank";var z=F.getComponent(AA);if(!z){var z=new Ext.Panel({id:AA,iconCls:"icon-chart-bar",autoScroll:true,title:" 产品销量排名统计",closable:true});z.on("render",function(){z.load({scripts:true,method:"post",params:{containerID:z.body.id,moduleID:"order-manager"},url:"order/allProductionSaleRankPanel.jsp"})});var AB=F.add(z);F.setActiveTab(AB)}else{z.body.getUpdater().update({scripts:true,method:"post",params:{containerID:z.body.id,moduleID:"order-manager"},url:"order/allProductionSaleRankPanel.jsp"});F.setActiveTab(z)}};var V=function(){var AA=F.id+"-productionSaleHistory";var z=F.getComponent(AA);if(!z){var z=new Ext.Panel({id:AA,iconCls:"icon-chart-curve",autoScroll:true,title:" 产品销售趋势统计",closable:true});z.on("render",function(){z.load({scripts:true,method:"post",params:{sid:Ext.id(),containerID:z.body.id,moduleID:"order-manager"},url:"order/listAllProductionSaleHistoryPanel.jsp"})});var AB=F.add(z);F.setActiveTab(AB)}else{z.body.getUpdater().update({scripts:true,method:"post",params:{sid:Ext.id(),containerID:z.body.id,moduleID:"order-manager"},url:"order/listAllProductionSaleHistoryPanel.jsp"});F.setActiveTab(z)}};var X=new Ext.menu.Menu({items:["-",{text:"销售业绩",tooltip:"销售业绩",iconCls:"icon-chart-line",handler:q},{text:"订单数量",tooltip:"订单数量",iconCls:"icon-chart-curve",handler:S},"-",{text:"产品销量",tooltip:"产品销量",iconCls:"icon-chart-bar",handler:A},{text:"产品趋势",tooltip:"产品销售趋势",iconCls:"icon-chart-curve",handler:V},"-",{text:"联系人份额",tooltip:"联系人份额统计",iconCls:"icon-chart-pie",handler:w},{text:"联系人排名",tooltip:"联系人订单金额排名",iconCls:"icon-chart-bar",handler:e},"-",{text:"客户份额",tooltip:"客户(分组)份额统计",iconCls:"icon-chart-pie",handler:C},{text:"客户排名",tooltip:"客户(分组)订单金额排名",iconCls:"icon-chart-bar",handler:M}]});var F=new Ext.TabPanel({id:"auditorder-manager-body",region:"center",margins:"0 0 0 0",resizeTabs:true,minTabWidth:135,tabWidth:160,plugins:new Ext.ux.TabCloseMenu(),enableTabScroll:true,border:true,activeTab:0,autoDestroy:true,items:[{id:"audit-offer-grid",closable:false,title:"报价单列表",autoScroll:true,layout:"fit",items:u,iconCls:"icon-grid"},{id:"audit-order-grid",closable:false,title:"订单列表",autoScroll:true,layout:"fit",items:T,iconCls:"icon-grid"}]});p=x.createWindow({id:this.moduleId,title:"报价单、订单审核",width:H,height:l,x:x.getWinX(H),y:x.getWinY(l),iconCls:"icon-order-edit",shim:false,animCollapse:false,constrainHeader:true,minimizable:true,maximizable:true,border:false,layout:"border",tbar:["-",{tooltip:"新建报价单",iconCls:"icon-offer-add",handler:i},{tooltip:"更新报价单",iconCls:"icon-offer-edit",handler:Z},{tooltip:"删除报价单",iconCls:"icon-offer-remove",handler:W},"-",{tooltip:"将报价单转为订单",iconCls:"icon-order",handler:n},"-",{tooltip:"新建订单",iconCls:"icon-order-add",handler:D},{tooltip:"更新订单",iconCls:"icon-order-edit",handler:m},{tooltip:"删除订单",iconCls:"icon-order-remove",handler:s},"-",{text:"销售报表",menu:X}],items:F,taskbuttonTooltip:"<b>订单审核</b><br />报价单、订单审核"})}p.show()}});Sliver.OrderCashedManager=Ext.extend(Ext.app.Module,{moduleType:"order",moduleId:"order-cashed-manager",init:function(){this.launcher={handler:this.createWindow,iconCls:"icon-cashed",scope:this,shortcutIconCls:"order-cahed-shortcut",text:"订单回款",tooltip:"<b>订单回款</b><br />回款管理、回款记录"}},createWindow:function(){var desktop=this.app.getDesktop();var win=desktop.getWindow(this.moduleId);if(!win){var winWidth=desktop.getWinWidth()/1.1;var winHeight=desktop.getWinHeight()/1.1;var ostore=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:"order/listAllOrder.action"}),reader:new Ext.data.JsonReader({root:"orderList",totalProperty:"total",id:"orderID",fields:["orderID","contactID","contactName","contactBusinessphone","contactFax","contactMobilephone","contactCustomer","auditID","auditName","ownerID","ownerName","orderLevel","orderState","orderTotal","orderCashed","orderPaymode","orderDescription","createDate","expiryDate"]}),remoteSort:true});var oexpander=new Ext.grid.RowExpander({tpl:new Ext.Template("<p><b>付款方式:</b>{orderPaymode}</p>","<p><b>备注:</b> {orderDescription}</p>")});var ocm=new Ext.grid.ColumnModel([oexpander,{header:"订单号",dataIndex:"orderID",width:30},{header:"联系人",dataIndex:"contactName",width:40},{header:"客户",dataIndex:"contactCustomer",width:80},{header:"联系人电话",dataIndex:"contactBusinessphone",width:80},{header:"传真",hidden:true,dataIndex:"contactFax",width:40},{header:"移动电话",hidden:true,dataIndex:"contactMobilephone",width:40},{header:"状态",hidden:true,align:"right",dataIndex:"orderState",width:30},{header:"订单等级",hidden:true,align:"right",dataIndex:"orderLevel",width:40},{align:"right",header:"经办人",dataIndex:"ownerName",width:30},{header:"合计金额",align:"right",dataIndex:"orderTotal",renderer:SliverUtil.cnMoney,width:60},{header:"回款金额",align:"right",dataIndex:"orderCashed",renderer:SliverUtil.cnMoney,width:60},{header:"创建日期",align:"right",dataIndex:"createDate",width:40},{header:"交付日期",align:"right",dataIndex:"expiryDate",width:40}]);ocm.defaultSortable=true;var orderAuditFilterParams={"order.contactName":"","order.contactCustomer":"","order.contactBusinessphone":"","order.contactFax":"","order.contactMobilephone":"","order.contactAddress":"","order.contactZipcode":"","order.ownerName":"","order.orderState":"","order.orderPaymode":"","order.orderLeval":"","order.orderDescription":"","order.createDate":"","order.expiryDate":""};var orderCashedGridFilterMenu=new Ext.menu.Menu({items:[{text:"联系人",checked:true,checkHandler:function(){operateAuditOrderParams(this.checked,"order.contactName")}},{text:"客户",checked:true,checkHandler:function(){operateAuditOrderParams(this.checked,"order.contactCustomer")}},{text:"联系人电话",checked:true,checkHandler:function(){operateAuditOrderParams(this.checked,"order.contactBusinessphone")}},{text:"联系人传真",checked:true,checkHandler:function(){operateAuditOrderParams(this.checked,"order.contactFax")}},{text:"联系人手机",checked:true,checkHandler:function(){operateAuditOrderParams(this.checked,"order.contactMobilephone")}},{text:"发货地址",checked:true,checkHandler:function(){operateAuditOrderParams(this.checked,"order.contactAddress")}},{text:"发货地址邮编",checked:true,checkHandler:function(){operateAuditOrderParams(this.checked,"offer.contactZipcode")}},{text:"订单等级",checked:true,checkHandler:function(){operateAuditOrderParams(this.checked,"order.orderLevel")}},{text:"经办人",checked:true,checkHandler:function(){operateAuditOrderParams(this.checked,"order.ownerName")}},{text:"付款方式",checked:true,checkHandler:function(){operateAuditOrderParams(this.checked,"order.orderPaymode")}},{text:"创建日期",checked:true,checkHandler:function(){operateAuditOrderParams(this.checked,"order.createDate")}},{text:"过期日期",checked:true,checkHandler:function(){operateAuditOrderParams(this.checked,"order.expiryDate")}},{text:"备注",checked:true,checkHandler:function(){operateAuditOrderParams(this.checked,"order.orderDescription")}}]});function operateAuditOrderParams(status,name){if(status===true){orderAuditFilterParams[name]=""}else{orderAuditFilterParams[name]=null}}var ofilterField=new Ext.form.TextField({});var ofilterButton=new Ext.Button({iconCls:"icon-search",tooltip:"开始搜索",handler:function(){if(null!==orderAuditFilterParams["order.contactName"]){orderAuditFilterParams["order.contactName"]=ofilterField.getValue()}if(null!==orderAuditFilterParams["order.contactCustomer"]){orderAuditFilterParams["order.contactCustomer"]=ofilterField.getValue()}if(null!==orderAuditFilterParams["order.contactBusinessphone"]){orderAuditFilterParams["order.contactBusinessphone"]=ofilterField.getValue()}if(null!==orderAuditFilterParams["order.contactFax"]){orderAuditFilterParams["order.contactFax"]=ofilterField.getValue()}if(null!==orderAuditFilterParams["order.contactMobilephone"]){orderAuditFilterParams["order.contactMobilephone"]=ofilterField.getValue()}if(null!==orderAuditFilterParams["order.contactAddress"]){orderAuditFilterParams["order.contactAddress"]=ofilterField.getValue()}if(null!==orderAuditFilterParams["order.contactZipcode"]){orderAuditFilterParams["order.contactZipcode"]=ofilterField.getValue()}if(null!==orderAuditFilterParams["order.ownerName"]){orderAuditFilterParams["order.ownerName"]=ofilterField.getValue()}if(null!==orderAuditFilterParams["order.orderState"]){orderAuditFilterParams["order.orderState"]=ofilterField.getValue()}if(null!==orderAuditFilterParams["order.orderPaymode"]){orderAuditFilterParams["order.orderPaymode"]=ofilterField.getValue()}if(null!==orderAuditFilterParams["order.orderLeval"]){orderAuditFilterParams["order.orderLeval"]=ofilterField.getValue()}if(null!==orderAuditFilterParams["order.createDate"]){orderAuditFilterParams["order.createDate"]=ofilterField.getValue()}if(null!==orderAuditFilterParams["order.expiryDate"]){orderAuditFilterParams["order.expiryDate"]=ofilterField.getValue()}if(null!==orderAuditFilterParams["order.orderDescription"]){orderAuditFilterParams["order.orderDescription"]=ofilterField.getValue()}ostore.baseParams=orderAuditFilterParams;ostore.setDefaultSort("orderID","DESC");ostore.load({params:{start:0,limit:pageSizePlugin.getPageSize()}})}});var oclearButton=new Ext.Button({iconCls:"icon-clear",tooltip:"清空",handler:function(){ofilterField.reset();ostore.baseParams={};ostore.setDefaultSort("orderID","DESC");ostore.load({params:{start:0,limit:pageSizePlugin.getPageSize()}})}});ostore.setDefaultSort("orderID","desc");var ogridsm=new Ext.grid.RowSelectionModel({singleSelect:true});var pageSizePlugin=new Ext.ux.Andrie.pPageSize();var ogrid=new Ext.grid.GridPanel({border:false,viewConfig:{forceFit:true},store:ostore,cm:ocm,sm:ogridsm,plugins:oexpander,loadMask:true,bbar:new Ext.PagingToolbar({plugins:pageSizePlugin,pageSize:20,store:ostore,displayInfo:true,items:["-",{text:"搜索范围",menu:orderCashedGridFilterMenu},ofilterField,ofilterButton,oclearButton]})});ogrid.on("render",function(){ostore.load({params:{start:0,limit:pageSizePlugin.getPageSize()}})});var getOrderByAuditView=function(record){var record=ogridsm.getSelected();if(record){var tabID="auditorder-"+record.data.orderID;var temp=main.getComponent(tabID);if(!temp){var temp=new Ext.Panel({id:tabID,iconCls:"icon-order",autoScroll:true,title:"订单"+record.data.orderID,closable:true});temp.on("render",function(){temp.load({scripts:true,method:"post",params:{"order.orderID":record.data.orderID,containerID:temp.body.id},url:"order/getOrderByAuditView.action"})});var p=main.add(temp);main.setActiveTab(p)}else{temp.setTitle("订单"+record.data.orderID);temp.setIconClass("icon-order");temp.body.getUpdater().update({scripts:true,method:"post",params:{"order.orderID":record.data.orderID,containerID:temp.body.id},url:"order/getOrderByAuditView.action"});main.setActiveTab(temp)}}};ogrid.on("rowdblclick",getOrderByAuditView);var orderCashedContextMenu;ogrid.on("rowcontextmenu",function(ogrid,rowindex,e){ogrid.getSelectionModel().selectRow(rowindex,false);if(!orderCashedContextMenu){orderCashedContextMenu=new Ext.menu.Menu([{id:"addOrderCashedContextMenuItem",text:"添加订单回款",handler:insertCashedOrderView},{id:"listOrderCashContextMenuItem",text:"查看订单回款",handler:listCashedByOrderID}])}orderCashedContextMenu.showAt(e.getPoint());e.stopEvent()});var insertCashedOrderView=function(){var record=ogridsm.getSelected();if(record){Ext.Ajax.request({url:"cashed/insertCashedView.action",method:"post",params:{"order.orderID":record.data.orderID},success:function(response){eval(response.responseText)}})}};var listCashedByOrderID=function(){Ext.Ajax.request({url:"cashed/listCashedView.jsp",method:"post",success:function(response){eval(response.responseText)}})};var cashed_store=new Ext.data.GroupingStore({reader:new Ext.data.JsonReader({root:"cashedList",totalProperty:"total",id:"orderCashedID",fields:["orderID","orderCashedID","orderCashedAmount","orderCashedDate","orderCashedDescription"]}),url:"cashed/listAllCashed.action",sortInfo:{field:"orderID",direction:"DESC"},groupField:"orderID",remoteSort:true});cashed_store.load({params:{start:0,limit:25,sort:"orderID",dir:"DESC"}});var cashed_columns=new Ext.grid.ColumnModel([{header:"订单号",dataIndex:"orderID",width:40},{header:"回款序号",dataIndex:"orderCashedID",width:40},{header:"回款日期",align:"right",dataIndex:"orderCashedDate",width:60},{header:"回款金额",align:"right",renderer:SliverUtil.cnMoney,dataIndex:"orderCashedAmount",width:60},{header:"备注",dataIndex:"orderCashedDescription",width:200}]);cashed_columns.defaultSortable=true;var cashed_sm=new Ext.grid.RowSelectionModel({singleSelect:true});var filterOrderID=function(){cashed_store.setDefaultSort("orderID","DESC");cashed_store.baseParams={"orderCashed.orderID":orderIDField.getValue()};cashed_store.load({params:{start:0,limit:cashedPageSizePlugin.getPageSize()}})};var orderIDField=new Ext.form.NumberField();var orderIDButton=new Ext.Button({iconCls:"icon-search",handler:filterOrderID});var orderIDCleaner=new Ext.Button({iconCls:"icon-clear",handler:function(){orderIDField.reset();cashed_store.baseParams={};cashed_store.load({params:{start:0,limit:cashedPageSizePlugin.getPageSize()}})}});var filterOrderCashedID=function(){cashed_store.setDefaultSort("orderID","DESC");cashed_store.baseParams={"orderCashed.orderCashedID":orderCashedIDField.getValue()};cashed_store.load({params:{start:0,limit:cashedPageSizePlugin.getPageSize()}})};var orderCashedIDField=new Ext.form.NumberField();var orderCashedIDButton=new Ext.Button({iconCls:"icon-search",handler:filterOrderCashedID});var orderCashedIDCleaner=new Ext.Button({iconCls:"icon-clear",handler:function(){orderCashedIDField.reset();cashed_store.baseParams={};cashed_store.load({params:{start:0,limit:cashedPageSizePlugin.getPageSize()}})}});var cashedPageSizePlugin=new Ext.ux.Andrie.pPageSize();var cashed_grid=new Ext.grid.GridPanel({border:false,viewConfig:{forceFit:true},store:cashed_store,cm:cashed_columns,sm:cashed_sm,view:new Ext.grid.GroupingView({forceFit:true,groupTextTpl:"{text} (回款数量：{[values.rs.length]})"}),loadMask:true,bbar:new Ext.PagingToolbar({plugins:cashedPageSizePlugin,pageSize:20,store:cashed_store,displayInfo:true,items:["-","订单编号：",orderIDField,orderIDButton,orderIDCleaner,"-","回款编号：",orderCashedIDField,orderCashedIDButton,orderCashedIDCleaner]})});cashed_grid.on("render",function(){cashed_store.load({params:{start:0,limit:cashedPageSizePlugin.getPageSize()}})});var cashedContextMenu;cashed_grid.on("rowcontextmenu",function(ogrid,rowindex,e){cashed_grid.getSelectionModel().selectRow(rowindex,false);if(!cashedContextMenu){cashedContextMenu=new Ext.menu.Menu([{id:"addCashedContextMenuItem",text:"添加回款记录",handler:insertCashedView},{id:"updateCashedContextMenuItem",text:"更新回款记录",handler:updateCashedView},{id:"removeCashedContextMenuItem",text:"删除回款记录",handler:removeCashedView}])}cashedContextMenu.showAt(e.getPoint());e.stopEvent()});var insertCashedView=function(){var record=cashed_sm.getSelected();if(record){Ext.Ajax.request({url:"cashed/insertCashedView.action",method:"post",params:{"order.orderID":record.data.orderID},success:function(response){eval(response.responseText)}})}};var updateCashedView=function(){var record=cashed_sm.getSelected();if(record){Ext.Ajax.request({url:"cashed/updateCashedView.action",method:"post",params:{"orderCashed.orderCashedID":record.data.orderCashedID,"order.orderID":record.data.orderID},success:function(response){eval(response.responseText)}})}};var removeCashedView=function(){var record=cashed_sm.getSelected();if(record){Ext.MessageBox.confirm("删除回款记录","您确定要删除回款记录?",function(btn){if(btn=="yes"){Ext.Ajax.request({url:"cashed/removeCashed.action",method:"post",params:{"orderCashed.orderCashedID":record.data.orderCashedID,"order.orderID":record.data.orderID},success:function(response){var j=Ext.decode(response.responseText);if(true===j.success){cashed_store.remove(record)}}})}})}};var centerID=Ext.id();var center=new Ext.Panel({id:centerID,border:true,region:"center",autoScroll:true});center.on("render",function(){center.load({scripts:true,method:"post",params:{containerID:centerID,width:600,height:300,"order.createDate":Ext.util.Format.date(new Date(Date.parse("01/01/"+new Date().getFullYear())),"Y-m-d"),"order.expiryDate":Ext.util.Format.date(new Date(Date.parse("12/31/"+new Date().getFullYear())),"Y-m-d")},url:"order/allSaleStateInformation.jsp"})});var west=new Ext.grid.PropertyGrid({border:true,region:"west",split:true,collapseMode:"mini",autoScroll:true,collapsible:true,width:225,minSize:175,maxSize:400,layout:"fit",source:{"起始日期":new Date(Date.parse("01/01/"+new Date().getFullYear())),"终止日期":new Date(Date.parse("12/31/"+new Date().getFullYear())),"报表高度":300,"报表宽度":600},bbar:["-",{tooltip:"刷新报表",iconCls:"icon-reload",handler:function(){var ps=west.getStore();center.body.getUpdater().update({scripts:true,method:"post",params:{containerID:centerID,width:ps.getById("报表宽度").data.value,height:ps.getById("报表高度").data.value,"order.createDate":Ext.util.Format.date(ps.getById("起始日期").data.value,"Y-m-d"),"order.expiryDate":Ext.util.Format.date(ps.getById("终止日期").data.value,"Y-m-d")},url:"order/allSaleStateInformation.jsp"})}},"-",{tooltip:"导出到PDF",iconCls:"icon-pdf",handler:function(){window.open("order/allSaleStateReport.action?order.createDate="+Ext.util.Format.date(west.getStore().getById("起始日期").data.value,"Y-m-d")+"&order.expiryDate="+Ext.util.Format.date(west.getStore().getById("终止日期").data.value,"Y-m-d"))}}]});var content=new Ext.Panel({title:"回款统计",iconCls:"icon-chart-line",border:false,buttonAlign:"right",viewConfig:{forceFit:true},layout:"border",items:[center,west]});var main=new Ext.TabPanel({id:"order-cashed-manager-body",region:"center",margins:"0 0 0 0",resizeTabs:true,minTabWidth:135,tabWidth:160,plugins:new Ext.ux.TabCloseMenu(),enableTabScroll:true,border:true,activeTab:0,autoDestroy:true,items:[content,{id:"order-cashed-grid",closable:false,title:"订单列表",autoScroll:true,layout:"fit",items:ogrid,iconCls:"icon-order"},{id:"order-cashedlist-grid",closable:false,title:"回款记录",autoScroll:true,layout:"fit",items:cashed_grid,iconCls:"icon-cashed"}]});win=desktop.createWindow({id:this.moduleId,title:"订单回款",width:winWidth,height:winHeight,x:desktop.getWinX(winWidth),y:desktop.getWinY(winHeight),iconCls:"icon-cashed",shim:false,animCollapse:false,constrainHeader:true,minimizable:true,maximizable:true,border:false,layout:"border",items:main,taskbuttonTooltip:"<b>订单回款</b><br />回款管理、回款记录"})}win.show()}});Sliver.OrderManager=Ext.extend(Ext.app.Module,{moduleType:"order",moduleId:"order-manager",init:function(){this.launcher={handler:this.createWindow,iconCls:"icon-order",scope:this,shortcutIconCls:"order-manager-shortcut",text:"我的订单",tooltip:"<b>我的报价单、订单</b><br />我的订单"}},createWindow:function(){var v=this.app.getDesktop();var o=v.getWindow(this.moduleId);if(!o){var J=v.getWinWidth()/1.1;var l=v.getWinHeight()/1.1;var G=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:"order/listOffer.action"}),reader:new Ext.data.JsonReader({root:"offerList",totalProperty:"total",id:"offerID",fields:["offerID","contactID","contactName","contactBusinessphone","contactFax","contactMobilephone","contactCustomer","auditID","auditName","ownerID","ownerName","offerState","offerTotal","offerPaymode","offerDescription","createDate","expiryDate"]}),remoteSort:true});G.setDefaultSort("offerID","desc");var r=new Ext.grid.RowExpander({tpl:new Ext.Template("<p><b>付款方式:</b>{offerPaymode}</p>","<p><b>备注:</b> {offerDescription}</p>")});var d=new Ext.grid.ColumnModel([r,{header:"报价单号",dataIndex:"offerID",width:30},{header:"联系人",dataIndex:"contactName",width:50},{header:"客户",dataIndex:"contactCustomer",width:80},{header:"联系人电话",dataIndex:"contactBusinessphone",width:80},{header:"传真",hidden:true,dataIndex:"contactFax",width:40},{header:"移动电话",hidden:true,dataIndex:"contactMobilephone",width:40},{header:"状态",align:"right",renderer:SliverUtil.renderOfferState,dataIndex:"offerState",width:30},{align:"right",header:"审核人",dataIndex:"auditName",width:30},{header:"合计金额",align:"right",dataIndex:"offerTotal",renderer:SliverUtil.cnMoney,width:60},{header:"创建日期",align:"right",dataIndex:"createDate",width:40},{header:"有效日期",align:"right",dataIndex:"expiryDate",width:40}]);d.defaultSortable=true;var g={"offer.contactName":"","offer.contactCustomer":"","offer.contactBusinessphone":"","offer.contactFax":"","offer.contactMobilephone":"","offer.auditName":"","offer.offerState":"","offer.offerPaymode":"","offer.offerDescription":"","offer.createDate":"","offer.expiryDate":""};var e=new Ext.menu.Menu({items:[{text:"联系人",checked:true,checkHandler:function(){D(this.checked,"offer.contactName")}},{text:"客户",checked:true,checkHandler:function(){D(this.checked,"offer.contactCustomer")}},{text:"联系人电话",checked:true,checkHandler:function(){D(this.checked,"offer.contactBusinessphone")}},{text:"联系人传真",checked:true,checkHandler:function(){D(this.checked,"offer.contactFax")}},{text:"联系人手机",checked:true,checkHandler:function(){D(this.checked,"offer.contactMobilephone")}},{text:"审核帐户",checked:true,checkHandler:function(){D(this.checked,"offer.auditName")}},{text:"付款方式",checked:true,checkHandler:function(){D(this.checked,"offer.offerPaymode")}},{text:"创建日期",checked:true,checkHandler:function(){D(this.checked,"offer.createDate")}},{text:"过期日期",checked:true,checkHandler:function(){D(this.checked,"offer.expiryDate")}},{text:"备注",checked:true,checkHandler:function(){D(this.checked,"offer.offerDescription")}}]});function D(x,y){if(x===true){g[y]=""}else{g[y]=null}}var a=new Ext.form.TextField({});var j=new Ext.Button({iconCls:"icon-search",tooltip:"开始搜索",handler:function(){if(null!==g["offer.contactName"]){g["offer.contactName"]=a.getValue()}if(null!==g["offer.contactCustomer"]){g["offer.contactCustomer"]=a.getValue()}if(null!==g["offer.contactBusinessphone"]){g["offer.contactBusinessphone"]=a.getValue()}if(null!==g["offer.contactFax"]){g["offer.contactFax"]=a.getValue()}if(null!==g["offer.contactMobilephone"]){g["offer.contactMobilephone"]=a.getValue()}if(null!==g["offer.auditName"]){g["offer.auditName"]=a.getValue()}if(null!==g["offer.offerPaymode"]){g["offer.offerPaymode"]=a.getValue()}if(null!==g["offer.createDate"]){g["offer.createDate"]=a.getValue()}if(null!==g["offer.expiryDate"]){g["offer.expiryDate"]=a.getValue()}if(null!==g["offer.offerDescription"]){g["offer.offerDescription"]=a.getValue()}G.baseParams=g;G.setDefaultSort("offerID","DESC");G.load({params:{start:0,limit:Z.getPageSize()}})}});var Y=new Ext.Button({iconCls:"icon-clear",tooltip:"清空",handler:function(){a.reset();G.baseParams={};G.setDefaultSort("offerID","DESC");G.load({params:{start:0,limit:Z.getPageSize()}})}});var p=new Ext.grid.RowSelectionModel({singleSelect:true});var Z=new Ext.ux.Andrie.pPageSize();var n=new Ext.grid.GridPanel({border:false,viewConfig:{forceFit:true},store:G,cm:d,sm:p,plugins:r,loadMask:true,bbar:new Ext.PagingToolbar({plugins:Z,pageSize:20,store:G,displayInfo:true,displayMsg:"显示 {0} - {1} 共{2}",emptyMsg:"",items:["-",{text:"搜索范围",menu:e},a,j,Y,"-",{tooltip:"将选中订单导出为PDF格式",iconCls:"icon-pdf",handler:function(){var x=p.getSelected();if(x){window.open("order/exportOfferPDF.action?offer.offerID="+x.data.offerID)}}},{tooltip:"将选中订单导出为xls格式",iconCls:"icon-xls",handler:function(){var x=p.getSelected();if(x){window.open("order/exportOfferPDF.action?offer.offerID="+x.data.offerID+"&type=xls")}}}]})});n.on("render",function(){G.load({params:{start:0,limit:Z.getPageSize()}})});var L=function(){var y=Ext.id();var x=new Ext.Panel({id:y,iconCls:"icon-offer-add",autoScroll:true,title:"创建报价单",closable:true});x.on("render",function(){x.load({scripts:true,method:"post",params:{containerID:x.body.id},url:"order/insertOfferView.action"})});var z=H.add(x);H.setActiveTab(z)};var X=function(x){var x=p.getSelected();if(x){var z="offer-"+x.data.offerID;var y=H.getComponent(z);if(!y){var y=new Ext.Panel({id:z,iconCls:"icon-offer",autoScroll:true,title:"报价单"+x.data.offerID,closable:true});y.on("render",function(){y.load({scripts:true,method:"post",params:{"offer.offerID":x.data.offerID,containerID:y.body.id},url:"order/getOfferView.action"})});var AA=H.add(y);H.setActiveTab(AA)}else{y.setTitle("报价单"+x.data.offerID);y.setIconClass("icon-offer");y.body.getUpdater().update({scripts:true,method:"post",params:{"offer.offerID":x.data.offerID,containerID:y.body.id},url:"order/getOfferView.action"});H.setActiveTab(y)}}};var h=function(x){var x=p.getSelected();if(x){var z="offerorder-"+x.data.offerID;var y=H.getComponent(z);if(!y){var y=new Ext.Panel({id:z,iconCls:"icon-order-add",autoScroll:true,title:x.data.offerID+"转为订单",closable:true});y.on("render",function(){y.load({scripts:true,method:"post",params:{"offer.offerID":x.data.offerID,containerID:y.body.id},url:"order/copyToOrderView.action"})});var AA=H.add(y);H.setActiveTab(AA)}else{title:x.data.offerID+"转为订单",y.setIconClass("icon-order-add");y.body.getUpdater().update({scripts:true,method:"post",params:{"offer.offerID":x.data.offerID,containerID:y.body.id},url:"order/copyToOrderView.action"});H.setActiveTab(y)}}};var w=function(){var x=p.getSelected();if(x){if(SliverData.offerState[3][1]===x.data.offerState){Ext.MessageBox.alert("警告","报价单["+x.data.offerID+"]已经锁定");return }var z="offer-"+x.data.offerID;var y=H.getComponent(z);if(!y){var y=new Ext.Panel({id:z,iconCls:"icon-offer-edit",autoScroll:true,title:"报价单"+x.data.offerID,closable:true});y.on("render",function(){y.load({scripts:true,method:"post",params:{"offer.offerID":x.data.offerID,containerID:y.body.id},url:"order/updateOfferView.action"})});var AA=H.add(y);H.setActiveTab(AA)}else{y.setTitle("报价单"+x.data.offerID);y.setIconClass("icon-offer-edit");y.body.getUpdater().update({scripts:true,method:"post",params:{"offer.offerID":x.data.offerID,containerID:y.body.id},url:"order/updateOfferView.action"});H.setActiveTab(y)}}};var f=function(){var x=p.getSelected();if(x){if(SliverData.offerState[3][1]===x.data.offerState){Ext.MessageBox.alert("警告","报价单["+x.data.offerID+"]已经锁定");return }Ext.MessageBox.confirm("删除报价单","您确定要删除选中报价单?",function(y){if(y=="yes"){Ext.Ajax.request({url:"order/removeOffer.action",params:{"offer.offerID":x.data.offerID,"offer.offerState":x.data.offerState},method:"post",success:function(AA){var AB=Ext.decode(AA.responseText);if(AB.success===true){var z="offer-"+x.data.offerID;var AC=H.getComponent(z);H.remove(AC);G.remove(x)}}})}})}};n.on("rowdblclick",X);var K;n.on("rowcontextmenu",function(y,x,z){y.getSelectionModel().selectRow(x,false);if(!K){K=new Ext.menu.Menu([{id:"addOfferContextMenu",text:"添加报价单",handler:L},{id:"copyOfferToOrderContextMenu",text:"转为为订单",handler:h},{id:"updateOfferContextMenu",text:"更新报价单",handler:w},"-",{id:"removeOfferContextMenu",text:"删除报价单",handler:f}])}K.showAt(z.getPoint());z.stopEvent()});var R=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:"order/listOrder.action"}),reader:new Ext.data.JsonReader({root:"orderList",totalProperty:"total",id:"orderID",fields:["orderID","contactID","contactName","contactBusinessphone","contactFax","contactMobilephone","contactCustomer","auditID","auditName","ownerID","ownerName","orderLevel","orderState","orderTotal","orderPaymode","orderDescription","createDate","expiryDate"]}),remoteSort:true});R.setDefaultSort("orderID","desc");var M=new Ext.grid.RowExpander({tpl:new Ext.Template("<p><b>付款方式:</b>{orderPaymode}</p>","<p><b>备注:</b> {orderDescription}</p>")});var k=new Ext.grid.ColumnModel([M,{header:"订单号",dataIndex:"orderID",width:30},{header:"联系人",dataIndex:"contactName",width:50},{header:"客户",dataIndex:"contactCustomer",width:80},{header:"联系人电话",dataIndex:"contactBusinessphone",width:80},{header:"传真",hidden:true,dataIndex:"contactFax",width:40},{header:"移动电话",hidden:true,dataIndex:"contactMobilephone",width:40},{header:"状态",align:"right",renderer:SliverUtil.renderOrderState,dataIndex:"orderState",width:30},{header:"订单等级",align:"right",dataIndex:"orderLevel",width:40},{align:"right",header:"审核人",dataIndex:"auditName",width:30},{header:"合计金额",align:"right",dataIndex:"orderTotal",renderer:SliverUtil.cnMoney,width:60},{header:"创建日期",align:"right",dataIndex:"createDate",width:40},{header:'<font style="color:red;font-weight:bold;">交付日期</font>',align:"right",dataIndex:"expiryDate",width:40}]);k.defaultSortable=true;var s={"order.contactName":"","order.contactCustomer":"","order.contactBusinessphone":"","order.contactFax":"","order.contactMobilephone":"","order.contactAddress":"","order.contactZipcode":"","order.auditName":"","order.orderState":"","order.orderPaymode":"","order.orderLeval":"","order.orderDescription":"","order.createDate":"","order.expiryDate":""};var P=new Ext.menu.Menu({items:[{text:"联系人",checked:true,checkHandler:function(){i(this.checked,"order.contactName")}},{text:"客户",checked:true,checkHandler:function(){i(this.checked,"order.contactCustomer")}},{text:"联系人电话",checked:true,checkHandler:function(){i(this.checked,"order.contactBusinessphone")}},{text:"联系人传真",checked:true,checkHandler:function(){i(this.checked,"order.contactFax")}},{text:"联系人手机",checked:true,checkHandler:function(){i(this.checked,"order.contactMobilephone")}},{text:"发货地址",checked:true,checkHandler:function(){i(this.checked,"order.contactAddress")}},{text:"发货地址邮编",checked:true,checkHandler:function(){i(this.checked,"offer.contactZipcode")}},{text:"订单等级",checked:true,checkHandler:function(){i(this.checked,"order.orderLevel")}},{text:"审核帐户",checked:true,checkHandler:function(){i(this.checked,"order.auditName")}},{text:"付款方式",checked:true,checkHandler:function(){i(this.checked,"order.orderPaymode")}},{text:"创建日期",checked:true,checkHandler:function(){i(this.checked,"order.createDate")}},{text:"过期日期",checked:true,checkHandler:function(){i(this.checked,"order.expiryDate")}},{text:"备注",checked:true,checkHandler:function(){i(this.checked,"order.orderDescription")}}]});function i(x,y){if(x===true){s[y]=""}else{s[y]=null}}var Q=new Ext.form.TextField({});var b=new Ext.Button({iconCls:"icon-search",tooltip:"开始搜索",handler:function(){if(null!==s["order.contactName"]){s["order.contactName"]=Q.getValue()}if(null!==s["order.contactCustomer"]){s["order.contactCustomer"]=Q.getValue()}if(null!==s["order.contactBusinessphone"]){s["order.contactBusinessphone"]=Q.getValue()}if(null!==s["order.contactFax"]){s["order.contactFax"]=Q.getValue()}if(null!==s["order.contactMobilephone"]){s["order.contactMobilephone"]=Q.getValue()}if(null!==s["order.contactAddress"]){s["order.contactAddress"]=Q.getValue()}if(null!==s["order.contactZipcode"]){s["order.contactZipcode"]=Q.getValue()}if(null!==s["order.auditName"]){s["order.auditName"]=Q.getValue()}if(null!==s["order.orderState"]){s["order.orderState"]=Q.getValue()}if(null!==s["order.orderPaymode"]){s["order.orderPaymode"]=Q.getValue()}if(null!==s["order.orderLeval"]){s["order.orderLeval"]=Q.getValue()}if(null!==s["order.createDate"]){s["order.createDate"]=Q.getValue()}if(null!==s["order.expiryDate"]){s["order.expiryDate"]=Q.getValue()}if(null!==s["order.orderDescription"]){s["order.orderDescription"]=Q.getValue()}R.baseParams=s;R.setDefaultSort("orderID","DESC");R.load({params:{start:0,limit:C.getPageSize()}})}});var O=new Ext.Button({iconCls:"icon-clear",tooltip:"清空",handler:function(){Q.reset();R.baseParams={};R.setDefaultSort("orderID","DESC");R.load({params:{start:0,limit:C.getPageSize()}})}});var I=new Ext.grid.RowSelectionModel({singleSelect:true});var C=new Ext.ux.Andrie.pPageSize();var U=new Ext.grid.GridPanel({border:false,viewConfig:{forceFit:true},store:R,cm:k,sm:I,plugins:M,loadMask:true,bbar:new Ext.PagingToolbar({plugins:C,pageSize:20,store:R,displayInfo:true,displayMsg:"显示 {0} - {1} 共{2}",emptyMsg:"",items:["-",{text:"搜索范围",menu:P},Q,b,O,"-",{tooltip:"将选中订单导出为PDF格式",iconCls:"icon-pdf",handler:function(){var x=I.getSelected();if(x){window.open("order/exportOrderPDF.action?order.orderID="+x.data.orderID)}}},{tooltip:"将选中订单导出为xls格式",iconCls:"icon-xls",handler:function(){var x=I.getSelected();if(x){window.open("order/exportOrderPDF.action?order.orderID="+x.data.orderID+"&type=xls")}}}]})});U.on("render",function(){R.load({params:{start:0,limit:C.getPageSize()}})});var F=function(){var y=Ext.id();var x=new Ext.Panel({id:y,iconCls:"icon-order-add",autoScroll:true,title:"添加订单",closable:true});x.on("render",function(){x.load({scripts:true,method:"post",params:{containerID:x.body.id},url:"order/insertOrderView.action"})});var z=H.add(x);H.setActiveTab(z)};var S=function(x){var x=I.getSelected();if(x){var z="order-"+x.data.orderID;var y=H.getComponent(z);if(!y){var y=new Ext.Panel({id:z,iconCls:"icon-order",autoScroll:true,title:"订单"+x.data.orderID,closable:true});y.on("render",function(){y.load({scripts:true,method:"post",params:{"order.orderID":x.data.orderID,containerID:y.body.id},url:"order/getOrderView.action"})});var AA=H.add(y);H.setActiveTab(AA)}else{y.setTitle("订单"+x.data.orderID);y.setIconClass("icon-order");y.body.getUpdater().update({scripts:true,method:"post",params:{"order.orderID":x.data.orderID,containerID:y.body.id},url:"order/getOrderView.action"});H.setActiveTab(y)}}};var t=function(){var x=I.getSelected();if(x){if(SliverData.offerState[3][1]===x.data.orderState){Ext.MessageBox.alert("警告","订单["+x.data.orderID+"]已经锁定");return }var z="order-"+x.data.orderID;var y=H.getComponent(z);if(!y){var y=new Ext.Panel({id:z,iconCls:"icon-order-edit",autoScroll:true,title:"订单"+x.data.orderID,closable:true});y.on("render",function(){y.load({scripts:true,method:"post",params:{"order.orderID":x.data.orderID,containerID:y.body.id},url:"order/updateOrderView.action"})});var AA=H.add(y);H.setActiveTab(AA)}else{y.setTitle("订单"+x.data.orderID);y.setIconClass("icon-order-edit");y.body.getUpdater().update({scripts:true,method:"post",params:{"order.orderID":x.data.orderID,containerID:y.body.id},url:"order/updateOrderView.action"});H.setActiveTab(y)}}};var m=function(){var x=I.getSelected();if(x){if(SliverData.offerState[3][1]===x.data.orderState){Ext.MessageBox.alert("警告","订单["+x.data.orderID+"]已经锁定");return }Ext.MessageBox.confirm("删除订单","您确定要删除选中订单?",function(y){if(y=="yes"){Ext.Ajax.request({url:"order/removeOrder.action",params:{"order.orderID":x.data.orderID,"order.orderState":x.data.orderState},method:"post",success:function(AA){var AB=Ext.decode(AA.responseText);if(AB.success===true){var z="order-"+x.data.orderID;var AC=H.getComponent(z);H.remove(AC);R.remove(x)}}})}})}};U.on("rowdblclick",S);var A;U.on("rowcontextmenu",function(z,x,y){z.getSelectionModel().selectRow(x,false);if(!A){A=new Ext.menu.Menu([{id:"addOrderContextMenu",text:"添加订单",handler:F},{id:"updateOrderContextMenu",text:"更新订单",handler:t},"-",{id:"removeOrderContextMenu",text:"删除订单",handler:m}])}A.showAt(y.getPoint());y.stopEvent()});var q=function(){var y=H.id+"-saleState";var x=H.getComponent(y);if(!x){var x=new Ext.Panel({id:y,iconCls:"icon-chart-line",autoScroll:true,layout:"fit",title:"销售业绩",closable:true});x.on("render",function(){x.load({scripts:true,params:{containerID:x.body.id,moduleID:"order-manager"},method:"post",url:"order/saleStatePanel.jsp"})});var z=H.add(x);H.setActiveTab(z)}else{x.body.getUpdater().update({scripts:true,method:"post",params:{containerID:x.body.id,moduleID:"order-manager"},url:"order/saleStatePanel.jsp"});H.setActiveTab(x)}};var T=function(){var y=H.id+"-orderState";var x=H.getComponent(y);if(!x){var x=new Ext.Panel({id:y,iconCls:"icon-chart-curve",autoScroll:true,title:" 订单数量",closable:true});x.on("render",function(){x.load({scripts:true,params:{containerID:x.body.id,moduleID:"order-manager"},method:"post",url:"order/orderStatePanel.jsp"})});var z=H.add(x);H.setActiveTab(z)}else{x.body.getUpdater().update({scripts:true,params:{containerID:x.body.id,moduleID:"order-manager"},method:"post",url:"order/orderStatePanel.jsp"});H.setActiveTab(x)}};var u=function(){var y=H.id+"-contactState";var x=H.getComponent(y);if(!x){var x=new Ext.Panel({id:y,iconCls:"icon-chart-pie",autoScroll:true,title:" 联系人份额统计",closable:true});x.on("render",function(){x.load({scripts:true,params:{containerID:x.body.id,moduleID:"order-manager"},method:"post",url:"order/contactStatePanel.jsp"})});var z=H.add(x);H.setActiveTab(z)}else{x.body.getUpdater().update({scripts:true,params:{containerID:x.body.id,moduleID:"order-manager"},method:"post",url:"order/contactStatePanel.jsp"});H.setActiveTab(x)}};var E=function(){var y=H.id+"-groupState";var x=H.getComponent(y);if(!x){var x=new Ext.Panel({id:y,iconCls:"icon-chart-pie",autoScroll:true,title:" 客户(分组)份额统计",closable:true});x.on("render",function(){x.load({scripts:true,method:"post",params:{containerID:x.body.id,moduleID:"order-manager"},url:"order/groupStatePanel.jsp"})});var z=H.add(x);H.setActiveTab(z)}else{x.body.getUpdater().update({scripts:true,method:"post",params:{containerID:x.body.id,moduleID:"order-manager"},url:"order/groupStatePanel.jsp"});H.setActiveTab(x)}};var c=function(){var y=H.id+"-contactRank";var x=H.getComponent(y);if(!x){var x=new Ext.Panel({id:y,iconCls:"icon-chart-bar",autoScroll:true,title:" 联系人订单排名统计",closable:true});x.on("render",function(){x.load({scripts:true,method:"post",params:{containerID:x.body.id,moduleID:"order-manager"},url:"order/contactRankPanel.jsp"})});var z=H.add(x);H.setActiveTab(z)}else{x.body.getUpdater().update({scripts:true,method:"post",params:{containerID:x.body.id,moduleID:"order-manager"},url:"order/contactRankPanel.jsp"});H.setActiveTab(x)}};var N=function(){var y=H.id+"-groupRank";var x=H.getComponent(y);if(!x){var x=new Ext.Panel({id:y,iconCls:"icon-chart-bar",autoScroll:true,title:" 客户订单排名统计",closable:true});x.on("render",function(){x.load({scripts:true,method:"post",params:{containerID:x.body.id,moduleID:"order-manager"},url:"order/groupRankPanel.jsp"})});var z=H.add(x);H.setActiveTab(z)}else{x.body.getUpdater().update({scripts:true,method:"post",params:{containerID:x.body.id,moduleID:"order-manager"},url:"order/groupRankPanel.jsp"});H.setActiveTab(x)}};var B=function(){var y=H.id+"-productionSaleRank";var x=H.getComponent(y);if(!x){var x=new Ext.Panel({id:y,iconCls:"icon-chart-bar",autoScroll:true,title:" 产品订单排名统计",closable:true});x.on("render",function(){x.load({scripts:true,method:"post",params:{containerID:x.body.id,moduleID:"order-manager"},url:"order/productionSaleRankPanel.jsp"})});var z=H.add(x);H.setActiveTab(z)}else{x.body.getUpdater().update({scripts:true,method:"post",params:{containerID:x.body.id,moduleID:"order-manager"},url:"order/productionSaleRankPanel.jsp"});H.setActiveTab(x)}};var V=function(){var y=H.id+"-productionSaleHistory";var x=H.getComponent(y);if(!x){var x=new Ext.Panel({id:y,iconCls:"icon-chart-curve",autoScroll:true,title:" 产品销售趋势统计",closable:true});x.on("render",function(){x.load({scripts:true,method:"post",params:{sid:Ext.id(),containerID:x.body.id,moduleID:"order-manager"},url:"order/listProductionSaleHistoryPanel.jsp"})});var z=H.add(x);H.setActiveTab(z)}else{x.body.getUpdater().update({scripts:true,method:"post",params:{sid:Ext.id(),containerID:x.body.id,moduleID:"order-manager"},url:"order/listProductionSaleHistoryPanel.jsp"});H.setActiveTab(x)}};var W=new Ext.menu.Menu({items:[{text:"销售业绩",tooltip:"订单及汇款统计",iconCls:"icon-chart-line",handler:q},{text:"订单数量",tooltip:"订单及报价单数量统计",iconCls:"icon-chart-curve",handler:T},"-",{text:"产品销量",tooltip:"产品销量排名",iconCls:"icon-chart-bar",handler:B},{text:"产品趋势",tooltip:"产品销售趋势",iconCls:"icon-chart-curve",handler:V},"-",{text:"联系人份额",tooltip:"联系人份额",iconCls:"icon-chart-pie",handler:u},{text:"联系人排名",tooltip:"联系人订单金额排名",iconCls:"icon-chart-bar",handler:c},"-",{text:"客户份额",tooltip:"客户(分组)份额",iconCls:"icon-chart-pie",handler:E},{text:"客户排名",tooltip:"客户(分组)订单金额排名",iconCls:"icon-chart-bar",handler:N}]});var H=new Ext.TabPanel({id:"order-manager-body",region:"center",margins:"0 0 0 0",resizeTabs:true,minTabWidth:135,tabWidth:160,plugins:new Ext.ux.TabCloseMenu(),enableTabScroll:true,border:true,activeTab:0,autoDestroy:true,items:[{id:"offer-grid",closable:false,title:"报价单列表",autoScroll:true,layout:"fit",items:n,iconCls:"icon-offer"},{id:"order-grid",closable:false,title:"订单列表",autoScroll:true,layout:"fit",items:U,iconCls:"icon-order"}]});o=v.createWindow({id:this.moduleId,title:"我的订单",width:J,height:l,x:v.getWinX(J),y:v.getWinY(l),iconCls:"icon-order",shim:false,animCollapse:false,constrainHeader:true,minimizable:true,maximizable:true,border:false,layout:"border",tbar:["-",{tooltip:"新建报价单",iconCls:"icon-offer-add",handler:L},{tooltip:"更新报价单",iconCls:"icon-offer-edit",handler:w},{tooltip:"删除报价单",iconCls:"icon-offer-remove",handler:f},"-",{tooltip:"报价单转为订单",iconCls:"icon-order",handler:h},"-",{tooltip:"新建订单",iconCls:"icon-order-add",handler:F},{tooltip:"更新订单",iconCls:"icon-order-edit",handler:t},{tooltip:"删除订单",iconCls:"icon-order-remove",handler:m},"-",{text:"销售报表",menu:W}],items:H,taskbuttonTooltip:"<b>我的报价单、订单</b><br />我的订单、报价单"})}o.show()}});Sliver.Preferences=Ext.extend(Ext.app.Module,{moduleType:"system",moduleId:"system-preferences",cards:["pref-win-card-1","pref-win-card-2","pref-win-card-3","pref-win-card-4","pref-win-card-5","pref-win-card-6","perf-win-card-7"],contentPanel:null,cardHistory:["pref-win-card-1"],layout:null,win:null,init:function(){this.launcher={iconCls:"pref-icon",handler:this.createWindow,scope:this,shortcutIconCls:"pref-shortcut-icon",text:"帐户设置",tooltip:"<b>帐户设置</b><br />更改您的帐户设置"}},createWindow:function(){var D=this.app.getDesktop();this.win=D.getWindow(this.moduleId);var C=new Sliver.Preferences.UserMessage({owner:this,autoScroll:true,title:"帐户信息",border:false,id:"perf-win-card-7"});C.on("render",function(){C.body.getUpdater().update({scripts:true,method:"post",params:{containerID:C.body.id},url:"system/updateCurrentUserView.action"})});if(!this.win){var B=610;var A=460;this.contentPanel=new Ext.Panel({activeItem:0,border:false,id:"pref-win-content",items:[new Sliver.Preferences.NavPanel({owner:this,id:"pref-win-card-1"}),new Sliver.Preferences.Shortcuts({owner:this,id:"pref-win-card-6"}),new Sliver.Preferences.AutoRun({owner:this,id:"pref-win-card-5"}),new Sliver.Preferences.QuickStart({owner:this,id:"pref-win-card-2"}),new Sliver.Preferences.Appearance({owner:this,id:"pref-win-card-3"}),new Sliver.Preferences.Background({owner:this,id:"pref-win-card-4"}),C],layout:"card",bbar:[{xtype:"tbfill"},{disabled:true,handler:this.navHandler.createDelegate(this,[-1]),id:"back",scope:this,text:"上一步"},{disabled:true,handler:this.navHandler.createDelegate(this,[1]),id:"next",scope:this,text:"下一步"}]});this.win=D.createWindow({animCollapse:false,constrainHeader:true,id:this.moduleId,height:A,iconCls:"pref-icon",items:this.contentPanel,layout:"fit",shim:false,taskbuttonTooltip:"<b>帐户设置</b><br />更改您的设置",title:"帐户设置",width:B});this.layout=this.contentPanel.getLayout()}this.win.show()},handleButtonState:function(){var G=this.cardHistory,D=this.layout.activeItem.id,C=this.contentPanel.getBottomToolbar().items,B=C.get(1),F=C.get(2);for(var E=0,A=G.length;E<A;E++){if(G[E]===D){if(E<=0){B.disable();F.enable()}else{if(E>=(A-1)){B.enable();F.disable()}else{B.enable();F.enable()}}break}}},navHandler:function(C){var F=this.cardHistory,B=this.layout.activeItem.id,E;for(var D=0,A=F.length;D<A;D++){if(F[D]===B){E=F[D+C];break}}this.layout.setActiveItem(E);this.handleButtonState()},save:function(A){Ext.MessageBox.show({msg:"正在保存数据，请等待...",progressText:"保存中...",width:300,wait:true,waitConfig:{interval:200},icon:"desktop-download"});Ext.Ajax.request({url:"system/saveCurrentStyle.action",params:A,success:function(B){if(Ext.decode(B.responseText).success){Ext.MessageBox.hide()}else{Ext.MessageBox.hide();Ext.MessageBox.alert("Error","Errors encountered on the server.")}},failure:function(){Ext.MessageBox.hide();Ext.MessageBox.alert("Error","Lost connection to server.")},scope:this})},viewCard:function(A){this.layout.setActiveItem(A);if(this.cardHistory.length>1){this.cardHistory.pop()}this.cardHistory.push(A);this.handleButtonState()}});Sliver.Preferences.NavPanel=function(A){this.owner=A.owner;Sliver.Preferences.NavPanel.superclass.constructor.call(this,{autoScroll:true,bodyStyle:"padding:15px",border:false,html:'<ul id="pref-nav-panel">         <li>           <img src="'+Ext.BLANK_IMAGE_URL+'" class="icon-pref-shortcut"/>           <a id="viewShortcuts" href="#">快捷方式</a><br />           <span>选择出现在桌面上的程序的快捷方式</span>         </li>         <li>           <img src="'+Ext.BLANK_IMAGE_URL+'" class="icon-pref-autorun"/>           <a id="viewAutoRun" href="#">自动运行程序</a><br />           <span>选择登录后及自动运行的程序</span>         </li>         <li>           <img src="'+Ext.BLANK_IMAGE_URL+'" class="icon-pref-quickstart"/>           <a id="viewQuickstart" href="#">快速启动程序</a><br />           <span>设置常用的程序图标</span>         </li>         <li>           <img src="'+Ext.BLANK_IMAGE_URL+'" class="icon-pref-appearance"/>           <a id="viewAppearance" href="#">系统主题</a><br />           <span>选择您的系统主题</span>         </li>         <li>           <img src="'+Ext.BLANK_IMAGE_URL+'" class="icon-pref-wallpaper"/>           <a id="viewWallpapers" href="#">桌面背景</a><br />           <span>选择您的桌面背景图片及背景颜色</span>         </li>         <li>           <img src="'+Ext.BLANK_IMAGE_URL+'" class="icon-pref-account"/>           <a id="viewUserMessage" href="#">帐户信息</a><br />           <span>更改您的帐户信息</span>         </li>       </ul>',id:A.id});this.actions={viewShortcuts:function(B){B.viewCard("pref-win-card-6")},viewAutoRun:function(B){B.viewCard("pref-win-card-5")},viewQuickstart:function(B){B.viewCard("pref-win-card-2")},viewAppearance:function(B){B.viewCard("pref-win-card-3")},viewWallpapers:function(B){B.viewCard("pref-win-card-4")},viewUserMessage:function(B){B.viewCard("perf-win-card-7")}}};Ext.extend(Sliver.Preferences.NavPanel,Ext.Panel,{afterRender:function(){this.body.on({mousedown:{fn:this.doAction,scope:this,delegate:"a"},click:{fn:Ext.emptyFn,scope:null,delegate:"a",preventDefault:true}});Sliver.Preferences.NavPanel.superclass.afterRender.call(this)},doAction:function(B,A){B.stopEvent();this.actions[A.id](this.owner)}});Sliver.Preferences.AutoRun=function(E){this.owner=E.owner;this.app=this.owner.app;var C=this.app.modules,A=this.app.desktop.config.autorun,D=B(C,A);Sliver.Preferences.AutoRun.superclass.constructor.call(this,{autoScroll:true,bodyStyle:"padding:10px",border:false,buttons:[{handler:G,scope:this,text:"保存"},{handler:I,scope:this,text:"关闭"}],cls:"pref-card pref-check-tree",id:E.id,lines:false,listeners:{checkchange:{fn:H,scope:this}},loader:new Ext.tree.TreeLoader(),rootVisible:false,root:new Ext.tree.AsyncTreeNode({text:"自动运行程序",children:D}),title:"自动运行程序"});function B(L,N){var K=[];for(var M=0,J=L.length;M<J;M++){var O=L[M].launcher?L[M].launcher:L[M];if(O.menu){}else{K.push({checked:F(L[M].moduleId,N)?true:false,iconCls:L[M].launcher.iconCls,id:L[M].moduleId,leaf:true,selected:true,text:O.text||O.menuText})}}return K}function F(M,L){for(var K=0,J=L.length;K<J;K++){if(M==L[K]){return true}}}function H(K,J){if(K.leaf&&K.id){if(J){this.app.desktop.addAutoRun(K.id,true)}else{this.app.desktop.removeAutoRun(K.id,true)}}K.ownerTree.selModel.select(K)}function I(){this.owner.win.close()}function G(){this.owner.save({task:"autorun",autorun:Ext.encode(this.app.desktop.config.autorun).toString()})}};Ext.extend(Sliver.Preferences.AutoRun,Ext.tree.TreePanel);Sliver.Preferences.Shortcuts=function(E){this.owner=E.owner;this.app=this.owner.app;var C=this.app.modules,A=this.app.desktop.config.shortcuts,D=B(C,A);Sliver.Preferences.Shortcuts.superclass.constructor.call(this,{autoScroll:true,bodyStyle:"padding:10px",border:false,buttons:[{handler:G,scope:this,text:"保存"},{handler:I,scope:this,text:"关闭"}],cls:"pref-card pref-check-tree",id:E.id,lines:false,listeners:{checkchange:{fn:H,scope:this}},loader:new Ext.tree.TreeLoader(),rootVisible:false,root:new Ext.tree.AsyncTreeNode({text:"快捷方式",children:D}),title:"快捷方式"});function B(L,N){var K=[];for(var M=0,J=L.length;M<J;M++){var O=L[M].launcher?L[M].launcher:L[M];if(O.menu){}else{K.push({checked:F(L[M].moduleId,N)?true:false,iconCls:L[M].launcher.iconCls,id:L[M].moduleId,leaf:true,selected:true,text:O.text||O.menuText})}}return K}function F(M,L){for(var K=0,J=L.length;K<J;K++){if(M==L[K]){return true}}}function H(K,J){if(K.leaf&&K.id){if(J){this.app.desktop.addShortcut(K.id,true)}else{this.app.desktop.removeShortcut(K.id,true)}}K.ownerTree.selModel.select(K)}function I(){this.owner.win.close()}function G(){this.owner.save({task:"shortcut",shortcut:Ext.encode(this.app.desktop.config.shortcuts).toString()})}};Ext.extend(Sliver.Preferences.Shortcuts,Ext.tree.TreePanel);Sliver.Preferences.QuickStart=function(E){this.owner=E.owner;this.app=this.owner.app;var C=this.app.modules,A=this.app.desktop.config.quickstart,D=B(C,A);Sliver.Preferences.QuickStart.superclass.constructor.call(this,{autoScroll:true,bodyStyle:"padding:10px",border:false,buttons:[{handler:G,scope:this,text:"保存"},{handler:I,scope:this,text:"关闭"}],cls:"pref-card pref-check-tree",id:E.id,lines:false,listeners:{checkchange:{fn:H,scope:this}},loader:new Ext.tree.TreeLoader(),rootVisible:false,root:new Ext.tree.AsyncTreeNode({text:"快速启动",children:D}),title:"快速启动"});function B(L,N){var K=[];for(var M=0,J=L.length;M<J;M++){var O=L[M].launcher?L[M].launcher:L[M];if(O.menu){}else{K.push({checked:F(L[M].moduleId,N)?true:false,iconCls:L[M].launcher.iconCls,id:L[M].moduleId,leaf:true,selected:true,text:O.text||O.menuText})}}return K}function F(M,L){for(var K=0,J=L.length;K<J;K++){if(M==L[K]){return true}}}function H(K,J){if(K.leaf&&K.id){if(J){this.app.desktop.addQuickStartButton(K.id,true)}else{this.app.desktop.removeQuickStartButton(K.id,true)}}K.ownerTree.selModel.select(K)}function I(){this.owner.win.close()}function G(){this.owner.save({task:"quickstart",quickstart:Ext.encode(this.app.desktop.config.quickstart).toString()})}};Ext.extend(Sliver.Preferences.QuickStart,Ext.tree.TreePanel);Sliver.Preferences.Appearance=function(A){this.owner=A.owner;this.app=this.owner.app;var N=this.app.getDesktop();var M=new Ext.data.JsonStore({baseParams:{},fields:["themeID","themeName","themeThumbnail","themePath"],id:"themeID",root:"themes",url:"system/listSystemTheme.action"});M.load();this.store=M;M.on("load",function(P,O){if(O){D.setTitle("可用主题 ("+O.length+")");var Q=this.app.desktop.config.styles.theme.id;if(Q){K.select(String(Q))}}},this);var H=new Ext.XTemplate('<tpl for=".">','<div class="pref-view-thumb-wrap" id="{themeID}">','<div class="pref-view-thumb"><img src="{themeThumbnail}" title="{themeName}" /></div>',"<span>{shortName}</span></div>","</tpl>",'<div class="x-clear"></div>');var K=new Ext.DataView({autoHeight:true,emptyText:"无可用主题",itemSelector:"div.pref-view-thumb-wrap",loadingText:"加载中...",singleSelect:true,overClass:"x-view-over",prepareData:function(O){O.shortName=Ext.util.Format.ellipsis(O.name,17);return O},store:M,tpl:H});K.on("selectionchange",E,this);var D=new Ext.Panel({border:false,cls:"pref-thumbnail-viewer",collapsible:true,id:"pref-theme-view",items:K,title:"默认主题",titleCollapse:true});var L=new Ext.Panel({autoScroll:true,bodyStyle:"padding:10px",border:true,cls:"pref-card-subpanel",id:"themes",items:D,margins:"10 15 0 15",region:"center"});this.slider=G({handler:new Ext.util.DelayedTask(I,this),min:0,max:100,x:15,y:35,width:100});var B=new Ext.FormPanel({border:false,height:70,bodyStyle:"font-size:12px;",items:[{x:15,y:15,xtype:"label",text:"设置任务栏 透明度"},this.slider.slider,this.slider.display],layout:"absolute",split:false,region:"south"});function G(Q){var X=Q.handler,R=Q.min,U=Q.max,P=Q.width||100,V=Q.x,T=Q.y;var O=new Ext.Slider({width:P,maxValue:U,minValue:R,x:V,y:T});var S=new Ext.form.NumberField({cls:"pref-percent-field",enableKeyEvents:true,maxValue:U,minValue:R,width:45,x:V+P+15,y:T-1});function W(Z){var Y=Z.getValue();S.setValue(Y);X.delay(100,null,null,[Y])}O.on({change:{fn:W,scope:this},drag:{fn:W,scope:this}});S.on({keyup:{fn:function(Z){var Y=Z.getValue();if(Y!==""&&!isNaN(Y)&&Y>=Z.minValue&&Y<=Z.maxValue){O.setValue(Y)}},buffer:350,scope:this}});return{slider:O,display:S}}Sliver.Preferences.Appearance.superclass.constructor.call(this,{border:false,buttons:[{handler:F,scope:this,text:"保存"},{handler:J,scope:this,text:"关闭"}],cls:"pref-card",id:A.id,items:[L,B],layout:"border",title:"系统主题"});function J(){this.owner.win.close()}function F(){var O=this.app.desktop.config.styles;this.owner.save({task:"theme",themeID:O.theme.themeID,transparency:O.transparency})}function E(P,R){if(R.length>0){var O=this.app.desktop.config.styles.theme.themeID,Q=P.getRecord(R[0]),S=Q.data;if(parseInt(O)!==parseInt(Q.id)){if(Q&&Q.id&&S.themeName&&S.themePath){N.setTheme({themeID:Q.id,themeName:S.themeName,themePath:S.themePath})}}}}function I(O){N.setTransparency(O)}function C(P,O){N.setTransparency(O)}};Ext.extend(Sliver.Preferences.Appearance,Ext.Panel,{afterRender:function(){Sliver.Preferences.Appearance.superclass.afterRender.call(this);this.on("show",this.loadStore,this,{single:true})},loadStore:function(){this.store.load();this.slider.slider.setValue(this.app.desktop.getTransparency())}});Sliver.Preferences.Background=function(P){this.owner=P.owner;this.app=this.owner.app;var N=this.app.getDesktop();var C=new Ext.data.JsonStore({baseParams:{},fields:["wallpaperID","wallpaperName","wallpaperThumbnail","wallpaperPath"],id:"wallpaperID",root:"wallpapers",url:"system/listSystemWallpaper.action"});C.load();this.store=C;C.on("load",function(T,S){if(S){E.setTitle("可用桌面背景 ("+S.length+")");var U=this.app.desktop.config.styles.wallpaper.id;if(U){G.select("wallpaper-"+U)}}},this);var R=new Ext.XTemplate('<tpl for=".">','<div class="pref-view-thumb-wrap" id="{wallpaperID}">','<div class="pref-view-thumb"><img src="{wallpaperThumbnail}" title="{wallpaperName}" /></div>',"<span>{shortName}</span></div>","</tpl>",'<div class="x-clear"></div>');var G=new Ext.DataView({autoHeight:true,emptyText:"没有可用桌面背景",itemSelector:"div.pref-view-thumb-wrap",loadingText:"加载中...",singleSelect:true,overClass:"x-view-over",prepareData:function(S){S.shortName=Ext.util.Format.ellipsis(S.name,17);return S},store:C,tpl:R});G.on("selectionchange",H,this);var E=new Ext.Panel({border:false,cls:"pref-thumbnail-viewer",collapsible:true,id:"pref-wallpaper-view",items:G,title:"桌面背景",titleCollapse:true});var D=new Ext.Panel({autoScroll:true,bodyStyle:"padding:10px",border:true,cls:"pref-card-subpanel",id:"wallpapers",items:E,margins:"10 15 0 15",region:"center"});var J=this.app.desktop.config.styles.wallpaperposition;var M=O("tile",J=="tile"?true:false,90,40);var F=O("center",J=="center"?true:false,200,40);var Q=new Ext.FormPanel({border:false,height:140,bodyStyle:"font-size:12px;",id:"position",items:[{border:false,items:{border:false,html:"选择背景图片排列方式?"},x:15,y:15},{border:false,items:{border:false,html:'<img class="bg-pos-tile" src="'+Ext.BLANK_IMAGE_URL+'" width="64" height="44" border="0" alt="" />'},x:15,y:40},M,{border:false,items:{border:false,html:'<img class="bg-pos-center" src="'+Ext.BLANK_IMAGE_URL+'" width="64" height="44" border="0" alt="" />'},x:125,y:40},F,{border:false,items:{border:false,html:"桌面背景颜色"},x:245,y:15},{border:false,items:new Ext.ColorPalette({listeners:{select:{fn:L,scope:this}}}),x:245,y:40},{border:false,items:{border:false,html:"选择桌面字体颜色"},x:425,y:15},{border:false,items:new Ext.ColorPalette({listeners:{select:{fn:K,scope:this}}}),x:425,y:40}],layout:"absolute",region:"south",split:false});Sliver.Preferences.Background.superclass.constructor.call(this,{border:false,buttons:[{handler:I,scope:this,text:"保存"},{handler:A,scope:this,text:"关闭"}],cls:"pref-card",id:P.id,items:[D,Q],layout:"border",title:"桌面背景"});function O(U,T,S,V){if(U){radio=new Ext.form.Radio({name:"position",inputValue:U,checked:T,x:S,y:V});radio.on("check",B,radio);return radio}}function A(){this.owner.win.close()}function L(T,S){N.setBackgroundColor(S)}function K(T,S){N.setFontColor(S)}function I(){var S=this.app.desktop.config.styles;this.owner.save({task:"wallpaper",wallpaperID:S.wallpaper.wallpaperID,backgroundColor:S.backgroundcolor,fontColor:S.fontcolor,wallpaperPosition:S.wallpaperposition})}function H(T,V){if(V.length>0){var S=this.app.desktop.config.styles.wallpaper.wallpaperID,U=T.getRecord(V[0]),W=U.data;if(parseInt(S)!==parseInt(U.id)){if(U&&U.id&&W.wallpaperName&&W.wallpaperPath){N.setWallpaper({wallpaperID:U.id,wallpaperName:W.wallpaperName,wallpaperPath:W.wallpaperPath})}}}}function B(T,S){if(S===true){N.setWallpaperPosition(T.inputValue)}}};Ext.extend(Sliver.Preferences.Background,Ext.Panel,{afterRender:function(){Sliver.Preferences.Background.superclass.afterRender.call(this)}});Sliver.Preferences.UserMessage=function(A){this.owner=A.owner;Sliver.Preferences.UserMessage.superclass.constructor.call(this,A)};Ext.extend(Sliver.Preferences.UserMessage,Ext.Panel,{});Ext.override(Ext.tree.TreeNodeUI,{toggleCheck:function(B){var A=this.checkbox;if(A){A.checked=(B===undefined?!A.checked:B);this.fireEvent("checkchange",this.node,A.checked)}}});Sliver.ProductionManager=Ext.extend(Ext.app.Module,{moduleType:"production",moduleId:"production-manager",init:function(){this.launcher={handler:this.createWindow,iconCls:"production-manager-icon",scope:this,shortcutIconCls:"production-manager-shortcut",text:"产品管理",tooltip:"<b>产品管理</b><br />系统产品管理"}},createWindow:function(){var desktop=this.app.getDesktop();var win=desktop.getWindow(this.moduleId);if(!win){var winWidth=desktop.getWinWidth()/1.1;var winHeight=desktop.getWinHeight()/1.1;var catetree=new Ext.tree.TreePanel({useArrows:true,autoScroll:true,animate:true,dropConfig:{appendOnly:true},enableDD:true,containerScroll:true,rootVisible:true,loader:new Ext.tree.SliverTreeLoader({dataUrl:"production/listCategoryTree.action"}),root:new Ext.tree.AsyncTreeNode({id:"category-1",text:"产品及分类",draggable:false,expanded:true,singleClickExpand:false}),tbar:[{tooltip:"重新加载",iconCls:"icon-reload",handler:function(){catetree.getRootNode().reload()}},"-",{iconCls:"icon-expand-all",tooltip:"全部展开",handler:function(){catetree.getRootNode().expand(true)}},{iconCls:"icon-collapse-all",tooltip:"全部折叠",handler:function(){catetree.getRootNode().collapse(true)}},"->","-",{iconCls:"icon-add",menu:new Ext.menu.Menu({items:[{text:"目录",iconCls:"x-tree-node-icon",handler:function(){insertCategoryView()}},{text:"产品",iconCls:"icon-production",handler:function(){insertProductionView()}}]})}],region:"west",collapseMode:"mini",autoScroll:true,collapsible:true,margins:"0 0 0 0",split:true,border:true,width:parseFloat(winWidth*0.3)<201?parseFloat(winWidth*0.3):200});var store=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:"production/listProduction.action"}),reader:new Ext.data.JsonReader({root:"list",totalProperty:"total",id:"productionID",fields:["productionID","productionSerial","productionName","categoryName","productionUnit","productionVn1","productionVn2","productionVn3","productionVn4","productionVn5","productionPrice","productionDescription","productionParameter"]}),remoteSort:true});store.setDefaultSort("production_id","desc");var expander=new Ext.grid.RowExpander({tpl:new Ext.Template("<p><b>产品说明:</b> {productionDescription}</p><br>","<p><b>技术参数:</b> {productionParameter}</p>")});var cm=new Ext.grid.ColumnModel([expander,{header:"产品编号",dataIndex:"productionSerial",width:50},{header:"产品名称",dataIndex:"productionName",width:80},{header:"分类名称",dataIndex:"categoryName",width:70},{header:"单位",dataIndex:"productionUnit",width:50},{header:"技术参数1",hidden:true,dataIndex:"productionVn1",width:50},{header:"技术参数2",hidden:true,dataIndex:"productionVn2",width:50},{header:"技术参数3",hidden:true,dataIndex:"productionVn3",width:50},{header:"技术参数4",hidden:true,dataIndex:"productionVn4",width:50},{header:"技术参数5",hidden:true,dataIndex:"productionVn5",width:50},{header:"报价",align:"right",dataIndex:"productionPrice",width:110,renderer:SliverUtil.cnMoney}]);cm.defaultSortable=true;var filterProductionParams={"p.productionSerial":"","p.productionName":"","p.categoryName":"","p.productionUnit":"","p.productionPn1":"","p.productionVn1":"","p.productionPrice":"","p.productionDescription":"","p.productionParameter":"",f:false};function operateProductionGridParams(status,name){if(status===true){filterProductionParams[name]=""}else{filterProductionParams[name]=null}}var productionFilterMenu=new Ext.menu.Menu({items:[{text:"产品编号",checked:true,checkHandler:function(){operateProductionGridParams(this.checked,"p.productionSerial")}},{text:"产品名称",checked:true,checkHandler:function(){operateProductionGridParams(this.checked,"p.productionName")}},{text:"分类名称",checked:true,checkHandler:function(){operateProductionGridParams(this.checked,"p.categoryName")}},{text:"单位",checked:true,checkHandler:function(){operateProductionGridParams(this.checked,"p.productionUnit")}},{text:"参数名称",checked:true,checkHandler:function(){operateProductionGridParams(this.checked,"p.productionPn1")}},{text:"参数数值",checked:true,checkHandler:function(){operateProductionGridParams(this.checked,"p.productionVn1")}},{text:"技术参数",checked:true,checkHandler:function(){operateProductionGridParams(this.checked,"p.productionParameter")}},{text:"产品描述",checked:true,checkHandler:function(){operateProductionGridParams(this.checked,"p.productionDescription")}}]});var filterProduction=function(){grid.reconfigure(store,cm);if(null!==filterProductionParams["p.productionSerial"]){filterProductionParams["p.productionSerial"]=filterField.getValue()}if(null!==filterProductionParams["p.productionName"]){filterProductionParams["p.productionName"]=filterField.getValue()}if(null!==filterProductionParams["p.categoryName"]){filterProductionParams["p.categoryName"]=filterField.getValue()}if(null!==filterProductionParams["p.productionUnit"]){filterProductionParams["p.productionUnit"]=filterField.getValue()}if(null!==filterProductionParams["p.productionPn1"]){filterProductionParams["p.productionPn1"]=filterField.getValue()}if(null!==filterProductionParams["p.productionVn1"]){filterProductionParams["p.productionVn1"]=filterField.getValue()}if(null!==filterProductionParams["p.productionParameter"]){filterProductionParams["p.productionParameter"]=filterField.getValue()}if(null!==filterProductionParams["p.productionDescription"]){filterProductionParams["p.productionDescription"]=filterField.getValue()}filterProductionParams.f=true;store.baseParams=filterProductionParams;store.setDefaultSort("productionID","desc");store.load({params:{start:0,limit:pageSizePlugin.getPageSize()}})};var filterProductionWithPrice=function(){store.setDefaultSort("productionID","desc");store.baseParams={minPrice:minPriceField.getValue(),maxPrice:maxPriceField.getValue(),f:false};store.load({params:{start:0,limit:pageSizePlugin.getPageSize()}})};var filterField=new Ext.form.TextField({});var filterButton=new Ext.Button({iconCls:"icon-search",handler:filterProduction});var clearButton=new Ext.Button({iconCls:"icon-clear",handler:function(){filterField.reset();store.baseParams={};store.load({params:{start:0,limit:pageSizePlugin.getPageSize()}})}});var minPriceField=new Ext.form.NumberField({});var maxPriceField=new Ext.form.NumberField({});var filterPriceButton=new Ext.Button({iconCls:"icon-search",handler:filterProductionWithPrice});var clearPriceButton=new Ext.Button({iconCls:"icon-clear",handler:function(){minPriceField.reset();maxPriceField.reset();store.setDefaultSort("productionID","desc");store.baseParams={minPrice:"",maxPrice:"",f:false};store.load({params:{start:0,limit:pageSizePlugin.getPageSize()}})}});var gridsm=new Ext.grid.RowSelectionModel({singleSelect:true});var pageSizePlugin=new Ext.ux.Andrie.pPageSize();var grid=new Ext.grid.GridPanel({viewConfig:{forceFit:true},border:false,store:store,cm:cm,sm:gridsm,plugins:expander,loadMask:true,tbar:new Ext.Toolbar(["-","关键字查询","-",{text:"查询范围",menu:productionFilterMenu},filterField,filterButton,clearButton,"-","->","报价查询","-","下限",minPriceField,"-","上限",maxPriceField,filterPriceButton,clearPriceButton]),bbar:new Ext.PagingToolbar({plugins:pageSizePlugin,pageSize:20,store:store,displayInfo:true})});grid.on("render",function(){store.load({params:{start:0,limit:pageSizePlugin.getPageSize()}})});grid.on("rowdblclick",function(){var record=gridsm.getSelected();if(record){var tabID=main.id+"-production-"+record.data.productionID;var tab=main.getComponent(tabID);if(tab){tab.body.getUpdater().update({scripts:true,method:"post",params:{productionID:record.data.productionID,containerID:tab.body.id},url:"production/getProductionByAllView.action"});main.setActiveTab(tab)}else{var temp=new Ext.Panel({id:tabID,autoScroll:true,iconCls:"production-manager-icon",title:record.data.productionName,closable:true});temp.on("render",function(){temp.load({scripts:true,method:"post",params:{productionID:record.data.productionID,containerID:temp.body.id},url:"production/getProductionByAllView.action"})});var p=main.add(temp);main.setActiveTab(p)}}});var updateProductionGridView=function(){var record=gridsm.getSelected();if(record){var tabID=main.id+"-"+record.data.productionID;var tab=main.getComponent(tabID);if(tab){tab.body.getUpdater().update({scripts:true,method:"post",params:{productionID:record.data.productionID,containerID:tab.body.id},url:"production/updateProductionView.action"});main.setActiveTab(tab)}else{var temp=new Ext.Panel({id:tabID,autoScroll:true,iconCls:"production-manager-icon",title:record.data.productionName,closable:true});temp.on("render",function(){temp.load({scripts:true,method:"post",params:{productionID:record.data.productionID,containerID:temp.body.id},url:"production/updateProductionView.action"})});var p=main.add(temp);main.setActiveTab(p)}}};var removeProductionGridView=function(){var record=gridsm.getSelected();if(record){Ext.MessageBox.confirm("删除产品","您确定要删除产品 <b>"+record.data.productionName+"</b>?",function(btn){if(btn=="yes"){Ext.Ajax.request({url:"production/deleteProduction.action",params:{productionID:record.data.productionID},success:function(response){var j=Ext.decode(response.responseText);if(j.success===true){if(record){var tabID=main.id+"-"+record.data.productionID;var tab=main.getComponent(tabID);if(tab){main.remove(tab,true)}store.remove(record)}}}})}})}};var productionGridMenu;grid.on("rowcontextmenu",function(grid,rowindex,e){grid.getSelectionModel().selectRow(rowindex,false);if(!productionGridMenu){productionGridMenu=new Ext.menu.Menu([{id:"updateProductionGridViewMenu",text:"更新产品资料",handler:updateProductionGridView},"-",{id:"removeProductionGridViewMenu",text:"删除产品资料",handler:removeProductionGridView}])}productionGridMenu.showAt(e.getPoint());e.stopEvent()});var main=new Ext.TabPanel({id:"production-manager-body",region:"center",margins:"0 0 0 0",resizeTabs:true,minTabWidth:135,plugins:new Ext.ux.TabCloseMenu(),enableTabScroll:true,border:true,activeTab:0,autoDestroy:true,items:[{id:"production-manager-welcome",closable:false,layout:"fit",title:"产品列表",items:grid,autoScroll:true,iconCls:"production-manager-icon"}]});catetree.on("click",function(node,e){if(!node.isSelected()){node.select()}if(true!==node.isLeaf()){store.setDefaultSort("productionID","desc");store.baseParams={"p.categoryID":node.id.substring(node.id.lastIndexOf("-")+1),f:true};store.load({params:{start:0,limit:20}});main.setActiveTab(main.getComponent("production-manager-welcome"))}});catetree.on("dblclick",function(node,e){if(!node.isSelected()){node.select()}node=sm.getSelectedNode();if(node.isLeaf()){e.stopEvent();loadProduction(node)}});var sm=catetree.getSelectionModel();var cmenu;catetree.on("contextMenu",function(n,e){if(!n.isSelected()){n.select()}if(!cmenu){cmenu=new Ext.menu.Menu([{id:"expandCatetreeItem",text:"展开目录",handler:expandNode},{id:"collapseCatetreeItem",text:"关闭目录",handler:collapseNode},"-",{id:"reloadCatetreeNode",text:"刷新",handler:reloadNode},"-",{text:"新建",id:"createInCatetree",menu:{items:[{id:"addCategoryView",text:"目录",handler:insertCategoryView},{id:"addProductionView",text:"产品",handler:insertProductionView}]}},{id:"updateCategoryItem",text:"修改",handler:updateNode},"-",{id:"deleteCategoryItem",text:"删除",handler:deleteNode}])}var is=cmenu.items;if(n.isLeaf()){is.get("createInCatetree").hide();is.get("reloadCatetreeNode").setDisabled(true);is.get("expandCatetreeItem").setDisabled(true);is.get("collapseCatetreeItem").setDisabled(true)}else{is.get("createInCatetree").show();is.get("reloadCatetreeNode").setDisabled(false);is.get("expandCatetreeItem").setDisabled(n.isExpanded());is.get("collapseCatetreeItem").setDisabled(!n.isExpanded())}cmenu.showAt(e.getPoint())});catetree.on("movenode",function(catetree,node,oldParent,newParent,index){if(node){if(node.isLeaf()){moveProduction(catetree,node,oldParent,newParent,index)}else{moveCategory(catetree,node,oldParent,newParent,index)}}});function reloadNode(){var node=sm.getSelectedNode();if(node){node.reload()}else{catetree.getRootNode().reload();sm.select(catetree.getRootNode())}}function expandNode(){var node=sm.getSelectedNode();if(node){node.expand()}else{catetree.getRootNode().expand();sm.select(catetree.getRootNode())}}function collapseNode(){var node=sm.getSelectedNode();if(node){node.collapse()}else{catetree.getRootNode().collapse();sm.select(catetree.getRootNode())}}function loadProduction(){var node=sm.getSelectedNode();if(node){var tabID=main.id+"-"+node.id;var tab=main.getComponent(tabID);if(tab){tab.body.getUpdater().update({scripts:true,method:"post",params:{productionID:node.id.substring(11,node.id.length),containerID:tab.body.id},url:"production/getProductionByAllView.action"});main.setActiveTab(tab)}else{var temp=new Ext.Panel({id:tabID,autoScroll:true,iconCls:"production-manager-icon",title:node.text,closable:true});temp.on("render",function(){temp.load({scripts:true,method:"post",params:{productionID:node.id.substring(11,node.id.length),containerID:temp.body.id},url:"production/getProductionByAllView.action"})});var p=main.add(temp);main.setActiveTab(p)}}}function insertCategoryView(){var node=sm.getSelectedNode();if(node){Ext.Ajax.request({url:"production/insertCategoryView.action",params:{categoryPID:node.id.substring(9,node.id.length)},success:function(response){eval(response.responseText)}})}else{Ext.Ajax.request({url:"production/insertCategoryView.action",success:function(response){eval(response.responseText)}})}}function insertProductionView(){var node=sm.getSelectedNode();if(node){var tabID=Ext.id();var temp=new Ext.Panel({id:tabID,title:"增加产品",closable:true,autoScroll:true});temp.on("render",function(){temp.load({scripts:true,method:"post",params:{categoryID:node.id.substring(9,node.id.length),containerID:tabID},url:"production/insertProductionView.action"})});var p=main.add(temp);main.setActiveTab(p)}else{var tabID=Ext.id();var temp=new Ext.Panel({id:tabID,title:"增加产品",closable:true,autoScroll:true});temp.on("render",function(){temp.load({scripts:true,method:"post",params:{containerID:tabID},url:"production/insertProductionView.action"})});var p=main.add(temp);main.setActiveTab(p)}}var deleteNode=function(){var node=sm.getSelectedNode();if(node){if(node.isLeaf()){deleteProduction(node)}else{deleteCategory(node)}}};var deleteCategory=function(node){Ext.MessageBox.confirm("删除目录","您确定删除目录 <b>"+node.text+"</b>?<br/>注意：将会删除该目录下的所有目录及产品",function(btn){if(btn=="yes"){Ext.Ajax.request({url:"production/deleteCategory.action",params:{categoryID:node.id.substring(9,node.id.length)},success:function(response){node.remove()}})}})};var deleteProduction=function(node){Ext.MessageBox.confirm("删除产品","您确定要删除产品 <b>"+node.text+"</b>?",function(btn){if(btn=="yes"){Ext.Ajax.request({url:"production/deleteProduction.action",params:{productionID:node.id.substring(11,node.id.length)},success:function(response){if(node){var tabID=main.id+"-"+node.id;var tab=main.getComponent(tabID);if(tab){main.remove(tab,true)}node.remove()}}})}})};var updateNode=function(){var node=sm.getSelectedNode();if(node){if(node.isLeaf()){updateProductionView(node)}else{updateCategoryView(node)}}};var updateCategoryView=function(node){Ext.Ajax.request({url:"production/updateCategoryView.action",params:{categoryID:node.id.substring(9,node.id.length)},success:function(response){eval(response.responseText)}})};var updateProductionView=function(node){var tabID=main.id+"-"+node.id;var tab=main.getComponent(tabID);if(tab){tab.body.getUpdater().update({scripts:true,method:"post",params:{productionID:node.id.substring(11,node.id.length),containerID:tab.body.id},url:"production/updateProductionView.action"});main.setActiveTab(tab)}else{var temp=new Ext.Panel({id:tabID,autoScroll:true,iconCls:"production-manager-icon",title:node.text,closable:true});temp.on("render",function(){temp.load({scripts:true,method:"post",params:{productionID:node.id.substring(11,node.id.length),containerID:temp.body.id},url:"production/updateProductionView.action"})});var p=main.add(temp);main.setActiveTab(p)}};var moveCategory=function(catetree,node,oldParent,newParent,index){if(oldParent.id!=newParent.id){Ext.Ajax.request({url:"production/moveCategory.action",params:{categoryID:node.id.substring(9,node.id.length),categoryPID:newParent.id.substring(9,newParent.id.length)},success:function(response){var s=Ext.decode(response.responseText);if(s.success){}}})}};var moveProduction=function(catetree,node,oldParent,newParent,index){if(oldParent.id!=newParent.id){Ext.Ajax.request({url:"production/moveProduction.action",params:{productionID:node.id.substring(11,node.id.length),categoryID:newParent.id.substring(9,newParent.id.length)},success:function(response){var s=Ext.decode(response.responseText);if(s.success){var tabID=main.id+"-"+node.id;var tab=main.getComponent(tabID);if(tab){tab.body.getUpdater().update({scripts:true,method:"post",params:{productionID:node.id.substring(11,node.id.length)},url:"production/getProductionByID.action"});main.setActiveTab(tab)}}}})}};win=desktop.createWindow({id:this.moduleId,title:"产品管理",width:winWidth,height:winHeight,x:desktop.getWinX(winWidth),y:desktop.getWinY(winHeight),iconCls:"production-manager-icon",shim:false,lines:false,animCollapse:false,constrainHeader:true,minimizable:true,maximizable:true,border:true,layout:"border",items:[catetree,main],taskbuttonTooltip:"<b>产品管理</b><br />系统产品管理"})}win.show()}});Sliver.ProductionStorage=Ext.extend(Ext.app.Module,{moduleType:"system",moduleId:"production-storage",init:function(){this.launcher={handler:this.createWindow,iconCls:"icon-storage",scope:this,shortcutIconCls:"production-storage-shortcut",text:SliverData.storage.title,tooltip:SliverData.storage.tooltip}},createWindow:function(){var desktop=this.app.getDesktop();var win=desktop.getWindow(this.moduleId);if(!win){var winWidth=desktop.getWinWidth()/1.1;var winHeight=desktop.getWinHeight()/1.1;var store=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:"storage/listStoredProduction.action"}),reader:new Ext.data.JsonReader({root:"list",totalProperty:"total",id:"productionID",fields:["productionID","productionName","productionSerial","categoryID","categoryName","productionSerial","productionUnit","productionPrice","productionVn1","productionVn2","productionVn3","productionVn4","productionVn5","productionDescription","productionQuantity","productionTotalPrice"]}),remoteSort:true});var expander=new Ext.grid.RowExpander({tpl:new Ext.Template("<p><b>"+SliverData.storage.productionDescription+":</b> {productionDescription}</p>")});var cm=new Ext.grid.ColumnModel([expander,{header:"产品编号",dataIndex:"productionSerial",width:50},{header:"产品名称",dataIndex:"productionName",width:80},{header:"分类名称",dataIndex:"categoryName",width:80},{header:"单位",dataIndex:"productionUnit",width:40},{header:"技术参数",hidden:true,dataIndex:"productionVn1",width:50},{header:"技术参数",hidden:true,dataIndex:"productionVn2",width:50},{header:"技术参数",hidden:true,dataIndex:"productionVn3",width:50},{header:"技术参数",hidden:true,dataIndex:"productionVn4",width:50},{header:"技术参数",hidden:true,dataIndex:"productionVn5",width:50},{header:"产品报价",hidden:true,dataIndex:"productionPrice",align:"right",renderer:SliverUtil.cnMoney,width:60},{header:"产品数量",align:"right",dataIndex:"productionQuantity",width:40},{header:"总价",align:"right",dataIndex:"productionTotalPrice",renderer:SliverUtil.cnMoney,width:60}]);cm.defaultSortable=true;var filterProductionParams={"storedProduction.productionSerial":"","storedProduction.productionName":"","storedProduction.categoryName":"","storedProduction.productionUnit":"","storedProduction.productionPn1":"","storedProduction.productionVn1":"","storedProduction.productionPrice":"","storedProduction.productionDescription":""};function operateProductionGridParams(status,name){if(status===true){filterProductionParams[name]=""}else{filterProductionParams[name]=null}}var productionFilterMenu=new Ext.menu.Menu({items:[{text:"产品编号",checked:true,checkHandler:function(){operateProductionGridParams(this.checked,"storedProduction.productionSerial")}},{text:"产品名称",checked:true,checkHandler:function(){operateProductionGridParams(this.checked,"storedProduction.productionName")}},{text:"分类名称",checked:true,checkHandler:function(){operateProductionGridParams(this.checked,"storedProduction.categoryName")}},{text:"单位",checked:true,checkHandler:function(){operateProductionGridParams(this.checked,"storedProduction.productionUnit")}},{text:"参数名称",checked:true,checkHandler:function(){operateProductionGridParams(this.checked,"storedProduction.productionPn1")}},{text:"参数数值",checked:true,checkHandler:function(){operateProductionGridParams(this.checked,"storedProduction.productionVn1")}},{text:"产品描述",checked:true,checkHandler:function(){operateProductionGridParams(this.checked,"storedProduction.productionDescription")}}]});var filterProduction=function(){if(null!==filterProductionParams["storedProduction.productionSerial"]){filterProductionParams["storedProduction.productionSerial"]=filterField.getValue()}if(null!==filterProductionParams["storedProduction.productionName"]){filterProductionParams["storedProduction.productionName"]=filterField.getValue()}if(null!==filterProductionParams["storedProduction.categoryName"]){filterProductionParams["storedProduction.categoryName"]=filterField.getValue()}if(null!==filterProductionParams["storedProduction.productionUnit"]){filterProductionParams["storedProduction.productionUnit"]=filterField.getValue()}if(null!==filterProductionParams["storedProduction.productionPn1"]){filterProductionParams["storedProduction.productionPn1"]=filterField.getValue()}if(null!==filterProductionParams["storedProduction.productionVn1"]){filterProductionParams["storedProduction.productionVn1"]=filterField.getValue()}if(null!==filterProductionParams["storedProduction.productionDescription"]){filterProductionParams["storedProduction.productionDescription"]=filterField.getValue()}store.baseParams=filterProductionParams;store.setDefaultSort("productionID","desc");store.load({params:{start:0,limit:pageSizePlugin.getPageSize()}})};var filterField=new Ext.form.TextField({});var filterButton=new Ext.Button({iconCls:"icon-search",tooltip:"开始搜索",handler:filterProduction});var clearButton=new Ext.Button({iconCls:"icon-clear",tooltip:"清空",handler:function(){filterField.reset();store.baseParams={};store.setDefaultSort("productionID","DESC");store.load({params:{start:0,limit:pageSizePlugin.getPageSize()}})}});store.setDefaultSort("productionID","DESC");var sm=new Ext.grid.RowSelectionModel({singleSelect:true});var createStoredProduction=function(){Ext.Ajax.request({url:"storage/insertStoredProductionView.jsp",method:"post",success:function(response){eval(response.responseText)}})};var removeStoredProduction=function(){var record=sm.getSelected();if(record){Ext.MessageBox.confirm("清空产品库存","您确定要清空产品库存 "+record.data.productionName+" ?",function(btn){if(btn=="yes"){Ext.Ajax.request({url:"storage/removeStoredProduction.action",method:"post",params:{"storedProduction.productionID":record.data.productionID},success:function(response){var result=Ext.decode(response.responseText);if(true===result.success){store.remove(record)}}})}})}};var inStoredRegistrationView=function(){var record=sm.getSelected();if(record){var tabID=main.id+"-inStoredRegitration-"+Ext.id();var temp=new Ext.Panel({id:tabID,autoScroll:true,iconCls:"icon-offer-add",title:"入库记录",closable:true});temp.on("render",function(){temp.load({scripts:true,method:"post",params:{"storedRegistration.productionID":record.data.productionID,"storedRegistration.productionName":record.data.productionName,"storedRegistration.productionSerial":record.data.productionSerial,containerID:temp.body.id},url:"storage/inStoredRegistrationView.action"})});var p=main.add(temp);main.setActiveTab(p)}};var outStoredRegistrationView=function(){var record=sm.getSelected();if(record){var tabID=main.id+"-outStoredRegitration-"+Ext.id();var temp=new Ext.Panel({id:tabID,autoScroll:true,iconCls:"icon-offer-remove",title:"出库记录",closable:true});temp.on("render",function(){temp.load({scripts:true,method:"post",params:{"storedRegistration.productionID":record.data.productionID,"storedRegistration.productionName":record.data.productionName,"storedRegistration.productionSerial":record.data.productionSerial,containerID:temp.body.id},url:"storage/outStoredRegistrationView.action"})});var p=main.add(temp);main.setActiveTab(p)}};var pageSizePlugin=new Ext.ux.Andrie.pPageSize();var grid=new Ext.grid.GridPanel({border:false,viewConfig:{forceFit:true},store:store,cm:cm,sm:sm,loadMask:true,plugins:expander,tbar:["-",{iconCls:"icon-storage-add",tooltip:"创建产品库存",handler:createStoredProduction},{iconCls:"icon-storage-remove",tooltip:"清空产品库存",handler:removeStoredProduction},"-",{iconCls:"icon-offer-add",tooltip:"产品入库记录",handler:inStoredRegistrationView},{iconCls:"icon-offer-remove",tooltip:"产品出库记录",handler:outStoredRegistrationView}],bbar:new Ext.PagingToolbar({plugins:pageSizePlugin,pageSize:20,store:store,displayInfo:true,items:["-",{text:"搜索范围",menu:productionFilterMenu},filterField,filterButton,clearButton,"-",{iconCls:"icon-pdf",tooltip:"将表格导出为PDF文件",handler:function(){var s="?";if(store.lastOptions){s+=Ext.urlEncode(store.lastOptions)}if(store.baseParams){if(s===""){s+=Ext.urlEncode(store.baseParams)}else{s+="&"+Ext.urlEncode(store.baseParams)}}window.open("storage/exportStoredProduction.action"+s)}},"-",{iconCls:"icon-xls",tooltip:"将表格导出为XLS文件",handler:function(){var s="?";if(store.lastOptions){s+=Ext.urlEncode(store.lastOptions)}if(store.baseParams){if(s===""){s+=Ext.urlEncode(store.baseParams)}else{s+="&";s+=Ext.urlEncode(store.baseParams)}}if(""===s){s="?type=xls"}else{s=s+"&type=xls"}window.open("storage/exportStoredProduction.action"+s)}}]})});grid.on("render",function(){store.load({params:{start:0,limit:pageSizePlugin.getPageSize()}})});var lotPageSizePlugin=new Ext.ux.Andrie.pPageSize();var lotStore=new Ext.data.GroupingStore({proxy:new Ext.data.HttpProxy({url:"storage/listStoredProductionLot.action"}),reader:new Ext.data.JsonReader({root:"list",totalProperty:"total",id:"productionLotID",fields:["productionID","productionName","productionSerial","categoryID","categoryName","productionSerial","productionUnit","productionPrice","productionVn1","productionVn2","productionVn3","productionVn4","productionVn5","productionDescription","productionParameter","productionDescription","productionParameter","productionLotNumber","productionLotPrice","productionLotQuantity","productionLotTotal"]}),sortInfo:{field:"productionLotID",direction:"DESC"},groupField:"productionName",remoteSort:true});var lotExpander=new Ext.grid.RowExpander({tpl:new Ext.Template("<p><b>产品说明:</b> {productionDescription}</p><br>","<p><b>技术参数:</b> {productionParameter}</p>")});var lotCm=new Ext.grid.ColumnModel([{header:"产品编号",dataIndex:"productionSerial",width:50},{header:"产品名称",dataIndex:"productionName",width:80},{header:"分类名称",dataIndex:"categoryName",width:80},{header:"单位",dataIndex:"productionUnit",width:40},{header:"技术参数",hidden:true,dataIndex:"productionVn1",width:50},{header:"技术参数",hidden:true,dataIndex:"productionVn2",width:50},{header:"技术参数",hidden:true,dataIndex:"productionVn3",width:50},{header:"技术参数",hidden:true,dataIndex:"productionVn4",width:50},{header:"技术参数",hidden:true,dataIndex:"productionVn5",width:50},{header:"产品报价",hidden:true,dataIndex:"productionPrice",align:"right",renderer:SliverUtil.cnMoney,width:60},{header:"产品批号",align:"left",dataIndex:"productionLotNumber",width:80},{header:"批量单价",align:"right",dataIndex:"productionLotPrice",renderer:SliverUtil.cnMoney,width:60},{header:"产品批量",align:"right",dataIndex:"productionLotQuantity",width:60},{header:"批总价",align:"right",dataIndex:"productionLotTotal",renderer:SliverUtil.cnMoney,width:60}]);lotCm.defaultSortable=true;var filterProductionLotParams={"storedProductionLot.productionSerial":"","storedProductionLot.productionName":"","storedProductionLot.categoryName":"","storedProductionLot.productionUnit":"","storedProductionLot.productionPn1":"","storedProductionLot.productionVn1":"","storedProductionLot.productionDescription":"","storedProductionLot.productionParameter":""};function operateProductionLotGridParams(status,name){if(status===true){filterProductionLotParams[name]=""}else{filterProductionLotParams[name]=null}}var productionLotFilterMenu=new Ext.menu.Menu({items:[{text:"产品编号",checked:true,checkHandler:function(){operateProductionLotGridParams(this.checked,"storedProductionLot.productionSerial")}},{text:"产品名称",checked:true,checkHandler:function(){operateProductionLotGridParams(this.checked,"storedProductionLot.productionName")}},{text:"分类名称",checked:true,checkHandler:function(){operateProductionLotGridParams(this.checked,"storedProductionLot.categoryName")}},{text:"单位",checked:true,checkHandler:function(){operateProductionLotGridParams(this.checked,"storedProductionLot.productionUnit")}},{text:"参数名称",checked:true,checkHandler:function(){operateProductionLotGridParams(this.checked,"storedProductionLot.productionPn1")}},{text:"参数数值",checked:true,checkHandler:function(){operateProductionLotGridParams(this.checked,"storedProductionLot.productionVn1")}},{text:"技术参数",checked:true,checkHandler:function(){operateProductionLotGridParams(this.checked,"storedProductionLot.productionParameter")}},{text:"产品描述",checked:true,checkHandler:function(){operateProductionLotGridParams(this.checked,"storedProductionLot.productionDescription")}}]});var filterProductionLot=function(){if(null!==filterProductionLotParams["storedProductionLot.productionSerial"]){filterProductionLotParams["storedProductionLot.productionSerial"]=filterLotField.getValue()}if(null!==filterProductionLotParams["storedProductionLot.productionName"]){filterProductionLotParams["storedProductionLot.productionName"]=filterLotField.getValue()}if(null!==filterProductionLotParams["storedProductionLot.categoryName"]){filterProductionLotParams["storedProductionLot.categoryName"]=filterLotField.getValue()}if(null!==filterProductionLotParams["storedProductionLot.productionUnit"]){filterProductionLotParams["storedProductionLot.productionUnit"]=filterLotField.getValue()}if(null!==filterProductionLotParams["storedProductionLot.productionPn1"]){filterProductionLotParams["storedProductionLot.productionPn1"]=filterLotField.getValue()}if(null!==filterProductionLotParams["storedProductionLot.productionVn1"]){filterProductionLotParams["storedProductionLot.productionVn1"]=filterLotField.getValue()}if(null!==filterProductionLotParams["storedProductionLot.productionParameter"]){filterProductionLotParams["storedProductionLot.productionParameter"]=filterLotField.getValue()}if(null!==filterProductionLotParams["storedProductionLot.productionDescription"]){filterProductionLotParams["storedProductionLot.productionDescription"]=filterLotField.getValue()}lotStore.baseParams=filterProductionLotParams;lotStore.setDefaultSort("productionID","desc");lotStore.load({params:{start:0,limit:lotPageSizePlugin.getPageSize()}})};var filterLotField=new Ext.form.TextField({});var filterLotButton=new Ext.Button({iconCls:"icon-search",tooltip:"开始搜索",handler:filterProductionLot});var clearLotButton=new Ext.Button({iconCls:"icon-clear",tooltip:"清空",handler:function(){filterLotField.reset();lotStore.baseParams={};lotStore.setDefaultSort("productionID","DESC");lotStore.load({params:{start:0,limit:lotPageSizePlugin.getPageSize()}})}});lotStore.setDefaultSort("productionID","DESC");var lotSm=new Ext.grid.RowSelectionModel({singleSelect:true});var lotGrid=new Ext.grid.GridPanel({border:false,viewConfig:{forceFit:true},store:lotStore,cm:lotCm,sm:lotSm,view:new Ext.grid.GroupingView({forceFit:true,groupTextTpl:"{text} (批量:{[values.rs.length]}批 )"}),loadMask:true,bbar:new Ext.PagingToolbar({plugins:lotPageSizePlugin,pageSize:20,store:lotStore,displayInfo:true,items:["-",{text:"搜索范围",menu:productionLotFilterMenu},filterLotField,filterLotButton,clearLotButton,"-",{iconCls:"icon-pdf",tooltip:"将表格导出为PDF文件",handler:function(){var s="";if(store.lastOptions){s+=Ext.urlEncode(store.lastOptions)}if(store.baseParams){if(s===""){s+=Ext.urlEncode(store.baseParams)}else{s+="&";s+=Ext.urlEncode(store.baseParams)}}if(""===s){s="?type=xls"}else{s="?"+s+"&type=xls"}window.open("storage/exportStoredProductionLot.action?"+s)}},"-",{iconCls:"icon-xls",tooltip:"将表格导出为XLS文件",handler:function(){var s="?";if(store.lastOptions){s+=Ext.urlEncode(store.lastOptions)}if(store.baseParams){if(s===""){s+=Ext.urlEncode(store.baseParams)}else{s+="&";s+=Ext.urlEncode(store.baseParams)}}if(""===s){s="?type=xls"}else{s="?"+s+"&type=xls"}window.open("storage/exportStoredProductionLot.action"+s)}}]})});lotGrid.on("render",function(){lotStore.load({params:{start:0,limit:lotPageSizePlugin.getPageSize()}})});var registrationStore=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:"storage/listStoredRegistration.action"}),reader:new Ext.data.JsonReader({root:"list",totalProperty:"total",id:"registrationID",fields:["registrationID","productionID","categoryID","categoryName","productionName","productionSerial","productionUnit","productionVn1","productionVn2","productionVn3","productionQuantity","productionLotPrice","productionLotNumber","productionLotTotal","registrationDate","registrationType","registrationQuantity","registrationSender","registrationReceiver","registrationDescription"]}),remoteSort:true});function change(val){if(val>0){return'<span style="color:green;font-weight:bold;">'+val+"</span>"}else{if(val<0){return'<span style="color:red;font-weight:bold;">'+val+"</span>"}}return val}var registrationCm=new Ext.grid.ColumnModel([{header:"产品编号",dataIndex:"productionSerial",width:50},{header:"产品名称",dataIndex:"productionName",width:80},{header:"分类名称",dataIndex:"categoryName",width:50},{header:"批号",dataIndex:"productionLotNumber",width:60},{header:"单位",dataIndex:"productionUnit",width:30},{header:"数量",dataIndex:"registrationQuantity",renderer:change,align:"right",width:60},{header:"成本单价",dataIndex:"productionLotPrice",align:"right",renderer:SliverUtil.cnMoney,width:60},{header:"发货人",align:"right",dataIndex:"registrationSender",width:50},{header:"收货人",align:"right",dataIndex:"registrationReceiver",width:50},{header:"日期",align:"right",dataIndex:"registrationDate",width:40}]);registrationCm.defaultSortable=true;var registrationSm=new Ext.grid.RowSelectionModel({singleSelect:true});var filterRegistrationParams={"storedRegistration.productionSerial":"","storedRegistration.productionName":"","storedRegistration.categoryName":"","storedRegistration.productionUnit":"","storedRegistration.productionPn1":"","storedRegistration.productionVn1":"","storedRegistration.supplierName":"","storedRegistration.supplierPhone":"","storedRegistration.registrationSender":"","storedRegistration.registrationReceiver":""};function operateRegistrationGridParams(status,name){if(status===true){filterProductionLotParams[name]=""}else{filterProductionLotParams[name]=null}}var registrationFilterMenu=new Ext.menu.Menu({items:[{text:"产品编号",checked:true,checkHandler:function(){operateRegistrationGridParams(this.checked,"storedRegistration.productionSerial")}},{text:"产品名称",checked:true,checkHandler:function(){operateRegistrationGridParams(this.checked,"storedRegistration.productionName")}},{text:"分类名称",checked:true,checkHandler:function(){operateRegistrationGridParams(this.checked,"storedRegistration.categoryName")}},{text:"单位",checked:true,checkHandler:function(){operateRegistrationGridParams(this.checked,"storedRegistration.productionUnit")}},{text:"参数名称",checked:true,checkHandler:function(){operateRegistrationGridParams(this.checked,"storedRegistration.productionPn1")}},{text:"参数数值",checked:true,checkHandler:function(){operateRegistrationGridParams(this.checked,"storedRegistration.productionVn1")}},{text:"供应商名称",checked:true,checkHandler:function(){operateRegistrationGridParams(this.checked,"storedRegistration.supplierName")}},{text:"供应商联系电话",checked:true,checkHandler:function(){operateRegistrationGridParams(this.checked,"storedRegistration.supplierPhone")}},{text:"供应商联系人",checked:true,checkHandler:function(){operateRegistrationGridParams(this.checked,"storedRegistration.registrationSender")}},{text:"收货人",checked:true,checkHandler:function(){operateRegistrationGridParams(this.checked,"storedRegistration.registrationReceiver")}}]});var filterRegistration=function(){if(null!==filterRegistrationParams["storedRegistration.productionSerial"]){filterRegistrationParams["storedRegistration.productionSerial"]=filterRegistrationField.getValue()}if(null!==filterRegistrationParams["storedRegistration.productionName"]){filterRegistrationParams["storedRegistration.productionName"]=filterRegistrationField.getValue()}if(null!==filterRegistrationParams["storedRegistration.categoryName"]){filterRegistrationParams["storedRegistration.categoryName"]=filterRegistrationField.getValue()}if(null!==filterRegistrationParams["storedRegistration.productionUnit"]){filterRegistrationParams["storedRegistration.productionUnit"]=filterRegistrationField.getValue()}if(null!==filterRegistrationParams["storedRegistration.productionPn1"]){filterRegistrationParams["storedRegistration.productionPn1"]=filterRegistrationField.getValue()}if(null!==filterRegistrationParams["storedRegistration.productionVn1"]){filterRegistrationParams["storedRegistration.productionVn1"]=filterRegistrationField.getValue()}if(null!==filterRegistrationParams["storedRegistration.supplierName"]){filterRegistrationParams["storedRegistration.supplierName"]=filterRegistrationField.getValue()}if(null!==filterRegistrationParams["storedRegistration.supplierPhone"]){filterRegistrationParams["storedRegistration.supplierPhone"]=filterRegistrationField.getValue()}if(null!==filterRegistrationParams["storedRegistration.registrationSender"]){filterRegistrationParams["storedRegistration.registrationSender"]=filterRegistrationField.getValue()}if(null!==filterRegistrationParams["storedRegistration.registrationReceiver"]){filterRegistrationParams["storedRegistration.registrationReceiver"]=filterRegistrationField.getValue()}registrationStore.baseParams=filterRegistrationParams;registrationStore.setDefaultSort("registrationID","DESC");registrationStore.load({params:{start:0,limit:registrationPageSizePlugin.getPageSize()}})};var filterRegistrationField=new Ext.form.TextField({});var filterRegistrationButton=new Ext.Button({iconCls:"icon-search",tooltip:"开始搜索",handler:filterRegistration});var clearRegistrationButton=new Ext.Button({iconCls:"icon-clear",tooltip:"清空",handler:function(){filterRegistrationField.reset();registrationStore.baseParams={};registrationStore.setDefaultSort("registrationID","DESC");registrationStore.load({params:{start:0,limit:registrationPageSizePlugin.getPageSize()}})}});registrationStore.setDefaultSort("registrationID","DESC");var registrationPageSizePlugin=new Ext.ux.Andrie.pPageSize();var registrationGrid=new Ext.grid.GridPanel({border:false,viewConfig:{forceFit:true},store:registrationStore,cm:registrationCm,sm:registrationSm,loadMask:true,bbar:new Ext.PagingToolbar({plugins:registrationPageSizePlugin,pageSize:20,store:registrationStore,displayInfo:true,items:["-",{text:"搜索范围",menu:registrationFilterMenu},filterRegistrationField,filterRegistrationButton,clearRegistrationButton,"-",{iconCls:"icon-pdf",tooltip:"将表格导出为PDF文件",handler:function(){var s="";if(store.lastOptions){s+=Ext.urlEncode(store.lastOptions)}if(store.baseParams){if(s===""){s+=Ext.urlEncode(store.baseParams)}else{s+="&";s+=Ext.urlEncode(store.baseParams)}}window.open("storage/exportStoredRegistration.action?"+s)}},"-",{iconCls:"icon-xls",tooltip:"将表格导出为XLS文件",handler:function(){var s="";if(store.lastOptions){s+=Ext.urlEncode(store.lastOptions)}if(store.baseParams){if(s===""){s+=Ext.urlEncode(store.baseParams)}else{s+="&";s+=Ext.urlEncode(store.baseParams)}s+="&type=xls"}window.open("storage/exportStoredRegistration.action?"+s)}}]})});registrationGrid.on("render",function(){registrationStore.load({params:{start:0,limit:registrationPageSizePlugin.getPageSize()}})});var main=new Ext.TabPanel({id:"production-storage-body",region:"center",margins:"0 0 0 0",resizeTabs:true,minTabWidth:135,tabWidth:160,plugins:new Ext.ux.TabCloseMenu(),enableTabScroll:true,border:true,activeTab:0,autoDestroy:true,items:[{id:"storage-production-grid",closable:false,title:"产品库存",autoScroll:true,layout:"fit",items:grid,iconCls:"icon-storage"},{id:"storage-lot-grid",closable:false,title:"产品库存明细",autoScroll:true,layout:"fit",items:lotGrid,iconCls:"icon-storage"},{id:"storage-registration-grid",closable:false,title:"产品收发记录",autoScroll:true,layout:"fit",items:registrationGrid,iconCls:"icon-storage-registration"}]});var updateStoredRegistrationView=function(){var record=registrationSm.getSelected();if(record){var tabID=main.id+"-outStoredRegitration-"+record.data.registrationID;var tab=Ext.getCmp(tabID);if(tab){tab.body.getUpdater().update({scripts:true,method:"post",params:{"storedRegistration.registrationID":record.data.registrationID,containerID:tab.body.id},url:"storage/updateStoredRegistrationView.action"})}else{tab=new Ext.Panel({id:tabID,autoScroll:true,iconCls:"icon-offer-edit",title:"更新记录",closable:true});tab.on("render",function(){tab.load({scripts:true,method:"post",params:{"storedRegistration.registrationID":record.data.registrationID,containerID:tab.body.id},url:"storage/updateStoredRegistrationView.action"})});main.add(tab)}main.setActiveTab(tab)}};var removeStoredRegistrationView=function(){var record=registrationGrid.getSelectionModel().getSelected();if(record){Ext.MessageBox.confirm("删除记录","您确定要删除选中出入库记录?",function(btn){if(btn=="yes"){Ext.Ajax.request({url:"storage/removeStoredRegistration.action",params:{"storedRegistration.registrationID":record.data.registrationID},method:"post",success:function(response){var j=Ext.decode(response.responseText);if(j.success===true){var tabID=main.id+"-outStoredRegitration-"+record.data.registrationID;registrationStore.remove(record);var tab=main.getComponent(tabID);if(tab){main.remove(tab)}}}})}})}};var storedProductionContextMenu;grid.on("rowcontextmenu",function(grid,rowindex,e){grid.getSelectionModel().selectRow(rowindex,false);if(!storedProductionContextMenu){storedProductionContextMenu=new Ext.menu.Menu([{text:"添加入库记录",handler:inStoredRegistrationView},{text:"添加出库记录",handler:outStoredRegistrationView}])}storedProductionContextMenu.showAt(e.getPoint());e.stopEvent()});lotGrid.on("rowcontextmenu",function(lotGrid,rowindex,e){e.stopEvent()});var storedRegistrationContextMenu;registrationGrid.on("rowcontextmenu",function(registrationGrid,rowindex,e){registrationGrid.getSelectionModel().selectRow(rowindex,false);if(!storedRegistrationContextMenu){storedRegistrationContextMenu=new Ext.menu.Menu([{text:"更新记录",handler:updateStoredRegistrationView},{text:"删除记录",handler:removeStoredRegistrationView}])}storedRegistrationContextMenu.showAt(e.getPoint());e.stopEvent()});win=desktop.createWindow({id:this.moduleId,title:SliverData.storage.title,width:winWidth,height:winHeight,x:desktop.getWinX(winWidth),y:desktop.getWinY(winHeight),iconCls:"icon-storage",shim:false,animCollapse:false,constrainHeader:true,minimizable:true,maximizable:true,border:false,layout:"border",items:main,taskbuttonTooltip:SliverData.storage.tooltip})}win.show()}});var loadProductionInViewer=null;Sliver.ProductionViewer=Ext.extend(Ext.app.Module,{moduleType:"production",moduleId:"production-viewer",init:function(){this.launcher={handler:this.createWindow,iconCls:"production-icon",scope:this,shortcutIconCls:"production-shortcut",text:"产品浏览",tooltip:"<b>产品浏览</b><br />系统产品浏览"}},createWindow:function(){var X=this.app.getDesktop();var H=X.getWindow(this.moduleId);if(!H){var P=X.getWinWidth()/1.1;var E=X.getWinHeight()/1.1;var I=new Ext.tree.TreePanel({useArrows:true,autoScroll:true,animate:true,dropConfig:{appendOnly:true},enableDD:false,containerScroll:true,rootVisible:true,loader:new Ext.tree.SliverTreeLoader({dataUrl:"production/listCategoryTree.action"}),root:new Ext.tree.AsyncTreeNode({id:"category-1",text:"产品及分类",draggable:false,expanded:true,singleClickExpand:false}),tbar:[{tooltip:"重新加载",iconCls:"icon-reload",handler:function(){I.getRootNode().reload()}},"-",{iconCls:"icon-expand-all",tooltip:"全部展开",handler:function(){I.getRootNode().expand(true)}},{iconCls:"icon-collapse-all",tooltip:"全部折叠",handler:function(){I.getRootNode().collapse(true)}}],region:"west",collapseMode:"mini",autoScroll:true,collapsible:true,margins:"0 0 0 0",split:true,border:true,width:parseFloat(P*0.3)<201?parseFloat(P*0.3):200});I.on("contextmenu",Ext.emptyFn);var L=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:"production/listProduction.action"}),reader:new Ext.data.JsonReader({root:"list",totalProperty:"total",id:"productionID",fields:["productionID","productionSerial","productionName","categoryName","productionUnit","productionPn1","productionPn2","productionPn3","productionPn4","productionPn5","productionVn1","productionVn2","productionVn3","productionVn4","productionVn5","productionPrice","productionMinimum","productionImage","productionDescription","productionParameter"]}),remoteSort:true});L.setDefaultSort("productionID","desc");var a={"p.productionSerial":"","p.productionName":"","p.categoryName":"","p.productionUnit":"","p.productionPn1":"","p.productionVn1":"","p.productionPrice":"","p.productionDescription":"","p.productionParameter":"",f:false};function O(b,c){if(b===true){a[c]=""}else{a[c]=null}}var F=new Ext.menu.Menu({items:[{text:"产品编号",checked:true,checkHandler:function(){O(this.checked,"p.productionSerial")}},{text:"产品名称",checked:true,checkHandler:function(){O(this.checked,"p.productionName")}},{text:"分类名称",checked:true,checkHandler:function(){O(this.checked,"p.categoryName")}},{text:"单位",checked:true,checkHandler:function(){O(this.checked,"p.productionUnit")}},{text:"参数名称",checked:true,checkHandler:function(){O(this.checked,"p.productionPn1")}},{text:"参数数值",checked:true,checkHandler:function(){O(this.checked,"p.productionVn1")}},{text:"技术参数",checked:true,checkHandler:function(){O(this.checked,"p.productionParameter")}},{text:"产品描述",checked:true,checkHandler:function(){O(this.checked,"p.productionDescription")}}]});var Q=function(){if(null!==a["p.productionSerial"]){a["p.productionSerial"]=M.getValue()}if(null!==a["p.productionName"]){a["p.productionName"]=M.getValue()}if(null!==a["p.categoryName"]){a["p.categoryName"]=M.getValue()}if(null!==a["p.productionUnit"]){a["p.productionUnit"]=M.getValue()}if(null!==a["p.productionPn1"]){a["p.productionPn1"]=M.getValue()}if(null!==a["p.productionVn1"]){a["p.productionVn1"]=M.getValue()}if(null!==a["p.productionParameter"]){a["p.productionParameter"]=M.getValue()}if(null!==a["p.productionDescription"]){a["p.productionDescription"]=M.getValue()}a.f=true;L.baseParams=a;L.setDefaultSort("productionID","desc");L.load({params:{start:0,limit:C.getPageSize()}})};var G=function(){L.setDefaultSort("productionID","desc");L.baseParams={minPrice:T.getValue(),maxPrice:V.getValue(),f:false};L.load({params:{start:0,limit:C.getPageSize()}})};var M=new Ext.form.TextField({});var U=new Ext.Button({iconCls:"icon-search",handler:Q});var N=new Ext.Button({iconCls:"icon-clear",handler:function(){M.reset();L.baseParams={};L.load({params:{start:0,limit:C.getPageSize()}})}});var T=new Ext.form.NumberField({});var V=new Ext.form.NumberField({});var D=new Ext.Button({iconCls:"icon-search",handler:G});var R=new Ext.Button({iconCls:"icon-clear",handler:function(){T.reset();V.reset();L.setDefaultSort("productionID","desc");L.baseParams={minPrice:"",maxPrice:"",f:false};L.load({params:{start:0,limit:C.getPageSize()}})}});var Z=new Ext.XTemplate('<tpl for=".">','<dd onclick="loadProductionInViewer({productionID},\'{productionName}\')"  style="float:left;width:280px;height:120px;font-size:12px;padding:8px 10px 0px 10px;cursor:pointer;">','<div style="float:left;"><a href="#"><img style="border:4px solid #EFEFEF;" width="120" onload="ImageUtil.scale(this,100,100);" src="{productionImage}"/></a></div>','<div style="float:left;padding-left:10px;">','<h4>编号：{productionSerial}</h4><p style="padding:1px;">名称：{productionName}</p>','<p style="padding:1px;">单位：{productionUnit}</p>','<p style="padding:1px;">报价：￥{productionPrice}</p>','<tpl if="(this.isNull(productionPn1) == false)&&(this.isNull(productionVn1))==false"><p style="padding:1px;">{productionPn1}：{productionVn1}</p></tpl>','<tpl if="(this.isNull(productionPn2) == false)&&(this.isNull(productionVn2))==false"><p style="padding:1px;">{productionPn2}：{productionVn2}</p></tpl>','</div><div style="clear:both"></div>',"</dd>",'</tpl><div style="clear:both"></div>',{isNull:function(b){return((null===b)||(""===b))}});var C=new Ext.ux.Andrie.pPageSize();var J=new Ext.TabPanel({id:"production-viewer-body",region:"center",margins:"0 0 0 0",resizeTabs:true,minTabWidth:135,tabWidth:135,plugins:new Ext.ux.TabCloseMenu(),enableTabScroll:true,border:true,activeTab:0,autoDestroy:true,items:[{id:"production-images-view",layout:"fit",bodyStyle:"padding:20px;",autoScroll:true,title:"产品浏览",iconCls:"production-icon",items:new Ext.DataView({store:L,tpl:Z,autoWidth:true,autoHeight:true,overClass:"over",itemSelector:"dd",emptyText:""}),tbar:new Ext.Toolbar(["-","关键字查询","-",{text:"查询范围",menu:F},M,U,N,"-","->","报价查询","-","下限",T,"-","上限",V,D,R]),bbar:new Ext.PagingToolbar({plugins:C,pageSize:20,store:L,displayInfo:true})}]});J.on("render",function(){L.load({params:{start:0,limit:C.getPageSize()}})});I.on("click",function(b,c){if(!b.isSelected()){b.select()}if(true!==b.isLeaf()){L.setDefaultSort("productionID","desc");L.baseParams={"p.categoryID":b.id.substring(b.id.lastIndexOf("-")+1),f:true};L.load({params:{start:0,limit:20}});J.setActiveTab(J.getComponent("production-images-view"))}});I.on("dblclick",function(b,c){if(!b.isSelected()){b.select()}b=W.getSelectedNode();if(true===b.isLeaf()){c.stopEvent();S(b)}});var W=I.getSelectionModel();function Y(){var b=W.getSelectedNode();if(b){b.reload()}else{I.getRootNode().reload();W.select(I.getRootNode())}}function K(){var b=W.getSelectedNode();if(b){b.expand()}else{I.getRootNode().expand();W.select(I.getRootNode())}}function B(){var b=W.getSelectedNode();if(b){b.collapse()}else{I.getRootNode().collapse();W.select(I.getRootNode())}}function S(b){if(b){loadProductionInViewer(b.id.substring(11,b.id.length),b.text)}}loadProductionInViewer=function A(g,d){var c=J.id+"-"+g;var e=J.getComponent(c);if(e){e.body.getUpdater().update({scripts:true,method:"post",params:{productionID:g,containerID:e.body.id},url:"production/getProductionByIDView.action"});J.setActiveTab(e)}else{var b=new Ext.Panel({id:c,autoScroll:true,iconCls:"production-icon",title:d,closable:true});b.on("render",function(){b.load({scripts:true,method:"post",params:{productionID:g,containerID:b.body.id},url:"production/getProductionByIDView.action"})});var f=J.add(b);J.setActiveTab(f)}};H=X.createWindow({id:this.moduleId,title:"产品浏览",width:P,height:E,x:X.getWinX(P),y:X.getWinY(E),iconCls:"production-icon",shim:true,animCollapse:false,constrainHeader:true,minimizable:true,maximizable:true,border:true,layout:"border",items:[I,J],taskbuttonTooltip:"<b>产品浏览</b><br />产品资料浏览"});H.on("destroy",function(){delete loadProductionInViewer})}H.show()}});Sliver.ServeManager=Ext.extend(Ext.app.Module,{moduleType:"serve",moduleId:"serve-manager",init:function(){this.launcher={handler:this.createWindow,iconCls:"icon-script",scope:this,shortcutIconCls:"serve-shortcut",text:"售后服务",tooltip:"<b>售后服务</b><br />售后服务记录处理"}},createWindow:function(){var a=this.app.getDesktop();var I=a.getWindow(this.moduleId);if(!I){var U=a.getWinWidth()/1.1;var E=a.getWinHeight()/1.1;var L=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:"serve/listServe.action"}),reader:new Ext.data.JsonReader({root:"list",totalProperty:"total",id:"serveID",fields:["serveID","serveDate","serveTitle","serveType","serveEngineer","serveDescription","productionID","productionSerial","productionName","customerID","customerName","contactID","contactName","contactGender","contactPhone","contactAddress","serveSkill","serveAttitude","serveResult","serveAdvice"]}),remoteSort:true});L.setDefaultSort("serveID","DESC");var Q=new Ext.grid.RowExpander({tpl:new Ext.Template("<p><b>描述 : </b>{serveDescription}</p>","<p><b>建议 : </b>{serveAdvice}</p>")});var S=new Ext.form.ComboBox({store:new Ext.data.SimpleStore({fields:["serveType"],data:SliverData.serveType}),fieldLabel:"状态",displayField:"serveType",editable:false,emptyText:SliverData.complainState[0],mode:"local",anchor:"95%",triggerAction:"all",selectOnFocus:true,name:"serve.serveType"});var M=new Ext.form.ComboBox({store:new Ext.data.SimpleStore({fields:["serveResult"],data:SliverData.result}),fieldLabel:"结果",displayField:"serveResult",editable:false,anchor:"95%",mode:"local",triggerAction:"all",selectOnFocus:true,name:"serve.serveResult"});var b=new Ext.form.ComboBox({store:new Ext.data.SimpleStore({fields:["serveSkill"],data:SliverData.result}),fieldLabel:"专业技术",displayField:"serveSkill",editable:false,anchor:"95%",mode:"local",triggerAction:"all",selectOnFocus:true,name:"serve.serveSkill"});var T=new Ext.form.ComboBox({store:new Ext.data.SimpleStore({fields:["serveAttitude"],data:SliverData.result}),fieldLabel:"结果",displayField:"serveAttitude",editable:false,anchor:"95%",mode:"local",triggerAction:"all",selectOnFocus:true,name:"serve.serveAttitude"});function W(e){return Ext.util.Format.ellipsis(e,12)}function Z(e){return Ext.util.Format.ellipsis(e,15)}function N(e){return Ext.util.Format.ellipsis(e,15)}function R(e){return Ext.util.Format.ellipsis(e,8)}var O=new Ext.grid.ColumnModel([Q,{header:"编号",dataIndex:"serveID",width:30},{header:"产品编号",hidden:true,dataIndex:"productionSerial",width:60},{header:"产品名称",hidden:true,dataIndex:"productionName",width:60},{header:"主题",dataIndex:"serveTitle",renderer:W,width:100},{header:"客户",dataIndex:"customerName",renderer:Z,width:100},{header:"联系人",dataIndex:"contactName",width:60},{header:"性别",align:"center",renderer:SliverUtil.renderGender,dataIndex:"contactGender",width:30},{header:"联系方式",dataIndex:"contactPhone",width:80},{header:"地址",hidden:true,dataIndex:"contactAddress",width:120},{header:"日期",dataIndex:"serveDate",width:60},{header:"人员",hidden:true,dataIndex:"serveEngineer",renderer:R,width:60},{header:"类型",align:"right",editor:S,dataIndex:"serveType",width:50},{header:'<span style="color:#FF0000;font-weight:bold;">技能</span>',align:"right",editor:b,dataIndex:"serveSkill",width:40},{header:'<span style="color:#FF0000;font-weight:bold;">态度</span>',align:"right",editor:T,dataIndex:"serveAttitude",width:40},{header:'<span style="color:#FF0000;font-weight:bold;">结果</span>',align:"right",editor:M,dataIndex:"serveResult",width:40}]);O.defaultSortable=true;var d={"serve.serveDate":"","serve.serveEngineer":"","serve.serveTitle":"","serve.productionSerial":"","serve.productionName":"","serve.customerName":"","serve.contactName":"","serve.contactPhone":"","serve.contactAddress":""};var V=new Ext.menu.Menu({items:[{text:"投诉日期",checked:true,checkHandler:function(){C(this.checked,"serve.serveDate")}},{text:"标题",checked:true,checkHandler:function(){C(this.checked,"serve.serveTitle")}},{text:"服务人员",checked:true,checkHandler:function(){C(this.checked,"serve.serveEngineer")}},{text:"产品编号",checked:true,checkHandler:function(){C(this.checked,"serve.productionSerial")}},{text:"产品名称",checked:true,checkHandler:function(){C(this.checked,"serve.productionName")}},{text:"客户名称",checked:true,checkHandler:function(){C(this.checked,"serve.customerName")}},{text:"联系人",checked:true,checkHandler:function(){C(this.checked,"serve.contactName")}},{text:"联系方式",checked:true,checkHandler:function(){C(this.checked,"serve.contactPhone")}},{text:"地址",checked:true,checkHandler:function(){C(this.checked,"serve.contactAddress")}}]});function C(e,f){if(e===true){d[f]=""}else{d[f]=null}}var K=new Ext.form.TextField({});var X=new Ext.Button({iconCls:"icon-search",tooltip:"开始搜索",handler:function(){if(null!==d["serve.serveDate"]){d["serve.serveDate"]=K.getValue()}if(null!==d["serve.serveTitle"]){d["serve.serveTitle"]=K.getValue()}if(null!==d["serve.serveEngineer"]){d["serve.serveEngineer"]=K.getValue()}if(null!==d["serve.productionSerial"]){d["serve.productionSerial"]=K.getValue()}if(null!==d["serve.productionName"]){d["serve.productionName"]=K.getValue()}if(null!==d["serve.customerName"]){d["serve.customerName"]=K.getValue()}if(null!==d["serve.contactName"]){d["serve.contactName"]=K.getValue()}if(null!==d["serve.contactPhone"]){d["serve.contactPhone"]=K.getValue()}if(null!==d["serve.contactAddress"]){d["serve.contactAddress"]=K.getValue()}L.baseParams=d;L.setDefaultSort("serveID","DESC");L.load({params:{start:0,limit:25}})}});var P=new Ext.Button({iconCls:"icon-clear",tooltip:"清空",handler:function(){K.reset();L.baseParams={};L.setDefaultSort("serveID","DESC");L.load({params:{start:0,limit:25}})}});var Y=new Ext.grid.RowSelectionModel({singleSelect:true});var D=new Ext.ux.Andrie.pPageSize();var A=new Ext.grid.EditorGridPanel({border:false,viewConfig:{forceFit:true},store:L,cm:O,sm:Y,plugins:Q,loadMask:true,clicksToEdit:1,bbar:new Ext.PagingToolbar({plugins:D,pageSize:20,store:L,displayInfo:true,items:["-",{text:"搜索范围",menu:V},K,X,P]})});A.on("beforeedit",function(f){Y.selectRow(f.row)});A.on("afteredit",function(g){var f=Y.getSelected();if(f){Ext.Ajax.request({url:"serve/updateServe.action",params:{"serve.serveID":f.data.serveID,"serve.contactName":f.data.contactName,"serve.contactGender":f.data.contactGender,"serve.contactPhone":f.data.contactPhone,"serve.serveDate":f.data.serveDate,"serve.serveTitle":f.data.serveTitle,"serve.serveDescription":f.data.serveDescription,"serve.serveType":f.data.serveType,"serve.serveSkill":f.data.serveSkill,"serve.serveAttitude":f.data.serveAttitude,"serve.serveResult":f.data.serveResult},method:"post",success:function(e){}})}});A.on("render",function(){L.load({params:{start:0,limit:25}})});var G=function(){var e=Y.getSelected();if(e){var g=J.id+"-serve-"+e.data.serveID;var f=J.getComponent(g);if(!f){var f=new Ext.Panel({id:g,iconCls:"icon-script",autoScroll:true,title:"售后服务"+e.data.serveID,closable:true});f.on("render",function(){f.load({scripts:true,method:"post",params:{"serve.serveID":e.data.serveID,containerID:f.body.id},url:"serve/getServe.action"})});var h=J.add(f);J.setActiveTab(h)}else{f.setTitle("售后服务"+e.data.serveID);f.setIconClass("icon-script");f.body.getUpdater().update({scripts:true,method:"post",params:{"serve.serveID":e.data.serveID,containerID:f.body.id},url:"serve/getServe.action"});J.setActiveTab(f)}}};var B=function(){var e=Y.getSelected();if(e){var g=J.id+"-serve-"+e.data.serveID;var f=J.getComponent(g);if(!f){var f=new Ext.Panel({id:g,iconCls:"icon-script",autoScroll:true,title:"售后服务"+e.data.serveID,closable:true});f.on("render",function(){f.load({scripts:true,method:"post",params:{"serve.serveID":e.data.serveID,containerID:f.body.id},url:"serve/updateServeView.action"})});var h=J.add(f);J.setActiveTab(h)}else{f.setTitle("售后服务"+e.data.serveID);f.setIconClass("icon-script");f.body.getUpdater().update({scripts:true,method:"post",params:{"serve.serveID":e.data.serveID,containerID:f.body.id},url:"serve/updateServeView.action"});J.setActiveTab(f)}}};var c=function(){var f=J.id+"-serve-"+Ext.id();var e=new Ext.Panel({id:f,iconCls:"icon-script-add",autoScroll:true,title:"新售后服务记录",closable:true});e.on("render",function(){e.load({scripts:true,method:"post",params:{containerID:e.body.id},url:"serve/insertServeView.action"})});var g=J.add(e);J.setActiveTab(g)};var F=function(){var e=Y.getSelected();if(e){Ext.MessageBox.confirm("产出售后服务","您确定要删除售后服务?",function(f){if(f=="yes"){Ext.Ajax.request({url:"serve/removeServe.action",method:"post",params:{"serve.serveID":e.data.serveID},success:function(h){var g=Ext.decode(h.responseText);if(true===g.success){L.remove(e)}}})}})}};A.on("rowdblclick",G);var H;A.on("rowcontextmenu",function(g,f,h){g.getSelectionModel().selectRow(f,false);if(!H){H=new Ext.menu.Menu([{text:"添加售后服务",handler:c},{text:"更新售后服务",handler:B},{text:"查看售后服务",handler:G},"-",{text:"删除售后服务",handler:F}])}H.showAt(h.getPoint());h.stopEvent()});var J=new Ext.TabPanel({id:"serve-manager-body",region:"center",margins:"0 0 0 0",resizeTabs:true,minTabWidth:135,tabWidth:160,plugins:new Ext.ux.TabCloseMenu(),enableTabScroll:true,border:true,activeTab:0,autoDestroy:true,items:[{closable:false,title:"售后服务",autoScroll:true,layout:"fit",items:A,iconCls:"icon-script"}]});I=a.createWindow({id:this.moduleId,title:"售后服务",width:U,height:E,x:a.getWinX(U),y:a.getWinY(E),iconCls:"icon-script",shim:false,animCollapse:false,constrainHeader:true,minimizable:true,maximizable:true,border:false,layout:"border",tbar:["-",{iconCls:"icon-script-add",tooltip:"新售后服务记录",handler:c},{iconCls:"icon-script-edit",tooltip:"更新售后服务记录",handler:B},{iconCls:"icon-script-remove",tooltip:"删除售后服务记录",handler:F},{iconCls:"icon-script",tooltip:"浏览售后服务记录",handler:G}],items:J,taskbuttonTooltip:"<b>售后服务</b><br />售后服务记录处理"})}I.show()}});Sliver.ShowDesktop=Ext.extend(Ext.app.Module,{moduleType:"system",moduleId:"system-showdesktop",init:function(){this.launcher={handler:this.showDesktop,iconCls:"icon-showdesktop",scope:this,shortcutIconCls:"system-showdesktop-shortcut",text:"显示桌面",tooltip:"<b>显示桌面</b><br />显示桌面按钮"}},isAllMinimized:true,isModuleWindow:function(C){var A=this.app.getModules();for(var B=0;B<A.length;B++){if(C.id&&A[B].moduleId===C.id){return true}else{return false}}},showDesktop:function(){var C=this.app.getDesktop().getManager();var D=C.getBy(function(E){return true});var A=this.app.getModules();for(var B=0;B<D.length;B++){if(D[B].isVisible()){this.isAllMinimized=false;break}}if(!this.isAllMinimized){C.hideAll();this.isAllMinimized=true}else{C.each(function(F){for(var E=0;E<A.length;E++){if(F.id&&A[E].moduleId===F.id){if(!F.isVisible()){F.show()}else{F.restore()}}}},C);this.isAllMinimized=false}}});Sliver.Documents=Ext.extend(Ext.app.Module,{moduleType:"system",moduleId:"system-documents",init:function(){this.launcher={handler:this.createWindow,iconCls:"documents-icon",scope:this,shortcutIconCls:"documents-shortcut",text:"我的文档",tooltip:"<b>我的文档</b><br />共享文档、我的文档"}},createWindow:function(){var desktop=this.app.getDesktop();var win=desktop.getWindow(this.moduleId);var sharedFile=new Ext.tree.TreePanel({id:"system-shared-file",title:"共享文档",useArrows:true,autoScroll:true,animate:true,dropConfig:{appendOnly:true},enableDD:true,containerScroll:true,rootVisible:true,loader:new Ext.tree.SliverTreeLoader({dataUrl:"file/listSharedFileTree.action"}),tools:[{id:"refresh",on:{click:function(){var tree=Ext.getCmp("system-shared-file");tree.body.mask("Loading","x-mask-loading");setTimeout(function(){tree.body.unmask();tree.root.reload()},1000)}}}],tbar:[{tooltip:"重新加载",iconCls:"icon-reload",handler:function(){sharedFile.getRootNode().reload()}},"-",{iconCls:"icon-expand-all",tooltip:"全部展开",handler:function(){sharedFile.getRootNode().expand(true)}},{iconCls:"icon-collapse-all",tooltip:"全部折叠",handler:function(){sharedFile.getRootNode().collapse(true)}}],root:new Ext.tree.AsyncTreeNode({id:"systemFolder-0",text:"共享文档",draggable:false,expanded:true,singleClickExpand:true})});var userFile=new Ext.tree.TreePanel({id:"system-file",title:"我的文档",useArrows:true,autoScroll:true,animate:true,dropConfig:{appendOnly:true},enableDD:true,containerScroll:true,rootVisible:true,loader:new Ext.tree.SliverTreeLoader({dataUrl:"file/listUserFileTree.action"}),tools:[{id:"refresh",on:{click:function(){var tree=Ext.getCmp("system-file");tree.body.mask("Loading","x-mask-loading");setTimeout(function(){tree.body.unmask();tree.root.reload()},1000)}}}],tbar:[{tooltip:"重新加载",iconCls:"icon-reload",handler:function(){userFile.getRootNode().reload()}},"-",{iconCls:"icon-expand-all",tooltip:"全部展开",handler:function(){userFile.getRootNode().expand(true)}},{iconCls:"icon-collapse-all",tooltip:"全部折叠",handler:function(){userFile.getRootNode().collapse(true)}}],root:new Ext.tree.AsyncTreeNode({id:"systemFolder-1",text:"我的文档",draggable:false,expanded:true,singleClickExpand:true})});userFile.on("dblclick",function(node,e){if(!node.isSelected()){node.select()}node=userFile.getSelectionModel().getSelectedNode();if(node.isLeaf()){e.stopEvent();window.open("file/downloadUserFile.action?file.fileID="+node.id.substring(node.id.lastIndexOf("-")+1))}});userFile.on("movenode",function(userFile,node,oldParent,newParent,index){if(node){if(node.isLeaf()){moveUserFile(userFile,node,oldParent,newParent,index)}else{moveUserFolder(userFile,node,oldParent,newParent,index)}}});var userFileContextMenu;userFile.on("contextMenu",function(n,e){var sm=userFile.getSelectionModel();if(!n.isSelected()){n.select()}if(!userFileContextMenu){userFileContextMenu=new Ext.menu.Menu([{id:"expandUserFileNode",text:"展开目录",handler:function(){var node=sm.getSelectedNode();if(node){node.expand()}}},{id:"collapseUserFileNode",text:"关闭目录",handler:function(){var node=sm.getSelectedNode();if(node){node.collapse()}}},"-",{id:"reloadUserFileNode",text:"刷新",handler:function(){var node=sm.getSelectedNode();if(node){node.reload()}}},"-",{id:"addUserFolderView",text:"创建目录",handler:insertUserFolderView},{id:"addUserFileView",text:"上传文件",handler:insertUserFileView},{id:"updateCategoryItem",text:"重命名",handler:updateUserNode},"-",{id:"deleteCategoryItem",text:"删除",handler:removeUserNode}])}var items=userFileContextMenu.items;if(n.isLeaf()){items.get("addUserFolderView").hide();items.get("addUserFileView").hide();items.get("reloadUserFileNode").setDisabled(true);items.get("expandUserFileNode").setDisabled(true);items.get("collapseUserFileNode").setDisabled(true)}else{items.get("addUserFolderView").show();items.get("addUserFileView").show();items.get("reloadUserFileNode").setDisabled(false);items.get("expandUserFileNode").setDisabled(n.isExpanded());items.get("collapseUserFileNode").setDisabled(!n.isExpanded())}userFileContextMenu.showAt(e.getPoint())});sharedFile.on("dblclick",function(node,e){if(!node.isSelected()){node.select()}node=sharedFile.getSelectionModel().getSelectedNode();if(node.isLeaf()){e.stopEvent();window.open("file/downloadSharedFile.action?file.fileID="+node.id.substring(node.id.lastIndexOf("-")+1))}});sharedFile.on("movenode",function(sharedFile,node,oldParent,newParent,index){if(node){if(node.isLeaf()){moveSharedFile(sharedFile,node,oldParent,newParent,index)}else{moveSharedFolder(sharedFile,node,oldParent,newParent,index)}}});var sharedFileContextMenu;sharedFile.on("contextMenu",function(n,e){var sm=sharedFile.getSelectionModel();if(!n.isSelected()){n.select()}if(!sharedFileContextMenu){sharedFileContextMenu=new Ext.menu.Menu([{id:"expandSharedFileNode",text:"展开目录",handler:function(){var node=sm.getSelectedNode();if(node){node.expand()}}},{id:"collapseSharedFileNode",text:"关闭目录",handler:function(){var node=sm.getSelectedNode();if(node){node.collapse()}}},"-",{id:"reloadSharedFileNode",text:"刷新",handler:function(){var node=sm.getSelectedNode();if(node){node.reload()}}},"-",{id:"addSharedFolderView",text:"创建目录",handler:insertSharedFolderView},{id:"addSharedFileView",text:"上传文件",handler:insertSharedFileView},{id:"updateSharedFileView",text:"重命名",handler:updateSharedNode},"-",{id:"removeSharedFile",text:"删除",handler:removeSharedNode}])}var items=sharedFileContextMenu.items;if(n.isLeaf()){items.get("addSharedFolderView").hide();items.get("addSharedFileView").hide();items.get("reloadSharedFileNode").setDisabled(true);items.get("expandSharedFileNode").setDisabled(true);items.get("collapseSharedFileNode").setDisabled(true)}else{items.get("addSharedFolderView").show();items.get("addSharedFileView").show();items.get("reloadSharedFileNode").setDisabled(false);items.get("expandSharedFileNode").setDisabled(n.isExpanded());items.get("collapseSharedFileNode").setDisabled(!n.isExpanded())}sharedFileContextMenu.showAt(e.getPoint())});var updateUserNode=function(){var node=userFile.getSelectionModel().getSelectedNode();if(true===node.isLeaf()){updateUserFileView(node)}else{updateUserFolderView(node)}};var removeUserNode=function(){var node=userFile.getSelectionModel().getSelectedNode();if(true===node.isLeaf()){removeUserFile(node)}else{removeUserFolder(node)}};var insertUserFolderView=function(){var node=userFile.getSelectionModel().getSelectedNode();if(node){Ext.Ajax.request({url:"file/insertUserFolderView.action",method:"post",params:{"folder.folderID":node.id.substring(node.id.lastIndexOf("-")+1)},success:function(request){eval(request.responseText)}})}};var updateUserFolderView=function(node){if(node){Ext.Ajax.request({url:"file/updateUserFolderView.action",method:"post",params:{"folder.folderID":node.id.substring(node.id.lastIndexOf("-")+1)},success:function(request){eval(request.responseText)}})}};var removeUserFolder=function(node){if(node){Ext.MessageBox.confirm("删除目录","您确定删除目录 <b>"+node.text+"</b>?<br/>注意：将会删除该目录下的所有文件",function(btn){if(btn=="yes"){Ext.Ajax.request({url:"file/removeUserFolder.action",params:{"folder.folderID":node.id.substring(node.id.lastIndexOf("-")+1)},success:function(response){var j=Ext.decode(response.responseText);if(j.success===true){node.remove()}}})}})}};var moveUserFolder=function(userFile,node,oldParent,newParent,index){if(oldParent.id!=newParent.id){Ext.Ajax.request({url:"file/updateUserFolderAction.action",params:{"folder.folderID":node.id.substring(node.id.lastIndexOf("-")+1),"folder.folderPID":newParent.id.substring(newParent.id.lastIndexOf("-")+1)},success:function(response){var s=Ext.decode(response.responseText);if(s.success){}}})}};var moveUserFile=function(userFile,node,oldParent,newParent,index){if(oldParent.id!=newParent.id){Ext.Ajax.request({url:"file/updateUserFileAction.action",params:{"file.fileID":node.id.substring(node.id.lastIndexOf("-")+1),"file.folderID":newParent.id.substring(newParent.id.lastIndexOf("-")+1)},success:function(response){var s=Ext.decode(response.responseText);if(s.success===true){}}})}};var insertUserFileView=function(){Ext.Ajax.request({url:"file/insertUserFileView.jsp",method:"post",params:{dc:1222297382},success:function(response){eval(response.responseText)}})};var updateUserFileView=function(node){Ext.Ajax.request({url:"file/updateUserFileView.action",params:{"file.fileID":node.id.substring(node.id.lastIndexOf("-")+1)},method:"post",success:function(response){eval(response.responseText)}})};var removeUserFile=function(node){if(node){Ext.MessageBox.confirm("删除文件","您确定删除文件 <b>"+node.text+"</b>?",function(btn){if(btn=="yes"){Ext.Ajax.request({url:"file/removeUserFile.action",params:{"file.fileID":node.id.substring(node.id.lastIndexOf("-")+1)},success:function(response){var j=Ext.decode(response.responseText);if(j.success===true){node.remove()}}})}})}};var updateSharedNode=function(){var node=sharedFile.getSelectionModel().getSelectedNode();if(true===node.isLeaf()){updateSharedFileView(node)}else{updateSharedFolderView(node)}};var removeSharedNode=function(){var node=sharedFile.getSelectionModel().getSelectedNode();if(true===node.isLeaf()){removeSharedFile(node)}else{removeSharedFolder(node)}};var insertSharedFolderView=function(){var node=sharedFile.getSelectionModel().getSelectedNode();if(node){Ext.Ajax.request({url:"file/insertSharedFolderView.action",method:"post",params:{"folder.folderID":node.id.substring(node.id.lastIndexOf("-")+1)},success:function(request){eval(request.responseText)}})}};var updateSharedFolderView=function(node){if(node){Ext.Ajax.request({url:"file/updateSharedFolderView.action",method:"post",params:{dc:1222297382},params:{"folder.folderID":node.id.substring(node.id.lastIndexOf("-")+1)},success:function(request){eval(request.responseText)}})}};var removeSharedFolder=function(node){if(node){Ext.MessageBox.confirm("删除目录","您确定删除目录 <b>"+node.text+"</b>?<br/>注意：将会删除该目录下的所有文件",function(btn){if(btn=="yes"){Ext.Ajax.request({url:"file/removeSharedFolder.action",params:{"folder.folderID":node.id.substring(node.id.lastIndexOf("-")+1)},success:function(response){var j=Ext.decode(response.responseText);if(j.success===true){node.remove()}}})}})}};var moveSharedFolder=function(sharedFile,node,oldParent,newParent,index){if(oldParent.id!=newParent.id){Ext.Ajax.request({url:"file/updateSharedFolderAction.action",params:{"folder.folderID":node.id.substring(node.id.lastIndexOf("-")+1),"folder.folderPID":newParent.id.substring(newParent.id.lastIndexOf("-")+1)},success:function(response){var s=Ext.decode(response.responseText);if(s.success){}}})}};var moveSharedFile=function(sharedFile,node,oldParent,newParent,index){if(oldParent.id!=newParent.id){Ext.Ajax.request({url:"file/updateSharedFileAction.action",params:{"file.fileID":node.id.substring(node.id.lastIndexOf("-")+1),"file.folderID":newParent.id.substring(newParent.id.lastIndexOf("-")+1)},success:function(response){var s=Ext.decode(response.responseText);if(s.success===true){}}})}};var insertSharedFileView=function(){Ext.Ajax.request({url:"file/insertSharedFileView.jsp",method:"post",success:function(response){eval(response.responseText)}})};var updateSharedFileView=function(node){Ext.Ajax.request({url:"file/updateSharedFileView.action",params:{"file.fileID":node.id.substring(node.id.lastIndexOf("-")+1)},method:"post",success:function(response){eval(response.responseText)}})};var removeSharedFile=function(node){if(node){Ext.MessageBox.confirm("删除文件","您确定删除文件 <b>"+node.text+"</b>?",function(btn){if(btn=="yes"){Ext.Ajax.request({url:"file/removeSharedFile.action",params:{"file.fileID":node.id.substring(node.id.lastIndexOf("-")+1)},success:function(response){var j=Ext.decode(response.responseText);if(j.success===true){node.remove()}}})}})}};if(!win){win=desktop.createWindow({id:this.moduleId,title:"我的文档",width:300,height:500,iconCls:"documents-icon",shim:false,border:false,animCollapse:false,constrainHeader:true,maximizable:false,taskbuttonTooltip:"<b>我的文档</b><br />共享文档、我的文档",layout:"accordion",layoutConfig:{animate:false},items:[userFile,sharedFile]})}win.show()}});Sliver.IMWindow=Ext.extend(Ext.app.Module,{moduleType:"system",moduleId:"system-im",init:function(){this.launcher={handler:this.createWindow,iconCls:"icon-comments",scope:this,shortcutIconCls:"im-shortcut",text:"即时通信",tooltip:"<b>及时通讯</b><br />在线交流、发送留言、发送文件"}},createWindow:function(){var desktop=this.app.getDesktop();var win=desktop.getWindow(this.moduleId);var runner=new Ext.util.TaskRunner();var onlineUser=new Ext.tree.TreePanel({id:"system-onlineuser-list",title:"在线用户",loader:new Ext.tree.SliverTreeLoader({dataUrl:"im/listOnlineUser.action"}),rootVisible:false,lines:false,autoScroll:true,tools:[{id:"refresh",on:{click:function(){var tree=Ext.getCmp("system-onlineuser-list");tree.body.mask("Loading","x-mask-loading");setTimeout(function(){tree.body.unmask();tree.root.reload()},1000)}}}],tbar:[{tooltip:"刷新",iconCls:"icon-reload",handler:function(){onlineUser.getRootNode().reload()}},"-",{iconCls:"icon-expand-all",tooltip:"全部展开",handler:function(){onlineUser.getRootNode().expand(true)}},{iconCls:"icon-collapse-all",tooltip:"全部折叠",handler:function(){onlineUser.getRootNode().collapse(true)}}],root:new Ext.tree.AsyncTreeNode({id:"ImOnlieUser-0",text:"组织架构",draggable:false,expanded:true,singleClickExpand:true})});var allUser=new Ext.tree.TreePanel({id:"system-user-list",title:"所有用户",loader:new Ext.tree.SliverTreeLoader({dataUrl:"system/listGroupTree.action"}),rootVisible:false,lines:false,autoScroll:true,tools:[{id:"refresh",on:{click:function(){var tree=Ext.getCmp("system-user-list");tree.body.mask("Loading","x-mask-loading");setTimeout(function(){tree.body.unmask();tree.root.reload()},1000)}}}],tbar:[{tooltip:"重新加载",iconCls:"icon-reload",handler:function(){userMessage.getRootNode().reload()}},"-",{iconCls:"icon-expand-all",tooltip:"全部展开",handler:function(){allUser.getRootNode().expand(true)}},{iconCls:"icon-collapse-all",tooltip:"全部折叠",handler:function(){allUser.getRootNode().collapse(true)}}],root:new Ext.tree.AsyncTreeNode({id:"systemImUser-0",text:"组织架构",draggable:false,expanded:true,singleClickExpand:true})});allUser.on("dblclick",function(node,e){if(!node.isSelected()){node.select()}node=allUser.getSelectionModel().getSelectedNode();if(node.isLeaf()){e.stopEvent();sendMsgView()}});var msgContextMenu;allUser.on("contextMenu",function(n,e){var sm=allUser.getSelectionModel();if(!n.isSelected()){n.select()}if(!msgContextMenu){msgContextMenu=new Ext.menu.Menu([{id:"expandAllUserMenuItem",text:"展开目录",handler:function(){var node=sm.getSelectedNode();if(node){node.expand()}}},{id:"collapseAllUserMenuItem",text:"关闭目录",handler:function(){var node=sm.getSelectedNode();if(node){node.collapse()}}},"-",{id:"reloadAllUserMenuItem",text:"刷新",handler:function(){var node=sm.getSelectedNode();if(node){node.reload()}}},{id:"listHistoryMsgMenuItem",text:"聊天记录",handler:function(){var node=sm.getSelectedNode();if(node){listHistoryMsg(node)}}},"-",{id:"sendMsgMenuItem",text:"发送信息",handler:sendMsgView},{id:"sendFileMenuItem",text:"发送文件",handler:function(){var node=sm.getSelectedNode();if(node){Ext.Ajax.request({url:"im/sendOfflineFileView.jsp",method:"post",success:function(response){eval(response.responseText)}})}}}])}var items=msgContextMenu.items;if(n.isLeaf()){}else{items.get("sendMsgMenuItem").setDisabled(true);items.get("expandAllUserMenuItem").setDisabled(n.isExpanded());items.get("collapseAllUserMenuItem").setDisabled(!n.isExpanded())}msgContextMenu.showAt(e.getPoint())});onlineUser.on("dblclick",function(node,e){if(!node.isSelected()){node.select()}node=onlineUser.getSelectionModel().getSelectedNode();if(true===node.isLeaf()){e.stopEvent();sendOnlineMsgView()}});var onlineMsgContextMenu;onlineUser.on("contextMenu",function(n,e){var sm=onlineUser.getSelectionModel();if(!n.isSelected()){n.select()}if(!onlineMsgContextMenu){onlineMsgContextMenu=new Ext.menu.Menu([{id:"expandOnlineUserMenuItem",text:"展开目录",handler:function(){var node=sm.getSelectedNode();if(node){node.expand()}}},{id:"collapseOnlineUserMenuItem",text:"关闭目录",handler:function(){var node=sm.getSelectedNode();if(node){node.collapse()}}},"-",{id:"reloadOnlineUserMenuItem",text:"刷新",handler:function(){var node=sm.getSelectedNode();if(node){node.reload()}}},{id:"listHistoryMsgMenuItem",text:"聊天记录",handler:function(){var node=sm.getSelectedNode();if(node){listHistoryMsg(node)}}},"-",{id:"sendOnlineMsgMenuItem",text:"发送信息",handler:sendOnlineMsgView},{id:"sendFileMenuItem",text:"发送文件",handler:function(){var node=sm.getSelectedNode();if(node){Ext.Ajax.request({url:"im/sendOnlineFileView.jsp",method:"post",success:function(response){eval(response.responseText)}})}}}])}var items=onlineMsgContextMenu.items;if(!n.isLeaf()){items.get("sendOnlineMsgMenuItem").setDisabled(true);items.get("listHistoryMsgMenuItem").setDisabled(true);items.get("expandOnlineUserMenuItem").setDisabled(n.isExpanded());items.get("collapseOnlineUserMenuItem").setDisabled(!n.isExpanded())}onlineMsgContextMenu.showAt(e.getPoint())});var sendMsgView=function(){Ext.Ajax.request({url:"im/sendMessageView.action",success:function(response){eval(response.responseText)}})};var sendOnlineMsgView=function(){Ext.Ajax.request({url:"im/sendOnlineMessageView.action",success:function(response){eval(response.responseText)}})};var listHistoryMsg=function(node){var sendTo=null;if(node.text.indexOf("(")===-1){sendTo=node.text}else{sendTo=node.text.substring(0,node.text.indexOf("("))}Ext.Ajax.request({url:"im/listHistoryMsgView.action",params:{"msg.msgTo":sendTo},success:function(response){eval(response.responseText)}})};var getFirstUnReadMsg=function(){Ext.Ajax.request({url:"im/countUnReadMsg.action",success:function(response){var j=Ext.decode(response.responseText);if(j.success===true){if(j.unread>0){Ext.Ajax.request({url:"im/getMessageView.action",success:function(response){eval(response.responseText);countUnReadMessage()}})}}}})};var countUnReadMessage=function(){Ext.Ajax.request({url:"im/countUnReadMsg.action",method:"post",params:{dc:1222297382},success:function(response){var j=Ext.decode(response.responseText);if(j.success===true){unReadMsgButton.setText("("+j.unread+")");if(0<j.unread){unReadMsgButton.setIconClass("icon-messages");soundManager.play("msg")}else{unReadMsgButton.setIconClass("icon-comments")}}}})};var unReadMsgButton=new Ext.Button({tooltip:"新留言",iconCls:"icon-comments",text:"(0)",handler:getFirstUnReadMsg});if(!win){win=desktop.createWindow({id:this.moduleId,title:"即时通信",width:250,height:500,iconCls:"icon-comments",shim:false,border:false,animCollapse:false,constrainHeader:true,maximizable:false,taskbuttonTooltip:"<b>即时通信</b><br />在线交流、发送留言、发送文件",tbar:["-",unReadMsgButton],layout:"accordion",layoutConfig:{animate:false},items:[onlineUser,allUser]})}var countTask={run:countUnReadMessage,interval:5000};runner.start(countTask);win.on("beforeclose",function(){runner.stopAll()});win.show()}});Sliver.TaskCreater=Ext.extend(Ext.app.Module,{moduleType:"task",moduleId:"task-creater",init:function(){this.launcher={handler:this.createWindow,iconCls:"task-manager-icon",scope:this,shortcutIconCls:"task-creater-shortcut",text:"任务管理",tooltip:"<b>任务管理</b><br />任务，项目管理"}},createWindow:function(){var desktop=this.app.getDesktop();var win=desktop.getWindow(this.moduleId);if(!win){var winWidth=desktop.getWinWidth()/1.1;var winHeight=desktop.getWinHeight()/1.1;var tree=new Ext.tree.TreePanel({region:"west",width:400,minWidth:240,border:true,enableDD:false,collapseMode:"mini",collapsible:true,split:true,rootVisible:false,iconCls:"task-manager-icon",autoScroll:true,tbar:[{tooltip:"刷新",iconCls:"icon-reload",handler:function(){tree.getRootNode().reload()}},"-",{iconCls:"icon-expand-all",tooltip:"全部展开",handler:function(){tree.getRootNode().expand(true)}},{iconCls:"icon-collapse-all",tooltip:"全部折叠",handler:function(){tree.getRootNode().collapse(true)}},"->","-",{iconCls:"icon-chart-bar",tooltip:"甘特图",handler:function(){node=tree.getSelectionModel().getSelectedNode();if(node){actions.createGanttChart(node.id.substring(node.id.lastIndexOf("-")+1),node.text)}else{Sliver.getDesktop().msg({title:"警告",iconCls:"icon-warn",html:"请选中任务[树]中任务"})}}},{iconCls:"icon-task-add",tooltip:"添加新任务",handler:function(){node=tree.getSelectionModel().getSelectedNode();if(node){actions.addTaskView(node.id.substring(node.id.lastIndexOf("-")+1))}else{actions.addTaskView()}}},{iconCls:"icon-task-edit",tooltip:"更新任务",handler:function(){node=tree.getSelectionModel().getSelectedNode();if(node){actions.updateTaskView(node.id.substring(node.id.lastIndexOf("-")+1))}else{Sliver.getDesktop().msg({title:"警告",iconCls:"icon-warn",html:"请选中任务[树]中需要更新的任务"})}}},"-",{iconCls:"icon-task-remove",tooltip:"删除任务",handler:function(){node=tree.getSelectionModel().getSelectedNode();if(node){actions.removeTaskView(node.id.substring(node.id.lastIndexOf("-")+1),node.text)}else{Sliver.getDesktop().msg({title:"警告",iconCls:"icon-warn",html:"请选中任务[树]中需要删除的任务"})}}}],loader:new Ext.tree.SliverTreeLoader({dataUrl:"task/listTaskTreeByAll.action"}),root:new Ext.tree.AsyncTreeNode({id:"alltask-1",text:"Tasks"})});tree.on("click",function(node,e){if(node){if(true!==node.isLeaf()){store.setDefaultSort("taskID","DESC");store.baseParams={"task.taskPid":node.id.substring(node.id.lastIndexOf("-")+1)};store.load({params:{start:0,limit:20}})}e.stopEvent()}});tree.on("dblclick",function(node,e){if(node){e.stopEvent();actions.updateTaskView(node.id.substring(node.id.lastIndexOf("-")+1))}});var treeMenu;tree.on("contextMenu",function(n,e){if(!n.isSelected()){n.select()}if(!treeMenu){treeMenu=new Ext.menu.Menu([{text:"展开",handler:function(){n.expand()}},{text:"折叠",handler:function(){n.collapse()}},"-",{text:"刷新",handler:function(){n.reload()}},"-",{text:"添加任务",handler:function(){if(n){actions.addTaskView(n.id.substring(n.id.lastIndexOf("-")+1))}else{actions.addTaskView()}}},{text:"更新任务",handler:function(){if(n){actions.updateTaskView(n.id.substring(n.id.lastIndexOf("-")+1))}else{Sliver.getDesktop().msg({title:"警告",iconCls:"icon-warn",html:"请选中任务[树]中需要更新的任务"})}}},"-",{text:"删除任务",handler:function(){if(n){actions.removeTaskView(n.id.substring(n.id.lastIndexOf("-")+1),n.text)}else{Sliver.getDesktop().msg({title:"警告",iconCls:"icon-warn",html:"请选中任务[树]中需要删除的任务"})}}}])}e.stopEvent();treeMenu.showAt(e.getPoint())});var renderState=function(v,p,record,rowIndex){if(100<=record.data.taskPercent){return'<span style="text-decoration:line-through;">'+v+"%</span>"}else{return v+"%"}};var renderComplete=function(v,p,record,rowIndex){if(100<=record.data.taskPercent){return'<span style="text-decoration:line-through;">'+v+"</span>"}else{return v}};var store=new Ext.data.GroupingStore({proxy:new Ext.data.HttpProxy({url:"task/listTaskByAll.action"}),reader:new Ext.data.JsonReader({root:"tasks",totalProperty:"total",id:"taskID",fields:["taskID","taskPid","taskTitle","taskContent","taskBegin","taskEnd","taskPercent","taskFolder","userID","userName"]}),sortInfo:{field:"taskID",direction:"DESC"},remoteSort:true});store.setDefaultSort("taskID","DESC");var iconColumn=new Ext.grid.taskIcon();var cm=new Ext.grid.ColumnModel([iconColumn,{header:"序号",dataIndex:"taskID",width:40},{header:"任务名称",dataIndex:"taskTitle",renderer:renderComplete,width:200},{align:"right",header:"状态",renderer:renderState,dataIndex:"taskPercent",width:30},{align:"right",header:"所属帐户",dataIndex:"userName",width:60},{align:"right",header:"开始日期",dataIndex:"taskBegin",renderer:renderComplete,width:60},{align:"right",header:"结束日期",dataIndex:"taskEnd",renderer:renderComplete,width:60}]);cm.defaultSortable=true;var pageSizePlugin=new Ext.ux.Andrie.pPageSize();var taskFilterParams={"task.taskPid":"","task.taskTitle":"","task.taskContent":"","task.taskBegin":"","task.taskEnd":"","task.taskPn":"","task.taskPercent":""};var taskGridFilterMenu=new Ext.menu.Menu({items:[{text:"任务名称",checked:true,checkHandler:function(){operateOfferParams(this.checked,"task.taskTitle")}},{text:"所属任务名称",checked:true,checkHandler:function(){operateOfferParams(this.checked,"task.taskPn")}},{text:"任务内容",checked:true,checkHandler:function(){operateOfferParams(this.checked,"task.taskContent")}},{text:"开始日期",checked:true,checkHandler:function(){operateOfferParams(this.checked,"task.taskBegin")}},{text:"结束日期",checked:true,checkHandler:function(){operateOfferParams(this.checked,"task.taskEnd")}}]});function operateOfferParams(status,name){if(status===true){taskFilterParams[name]=""}else{taskFilterParams[name]=null}}var filterField=new Ext.form.TextField({});var filterButton=new Ext.Button({iconCls:"icon-search",tooltip:"开始搜索",handler:function(){if(null!==taskFilterParams["task.taskTitle"]){taskFilterParams["task.taskTitle"]=filterField.getValue()}if(null!==taskFilterParams["task.taskPn"]){taskFilterParams["task.taskPn"]=filterField.getValue()}if(null!==taskFilterParams["task.taskContent"]){taskFilterParams["task.taskContent"]=filterField.getValue()}if(null!==taskFilterParams["task.taskBegin"]){taskFilterParams["task.taskBegin"]=filterField.getValue()}if(null!==taskFilterParams["task.taskEnd"]){taskFilterParams["task.taskEnd"]=filterField.getValue()}taskFilterParams["task.taskPercent"]=null;store.baseParams=taskFilterParams;store.load({params:{start:0,limit:pageSizePlugin.getPageSize()}})}});var clearButton=new Ext.Button({iconCls:"icon-clear",tooltip:"清空",handler:function(){filterField.reset();store.baseParams={};store.load({params:{start:0,limit:pageSizePlugin.getPageSize()}})}});var sm=new Ext.grid.RowSelectionModel({singleSelect:true});var grid=new Ext.grid.GridPanel({region:"center",border:true,store:store,cm:cm,sm:sm,loadMask:true,tbar:["-",{iconCls:"icon-task-add",tooltip:"添加新任务",handler:function(){var record=sm.getSelected();if(record){actions.addTaskView(record.data.taskID);store.reload()}else{actions.addTaskView()}}},{iconCls:"icon-task-edit",tooltip:"更新任务",handler:function(){var record=sm.getSelected();if(record){actions.updateTaskView(record.data.taskID);store.reload()}else{Sliver.getDesktop().msg({title:"警告",iconCls:"icon-warn",html:"请选中任务[列表]中需要更新的任务"})}}},"-",{iconCls:"icon-task-remove",tooltip:"删除选中任务",handler:function(){var record=sm.getSelected();if(record){actions.removeTaskView(record.data.taskID,record.data.taskTitle);store.reload()}else{Sliver.getDesktop().msg({title:"警告",iconCls:"icon-warn",html:"请选中任务[列表]中需要删除的任务"})}}},"-",{iconCls:"icon-task-group",tooltip:"按照所属任务分组",handler:function(){store.groupBy("taskPid")}},{iconCls:"icon-time",tooltip:"按照开始日期分组",handler:function(){store.groupBy("taskBegin")}},{iconCls:"icon-grid",tooltip:"不分组",handler:function(){store.clearGrouping()}},"-",{iconCls:"icon-chart-bar",tooltip:"为所选任务生成甘特图",handler:function(){var record=sm.getSelected();if(record){actions.createGanttChart(record.data.taskID,record.data.taskTitle)}else{Sliver.getDesktop().msg({title:"警告",iconCls:"icon-warn",html:"请选中任务[列表]中任务"})}}},"-",{iconCls:"task-all",tooltip:"显示所有任务",handler:function(){if(null!==taskFilterParams["task.taskTitle"]){taskFilterParams["task.taskTitle"]=filterField.getValue()}if(null!==taskFilterParams["task.taskPn"]){taskFilterParams["task.taskPn"]=filterField.getValue()}if(null!==taskFilterParams["task.taskContent"]){taskFilterParams["task.taskContent"]=filterField.getValue()}if(null!==taskFilterParams["task.taskBegin"]){taskFilterParams["task.taskBegin"]=filterField.getValue()}if(null!==taskFilterParams["task.taskEnd"]){taskFilterParams["task.taskEnd"]=filterField.getValue()}taskFilterParams["task.taskPercent"]=null;store.baseParams=taskFilterParams;store.reload()}},{iconCls:"task-complete",tooltip:"显示完成的任务",handler:function(){if(null!==taskFilterParams["task.taskTitle"]){taskFilterParams["task.taskTitle"]=filterField.getValue()}if(null!==taskFilterParams["task.taskPn"]){taskFilterParams["task.taskPn"]=filterField.getValue()}if(null!==taskFilterParams["task.taskContent"]){taskFilterParams["task.taskContent"]=filterField.getValue()}if(null!==taskFilterParams["task.taskBegin"]){taskFilterParams["task.taskBegin"]=filterField.getValue()}if(null!==taskFilterParams["task.taskEnd"]){taskFilterParams["task.taskEnd"]=filterField.getValue()}taskFilterParams["task.taskPercent"]=100;store.baseParams=taskFilterParams;store.reload()}},{iconCls:"task-incomplete",tooltip:"显示未完成任务",handler:function(){if(null!==taskFilterParams["task.taskTitle"]){taskFilterParams["task.taskTitle"]=filterField.getValue()}if(null!==taskFilterParams["task.taskPn"]){taskFilterParams["task.taskPn"]=filterField.getValue()}if(null!==taskFilterParams["task.taskContent"]){taskFilterParams["task.taskContent"]=filterField.getValue()}if(null!==taskFilterParams["task.taskBegin"]){taskFilterParams["task.taskBegin"]=filterField.getValue()}if(null!==taskFilterParams["task.taskEnd"]){taskFilterParams["task.taskEnd"]=filterField.getValue()}taskFilterParams["task.taskPercent"]=0;store.baseParams=taskFilterParams;store.reload()}}],bbar:new Ext.PagingToolbar({plugins:pageSizePlugin,pageSize:20,store:store,items:["-",{text:"搜索范围",menu:taskGridFilterMenu},filterField,filterButton,clearButton]}),view:new Ext.grid.GroupingView({forceFit:true,groupTextTpl:"{text} (子任务: {[values.rs.length]})"})});grid.on("render",function(){store.load({params:{start:0,limit:pageSizePlugin.getPageSize()}})});grid.on("contextmenu",function(e){e.stopEvent()});grid.on("rowdblclick",function(){var record=sm.getSelected();if(record){actions.updateTaskView(record.data.taskID)}});var gridMenu;grid.on("rowcontextmenu",function(grid,rowindex,e){grid.getSelectionModel().selectRow(rowindex,false);if(!gridMenu){gridMenu=new Ext.menu.Menu([{text:"添加任务",handler:function(){var record=sm.getSelected();if(record){actions.addTaskView(record.data.taskID)}else{actions.addTaskView()}}},{text:"更新任务",handler:function(){var record=sm.getSelected();if(record){actions.updateTaskView(record.data.taskID)}else{Sliver.getDesktop().msg({title:"警告",iconCls:"icon-warn",html:"请选中任务[列表]中需要更新的任务"})}}},"-",{text:"删除删除",handler:function(){var record=sm.getSelected();if(record){actions.removeTaskView(record.data.taskID,record.data.taskTitle)}else{Sliver.getDesktop().msg({title:"警告",iconCls:"icon-warn",html:"请选中任务[列表]中需要删除的任务"})}}}])}gridMenu.showAt(e.getPoint());e.stopEvent()});var actions={addTaskView:function(taskID){if(!taskID){taskID=1}Ext.Ajax.request({url:"task/insertTaskAllView.action",method:"post",params:{"task.taskID":taskID},success:function(response){eval(response.responseText)}})},updateTaskView:function(taskID){if(taskID){Ext.Ajax.request({url:"task/updateTaskAllView.action",method:"post",params:{"task.taskID":taskID},success:function(response){eval(response.responseText)}})}},removeTaskView:function(taskID,taskTitle){if(taskID&&taskTitle){Ext.MessageBox.confirm("删除任务","您确定要删除任务["+taskTitle+"]?",function(btn){if(btn=="yes"){Ext.Ajax.request({url:"task/removeTaskAllAction.action",method:"post",params:{"task.taskID":taskID},success:function(response){var result=Ext.decode(response.responseText);if(true===result.success){store.reload()}}})}})}},createGanttChart:function(taskID,taskTitle){var html='<table width="100%" border="0"><tr><td align="center" valign="middle"><img src="task/taskGanttAllView.action?width=760&height=520&task.taskID='+taskID+"&_dc="+new Date().getTime()+'"></td></tr></table>';var tempWin=new Ext.Window({width:800,height:600,resizable:false,layout:"fit",title:"任务["+taskTitle+"]甘特图",html:html,iconCls:"icon-chart-bar",buttonAlign:"right",buttons:[{text:"关闭",handler:function(){tempWin.close()}}]});tempWin.show()}};win=desktop.createWindow({id:this.moduleId,title:"任务管理",width:winWidth,height:winHeight,x:desktop.getWinX(winWidth),y:desktop.getWinY(winHeight),iconCls:"task-manager-icon",shim:false,animCollapse:false,constrainHeader:true,minimizable:true,maximizable:true,border:false,layout:"border",items:[tree,grid],taskbuttonTooltip:"<b>任务管理</b><br />任务，项目管理"})}win.show()}});Sliver.TaskManager=Ext.extend(Ext.app.Module,{moduleType:"task",moduleId:"task-manager",init:function(){this.launcher={handler:this.createWindow,iconCls:"task-manager-icon",scope:this,shortcutIconCls:"task-manager-shortcut",text:"我的任务",tooltip:"<b>我的任务</b><br />我的任务，项目"}},createWindow:function(){var desktop=this.app.getDesktop();var win=desktop.getWindow(this.moduleId);if(!win){var winWidth=desktop.getWinWidth()/1.1;var winHeight=desktop.getWinHeight()/1.1;var tree=new Ext.tree.TreePanel({region:"west",width:400,minWidth:240,border:true,enableDD:false,collapseMode:"mini",collapsible:true,split:true,rootVisible:false,iconCls:"task-manager-icon",autoScroll:true,tbar:[{tooltip:"刷新",iconCls:"icon-reload",handler:function(){tree.getRootNode().reload()}},"-",{iconCls:"icon-expand-all",tooltip:"全部展开",handler:function(){tree.getRootNode().expand(true)}},{iconCls:"icon-collapse-all",tooltip:"全部折叠",handler:function(){tree.getRootNode().collapse(true)}},"->","-",{iconCls:"icon-chart-bar",tooltip:"甘特图",handler:function(){node=tree.getSelectionModel().getSelectedNode();if(node){actions.createGanttChart(node.id.substring(node.id.lastIndexOf("-")+1),node.text)}else{Sliver.getDesktop().msg({title:"警告",iconCls:"icon-warn",html:"请选中任务[树]中任务"})}}},{iconCls:"icon-task-add",tooltip:"添加新任务",handler:function(){node=tree.getSelectionModel().getSelectedNode();if(node){actions.addTaskView(node.id.substring(node.id.lastIndexOf("-")+1))}else{actions.addTaskView()}}},{iconCls:"icon-task-edit",tooltip:"更新任务",handler:function(){node=tree.getSelectionModel().getSelectedNode();if(node){actions.updateTaskView(node.id.substring(node.id.lastIndexOf("-")+1))}else{Sliver.getDesktop().msg({title:"警告",iconCls:"icon-warn",html:"请选中任务[树]中需要更新的任务"})}}},"-",{iconCls:"icon-task-remove",tooltip:"删除任务",handler:function(){node=tree.getSelectionModel().getSelectedNode();if(node){actions.removeTaskView(node.id.substring(node.id.lastIndexOf("-")+1),node.text)}else{Sliver.getDesktop().msg({title:"警告",iconCls:"icon-warn",html:"请选中任务[树]中需要删除的任务"})}}}],loader:new Ext.tree.SliverTreeLoader({dataUrl:"task/listTaskTreeByUser.action"}),root:new Ext.tree.AsyncTreeNode({id:"task-1",text:"Tasks"})});tree.on("click",function(node,e){if(node){if(true!==node.isLeaf()){store.setDefaultSort("taskID","DESC");store.baseParams={"task.taskPid":node.id.substring(node.id.lastIndexOf("-")+1)};store.load({params:{start:0,limit:20}})}e.stopEvent()}});tree.on("dblclick",function(node,e){if(node){e.stopEvent();actions.updateTaskView(node.id.substring(node.id.lastIndexOf("-")+1))}});var treeMenu;tree.on("contextMenu",function(n,e){if(!n.isSelected()){n.select()}if(!treeMenu){treeMenu=new Ext.menu.Menu([{text:"展开",handler:function(){n.expand()}},{text:"折叠",handler:function(){n.collapse()}},"-",{text:"刷新",handler:function(){n.reload()}},"-",{text:"添加任务",handler:function(){if(n){actions.addTaskView(n.id.substring(n.id.lastIndexOf("-")+1))}else{actions.addTaskView()}}},{text:"更新任务",handler:function(){if(n){actions.updateTaskView(n.id.substring(n.id.lastIndexOf("-")+1))}else{Sliver.getDesktop().msg({title:"警告",iconCls:"icon-warn",html:"请选中任务[树]中需要更新的任务"})}}},"-",{text:"删除任务",handler:function(){if(n){actions.removeTaskView(n.id.substring(n.id.lastIndexOf("-")+1),n.text)}else{Sliver.getDesktop().msg({title:"警告",iconCls:"icon-warn",html:"请选中任务[树]中需要删除的任务"})}}}])}e.stopEvent();treeMenu.showAt(e.getPoint())});var renderState=function(v,p,record,rowIndex){if(100<=record.data.taskPercent){return'<span style="text-decoration:line-through;">'+v+"%</span>"}else{return v+"%"}};var renderComplete=function(v,p,record,rowIndex){if(100<=record.data.taskPercent){return'<span style="text-decoration:line-through;">'+v+"</span>"}else{return v}};var store=new Ext.data.GroupingStore({proxy:new Ext.data.HttpProxy({url:"task/listTask.action"}),reader:new Ext.data.JsonReader({root:"tasks",totalProperty:"total",id:"taskID",fields:["taskID","taskPid","taskTitle","taskContent","taskBegin","taskEnd","taskPercent","taskFolder"]}),sortInfo:{field:"taskID",direction:"DESC"},groupField:"taskPid",remoteSort:true});store.setDefaultSort("taskID","DESC");var iconColumn=new Ext.grid.taskIcon();var cm=new Ext.grid.ColumnModel([iconColumn,{header:"序号",dataIndex:"taskID",width:40},{header:"所属任务",dataIndex:"taskPid",renderer:function(v,p,record,rowIndex){return"["+record.data.taskPid+"]"},hidden:true,width:40},{header:"任务名称",dataIndex:"taskTitle",renderer:renderComplete,width:200},{align:"right",header:"状态",renderer:renderState,dataIndex:"taskPercent",width:30},{align:"right",header:"开始日期",dataIndex:"taskBegin",renderer:renderComplete,width:80},{align:"right",header:"结束日期",dataIndex:"taskEnd",renderer:renderComplete,width:80}]);cm.defaultSortable=true;var pageSizePlugin=new Ext.ux.Andrie.pPageSize();var taskFilterParams={"task.taskPid":"","task.taskTitle":"","task.taskContent":"","task.taskBegin":"","task.taskEnd":"","task.taskPercent":""};var taskGridFilterMenu=new Ext.menu.Menu({items:[{text:"任务名称",checked:true,checkHandler:function(){operateOfferParams(this.checked,"task.taskTitle")}},{text:"任务内容",checked:true,checkHandler:function(){operateOfferParams(this.checked,"task.taskContent")}},{text:"开始日期",checked:true,checkHandler:function(){operateOfferParams(this.checked,"task.taskBegin")}},{text:"结束日期",checked:true,checkHandler:function(){operateOfferParams(this.checked,"task.taskEnd")}}]});function operateOfferParams(status,name){if(status===true){taskFilterParams[name]=""}else{taskFilterParams[name]=null}}var filterField=new Ext.form.TextField({});var filterButton=new Ext.Button({iconCls:"icon-search",tooltip:"开始搜索",handler:function(){if(null!==taskFilterParams["task.taskTitle"]){taskFilterParams["task.taskTitle"]=filterField.getValue()}if(null!==taskFilterParams["task.taskContent"]){taskFilterParams["task.taskContent"]=filterField.getValue()}if(null!==taskFilterParams["task.taskBegin"]){taskFilterParams["task.taskBegin"]=filterField.getValue()}if(null!==taskFilterParams["task.taskEnd"]){taskFilterParams["task.taskEnd"]=filterField.getValue()}taskFilterParams["task.taskPercent"]=null;store.baseParams=taskFilterParams;store.load({params:{start:0,limit:pageSizePlugin.getPageSize()}})}});var clearButton=new Ext.Button({iconCls:"icon-clear",tooltip:"清空",handler:function(){filterField.reset();store.baseParams={};store.load({params:{start:0,limit:pageSizePlugin.getPageSize()}})}});var sm=new Ext.grid.RowSelectionModel({singleSelect:true});var grid=new Ext.grid.GridPanel({region:"center",border:true,store:store,cm:cm,sm:sm,loadMask:true,tbar:["-",{iconCls:"icon-task-add",tooltip:"添加新任务",handler:function(){var record=sm.getSelected();if(record){actions.addTaskView(record.data.taskID);store.reload()}else{actions.addTaskView()}}},{iconCls:"icon-task-edit",tooltip:"更新任务",handler:function(){var record=sm.getSelected();if(record){actions.updateTaskView(record.data.taskID);store.reload()}else{Sliver.getDesktop().msg({title:"警告",iconCls:"icon-warn",html:"请选中任务[列表]中需要更新的任务"})}}},"-",{iconCls:"icon-task-remove",tooltip:"删除选中任务",handler:function(){var record=sm.getSelected();if(record){actions.removeTaskView(record.data.taskID,record.data.taskTitle);store.reload()}else{Sliver.getDesktop().msg({title:"警告",iconCls:"icon-warn",html:"请选中任务[列表]中需要删除的任务"})}}},"-",{iconCls:"icon-task-group",tooltip:"按照所属任务分组",handler:function(){store.groupBy("taskPid")}},{iconCls:"icon-time",tooltip:"按照开始日期分组",handler:function(){store.groupBy("taskBegin")}},{iconCls:"icon-grid",tooltip:"不分组",handler:function(){store.clearGrouping()}},"-",{iconCls:"icon-chart-bar",tooltip:"为所选任务生成甘特图",handler:function(){var record=sm.getSelected();if(record){actions.createGanttChart(record.data.taskID,record.data.taskTitle)}else{Sliver.getDesktop().msg({title:"警告",iconCls:"icon-warn",html:"请选中任务[列表]中任务"})}}},"-",{iconCls:"task-all",tooltip:"显示所有任务",handler:function(){if(null!==taskFilterParams["task.taskTitle"]){taskFilterParams["task.taskTitle"]=filterField.getValue()}if(null!==taskFilterParams["task.taskContent"]){taskFilterParams["task.taskContent"]=filterField.getValue()}if(null!==taskFilterParams["task.taskBegin"]){taskFilterParams["task.taskBegin"]=filterField.getValue()}if(null!==taskFilterParams["task.taskEnd"]){taskFilterParams["task.taskEnd"]=filterField.getValue()}taskFilterParams["task.taskPercent"]=null;store.baseParams=taskFilterParams;store.reload()}},{iconCls:"task-complete",tooltip:"显示完成的任务",handler:function(){if(null!==taskFilterParams["task.taskTitle"]){taskFilterParams["task.taskTitle"]=filterField.getValue()}if(null!==taskFilterParams["task.taskContent"]){taskFilterParams["task.taskContent"]=filterField.getValue()}if(null!==taskFilterParams["task.taskBegin"]){taskFilterParams["task.taskBegin"]=filterField.getValue()}if(null!==taskFilterParams["task.taskEnd"]){taskFilterParams["task.taskEnd"]=filterField.getValue()}taskFilterParams["task.taskPercent"]=100;store.baseParams=taskFilterParams;store.reload()}},{iconCls:"task-incomplete",tooltip:"显示未完成任务",handler:function(){if(null!==taskFilterParams["task.taskTitle"]){taskFilterParams["task.taskTitle"]=filterField.getValue()}if(null!==taskFilterParams["task.taskContent"]){taskFilterParams["task.taskContent"]=filterField.getValue()}if(null!==taskFilterParams["task.taskBegin"]){taskFilterParams["task.taskBegin"]=filterField.getValue()}if(null!==taskFilterParams["task.taskEnd"]){taskFilterParams["task.taskEnd"]=filterField.getValue()}taskFilterParams["task.taskPercent"]=0;store.baseParams=taskFilterParams;store.reload()}}],bbar:new Ext.PagingToolbar({plugins:pageSizePlugin,pageSize:20,store:store,items:["-",{text:"搜索范围",menu:taskGridFilterMenu},filterField,filterButton,clearButton]}),view:new Ext.grid.GroupingView({forceFit:true,groupTextTpl:"{text} (子任务: {[values.rs.length]})"})});grid.on("render",function(){store.load({params:{start:0,limit:pageSizePlugin.getPageSize()}})});grid.on("contextmenu",function(e){e.stopEvent()});grid.on("rowdblclick",function(){var record=sm.getSelected();if(record){actions.updateTaskView(record.data.taskID)}});var gridMenu;grid.on("rowcontextmenu",function(grid,rowindex,e){grid.getSelectionModel().selectRow(rowindex,false);if(!gridMenu){gridMenu=new Ext.menu.Menu([{text:"添加任务",handler:function(){var record=sm.getSelected();if(record){actions.addTaskView(record.data.taskID)}else{actions.addTaskView()}}},{text:"更新任务",handler:function(){var record=sm.getSelected();if(record){actions.updateTaskView(record.data.taskID)}else{Sliver.getDesktop().msg({title:"警告",iconCls:"icon-warn",html:"请选中任务[列表]中需要更新的任务"})}}},"-",{text:"删除删除",handler:function(){var record=sm.getSelected();if(record){actions.removeTaskView(record.data.taskID,record.data.taskTitle)}else{Sliver.getDesktop().msg({title:"警告",iconCls:"icon-warn",html:"请选中任务[列表]中需要删除的任务"})}}}])}gridMenu.showAt(e.getPoint());e.stopEvent()});var actions={addTaskView:function(taskID){if(!taskID){taskID=1}Ext.Ajax.request({url:"task/insertTaskUserView.action",method:"post",params:{"task.taskID":taskID},success:function(response){eval(response.responseText)}})},updateTaskView:function(taskID){if(taskID){Ext.Ajax.request({url:"task/updateTaskUserView.action",method:"post",params:{"task.taskID":taskID},success:function(response){eval(response.responseText)}})}},removeTaskView:function(taskID,taskTitle){if(taskID&&taskTitle){Ext.MessageBox.confirm("删除任务","您确定要删除任务["+taskTitle+"]?",function(btn){if(btn=="yes"){Ext.Ajax.request({url:"task/removeTaskUserAction.action",method:"post",params:{"task.taskID":taskID},success:function(response){var result=Ext.decode(response.responseText);if(true===result.success){store.reload()}}})}})}},createGanttChart:function(taskID,taskTitle){var html='<table width="100%" border="0"><tr><td align="center" valign="middle"><img src="task/taskGanttUserView.action?width=760&height=520&task.taskID='+taskID+"&_dc="+new Date().getTime()+'"></td></tr></table>';var tempWin=new Ext.Window({width:800,height:600,resizable:false,layout:"fit",title:"任务["+taskTitle+"]甘特图",html:html,iconCls:"icon-chart-bar",buttonAlign:"right",buttons:[{text:"关闭",handler:function(){tempWin.close()}}]});tempWin.show()}};win=desktop.createWindow({id:this.moduleId,title:"我的任务",width:winWidth,height:winHeight,x:desktop.getWinX(winWidth),y:desktop.getWinY(winHeight),iconCls:"task-manager-icon",shim:false,animCollapse:false,constrainHeader:true,minimizable:true,maximizable:true,border:false,layout:"border",items:[tree,grid],taskbuttonTooltip:"<b>我的任务</b><br />我的任务，项目"})}win.show()}});Sliver.UserManager=Ext.extend(Ext.app.Module,{moduleType:"system",moduleId:"user-manager",init:function(){this.launcher={handler:this.createWindow,iconCls:"icon-user",scope:this,shortcutIconCls:"user-shortcut",text:"用户管理",tooltip:"<b>用户管理</b><br />系统用户管理"}},createWindow:function(){var desktop=this.app.getDesktop();var win=desktop.getWindow(this.moduleId);if(!win){var winWidth=desktop.getWinWidth()/1.1;var winHeight=desktop.getWinHeight()/1.1;var grouptree=new Ext.tree.TreePanel({useArrows:true,autoScroll:true,animate:true,dropConfig:{appendOnly:true},enableDD:true,containerScroll:true,rootVisible:true,loader:new Ext.tree.SliverTreeLoader({dataUrl:"system/listGroupTree.action"}),root:new Ext.tree.AsyncTreeNode({id:"group-0",text:"组织架构",draggable:false,expanded:true,singleClickExpand:false}),tbar:[{tooltip:"重新加载",iconCls:"icon-reload",handler:function(){grouptree.getRootNode().reload()}},"-",{iconCls:"icon-expand-all",tooltip:"全部展开",handler:function(){grouptree.getRootNode().expand(true)}},{iconCls:"icon-collapse-all",tooltip:"全部折叠",handler:function(){grouptree.getRootNode().collapse(true)}}],region:"west",collapseMode:"mini",autoScroll:true,collapsible:true,margins:"0 0 0 0",split:true,border:true,width:parseFloat(winWidth*0.3)<201?parseFloat(winWidth*0.3):200});var store=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:"system/listUserRecord.action"}),reader:new Ext.data.JsonReader({root:"list",totalProperty:"total",id:"recordID",fields:["recordID","userName","recordIP","recordStatus","recordDatetime","ipCountry","ipLocal"]}),remoteSort:false});store.setDefaultSort("recordID","DESC");function renderStatus(v){if(v===true){return'<span style="font-weight:bold;color:green">登陆</span>'}else{return'<span style="font-weight:bold;color:red">退出</span>'}}var cm=new Ext.grid.ColumnModel([{header:"序号",dataIndex:"recordID",width:40},{header:"用户名",dataIndex:"userName",width:40},{header:"状态",dataIndex:"recordStatus",renderer:renderStatus,width:40},{align:"right",header:"IP地址",dataIndex:"recordIP",width:60},{header:"地域",dataIndex:"ipCountry",width:100},{header:"类型",dataIndex:"ipLocal",width:100},{align:"right",header:"时间",dataIndex:"recordDatetime",width:60}]);cm.defaultSortable=true;var filterRecord=function(){grid.reconfigure(store,cm);store.baseParams={userName:filterField.getValue()};store.setDefaultSort("recordID","DESC");store.load({params:{start:0,limit:pageSizePlugin.getPageSize()}})};var filterField=new Ext.form.TextField({});var filterButton=new Ext.Button({iconCls:"icon-search",tooltip:"开始搜索",handler:filterRecord});var clearButton=new Ext.Button({iconCls:"icon-clear",tooltip:"清空",handler:function(){filterField.reset();store.baseParams={userName:""};store.reload()}});var pageSizePlugin=new Ext.ux.Andrie.pPageSize();var grid=new Ext.grid.GridPanel({border:false,viewConfig:{forceFit:true},store:store,cm:cm,sm:new Ext.grid.RowSelectionModel({singleSelect:true}),loadMask:true,bbar:new Ext.PagingToolbar({plugins:pageSizePlugin,pageSize:20,store:store,displayInfo:true,displayMsg:"显示 {0} - {1} 共{2}",emptyMsg:"",items:["-","过滤用户",filterField,filterButton,clearButton]})});grid.on("render",function(){store.load({params:{start:0,limit:pageSizePlugin.getPageSize()}})});grid.on("contextmenu",function(e){e.stopEvent()});var ustore=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:"system/listUser.action"}),reader:new Ext.data.JsonReader({root:"list",totalProperty:"total",id:"userID",fields:["userID","userName","userGender","userBirthdate","userRole","groupName","userPhone","userMobile","userEmail"]}),remoteSort:true});ustore.setDefaultSort("userID","ASC");var ucm=new Ext.grid.ColumnModel([{header:"编号",dataIndex:"userID",width:40},{header:"用户名",dataIndex:"userName",width:80},{header:"性别",dataIndex:"userGender",renderer:SliverUtil.renderGender,width:40},{header:"出生日期",dataIndex:"userBirthdate",width:60},{header:"职位",dataIndex:"userRole",width:60},{header:"部门",dataIndex:"groupName",width:60},{header:"电话",dataIndex:"userPhone",widht:60},{header:"移动电话",hidden:true,dataIndex:"userMobile",width:60},{header:"电子邮件",dataIndex:"userEmail",width:100}]);ucm.defaultSortable=true;var filterUserParams={"user.userName":"","user.userBirthdate":"","user.userRole":"","user.groupID":"","user.groupName":"","user.userPhone":"","user.userMobile":"","user.userEmail":""};var userGridFilterMenu=new Ext.menu.Menu({id:"userGridFilterMenu",items:[{text:"帐户",checked:true,checkHandler:function(){operateUserGridParams(this.checked,"user.userName")}},{text:"出生日期",checked:true,checkHandler:function(){operateUserGridParams(this.checked,"user.userBirthdate")}},{text:"职位",checked:true,checkHandler:function(){operateUserGridParams(this.checked,"user.userRole")}},{text:"部门",checked:true,checkHandler:function(){operateUserGridParams(this.checked,"user.groupName")}},{text:"电话",checked:true,checkHandler:function(){operateUserGridParams(this.checked,"user.userPhone")}},{text:"移动电话",checked:true,checkHandler:function(){operateUserGridParams(this.checked,"user.userMobile")}},{text:"电子邮件",checked:true,checkHandler:function(){operateUserGridParams(this.checked,"user.userEmail")}}]});function operateUserGridParams(status,name){if(status===true){filterUserParams[name]=""}else{filterUserParams[name]=null}}var filterUserButton=new Ext.Button({iconCls:"icon-search",tooltip:"开始搜索",handler:function(){if(null!==filterUserParams["user.userName"]){filterUserParams["user.userName"]=filterUserField.getValue()}if(null!==filterUserParams["user.userBirthdate"]){filterUserParams["user.userBirthdate"]=filterUserField.getValue()}if(null!==filterUserParams["user.userRole"]){filterUserParams["user.userRole"]=filterUserField.getValue()}if(null!==filterUserParams["user.groupName"]){filterUserParams["user.groupName"]=filterUserField.getValue()}if(null!==filterUserParams["user.userPhone"]){filterUserParams["user.userPhone"]=filterUserField.getValue()}if(null!==filterUserParams["user.userMobile"]){filterUserParams["user.userMobile"]=filterUserField.getValue()}if(null!==filterUserParams["user.userEmail"]){filterUserParams["user.userEmail"]=filterUserField.getValue()}ustore.baseParams=filterUserParams;ustore.setDefaultSort("userID","ASC");ustore.load({params:{start:0,limit:uPageSizePlugin.getPageSize()}})}});var filterUserField=new Ext.form.TextField({});var clearUserButton=new Ext.Button({iconCls:"icon-clear",tooltip:"清空",handler:function(){filterUserField.reset();ustore.baseParams={};ustore.setDefaultSort("userID","ASC");ustore.load({params:{start:0,limit:uPageSizePlugin.getPageSize()}})}});var ugridsm=new Ext.grid.RowSelectionModel({singleSelect:true});var loadUserGridView=function(){var record=ugridsm.getSelected();if(record){var tabID=main.id+"-"+record.data.userID;var tab=main.getComponent(tabID);if(tab){tab.setTitle(record.data.userName);tab.body.getUpdater().update({scripts:true,method:"post",params:{userID:record.data.userID,containerID:tab.body.id},url:"system/getUserByIDView.action"});main.setActiveTab(tab)}else{var temp=new Ext.Panel({id:tabID,autoScroll:true,iconCls:"icon-user",title:record.data.userName,closable:true});temp.on("render",function(){temp.load({scripts:true,method:"post",params:{userID:record.data.userID,containerID:temp.body.id},url:"system/getUserByIDView.action"})});var p=main.add(temp);main.setActiveTab(p)}}};var updateUserGridView=function(){var record=ugridsm.getSelected();if(record){var tabID=main.id+"-"+record.data.userID;var tab=main.getComponent(tabID);if(tab){tab.body.getUpdater().update({scripts:true,method:"post",params:{userID:record.data.userID,containerID:tab.body.id},url:"system/updateUserView.action"});main.setActiveTab(tab)}else{var temp=new Ext.Panel({id:tabID,autoScroll:true,iconCls:"icon-user",title:record.data.userName,closable:true});temp.on("render",function(){temp.load({scripts:true,method:"post",params:{userID:record.data.userID,containerID:temp.body.id},url:"system/updateUserView.action"})});var p=main.add(temp);main.setActiveTab(p)}}};var updateUserModuleGridView=function(){var record=ugridsm.getSelected();if(record){var tabID=main.id+"-"+record.data.userID;var tab=main.getComponent(tabID);if(tab){tab.setTitle("["+record.data.userName+"]权限");tab.body.getUpdater().update({scripts:true,method:"post",params:{userID:record.data.userID,containerID:tab.body.id},url:"system/updateUserModuleView.action"});main.setActiveTab(tab)}else{var temp=new Ext.Panel({id:tabID,autoScroll:true,iconCls:"icon-user",title:"["+record.data.userName+"]权限",closable:true});temp.on("render",function(){temp.load({scripts:true,method:"post",params:{userID:record.data.userID,containerID:temp.body.id},url:"system/updateUserModuleView.action"})});var p=main.add(temp);main.setActiveTab(p)}}};var removeUserGridView=function(){var record=ugridsm.getSelected();if(record){Ext.MessageBox.confirm("删除用户","您确定要删用户 <b>"+record.data.userName+"</b>?",function(btn){if(btn=="yes"){Ext.Ajax.request({url:"system/deleteUser.action",params:{userID:record.data.userID},success:function(response){var j=Ext.decode(response.responseText);if(j.success===true){if(record){var tabID=main.id+"-"+record.data.userID;var tab=main.getComponent(tabID);if(tab){main.remove(tab,true)}ustore.remove(record)}}}})}})}};var uPageSizePlugin=new Ext.ux.Andrie.pPageSize();var ugrid=new Ext.grid.GridPanel({border:false,viewConfig:{forceFit:true},store:ustore,cm:ucm,sm:ugridsm,loadMask:true,bbar:new Ext.PagingToolbar({plugins:uPageSizePlugin,pageSize:20,store:ustore,displayInfo:true,displayMsg:"显示 {0} - {1} 共{2}",emptyMsg:"",items:["-",{text:"查询范围",menu:userGridFilterMenu},filterUserField,filterUserButton,clearUserButton]})});ugrid.on("render",function(){ustore.load({params:{start:0,limit:uPageSizePlugin.getPageSize()}})});ugrid.on("rowdblclick",loadUserGridView);var ugridmenu;ugrid.on("rowcontextmenu",function(ugrid,rowindex,e){ugrid.getSelectionModel().selectRow(rowindex,false);if(!ugridmenu){ugridmenu=new Ext.menu.Menu([{id:"updateUserGridViewMenu",text:"更新用户",handler:updateUserGridView},{id:"updateUserModuleGridViewMenu",text:"更新用户权限",handler:updateUserModuleGridView},{text:"查看销售业绩",handler:function(){var record=ugridsm.getSelected();if(record){saleStateView(record.data.userID,record.data.userName)}}},{text:"查看业务数量",handler:function(){var record=ugridsm.getSelected();if(record){orderStateView(record.data.userID,record.data.userName)}}},"-",{id:"removeContactRecordGridContextView",text:"删除用户",handler:removeUserGridView}])}ugridmenu.showAt(e.getPoint());e.stopEvent()});var main=new Ext.TabPanel({id:"user-manager-body",region:"center",margins:"0 0 0 0",resizeTabs:true,minTabWidth:135,tabWidth:160,plugins:new Ext.ux.TabCloseMenu(),enableTabScroll:true,border:true,activeTab:0,autoDestroy:true,items:[{id:"user-manager-userlist",closable:false,title:"用户列表",autoScroll:true,layout:"fit",items:ugrid,iconCls:"icon-user"},{id:"user-manager-welcome",closable:false,title:"用户记录",autoScroll:true,layout:"fit",items:grid,iconCls:"icon-grid"}]});grouptree.on("click",function(node,e){if(!node.isSelected()){node.select()}if(true!==node.isLeaf()){ustore.setDefaultSort("userID","ASC");ustore.baseParams={"user.groupID":node.id.substring(node.id.lastIndexOf("-")+1)};ustore.load({params:{start:0,limit:20}});main.setActiveTab(main.getComponent("user-manager-userlist"))}});grouptree.on("dblclick",function(node,e){if(!node.isSelected()){node.select()}node=sm.getSelectedNode();if(node.isLeaf()){e.stopEvent();loadUser(node)}});var sm=grouptree.getSelectionModel();var cmenu;grouptree.on("contextMenu",function(n,e){if(!n.isSelected()){n.select()}if(!cmenu){cmenu=new Ext.menu.Menu([{id:"expandGrouptreeItem",text:"展开",handler:expandNode},{id:"collapseGrouptreeItem",text:"折叠",handler:collapseNode},"-",{id:"reloadGrouptreeNode",text:"刷新",handler:reloadNode},"-",{text:"新建",id:"createInGrouptree",menu:{items:[{id:"addGroupView",text:"部门",handler:insertGroupView},{id:"addUserView",text:"用户",handler:insertUserView}]}},{id:"updateGrouptreeItem",text:"修改",handler:updateNode},{id:"updateUserConfig",text:"设置权限",handler:updateUserModule},{id:"userSaleState",text:"销售业绩",handler:function(){var node=sm.getSelectedNode();if(node){saleStateView(node.id.substring(node.id.lastIndexOf("-")+1),node.text.substring(0,node.text.indexOf("(")))}}},{id:"userOrderState",text:"业务数量",handler:function(){var node=sm.getSelectedNode();if(node){orderStateView(node.id.substring(node.id.lastIndexOf("-")+1),node.text.substring(0,node.text.indexOf("(")))}}},"-",{id:"deleteGrouptreeItem",text:"删除",handler:deleteNode}])}var is=cmenu.items;if(n.isLeaf()){is.get("createInGrouptree").hide();is.get("updateUserConfig").show();is.get("userSaleState").show();is.get("userOrderState").show();is.get("reloadGrouptreeNode").setDisabled(true);is.get("expandGrouptreeItem").setDisabled(true);is.get("collapseGrouptreeItem").setDisabled(true)}else{is.get("updateUserConfig").hide();is.get("createInGrouptree").show();is.get("userSaleState").hide();is.get("userOrderState").hide();is.get("reloadGrouptreeNode").setDisabled(false);is.get("expandGrouptreeItem").setDisabled(n.isExpanded());is.get("collapseGrouptreeItem").setDisabled(!n.isExpanded())}cmenu.showAt(e.getPoint())});grouptree.on("movenode",function(grouptree,node,oldParent,newParent,index){if(node){if(node.isLeaf()){moveUser(grouptree,node,oldParent,newParent,index)}else{moveGroup(grouptree,node,oldParent,newParent,index)}}});function reloadNode(){var node=sm.getSelectedNode();if(node){node.reload()}else{grouptree.getRootNode().reload();sm.select(grouptree.getRootNode())}}function expandNode(){var node=sm.getSelectedNode();if(node){node.expand()}else{grouptree.getRootNode().expand();sm.select(grouptree.getRootNode())}}function collapseNode(){var node=sm.getSelectedNode();if(node){node.collapse()}else{grouptree.getRootNode().collapse();sm.select(grouptree.getRootNode())}}function loadUser(){var node=sm.getSelectedNode();if(node){var tabID=main.id+"-"+node.id;var tab=main.getComponent(tabID);if(tab){tab.setTitle(node.text.substring(0,(node.text.indexOf("(")==-1?node.text.length:node.text.indexOf("("))));tab.body.getUpdater().update({scripts:true,method:"post",params:{userID:node.id.substring(node.id.lastIndexOf("-")+1),containerID:tab.body.id},url:"system/getUserByIDView.action"});main.setActiveTab(tab)}else{var temp=new Ext.Panel({id:tabID,autoScroll:true,iconCls:"icon-user",title:node.text.substring(0,(node.text.indexOf("(")==-1?node.text.length:node.text.indexOf("("))),closable:true});temp.on("render",function(){temp.load({scripts:true,method:"post",params:{userID:node.id.substring(node.id.lastIndexOf("-")+1),containerID:temp.body.id},url:"system/getUserByIDView.action"})});var p=main.add(temp);main.setActiveTab(p)}}}function updateUserModule(){var node=sm.getSelectedNode();if(node){var tabID=main.id+"-"+node.id;var tab=main.getComponent(tabID);if(tab){tab.setTitle("["+node.text.substring(0,(node.text.indexOf("(")==-1?node.text.length:node.text.indexOf("(")))+"]权限");tab.body.getUpdater().update({scripts:true,method:"post",params:{userID:node.id.substring(node.id.lastIndexOf("-")+1),containerID:tab.body.id},url:"system/updateUserModuleView.action"});main.setActiveTab(tab)}else{var temp=new Ext.Panel({id:tabID,autoScroll:true,iconCls:"icon-user",title:"["+node.text.substring(0,(node.text.indexOf("(")==-1?node.text.length:node.text.indexOf("(")))+"]权限",closable:true});temp.on("render",function(){temp.load({scripts:true,method:"post",params:{userID:node.id.substring(node.id.lastIndexOf("-")+1),containerID:temp.body.id},url:"system/updateUserModuleView.action"})});var p=main.add(temp);main.setActiveTab(p)}}}function insertGroupView(){var node=sm.getSelectedNode();if(node){Ext.Ajax.request({url:"system/insertGroupView.action",params:{groupPID:node.id.substring(node.id.lastIndexOf("-")+1)},success:function(response){eval(response.responseText)}})}}function insertUserView(){var node=sm.getSelectedNode();if(node){var tabID=Ext.id();var temp=new Ext.Panel({id:tabID,title:"添加用户",closable:true,autoScroll:true});temp.on("render",function(){temp.load({scripts:true,method:"post",params:{groupID:node.id.substring(node.id.lastIndexOf("-")+1),containerID:tabID},url:"system/insertUserView.action"})});var p=main.add(temp);main.setActiveTab(p)}}var deleteNode=function(){var node=sm.getSelectedNode();if(node){if(node.isLeaf()){deleteUser(node)}else{deleteGroup(node)}}};var deleteGroup=function(node){Ext.MessageBox.confirm("删除部门","您确定要删除部门 <b>"+node.text+"</b>?<br/>注意：将会删除该部门下的所有部门及用户",function(btn){if(btn=="yes"){Ext.Ajax.request({url:"system/deleteGroup.action",params:{groupID:node.id.substring(node.id.lastIndexOf("-")+1)},success:function(response){node.remove()}})}})};var deleteUser=function(node){Ext.MessageBox.confirm("删除用户","您确定要删用户 <b>"+node.text+"</b>?",function(btn){if(btn=="yes"){Ext.Ajax.request({url:"system/deleteUser.action",params:{userID:node.id.substring(node.id.lastIndexOf("-")+1)},success:function(response){var j=Ext.decode(response.responseText);if(j.success===true){if(node){var tabID=main.id+"-"+node.id;var tab=main.getComponent(tabID);if(tab){main.remove(tab,true)}node.remove()}}}})}})};var updateNode=function(){var node=sm.getSelectedNode();if(node){if(node.isLeaf()){updateUserView(node)}else{updateGroupView(node)}}};var updateGroupView=function(node){Ext.Ajax.request({url:"system/updateGroupView.action",params:{groupID:node.id.substring(node.id.lastIndexOf("-")+1)},success:function(response){eval(response.responseText)}})};var updateUserView=function(node){var tabID=main.id+"-"+node.id;var tab=main.getComponent(tabID);if(tab){tab.body.getUpdater().update({scripts:true,method:"post",params:{userID:node.id.substring(node.id.lastIndexOf("-")+1),containerID:tab.body.id},url:"system/updateUserView.action"});main.setActiveTab(tab)}else{var temp=new Ext.Panel({id:tabID,autoScroll:true,iconCls:"icon-user",title:node.text,closable:true});temp.on("render",function(){temp.load({scripts:true,method:"post",params:{userID:node.id.substring(node.id.lastIndexOf("-")+1),containerID:temp.body.id},url:"system/updateUserView.action"})});var p=main.add(temp);main.setActiveTab(p)}};var moveGroup=function(grouptree,node,oldParent,newParent,index){if(oldParent.id!=newParent.id){Ext.Ajax.request({url:"system/moveGroup.action",params:{groupID:node.id.substring(node.id.lastIndexOf("-")+1),groupPID:newParent.id.substring(node.id.lastIndexOf("-")+1)},success:function(response){var s=Ext.decode(response.responseText);if(s.success){}}})}};var moveUser=function(grouptree,node,oldParent,newParent,index){if(oldParent.id!=newParent.id){Ext.Ajax.request({url:"system/moveUser.action",params:{userID:node.id.substring(node.id.lastIndexOf("-")+1),groupID:newParent.id.substring(newParent.id.lastIndexOf("-")+1)},success:function(response){var s=Ext.decode(response.responseText);if(s.success){var tabID=main.id+"-"+node.id;var tab=main.getComponent(tabID);if(tab){tab.body.getUpdater().update({scripts:true,method:"post",params:{userID:node.id.substring(node.id.lastIndexOf("-")+1)},url:"system/getUserByIDView.action"});main.setActiveTab(tab)}}}})}};var saleStateView=function(userID,userName){var tabID=main.id+"-saleState-"+userID;var temp=main.getComponent(tabID);if(!temp){var temp=new Ext.Panel({id:tabID,iconCls:"icon-chart-line",autoScroll:true,title:"("+userName+")销售业绩",closable:true});temp.on("render",function(){temp.load({scripts:true,method:"post",params:{containerID:temp.body.id,userID:userID,userName:userName},url:"system/userSaleStatePanel.jsp"})});var p=main.add(temp);main.setActiveTab(p)}else{temp.body.getUpdater().update({scripts:true,method:"post",params:{containerID:temp.body.id,userID:userID,userName:userName},url:"system/userSaleStatePanel.jsp"});main.setActiveTab(temp)}};var orderStateView=function(userID,userName){var tabID=main.id+"-orderState-"+userID;var temp=main.getComponent(tabID);if(!temp){var temp=new Ext.Panel({id:tabID,iconCls:"icon-chart-curve",autoScroll:true,title:"("+userName+")业务数量",closable:true});temp.on("render",function(){temp.load({scripts:true,method:"post",params:{containerID:temp.body.id,userID:userID,userName:userName},url:"system/userOrderStatePanel.jsp"})});var p=main.add(temp);main.setActiveTab(p)}else{temp.body.getUpdater().update({scripts:true,method:"post",params:{containerID:temp.body.id,userID:userID,userName:userName},url:"system/userOrderStatePanel.jsp"});main.setActiveTab(temp)}};win=desktop.createWindow({id:this.moduleId,title:"用户管理",width:winWidth,height:winHeight,x:desktop.getWinX(winWidth),y:desktop.getWinY(winHeight),iconCls:"icon-user",shim:false,animCollapse:false,constrainHeader:true,minimizable:true,maximizable:true,border:true,layout:"border",items:[grouptree,main],taskbuttonTooltip:"<b>用户管理</b><br />系统用户管理"})}win.show()}});Sliver.WebForum=Ext.extend(Ext.app.Module,{moduleType:"web",moduleId:"web-forum",init:function(){this.launcher={handler:this.createWindow,iconCls:"web-forum-icon",scope:this,shortcutIconCls:"web-forum-shortcut",text:"论坛",tooltip:"<b>论坛</b><br />论坛交流"}},createWindow:function(){var E=this.app.getDesktop();var D=E.getWindow(this.moduleId);if(!D){var C=E.getWinWidth();var B=E.getWinHeight();var A=new Ext.Panel({id:"web-forum-body",region:"center",margins:"0 0 0 0",border:true,autoScroll:false,html:'<iframe width="100%" height="100%" border="no" src="http://www.slivercrm.cn/forum"></iframe>'});D=E.createWindow({id:this.moduleId,title:"讨论",width:C,height:B,x:E.getWinX(C),y:E.getWinY(B),iconCls:"web-forum-icon",shim:false,autoScroll:false,animCollapse:false,constrainHeader:true,minimizable:true,maximizable:false,border:false,layout:"border",items:A,taskbuttonTooltip:"<b>论坛讨论</b><br />到论坛讨论"})}D.show()}});