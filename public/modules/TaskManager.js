
//~~~
Sliver.TaskCreater=Ext.extend(Ext.app.Module,{
    moduleType:"task",
    moduleId:"task-creater",
    init:function(){
        this.launcher={
            handler:this.createWindow,
            iconCls:"task-manager-icon",
            scope:this,
            shortcutIconCls:"task-creater-shortcut",
            text:"任务管理",
            tooltip:"<b>任务管理</b><br />任务，项目管理"
        }
    },
    createWindow:function(){
        var desktop=this.app.getDesktop();var win=desktop.getWindow(this.moduleId);if(!win){
            var winWidth=desktop.getWinWidth()/1.1;var winHeight=desktop.getWinHeight()/1.1;var tree=new Ext.tree.TreePanel({
                region:"west",
                width:400,
                minWidth:240,
                border:true,
                enableDD:false,
                collapseMode:"mini",
                collapsible:true,
                split:true,
                rootVisible:false,
                iconCls:"task-manager-icon",
                autoScroll:true,
                tbar:[{
                        tooltip:"刷新",
                        iconCls:"icon-reload",
                        handler:function(){
                            tree.getRootNode().reload()
                        }
                    },"-",{
                        iconCls:"icon-expand-all",
                        tooltip:"全部展开",
                        handler:function(){
                            tree.getRootNode().expand(true)
                        }
                    },{
                        iconCls:"icon-collapse-all",
                        tooltip:"全部折叠",
                        handler:function(){
                            tree.getRootNode().collapse(true)
                        }
                    },"->","-",{
                        iconCls:"icon-chart-bar",
                        tooltip:"甘特图",
                        handler:function(){
                            node=tree.getSelectionModel().getSelectedNode();if(node){
                                actions.createGanttChart(node.id.substring(node.id.lastIndexOf("-")+1),node.text)
                            }else{
                                Sliver.getDesktop().msg({
                                    title:"警告",
                                    iconCls:"icon-warn",
                                    html:"请选中任务[树]中任务"
                                })
                            }
                        }
                    },{
                        iconCls:"icon-task-add",
                        tooltip:"添加新任务",
                        handler:function(){
                            node=tree.getSelectionModel().getSelectedNode();if(node){
                                actions.addTaskView(node.id.substring(node.id.lastIndexOf("-")+1))
                            }else{
                                actions.addTaskView()
                            }
                        }
                    },{
                        iconCls:"icon-task-edit",
                        tooltip:"更新任务",
                        handler:function(){
                            node=tree.getSelectionModel().getSelectedNode();if(node){
                                actions.updateTaskView(node.id.substring(node.id.lastIndexOf("-")+1))
                            }else{
                                Sliver.getDesktop().msg({
                                    title:"警告",
                                    iconCls:"icon-warn",
                                    html:"请选中任务[树]中需要更新的任务"
                                })
                            }
                        }
                    },"-",{
                        iconCls:"icon-task-remove",
                        tooltip:"删除任务",
                        handler:function(){
                            node=tree.getSelectionModel().getSelectedNode();if(node){
                                actions.removeTaskView(node.id.substring(node.id.lastIndexOf("-")+1),node.text)
                            }else{
                                Sliver.getDesktop().msg({
                                    title:"警告",
                                    iconCls:"icon-warn",
                                    html:"请选中任务[树]中需要删除的任务"
                                })
                            }
                        }
                    }],
                loader:new Ext.tree.SliverTreeLoader({
                    dataUrl:"task/listTaskTreeByAll.action"
                }),
                root:new Ext.tree.AsyncTreeNode({
                    id:"alltask-1",
                    text:"Tasks"
                })
            });tree.on("click",function(node,e){
                if(node){
                    if(true!==node.isLeaf()){
                        store.setDefaultSort("taskID","DESC");store.baseParams={
                            "task.taskPid":node.id.substring(node.id.lastIndexOf("-")+1)
                        };store.load({
                            params:{
                                start:0,
                                limit:20
                            }
                        })
                    }e.stopEvent()
                }
            });tree.on("dblclick",function(node,e){
                if(node){
                    e.stopEvent();actions.updateTaskView(node.id.substring(node.id.lastIndexOf("-")+1))
                }
            });var treeMenu;tree.on("contextMenu",function(n,e){
                if(!n.isSelected()){
                    n.select()
                }if(!treeMenu){
                    treeMenu=new Ext.menu.Menu([{
                            text:"展开",
                            handler:function(){
                                n.expand()
                            }
                        },{
                            text:"折叠",
                            handler:function(){
                                n.collapse()
                            }
                        },"-",{
                            text:"刷新",
                            handler:function(){
                                n.reload()
                            }
                        },"-",{
                            text:"添加任务",
                            handler:function(){
                                if(n){
                                    actions.addTaskView(n.id.substring(n.id.lastIndexOf("-")+1))
                                }else{
                                    actions.addTaskView()
                                }
                            }
                        },{
                            text:"更新任务",
                            handler:function(){
                                if(n){
                                    actions.updateTaskView(n.id.substring(n.id.lastIndexOf("-")+1))
                                }else{
                                    Sliver.getDesktop().msg({
                                        title:"警告",
                                        iconCls:"icon-warn",
                                        html:"请选中任务[树]中需要更新的任务"
                                    })
                                }
                            }
                        },"-",{
                            text:"删除任务",
                            handler:function(){
                                if(n){
                                    actions.removeTaskView(n.id.substring(n.id.lastIndexOf("-")+1),n.text)
                                }else{
                                    Sliver.getDesktop().msg({
                                        title:"警告",
                                        iconCls:"icon-warn",
                                        html:"请选中任务[树]中需要删除的任务"
                                    })
                                }
                            }
                        }])
                }e.stopEvent();treeMenu.showAt(e.getPoint())
            });var renderState=function(v,p,record,rowIndex){
                if(100<=record.data.taskPercent){
                    return'<span style="text-decoration:line-through;">'+v+"%</span>"
                }else{
                    return v+"%"
                }
            };var renderComplete=function(v,p,record,rowIndex){
                if(100<=record.data.taskPercent){
                    return'<span style="text-decoration:line-through;">'+v+"</span>"
                }else{
                    return v
                }
            };var store=new Ext.data.GroupingStore({
                proxy:new Ext.data.HttpProxy({
                    url:"task/listTaskByAll.action"
                }),
                reader:new Ext.data.JsonReader({
                    root:"tasks",
                    totalProperty:"total",
                    id:"taskID",
                    fields:["taskID","taskPid","taskTitle","taskContent","taskBegin","taskEnd","taskPercent","taskFolder","userID","userName"]
                }),
                sortInfo:{
                    field:"taskID",
                    direction:"DESC"
                },
                remoteSort:true
            });store.setDefaultSort("taskID","DESC");var iconColumn=new Ext.grid.taskIcon();var cm=new Ext.grid.ColumnModel([iconColumn,{
                    header:"序号",
                    dataIndex:"taskID",
                    width:40
                },{
                    header:"任务名称",
                    dataIndex:"taskTitle",
                    renderer:renderComplete,
                    width:200
                },{
                    align:"right",
                    header:"状态",
                    renderer:renderState,
                    dataIndex:"taskPercent",
                    width:30
                },{
                    align:"right",
                    header:"所属帐户",
                    dataIndex:"userName",
                    width:60
                },{
                    align:"right",
                    header:"开始日期",
                    dataIndex:"taskBegin",
                    renderer:renderComplete,
                    width:60
                },{
                    align:"right",
                    header:"结束日期",
                    dataIndex:"taskEnd",
                    renderer:renderComplete,
                    width:60
                }]);cm.defaultSortable=true;var pageSizePlugin=new Ext.ux.Andrie.pPageSize();var taskFilterParams={
                "task.taskPid":"",
                "task.taskTitle":"",
                "task.taskContent":"",
                "task.taskBegin":"",
                "task.taskEnd":"",
                "task.taskPn":"",
                "task.taskPercent":""
            };var taskGridFilterMenu=new Ext.menu.Menu({
                items:[{
                        text:"任务名称",
                        checked:true,
                        checkHandler:function(){
                            operateOfferParams(this.checked,"task.taskTitle")
                        }
                    },{
                        text:"所属任务名称",
                        checked:true,
                        checkHandler:function(){
                            operateOfferParams(this.checked,"task.taskPn")
                        }
                    },{
                        text:"任务内容",
                        checked:true,
                        checkHandler:function(){
                            operateOfferParams(this.checked,"task.taskContent")
                        }
                    },{
                        text:"开始日期",
                        checked:true,
                        checkHandler:function(){
                            operateOfferParams(this.checked,"task.taskBegin")
                        }
                    },{
                        text:"结束日期",
                        checked:true,
                        checkHandler:function(){
                            operateOfferParams(this.checked,"task.taskEnd")
                        }
                    }]
            });function operateOfferParams(status,name){
                if(status===true){
                    taskFilterParams[name]=""
                }else{
                    taskFilterParams[name]=null
                }
            }var filterField=new Ext.form.TextField({});var filterButton=new Ext.Button({
                iconCls:"icon-search",
                tooltip:"开始搜索",
                handler:function(){
                    if(null!==taskFilterParams["task.taskTitle"]){
                        taskFilterParams["task.taskTitle"]=filterField.getValue()
                    }if(null!==taskFilterParams["task.taskPn"]){
                        taskFilterParams["task.taskPn"]=filterField.getValue()
                    }if(null!==taskFilterParams["task.taskContent"]){
                        taskFilterParams["task.taskContent"]=filterField.getValue()
                    }if(null!==taskFilterParams["task.taskBegin"]){
                        taskFilterParams["task.taskBegin"]=filterField.getValue()
                    }if(null!==taskFilterParams["task.taskEnd"]){
                        taskFilterParams["task.taskEnd"]=filterField.getValue()
                    }taskFilterParams["task.taskPercent"]=null;store.baseParams=taskFilterParams;store.load({
                        params:{
                            start:0,
                            limit:pageSizePlugin.getPageSize()
                        }
                    })
                }
            });var clearButton=new Ext.Button({
                iconCls:"icon-clear",
                tooltip:"清空",
                handler:function(){
                    filterField.reset();store.baseParams={};store.load({
                        params:{
                            start:0,
                            limit:pageSizePlugin.getPageSize()
                        }
                    })
                }
            });var sm=new Ext.grid.RowSelectionModel({
                singleSelect:true
            });var grid=new Ext.grid.GridPanel({
                region:"center",
                border:true,
                store:store,
                cm:cm,
                sm:sm,
                loadMask:true,
                tbar:["-",{
                        iconCls:"icon-task-add",
                        tooltip:"添加新任务",
                        handler:function(){
                            var record=sm.getSelected();if(record){
                                actions.addTaskView(record.data.taskID);store.reload()
                            }else{
                                actions.addTaskView()
                            }
                        }
                    },{
                        iconCls:"icon-task-edit",
                        tooltip:"更新任务",
                        handler:function(){
                            var record=sm.getSelected();if(record){
                                actions.updateTaskView(record.data.taskID);store.reload()
                            }else{
                                Sliver.getDesktop().msg({
                                    title:"警告",
                                    iconCls:"icon-warn",
                                    html:"请选中任务[列表]中需要更新的任务"
                                })
                            }
                        }
                    },"-",{
                        iconCls:"icon-task-remove",
                        tooltip:"删除选中任务",
                        handler:function(){
                            var record=sm.getSelected();if(record){
                                actions.removeTaskView(record.data.taskID,record.data.taskTitle);store.reload()
                            }else{
                                Sliver.getDesktop().msg({
                                    title:"警告",
                                    iconCls:"icon-warn",
                                    html:"请选中任务[列表]中需要删除的任务"
                                })
                            }
                        }
                    },"-",{
                        iconCls:"icon-task-group",
                        tooltip:"按照所属任务分组",
                        handler:function(){
                            store.groupBy("taskPid")
                        }
                    },{
                        iconCls:"icon-time",
                        tooltip:"按照开始日期分组",
                        handler:function(){
                            store.groupBy("taskBegin")
                        }
                    },{
                        iconCls:"icon-grid",
                        tooltip:"不分组",
                        handler:function(){
                            store.clearGrouping()
                        }
                    },"-",{
                        iconCls:"icon-chart-bar",
                        tooltip:"为所选任务生成甘特图",
                        handler:function(){
                            var record=sm.getSelected();if(record){
                                actions.createGanttChart(record.data.taskID,record.data.taskTitle)
                            }else{
                                Sliver.getDesktop().msg({
                                    title:"警告",
                                    iconCls:"icon-warn",
                                    html:"请选中任务[列表]中任务"
                                })
                            }
                        }
                    },"-",{
                        iconCls:"task-all",
                        tooltip:"显示所有任务",
                        handler:function(){
                            if(null!==taskFilterParams["task.taskTitle"]){
                                taskFilterParams["task.taskTitle"]=filterField.getValue()
                            }if(null!==taskFilterParams["task.taskPn"]){
                                taskFilterParams["task.taskPn"]=filterField.getValue()
                            }if(null!==taskFilterParams["task.taskContent"]){
                                taskFilterParams["task.taskContent"]=filterField.getValue()
                            }if(null!==taskFilterParams["task.taskBegin"]){
                                taskFilterParams["task.taskBegin"]=filterField.getValue()
                            }if(null!==taskFilterParams["task.taskEnd"]){
                                taskFilterParams["task.taskEnd"]=filterField.getValue()
                            }taskFilterParams["task.taskPercent"]=null;store.baseParams=taskFilterParams;store.reload()
                        }
                    },{
                        iconCls:"task-complete",
                        tooltip:"显示完成的任务",
                        handler:function(){
                            if(null!==taskFilterParams["task.taskTitle"]){
                                taskFilterParams["task.taskTitle"]=filterField.getValue()
                            }if(null!==taskFilterParams["task.taskPn"]){
                                taskFilterParams["task.taskPn"]=filterField.getValue()
                            }if(null!==taskFilterParams["task.taskContent"]){
                                taskFilterParams["task.taskContent"]=filterField.getValue()
                            }if(null!==taskFilterParams["task.taskBegin"]){
                                taskFilterParams["task.taskBegin"]=filterField.getValue()
                            }if(null!==taskFilterParams["task.taskEnd"]){
                                taskFilterParams["task.taskEnd"]=filterField.getValue()
                            }taskFilterParams["task.taskPercent"]=100;store.baseParams=taskFilterParams;store.reload()
                        }
                    },{
                        iconCls:"task-incomplete",
                        tooltip:"显示未完成任务",
                        handler:function(){
                            if(null!==taskFilterParams["task.taskTitle"]){
                                taskFilterParams["task.taskTitle"]=filterField.getValue()
                            }if(null!==taskFilterParams["task.taskPn"]){
                                taskFilterParams["task.taskPn"]=filterField.getValue()
                            }if(null!==taskFilterParams["task.taskContent"]){
                                taskFilterParams["task.taskContent"]=filterField.getValue()
                            }if(null!==taskFilterParams["task.taskBegin"]){
                                taskFilterParams["task.taskBegin"]=filterField.getValue()
                            }if(null!==taskFilterParams["task.taskEnd"]){
                                taskFilterParams["task.taskEnd"]=filterField.getValue()
                            }taskFilterParams["task.taskPercent"]=0;store.baseParams=taskFilterParams;store.reload()
                        }
                    }],
                bbar:new Ext.PagingToolbar({
                    plugins:pageSizePlugin,
                    pageSize:20,
                    store:store,
                    items:["-",{
                            text:"搜索范围",
                            menu:taskGridFilterMenu
                        },filterField,filterButton,clearButton]
                }),
                view:new Ext.grid.GroupingView({
                    forceFit:true,
                    groupTextTpl:"{text} (子任务: {[values.rs.length]})"
                })
            });grid.on("render",function(){
                store.load({
                    params:{
                        start:0,
                        limit:pageSizePlugin.getPageSize()
                    }
                })
            });grid.on("contextmenu",function(e){
                e.stopEvent()
            });grid.on("rowdblclick",function(){
                var record=sm.getSelected();if(record){
                    actions.updateTaskView(record.data.taskID)
                }
            });var gridMenu;grid.on("rowcontextmenu",function(grid,rowindex,e){
                grid.getSelectionModel().selectRow(rowindex,false);if(!gridMenu){
                    gridMenu=new Ext.menu.Menu([{
                            text:"添加任务",
                            handler:function(){
                                var record=sm.getSelected();if(record){
                                    actions.addTaskView(record.data.taskID)
                                }else{
                                    actions.addTaskView()
                                }
                            }
                        },{
                            text:"更新任务",
                            handler:function(){
                                var record=sm.getSelected();if(record){
                                    actions.updateTaskView(record.data.taskID)
                                }else{
                                    Sliver.getDesktop().msg({
                                        title:"警告",
                                        iconCls:"icon-warn",
                                        html:"请选中任务[列表]中需要更新的任务"
                                    })
                                }
                            }
                        },"-",{
                            text:"删除删除",
                            handler:function(){
                                var record=sm.getSelected();if(record){
                                    actions.removeTaskView(record.data.taskID,record.data.taskTitle)
                                }else{
                                    Sliver.getDesktop().msg({
                                        title:"警告",
                                        iconCls:"icon-warn",
                                        html:"请选中任务[列表]中需要删除的任务"
                                    })
                                }
                            }
                        }])
                }gridMenu.showAt(e.getPoint());e.stopEvent()
            });var actions={
                addTaskView:function(taskID){
                    if(!taskID){
                        taskID=1
                    }Ext.Ajax.request({
                        url:"task/insertTaskAllView.action",
                        method:"post",
                        params:{
                            "task.taskID":taskID
                        },
                        success:function(response){
                            eval(response.responseText)
                        }
                    })
                },
                updateTaskView:function(taskID){
                    if(taskID){
                        Ext.Ajax.request({
                            url:"task/updateTaskAllView.action",
                            method:"post",
                            params:{
                                "task.taskID":taskID
                            },
                            success:function(response){
                                eval(response.responseText)
                            }
                        })
                    }
                },
                removeTaskView:function(taskID,taskTitle){
                    if(taskID&&taskTitle){
                        Ext.MessageBox.confirm("删除任务","您确定要删除任务["+taskTitle+"]?",function(btn){
                            if(btn=="yes"){
                                Ext.Ajax.request({
                                    url:"task/removeTaskAllAction.action",
                                    method:"post",
                                    params:{
                                        "task.taskID":taskID
                                    },
                                    success:function(response){
                                        var result=Ext.decode(response.responseText);if(true===result.success){
                                            store.reload()
                                        }
                                    }
                                })
                            }
                        })
                    }
                },
                createGanttChart:function(taskID,taskTitle){
                    var html='<table width="100%" border="0"><tr><td align="center" valign="middle"><img src="task/taskGanttAllView.action?width=760&height=520&task.taskID='+taskID+"&_dc="+new Date().getTime()+'"></td></tr></table>';var tempWin=new Ext.Window({
                        width:800,
                        height:600,
                        resizable:false,
                        layout:"fit",
                        title:"任务["+taskTitle+"]甘特图",
                        html:html,
                        iconCls:"icon-chart-bar",
                        buttonAlign:"right",
                        buttons:[{
                                text:"关闭",
                                handler:function(){
                                    tempWin.close()
                                }
                            }]
                    });tempWin.show()
                }
            };win=desktop.createWindow({
                id:this.moduleId,
                title:"任务管理",
                width:winWidth,
                height:winHeight,
                x:desktop.getWinX(winWidth),
                y:desktop.getWinY(winHeight),
                iconCls:"task-manager-icon",
                shim:false,
                animCollapse:false,
                constrainHeader:true,
                minimizable:true,
                maximizable:true,
                border:false,
                layout:"border",
                items:[tree,grid],
                taskbuttonTooltip:"<b>任务管理</b><br />任务，项目管理"
            })
        }win.show()
    }
});

//~~~
Sliver.TaskManager=Ext.extend(Ext.app.Module,{
    moduleType:"task",
    moduleId:"task-manager",
    init:function(){
        this.launcher={
            handler:this.createWindow,
            iconCls:"task-manager-icon",
            scope:this,
            shortcutIconCls:"task-manager-shortcut",
            text:"我的任务",
            tooltip:"<b>我的任务</b><br />我的任务，项目"
        }
    },
    createWindow:function(){
        var desktop=this.app.getDesktop();var win=desktop.getWindow(this.moduleId);if(!win){
            var winWidth=desktop.getWinWidth()/1.1;var winHeight=desktop.getWinHeight()/1.1;var tree=new Ext.tree.TreePanel({
                region:"west",
                width:400,
                minWidth:240,
                border:true,
                enableDD:false,
                collapseMode:"mini",
                collapsible:true,
                split:true,
                rootVisible:false,
                iconCls:"task-manager-icon",
                autoScroll:true,
                tbar:[{
                        tooltip:"刷新",
                        iconCls:"icon-reload",
                        handler:function(){
                            tree.getRootNode().reload()
                        }
                    },"-",{
                        iconCls:"icon-expand-all",
                        tooltip:"全部展开",
                        handler:function(){
                            tree.getRootNode().expand(true)
                        }
                    },{
                        iconCls:"icon-collapse-all",
                        tooltip:"全部折叠",
                        handler:function(){
                            tree.getRootNode().collapse(true)
                        }
                    },"->","-",{
                        iconCls:"icon-chart-bar",
                        tooltip:"甘特图",
                        handler:function(){
                            node=tree.getSelectionModel().getSelectedNode();if(node){
                                actions.createGanttChart(node.id.substring(node.id.lastIndexOf("-")+1),node.text)
                            }else{
                                Sliver.getDesktop().msg({
                                    title:"警告",
                                    iconCls:"icon-warn",
                                    html:"请选中任务[树]中任务"
                                })
                            }
                        }
                    },{
                        iconCls:"icon-task-add",
                        tooltip:"添加新任务",
                        handler:function(){
                            node=tree.getSelectionModel().getSelectedNode();if(node){
                                actions.addTaskView(node.id.substring(node.id.lastIndexOf("-")+1))
                            }else{
                                actions.addTaskView()
                            }
                        }
                    },{
                        iconCls:"icon-task-edit",
                        tooltip:"更新任务",
                        handler:function(){
                            node=tree.getSelectionModel().getSelectedNode();if(node){
                                actions.updateTaskView(node.id.substring(node.id.lastIndexOf("-")+1))
                            }else{
                                Sliver.getDesktop().msg({
                                    title:"警告",
                                    iconCls:"icon-warn",
                                    html:"请选中任务[树]中需要更新的任务"
                                })
                            }
                        }
                    },"-",{
                        iconCls:"icon-task-remove",
                        tooltip:"删除任务",
                        handler:function(){
                            node=tree.getSelectionModel().getSelectedNode();if(node){
                                actions.removeTaskView(node.id.substring(node.id.lastIndexOf("-")+1),node.text)
                            }else{
                                Sliver.getDesktop().msg({
                                    title:"警告",
                                    iconCls:"icon-warn",
                                    html:"请选中任务[树]中需要删除的任务"
                                })
                            }
                        }
                    }],
                loader:new Ext.tree.SliverTreeLoader({
                    dataUrl:"task/listTaskTreeByUser.action"
                }),
                root:new Ext.tree.AsyncTreeNode({
                    id:"task-1",
                    text:"Tasks"
                })
            });tree.on("click",function(node,e){
                if(node){
                    if(true!==node.isLeaf()){
                        store.setDefaultSort("taskID","DESC");store.baseParams={
                            "task.taskPid":node.id.substring(node.id.lastIndexOf("-")+1)
                        };store.load({
                            params:{
                                start:0,
                                limit:20
                            }
                        })
                    }e.stopEvent()
                }
            });tree.on("dblclick",function(node,e){
                if(node){
                    e.stopEvent();actions.updateTaskView(node.id.substring(node.id.lastIndexOf("-")+1))
                }
            });var treeMenu;tree.on("contextMenu",function(n,e){
                if(!n.isSelected()){
                    n.select()
                }if(!treeMenu){
                    treeMenu=new Ext.menu.Menu([{
                            text:"展开",
                            handler:function(){
                                n.expand()
                            }
                        },{
                            text:"折叠",
                            handler:function(){
                                n.collapse()
                            }
                        },"-",{
                            text:"刷新",
                            handler:function(){
                                n.reload()
                            }
                        },"-",{
                            text:"添加任务",
                            handler:function(){
                                if(n){
                                    actions.addTaskView(n.id.substring(n.id.lastIndexOf("-")+1))
                                }else{
                                    actions.addTaskView()
                                }
                            }
                        },{
                            text:"更新任务",
                            handler:function(){
                                if(n){
                                    actions.updateTaskView(n.id.substring(n.id.lastIndexOf("-")+1))
                                }else{
                                    Sliver.getDesktop().msg({
                                        title:"警告",
                                        iconCls:"icon-warn",
                                        html:"请选中任务[树]中需要更新的任务"
                                    })
                                }
                            }
                        },"-",{
                            text:"删除任务",
                            handler:function(){
                                if(n){
                                    actions.removeTaskView(n.id.substring(n.id.lastIndexOf("-")+1),n.text)
                                }else{
                                    Sliver.getDesktop().msg({
                                        title:"警告",
                                        iconCls:"icon-warn",
                                        html:"请选中任务[树]中需要删除的任务"
                                    })
                                }
                            }
                        }])
                }e.stopEvent();treeMenu.showAt(e.getPoint())
            });var renderState=function(v,p,record,rowIndex){
                if(100<=record.data.taskPercent){
                    return'<span style="text-decoration:line-through;">'+v+"%</span>"
                }else{
                    return v+"%"
                }
            };var renderComplete=function(v,p,record,rowIndex){
                if(100<=record.data.taskPercent){
                    return'<span style="text-decoration:line-through;">'+v+"</span>"
                }else{
                    return v
                }
            };var store=new Ext.data.GroupingStore({
                proxy:new Ext.data.HttpProxy({
                    url:"task/listTask.action"
                }),
                reader:new Ext.data.JsonReader({
                    root:"tasks",
                    totalProperty:"total",
                    id:"taskID",
                    fields:["taskID","taskPid","taskTitle","taskContent","taskBegin","taskEnd","taskPercent","taskFolder"]
                }),
                sortInfo:{
                    field:"taskID",
                    direction:"DESC"
                },
                groupField:"taskPid",
                remoteSort:true
            });store.setDefaultSort("taskID","DESC");var iconColumn=new Ext.grid.taskIcon();var cm=new Ext.grid.ColumnModel([iconColumn,{
                    header:"序号",
                    dataIndex:"taskID",
                    width:40
                },{
                    header:"所属任务",
                    dataIndex:"taskPid",
                    renderer:function(v,p,record,rowIndex){
                        return"["+record.data.taskPid+"]"
                    },
                    hidden:true,
                    width:40
                },{
                    header:"任务名称",
                    dataIndex:"taskTitle",
                    renderer:renderComplete,
                    width:200
                },{
                    align:"right",
                    header:"状态",
                    renderer:renderState,
                    dataIndex:"taskPercent",
                    width:30
                },{
                    align:"right",
                    header:"开始日期",
                    dataIndex:"taskBegin",
                    renderer:renderComplete,
                    width:80
                },{
                    align:"right",
                    header:"结束日期",
                    dataIndex:"taskEnd",
                    renderer:renderComplete,
                    width:80
                }]);cm.defaultSortable=true;var pageSizePlugin=new Ext.ux.Andrie.pPageSize();var taskFilterParams={
                "task.taskPid":"",
                "task.taskTitle":"",
                "task.taskContent":"",
                "task.taskBegin":"",
                "task.taskEnd":"",
                "task.taskPercent":""
            };var taskGridFilterMenu=new Ext.menu.Menu({
                items:[{
                        text:"任务名称",
                        checked:true,
                        checkHandler:function(){
                            operateOfferParams(this.checked,"task.taskTitle")
                        }
                    },{
                        text:"任务内容",
                        checked:true,
                        checkHandler:function(){
                            operateOfferParams(this.checked,"task.taskContent")
                        }
                    },{
                        text:"开始日期",
                        checked:true,
                        checkHandler:function(){
                            operateOfferParams(this.checked,"task.taskBegin")
                        }
                    },{
                        text:"结束日期",
                        checked:true,
                        checkHandler:function(){
                            operateOfferParams(this.checked,"task.taskEnd")
                        }
                    }]
            });function operateOfferParams(status,name){
                if(status===true){
                    taskFilterParams[name]=""
                }else{
                    taskFilterParams[name]=null
                }
            }var filterField=new Ext.form.TextField({});var filterButton=new Ext.Button({
                iconCls:"icon-search",
                tooltip:"开始搜索",
                handler:function(){
                    if(null!==taskFilterParams["task.taskTitle"]){
                        taskFilterParams["task.taskTitle"]=filterField.getValue()
                    }if(null!==taskFilterParams["task.taskContent"]){
                        taskFilterParams["task.taskContent"]=filterField.getValue()
                    }if(null!==taskFilterParams["task.taskBegin"]){
                        taskFilterParams["task.taskBegin"]=filterField.getValue()
                    }if(null!==taskFilterParams["task.taskEnd"]){
                        taskFilterParams["task.taskEnd"]=filterField.getValue()
                    }taskFilterParams["task.taskPercent"]=null;store.baseParams=taskFilterParams;store.load({
                        params:{
                            start:0,
                            limit:pageSizePlugin.getPageSize()
                        }
                    })
                }
            });var clearButton=new Ext.Button({
                iconCls:"icon-clear",
                tooltip:"清空",
                handler:function(){
                    filterField.reset();store.baseParams={};store.load({
                        params:{
                            start:0,
                            limit:pageSizePlugin.getPageSize()
                        }
                    })
                }
            });var sm=new Ext.grid.RowSelectionModel({
                singleSelect:true
            });var grid=new Ext.grid.GridPanel({
                region:"center",
                border:true,
                store:store,
                cm:cm,
                sm:sm,
                loadMask:true,
                tbar:["-",{
                        iconCls:"icon-task-add",
                        tooltip:"添加新任务",
                        handler:function(){
                            var record=sm.getSelected();if(record){
                                actions.addTaskView(record.data.taskID);store.reload()
                            }else{
                                actions.addTaskView()
                            }
                        }
                    },{
                        iconCls:"icon-task-edit",
                        tooltip:"更新任务",
                        handler:function(){
                            var record=sm.getSelected();if(record){
                                actions.updateTaskView(record.data.taskID);store.reload()
                            }else{
                                Sliver.getDesktop().msg({
                                    title:"警告",
                                    iconCls:"icon-warn",
                                    html:"请选中任务[列表]中需要更新的任务"
                                })
                            }
                        }
                    },"-",{
                        iconCls:"icon-task-remove",
                        tooltip:"删除选中任务",
                        handler:function(){
                            var record=sm.getSelected();if(record){
                                actions.removeTaskView(record.data.taskID,record.data.taskTitle);store.reload()
                            }else{
                                Sliver.getDesktop().msg({
                                    title:"警告",
                                    iconCls:"icon-warn",
                                    html:"请选中任务[列表]中需要删除的任务"
                                })
                            }
                        }
                    },"-",{
                        iconCls:"icon-task-group",
                        tooltip:"按照所属任务分组",
                        handler:function(){
                            store.groupBy("taskPid")
                        }
                    },{
                        iconCls:"icon-time",
                        tooltip:"按照开始日期分组",
                        handler:function(){
                            store.groupBy("taskBegin")
                        }
                    },{
                        iconCls:"icon-grid",
                        tooltip:"不分组",
                        handler:function(){
                            store.clearGrouping()
                        }
                    },"-",{
                        iconCls:"icon-chart-bar",
                        tooltip:"为所选任务生成甘特图",
                        handler:function(){
                            var record=sm.getSelected();if(record){
                                actions.createGanttChart(record.data.taskID,record.data.taskTitle)
                            }else{
                                Sliver.getDesktop().msg({
                                    title:"警告",
                                    iconCls:"icon-warn",
                                    html:"请选中任务[列表]中任务"
                                })
                            }
                        }
                    },"-",{
                        iconCls:"task-all",
                        tooltip:"显示所有任务",
                        handler:function(){
                            if(null!==taskFilterParams["task.taskTitle"]){
                                taskFilterParams["task.taskTitle"]=filterField.getValue()
                            }if(null!==taskFilterParams["task.taskContent"]){
                                taskFilterParams["task.taskContent"]=filterField.getValue()
                            }if(null!==taskFilterParams["task.taskBegin"]){
                                taskFilterParams["task.taskBegin"]=filterField.getValue()
                            }if(null!==taskFilterParams["task.taskEnd"]){
                                taskFilterParams["task.taskEnd"]=filterField.getValue()
                            }taskFilterParams["task.taskPercent"]=null;store.baseParams=taskFilterParams;store.reload()
                        }
                    },{
                        iconCls:"task-complete",
                        tooltip:"显示完成的任务",
                        handler:function(){
                            if(null!==taskFilterParams["task.taskTitle"]){
                                taskFilterParams["task.taskTitle"]=filterField.getValue()
                            }if(null!==taskFilterParams["task.taskContent"]){
                                taskFilterParams["task.taskContent"]=filterField.getValue()
                            }if(null!==taskFilterParams["task.taskBegin"]){
                                taskFilterParams["task.taskBegin"]=filterField.getValue()
                            }if(null!==taskFilterParams["task.taskEnd"]){
                                taskFilterParams["task.taskEnd"]=filterField.getValue()
                            }taskFilterParams["task.taskPercent"]=100;store.baseParams=taskFilterParams;store.reload()
                        }
                    },{
                        iconCls:"task-incomplete",
                        tooltip:"显示未完成任务",
                        handler:function(){
                            if(null!==taskFilterParams["task.taskTitle"]){
                                taskFilterParams["task.taskTitle"]=filterField.getValue()
                            }if(null!==taskFilterParams["task.taskContent"]){
                                taskFilterParams["task.taskContent"]=filterField.getValue()
                            }if(null!==taskFilterParams["task.taskBegin"]){
                                taskFilterParams["task.taskBegin"]=filterField.getValue()
                            }if(null!==taskFilterParams["task.taskEnd"]){
                                taskFilterParams["task.taskEnd"]=filterField.getValue()
                            }taskFilterParams["task.taskPercent"]=0;store.baseParams=taskFilterParams;store.reload()
                        }
                    }],
                bbar:new Ext.PagingToolbar({
                    plugins:pageSizePlugin,
                    pageSize:20,
                    store:store,
                    items:["-",{
                            text:"搜索范围",
                            menu:taskGridFilterMenu
                        },filterField,filterButton,clearButton]
                }),
                view:new Ext.grid.GroupingView({
                    forceFit:true,
                    groupTextTpl:"{text} (子任务: {[values.rs.length]})"
                })
            });grid.on("render",function(){
                store.load({
                    params:{
                        start:0,
                        limit:pageSizePlugin.getPageSize()
                    }
                })
            });grid.on("contextmenu",function(e){
                e.stopEvent()
            });grid.on("rowdblclick",function(){
                var record=sm.getSelected();if(record){
                    actions.updateTaskView(record.data.taskID)
                }
            });var gridMenu;grid.on("rowcontextmenu",function(grid,rowindex,e){
                grid.getSelectionModel().selectRow(rowindex,false);if(!gridMenu){
                    gridMenu=new Ext.menu.Menu([{
                            text:"添加任务",
                            handler:function(){
                                var record=sm.getSelected();if(record){
                                    actions.addTaskView(record.data.taskID)
                                }else{
                                    actions.addTaskView()
                                }
                            }
                        },{
                            text:"更新任务",
                            handler:function(){
                                var record=sm.getSelected();if(record){
                                    actions.updateTaskView(record.data.taskID)
                                }else{
                                    Sliver.getDesktop().msg({
                                        title:"警告",
                                        iconCls:"icon-warn",
                                        html:"请选中任务[列表]中需要更新的任务"
                                    })
                                }
                            }
                        },"-",{
                            text:"删除删除",
                            handler:function(){
                                var record=sm.getSelected();if(record){
                                    actions.removeTaskView(record.data.taskID,record.data.taskTitle)
                                }else{
                                    Sliver.getDesktop().msg({
                                        title:"警告",
                                        iconCls:"icon-warn",
                                        html:"请选中任务[列表]中需要删除的任务"
                                    })
                                }
                            }
                        }])
                }gridMenu.showAt(e.getPoint());e.stopEvent()
            });var actions={
                addTaskView:function(taskID){
                    if(!taskID){
                        taskID=1
                    }Ext.Ajax.request({
                        url:"task/insertTaskUserView.action",
                        method:"post",
                        params:{
                            "task.taskID":taskID
                        },
                        success:function(response){
                            eval(response.responseText)
                        }
                    })
                },
                updateTaskView:function(taskID){
                    if(taskID){
                        Ext.Ajax.request({
                            url:"task/updateTaskUserView.action",
                            method:"post",
                            params:{
                                "task.taskID":taskID
                            },
                            success:function(response){
                                eval(response.responseText)
                            }
                        })
                    }
                },
                removeTaskView:function(taskID,taskTitle){
                    if(taskID&&taskTitle){
                        Ext.MessageBox.confirm("删除任务","您确定要删除任务["+taskTitle+"]?",function(btn){
                            if(btn=="yes"){
                                Ext.Ajax.request({
                                    url:"task/removeTaskUserAction.action",
                                    method:"post",
                                    params:{
                                        "task.taskID":taskID
                                    },
                                    success:function(response){
                                        var result=Ext.decode(response.responseText);if(true===result.success){
                                            store.reload()
                                        }
                                    }
                                })
                            }
                        })
                    }
                },
                createGanttChart:function(taskID,taskTitle){
                    var html='<table width="100%" border="0"><tr><td align="center" valign="middle"><img src="task/taskGanttUserView.action?width=760&height=520&task.taskID='+taskID+"&_dc="+new Date().getTime()+'"></td></tr></table>';var tempWin=new Ext.Window({
                        width:800,
                        height:600,
                        resizable:false,
                        layout:"fit",
                        title:"任务["+taskTitle+"]甘特图",
                        html:html,
                        iconCls:"icon-chart-bar",
                        buttonAlign:"right",
                        buttons:[{
                                text:"关闭",
                                handler:function(){
                                    tempWin.close()
                                }
                            }]
                    });tempWin.show()
                }
            };win=desktop.createWindow({
                id:this.moduleId,
                title:"我的任务",
                width:winWidth,
                height:winHeight,
                x:desktop.getWinX(winWidth),
                y:desktop.getWinY(winHeight),
                iconCls:"task-manager-icon",
                shim:false,
                animCollapse:false,
                constrainHeader:true,
                minimizable:true,
                maximizable:true,
                border:false,
                layout:"border",
                items:[tree,grid],
                taskbuttonTooltip:"<b>我的任务</b><br />我的任务，项目"
            })
        }win.show()
    }
});