//~~~
Sliver.ProductionStorage=Ext.extend(Ext.app.Module,{
    moduleType:"system",
    moduleId:"production-storage",
    init:function(){
        this.launcher={
            handler:this.createWindow,
            iconCls:"icon-storage",
            scope:this,
            shortcutIconCls:"production-storage-shortcut",
            text:SliverData.storage.title,
            tooltip:SliverData.storage.tooltip
        }
    },
    createWindow:function(){
        var desktop=this.app.getDesktop();var win=desktop.getWindow(this.moduleId);if(!win){
            var winWidth=desktop.getWinWidth()/1.1;
			var winHeight=desktop.getWinHeight()/1.1;
			var store=new Ext.data.Store({
                proxy:new Ext.data.HttpProxy({
                    url:"storage/listStoredProduction.action"
                }),
                reader:new Ext.data.JsonReader({
                    root:"list",
                    totalProperty:"total",
                    id:"productionID",
                    fields:["productionID","productionName","productionSerial","categoryID","categoryName","productionSerial","productionUnit","productionPrice","productionVn1","productionVn2","productionVn3","productionVn4","productionVn5","productionDescription","productionQuantity","productionTotalPrice"]
                }),
                remoteSort:true
            });
			var expander=new Ext.grid.RowExpander({
                tpl:new Ext.Template("<p><b>"+SliverData.storage.productionDescription+":</b> {productionDescription}</p>")
            });
			var cm=new Ext.grid.ColumnModel([expander,{
                    header:"产品编号",
                    dataIndex:"productionSerial",
                    width:50
                },{
                    header:"产品名称",
                    dataIndex:"productionName",
                    width:80
                },{
                    header:"分类名称",
                    dataIndex:"categoryName",
                    width:80
                },{
                    header:"单位",
                    dataIndex:"productionUnit",
                    width:40
                },{
                    header:"技术参数",
                    hidden:true,
                    dataIndex:"productionVn1",
                    width:50
                },{
                    header:"技术参数",
                    hidden:true,
                    dataIndex:"productionVn2",
                    width:50
                },{
                    header:"技术参数",
                    hidden:true,
                    dataIndex:"productionVn3",
                    width:50
                },{
                    header:"技术参数",
                    hidden:true,
                    dataIndex:"productionVn4",
                    width:50
                },{
                    header:"技术参数",
                    hidden:true,
                    dataIndex:"productionVn5",
                    width:50
                },{
                    header:"产品报价",
                    hidden:true,
                    dataIndex:"productionPrice",
                    align:"right",
                    renderer:SliverUtil.cnMoney,
                    width:60
                },{
                    header:"产品数量",
                    align:"right",
                    dataIndex:"productionQuantity",
                    width:40
                },{
                    header:"总价",
                    align:"right",
                    dataIndex:"productionTotalPrice",
                    renderer:SliverUtil.cnMoney,
                    width:60
                }]);cm.defaultSortable=true;var filterProductionParams={
                "storedProduction.productionSerial":"",
                "storedProduction.productionName":"",
                "storedProduction.categoryName":"",
                "storedProduction.productionUnit":"",
                "storedProduction.productionPn1":"",
                "storedProduction.productionVn1":"",
                "storedProduction.productionPrice":"",
                "storedProduction.productionDescription":""
            };function operateProductionGridParams(status,name){
                if(status===true){
                    filterProductionParams[name]=""
                }else{
                    filterProductionParams[name]=null
                }
            }var productionFilterMenu=new Ext.menu.Menu({
                items:[{
                        text:"产品编号",
                        checked:true,
                        checkHandler:function(){
                            operateProductionGridParams(this.checked,"storedProduction.productionSerial")
                        }
                    },{
                        text:"产品名称",
                        checked:true,
                        checkHandler:function(){
                            operateProductionGridParams(this.checked,"storedProduction.productionName")
                        }
                    },{
                        text:"分类名称",
                        checked:true,
                        checkHandler:function(){
                            operateProductionGridParams(this.checked,"storedProduction.categoryName")
                        }
                    },{
                        text:"单位",
                        checked:true,
                        checkHandler:function(){
                            operateProductionGridParams(this.checked,"storedProduction.productionUnit")
                        }
                    },{
                        text:"参数名称",
                        checked:true,
                        checkHandler:function(){
                            operateProductionGridParams(this.checked,"storedProduction.productionPn1")
                        }
                    },{
                        text:"参数数值",
                        checked:true,
                        checkHandler:function(){
                            operateProductionGridParams(this.checked,"storedProduction.productionVn1")
                        }
                    },{
                        text:"产品描述",
                        checked:true,
                        checkHandler:function(){
                            operateProductionGridParams(this.checked,"storedProduction.productionDescription")
                        }
                    }]
            });var filterProduction=function(){
                if(null!==filterProductionParams["storedProduction.productionSerial"]){
                    filterProductionParams["storedProduction.productionSerial"]=filterField.getValue()
                }if(null!==filterProductionParams["storedProduction.productionName"]){
                    filterProductionParams["storedProduction.productionName"]=filterField.getValue()
                }if(null!==filterProductionParams["storedProduction.categoryName"]){
                    filterProductionParams["storedProduction.categoryName"]=filterField.getValue()
                }if(null!==filterProductionParams["storedProduction.productionUnit"]){
                    filterProductionParams["storedProduction.productionUnit"]=filterField.getValue()
                }if(null!==filterProductionParams["storedProduction.productionPn1"]){
                    filterProductionParams["storedProduction.productionPn1"]=filterField.getValue()
                }if(null!==filterProductionParams["storedProduction.productionVn1"]){
                    filterProductionParams["storedProduction.productionVn1"]=filterField.getValue()
                }if(null!==filterProductionParams["storedProduction.productionDescription"]){
                    filterProductionParams["storedProduction.productionDescription"]=filterField.getValue()
                }store.baseParams=filterProductionParams;store.setDefaultSort("productionID","desc");store.load({
                    params:{
                        start:0,
                        limit:pageSizePlugin.getPageSize()
                    }
                })
            };var filterField=new Ext.form.TextField({});var filterButton=new Ext.Button({
                iconCls:"icon-search",
                tooltip:"开始搜索",
                handler:filterProduction
            });var clearButton=new Ext.Button({
                iconCls:"icon-clear",
                tooltip:"清空",
                handler:function(){
                    filterField.reset();store.baseParams={};store.setDefaultSort("productionID","DESC");store.load({
                        params:{
                            start:0,
                            limit:pageSizePlugin.getPageSize()
                        }
                    })
                }
            });store.setDefaultSort("productionID","DESC");var sm=new Ext.grid.RowSelectionModel({
                singleSelect:true
            });var createStoredProduction=function(){
                Ext.Ajax.request({
                    url:"storage/insertStoredProductionView.jsp",
                    method:"post",
                    success:function(response){
                        eval(response.responseText)
                    }
                })
            };var removeStoredProduction=function(){
                var record=sm.getSelected();if(record){
                    Ext.MessageBox.confirm("清空产品库存","您确定要清空产品库存 "+record.data.productionName+" ?",function(btn){
                        if(btn=="yes"){
                            Ext.Ajax.request({
                                url:"storage/removeStoredProduction.action",
                                method:"post",
                                params:{
                                    "storedProduction.productionID":record.data.productionID
                                },
                                success:function(response){
                                    var result=Ext.decode(response.responseText);if(true===result.success){
                                        store.remove(record)
                                    }
                                }
                            })
                        }
                    })
                }
            };var inStoredRegistrationView=function(){
                var record=sm.getSelected();if(record){
                    var tabID=main.id+"-inStoredRegitration-"+Ext.id();var temp=new Ext.Panel({
                        id:tabID,
                        autoScroll:true,
                        iconCls:"icon-offer-add",
                        title:"入库记录",
                        closable:true
                    });temp.on("render",function(){
                        temp.load({
                            scripts:true,
                            method:"post",
                            params:{
                                "storedRegistration.productionID":record.data.productionID,
                                "storedRegistration.productionName":record.data.productionName,
                                "storedRegistration.productionSerial":record.data.productionSerial,
                                containerID:temp.body.id
                            },
                            url:"storage/inStoredRegistrationView.action"
                        })
                    });var p=main.add(temp);main.setActiveTab(p)
                }
            };var outStoredRegistrationView=function(){
                var record=sm.getSelected();if(record){
                    var tabID=main.id+"-outStoredRegitration-"+Ext.id();var temp=new Ext.Panel({
                        id:tabID,
                        autoScroll:true,
                        iconCls:"icon-offer-remove",
                        title:"出库记录",
                        closable:true
                    });temp.on("render",function(){
                        temp.load({
                            scripts:true,
                            method:"post",
                            params:{
                                "storedRegistration.productionID":record.data.productionID,
                                "storedRegistration.productionName":record.data.productionName,
                                "storedRegistration.productionSerial":record.data.productionSerial,
                                containerID:temp.body.id
                            },
                            url:"storage/outStoredRegistrationView.action"
                        })
                    });var p=main.add(temp);main.setActiveTab(p)
                }
            };var pageSizePlugin=new Ext.ux.Andrie.pPageSize();var grid=new Ext.grid.GridPanel({
                border:false,
                viewConfig:{
                    forceFit:true
                },
                store:store,
                cm:cm,
                sm:sm,
                loadMask:true,
                plugins:expander,
                tbar:["-",{
                        iconCls:"icon-storage-add",
                        tooltip:"创建产品库存",
                        handler:createStoredProduction
                    },{
                        iconCls:"icon-storage-remove",
                        tooltip:"清空产品库存",
                        handler:removeStoredProduction
                    },"-",{
                        iconCls:"icon-offer-add",
                        tooltip:"产品入库记录",
                        handler:inStoredRegistrationView
                    },{
                        iconCls:"icon-offer-remove",
                        tooltip:"产品出库记录",
                        handler:outStoredRegistrationView
                    }],
                bbar:new Ext.PagingToolbar({
                    plugins:pageSizePlugin,
                    pageSize:20,
                    store:store,
                    displayInfo:true,
                    items:["-",{
                            text:"搜索范围",
                            menu:productionFilterMenu
                        },filterField,filterButton,clearButton,"-",{
                            iconCls:"icon-pdf",
                            tooltip:"将表格导出为PDF文件",
                            handler:function(){
                                var s="?";if(store.lastOptions){
                                    s+=Ext.urlEncode(store.lastOptions)
                                }if(store.baseParams){
                                    if(s===""){
                                        s+=Ext.urlEncode(store.baseParams)
                                    }else{
                                        s+="&"+Ext.urlEncode(store.baseParams)
                                    }
                                }window.open("storage/exportStoredProduction.action"+s)
                            }
                        },"-",{
                            iconCls:"icon-xls",
                            tooltip:"将表格导出为XLS文件",
                            handler:function(){
                                var s="?";if(store.lastOptions){
                                    s+=Ext.urlEncode(store.lastOptions)
                                }if(store.baseParams){
                                    if(s===""){
                                        s+=Ext.urlEncode(store.baseParams)
                                    }else{
                                        s+="&";s+=Ext.urlEncode(store.baseParams)
                                    }
                                }if(""===s){
                                    s="?type=xls"
                                }else{
                                    s=s+"&type=xls"
                                }window.open("storage/exportStoredProduction.action"+s)
                            }
                        }]
                })
            });grid.on("render",function(){
                store.load({
                    params:{
                        start:0,
                        limit:pageSizePlugin.getPageSize()
                    }
                })
            });var lotPageSizePlugin=new Ext.ux.Andrie.pPageSize();var lotStore=new Ext.data.GroupingStore({
                proxy:new Ext.data.HttpProxy({
                    url:"storage/listStoredProductionLot.action"
                }),
                reader:new Ext.data.JsonReader({
                    root:"list",
                    totalProperty:"total",
                    id:"productionLotID",
                    fields:["productionID","productionName","productionSerial","categoryID","categoryName","productionSerial","productionUnit","productionPrice","productionVn1","productionVn2","productionVn3","productionVn4","productionVn5","productionDescription","productionParameter","productionDescription","productionParameter","productionLotNumber","productionLotPrice","productionLotQuantity","productionLotTotal"]
                }),
                sortInfo:{
                    field:"productionLotID",
                    direction:"DESC"
                },
                groupField:"productionName",
                remoteSort:true
            });var lotExpander=new Ext.grid.RowExpander({
                tpl:new Ext.Template("<p><b>产品说明:</b> {productionDescription}</p><br>","<p><b>技术参数:</b> {productionParameter}</p>")
            });var lotCm=new Ext.grid.ColumnModel([{
                    header:"产品编号",
                    dataIndex:"productionSerial",
                    width:50
                },{
                    header:"产品名称",
                    dataIndex:"productionName",
                    width:80
                },{
                    header:"分类名称",
                    dataIndex:"categoryName",
                    width:80
                },{
                    header:"单位",
                    dataIndex:"productionUnit",
                    width:40
                },{
                    header:"技术参数",
                    hidden:true,
                    dataIndex:"productionVn1",
                    width:50
                },{
                    header:"技术参数",
                    hidden:true,
                    dataIndex:"productionVn2",
                    width:50
                },{
                    header:"技术参数",
                    hidden:true,
                    dataIndex:"productionVn3",
                    width:50
                },{
                    header:"技术参数",
                    hidden:true,
                    dataIndex:"productionVn4",
                    width:50
                },{
                    header:"技术参数",
                    hidden:true,
                    dataIndex:"productionVn5",
                    width:50
                },{
                    header:"产品报价",
                    hidden:true,
                    dataIndex:"productionPrice",
                    align:"right",
                    renderer:SliverUtil.cnMoney,
                    width:60
                },{
                    header:"产品批号",
                    align:"left",
                    dataIndex:"productionLotNumber",
                    width:80
                },{
                    header:"批量单价",
                    align:"right",
                    dataIndex:"productionLotPrice",
                    renderer:SliverUtil.cnMoney,
                    width:60
                },{
                    header:"产品批量",
                    align:"right",
                    dataIndex:"productionLotQuantity",
                    width:60
                },{
                    header:"批总价",
                    align:"right",
                    dataIndex:"productionLotTotal",
                    renderer:SliverUtil.cnMoney,
                    width:60
                }]);lotCm.defaultSortable=true;var filterProductionLotParams={
                "storedProductionLot.productionSerial":"",
                "storedProductionLot.productionName":"",
                "storedProductionLot.categoryName":"",
                "storedProductionLot.productionUnit":"",
                "storedProductionLot.productionPn1":"",
                "storedProductionLot.productionVn1":"",
                "storedProductionLot.productionDescription":"",
                "storedProductionLot.productionParameter":""
            };function operateProductionLotGridParams(status,name){
                if(status===true){
                    filterProductionLotParams[name]=""
                }else{
                    filterProductionLotParams[name]=null
                }
            }var productionLotFilterMenu=new Ext.menu.Menu({
                items:[{
                        text:"产品编号",
                        checked:true,
                        checkHandler:function(){
                            operateProductionLotGridParams(this.checked,"storedProductionLot.productionSerial")
                        }
                    },{
                        text:"产品名称",
                        checked:true,
                        checkHandler:function(){
                            operateProductionLotGridParams(this.checked,"storedProductionLot.productionName")
                        }
                    },{
                        text:"分类名称",
                        checked:true,
                        checkHandler:function(){
                            operateProductionLotGridParams(this.checked,"storedProductionLot.categoryName")
                        }
                    },{
                        text:"单位",
                        checked:true,
                        checkHandler:function(){
                            operateProductionLotGridParams(this.checked,"storedProductionLot.productionUnit")
                        }
                    },{
                        text:"参数名称",
                        checked:true,
                        checkHandler:function(){
                            operateProductionLotGridParams(this.checked,"storedProductionLot.productionPn1")
                        }
                    },{
                        text:"参数数值",
                        checked:true,
                        checkHandler:function(){
                            operateProductionLotGridParams(this.checked,"storedProductionLot.productionVn1")
                        }
                    },{
                        text:"技术参数",
                        checked:true,
                        checkHandler:function(){
                            operateProductionLotGridParams(this.checked,"storedProductionLot.productionParameter")
                        }
                    },{
                        text:"产品描述",
                        checked:true,
                        checkHandler:function(){
                            operateProductionLotGridParams(this.checked,"storedProductionLot.productionDescription")
                        }
                    }]
            });var filterProductionLot=function(){
                if(null!==filterProductionLotParams["storedProductionLot.productionSerial"]){
                    filterProductionLotParams["storedProductionLot.productionSerial"]=filterLotField.getValue()
                }if(null!==filterProductionLotParams["storedProductionLot.productionName"]){
                    filterProductionLotParams["storedProductionLot.productionName"]=filterLotField.getValue()
                }if(null!==filterProductionLotParams["storedProductionLot.categoryName"]){
                    filterProductionLotParams["storedProductionLot.categoryName"]=filterLotField.getValue()
                }if(null!==filterProductionLotParams["storedProductionLot.productionUnit"]){
                    filterProductionLotParams["storedProductionLot.productionUnit"]=filterLotField.getValue()
                }if(null!==filterProductionLotParams["storedProductionLot.productionPn1"]){
                    filterProductionLotParams["storedProductionLot.productionPn1"]=filterLotField.getValue()
                }if(null!==filterProductionLotParams["storedProductionLot.productionVn1"]){
                    filterProductionLotParams["storedProductionLot.productionVn1"]=filterLotField.getValue()
                }if(null!==filterProductionLotParams["storedProductionLot.productionParameter"]){
                    filterProductionLotParams["storedProductionLot.productionParameter"]=filterLotField.getValue()
                }if(null!==filterProductionLotParams["storedProductionLot.productionDescription"]){
                    filterProductionLotParams["storedProductionLot.productionDescription"]=filterLotField.getValue()
                }lotStore.baseParams=filterProductionLotParams;lotStore.setDefaultSort("productionID","desc");lotStore.load({
                    params:{
                        start:0,
                        limit:lotPageSizePlugin.getPageSize()
                    }
                })
            };var filterLotField=new Ext.form.TextField({});var filterLotButton=new Ext.Button({
                iconCls:"icon-search",
                tooltip:"开始搜索",
                handler:filterProductionLot
            });var clearLotButton=new Ext.Button({
                iconCls:"icon-clear",
                tooltip:"清空",
                handler:function(){
                    filterLotField.reset();lotStore.baseParams={};lotStore.setDefaultSort("productionID","DESC");lotStore.load({
                        params:{
                            start:0,
                            limit:lotPageSizePlugin.getPageSize()
                        }
                    })
                }
            });lotStore.setDefaultSort("productionID","DESC");var lotSm=new Ext.grid.RowSelectionModel({
                singleSelect:true
            });var lotGrid=new Ext.grid.GridPanel({
                border:false,
                viewConfig:{
                    forceFit:true
                },
                store:lotStore,
                cm:lotCm,
                sm:lotSm,
                view:new Ext.grid.GroupingView({
                    forceFit:true,
                    groupTextTpl:"{text} (批量:{[values.rs.length]}批 )"
                }),
                loadMask:true,
                bbar:new Ext.PagingToolbar({
                    plugins:lotPageSizePlugin,
                    pageSize:20,
                    store:lotStore,
                    displayInfo:true,
                    items:["-",{
                            text:"搜索范围",
                            menu:productionLotFilterMenu
                        },filterLotField,filterLotButton,clearLotButton,"-",{
                            iconCls:"icon-pdf",
                            tooltip:"将表格导出为PDF文件",
                            handler:function(){
                                var s="";if(store.lastOptions){
                                    s+=Ext.urlEncode(store.lastOptions)
                                }if(store.baseParams){
                                    if(s===""){
                                        s+=Ext.urlEncode(store.baseParams)
                                    }else{
                                        s+="&";s+=Ext.urlEncode(store.baseParams)
                                    }
                                }if(""===s){
                                    s="?type=xls"
                                }else{
                                    s="?"+s+"&type=xls"
                                }window.open("storage/exportStoredProductionLot.action?"+s)
                            }
                        },"-",{
                            iconCls:"icon-xls",
                            tooltip:"将表格导出为XLS文件",
                            handler:function(){
                                var s="?";if(store.lastOptions){
                                    s+=Ext.urlEncode(store.lastOptions)
                                }if(store.baseParams){
                                    if(s===""){
                                        s+=Ext.urlEncode(store.baseParams)
                                    }else{
                                        s+="&";s+=Ext.urlEncode(store.baseParams)
                                    }
                                }if(""===s){
                                    s="?type=xls"
                                }else{
                                    s="?"+s+"&type=xls"
                                }window.open("storage/exportStoredProductionLot.action"+s)
                            }
                        }]
                })
            });lotGrid.on("render",function(){
                lotStore.load({
                    params:{
                        start:0,
                        limit:lotPageSizePlugin.getPageSize()
                    }
                })
            });var registrationStore=new Ext.data.Store({
                proxy:new Ext.data.HttpProxy({
                    url:"storage/listStoredRegistration.action"
                }),
                reader:new Ext.data.JsonReader({
                    root:"list",
                    totalProperty:"total",
                    id:"registrationID",
                    fields:["registrationID","productionID","categoryID","categoryName","productionName","productionSerial","productionUnit","productionVn1","productionVn2","productionVn3","productionQuantity","productionLotPrice","productionLotNumber","productionLotTotal","registrationDate","registrationType","registrationQuantity","registrationSender","registrationReceiver","registrationDescription"]
                }),
                remoteSort:true
            });function change(val){
                if(val>0){
                    return'<span style="color:green;font-weight:bold;">'+val+"</span>"
                }else{
                    if(val<0){
                        return'<span style="color:red;font-weight:bold;">'+val+"</span>"
                    }
                }return val
            }var registrationCm=new Ext.grid.ColumnModel([{
                    header:"产品编号",
                    dataIndex:"productionSerial",
                    width:50
                },{
                    header:"产品名称",
                    dataIndex:"productionName",
                    width:80
                },{
                    header:"分类名称",
                    dataIndex:"categoryName",
                    width:50
                },{
                    header:"批号",
                    dataIndex:"productionLotNumber",
                    width:60
                },{
                    header:"单位",
                    dataIndex:"productionUnit",
                    width:30
                },{
                    header:"数量",
                    dataIndex:"registrationQuantity",
                    renderer:change,
                    align:"right",
                    width:60
                },{
                    header:"成本单价",
                    dataIndex:"productionLotPrice",
                    align:"right",
                    renderer:SliverUtil.cnMoney,
                    width:60
                },{
                    header:"发货人",
                    align:"right",
                    dataIndex:"registrationSender",
                    width:50
                },{
                    header:"收货人",
                    align:"right",
                    dataIndex:"registrationReceiver",
                    width:50
                },{
                    header:"日期",
                    align:"right",
                    dataIndex:"registrationDate",
                    width:40
                }]);registrationCm.defaultSortable=true;var registrationSm=new Ext.grid.RowSelectionModel({
                singleSelect:true
            });var filterRegistrationParams={
                "storedRegistration.productionSerial":"",
                "storedRegistration.productionName":"",
                "storedRegistration.categoryName":"",
                "storedRegistration.productionUnit":"",
                "storedRegistration.productionPn1":"",
                "storedRegistration.productionVn1":"",
                "storedRegistration.supplierName":"",
                "storedRegistration.supplierPhone":"",
                "storedRegistration.registrationSender":"",
                "storedRegistration.registrationReceiver":""
            };function operateRegistrationGridParams(status,name){
                if(status===true){
                    filterProductionLotParams[name]=""
                }else{
                    filterProductionLotParams[name]=null
                }
            }var registrationFilterMenu=new Ext.menu.Menu({
                items:[{
                        text:"产品编号",
                        checked:true,
                        checkHandler:function(){
                            operateRegistrationGridParams(this.checked,"storedRegistration.productionSerial")
                        }
                    },{
                        text:"产品名称",
                        checked:true,
                        checkHandler:function(){
                            operateRegistrationGridParams(this.checked,"storedRegistration.productionName")
                        }
                    },{
                        text:"分类名称",
                        checked:true,
                        checkHandler:function(){
                            operateRegistrationGridParams(this.checked,"storedRegistration.categoryName")
                        }
                    },{
                        text:"单位",
                        checked:true,
                        checkHandler:function(){
                            operateRegistrationGridParams(this.checked,"storedRegistration.productionUnit")
                        }
                    },{
                        text:"参数名称",
                        checked:true,
                        checkHandler:function(){
                            operateRegistrationGridParams(this.checked,"storedRegistration.productionPn1")
                        }
                    },{
                        text:"参数数值",
                        checked:true,
                        checkHandler:function(){
                            operateRegistrationGridParams(this.checked,"storedRegistration.productionVn1")
                        }
                    },{
                        text:"供应商名称",
                        checked:true,
                        checkHandler:function(){
                            operateRegistrationGridParams(this.checked,"storedRegistration.supplierName")
                        }
                    },{
                        text:"供应商联系电话",
                        checked:true,
                        checkHandler:function(){
                            operateRegistrationGridParams(this.checked,"storedRegistration.supplierPhone")
                        }
                    },{
                        text:"供应商联系人",
                        checked:true,
                        checkHandler:function(){
                            operateRegistrationGridParams(this.checked,"storedRegistration.registrationSender")
                        }
                    },{
                        text:"收货人",
                        checked:true,
                        checkHandler:function(){
                            operateRegistrationGridParams(this.checked,"storedRegistration.registrationReceiver")
                        }
                    }]
            });var filterRegistration=function(){
                if(null!==filterRegistrationParams["storedRegistration.productionSerial"]){
                    filterRegistrationParams["storedRegistration.productionSerial"]=filterRegistrationField.getValue()
                }if(null!==filterRegistrationParams["storedRegistration.productionName"]){
                    filterRegistrationParams["storedRegistration.productionName"]=filterRegistrationField.getValue()
                }if(null!==filterRegistrationParams["storedRegistration.categoryName"]){
                    filterRegistrationParams["storedRegistration.categoryName"]=filterRegistrationField.getValue()
                }if(null!==filterRegistrationParams["storedRegistration.productionUnit"]){
                    filterRegistrationParams["storedRegistration.productionUnit"]=filterRegistrationField.getValue()
                }if(null!==filterRegistrationParams["storedRegistration.productionPn1"]){
                    filterRegistrationParams["storedRegistration.productionPn1"]=filterRegistrationField.getValue()
                }if(null!==filterRegistrationParams["storedRegistration.productionVn1"]){
                    filterRegistrationParams["storedRegistration.productionVn1"]=filterRegistrationField.getValue()
                }if(null!==filterRegistrationParams["storedRegistration.supplierName"]){
                    filterRegistrationParams["storedRegistration.supplierName"]=filterRegistrationField.getValue()
                }if(null!==filterRegistrationParams["storedRegistration.supplierPhone"]){
                    filterRegistrationParams["storedRegistration.supplierPhone"]=filterRegistrationField.getValue()
                }if(null!==filterRegistrationParams["storedRegistration.registrationSender"]){
                    filterRegistrationParams["storedRegistration.registrationSender"]=filterRegistrationField.getValue()
                }if(null!==filterRegistrationParams["storedRegistration.registrationReceiver"]){
                    filterRegistrationParams["storedRegistration.registrationReceiver"]=filterRegistrationField.getValue()
                }registrationStore.baseParams=filterRegistrationParams;registrationStore.setDefaultSort("registrationID","DESC");registrationStore.load({
                    params:{
                        start:0,
                        limit:registrationPageSizePlugin.getPageSize()
                    }
                })
            };var filterRegistrationField=new Ext.form.TextField({});var filterRegistrationButton=new Ext.Button({
                iconCls:"icon-search",
                tooltip:"开始搜索",
                handler:filterRegistration
            });var clearRegistrationButton=new Ext.Button({
                iconCls:"icon-clear",
                tooltip:"清空",
                handler:function(){
                    filterRegistrationField.reset();registrationStore.baseParams={};registrationStore.setDefaultSort("registrationID","DESC");registrationStore.load({
                        params:{
                            start:0,
                            limit:registrationPageSizePlugin.getPageSize()
                        }
                    })
                }
            });registrationStore.setDefaultSort("registrationID","DESC");var registrationPageSizePlugin=new Ext.ux.Andrie.pPageSize();var registrationGrid=new Ext.grid.GridPanel({
                border:false,
                viewConfig:{
                    forceFit:true
                },
                store:registrationStore,
                cm:registrationCm,
                sm:registrationSm,
                loadMask:true,
                bbar:new Ext.PagingToolbar({
                    plugins:registrationPageSizePlugin,
                    pageSize:20,
                    store:registrationStore,
                    displayInfo:true,
                    items:["-",{
                            text:"搜索范围",
                            menu:registrationFilterMenu
                        },filterRegistrationField,filterRegistrationButton,clearRegistrationButton,"-",{
                            iconCls:"icon-pdf",
                            tooltip:"将表格导出为PDF文件",
                            handler:function(){
                                var s="";if(store.lastOptions){
                                    s+=Ext.urlEncode(store.lastOptions)
                                }if(store.baseParams){
                                    if(s===""){
                                        s+=Ext.urlEncode(store.baseParams)
                                    }else{
                                        s+="&";s+=Ext.urlEncode(store.baseParams)
                                    }
                                }window.open("storage/exportStoredRegistration.action?"+s)
                            }
                        },"-",{
                            iconCls:"icon-xls",
                            tooltip:"将表格导出为XLS文件",
                            handler:function(){
                                var s="";if(store.lastOptions){
                                    s+=Ext.urlEncode(store.lastOptions)
                                }if(store.baseParams){
                                    if(s===""){
                                        s+=Ext.urlEncode(store.baseParams)
                                    }else{
                                        s+="&";s+=Ext.urlEncode(store.baseParams)
                                    }s+="&type=xls"
                                }window.open("storage/exportStoredRegistration.action?"+s)
                            }
                        }]
                })
            });registrationGrid.on("render",function(){
                registrationStore.load({
                    params:{
                        start:0,
                        limit:registrationPageSizePlugin.getPageSize()
                    }
                })
            });var main=new Ext.TabPanel({
                id:"production-storage-body",
                region:"center",
                margins:"0 0 0 0",
                resizeTabs:true,
                minTabWidth:135,
                tabWidth:160,
                plugins:new Ext.ux.TabCloseMenu(),
                enableTabScroll:true,
                border:true,
                activeTab:0,
                autoDestroy:true,
                items:[{
                        id:"storage-production-grid",
                        closable:false,
                        title:"产品库存",
                        autoScroll:true,
                        layout:"fit",
                        items:grid,
                        iconCls:"icon-storage"
                    },{
                        id:"storage-lot-grid",
                        closable:false,
                        title:"产品库存明细",
                        autoScroll:true,
                        layout:"fit",
                        items:lotGrid,
                        iconCls:"icon-storage"
                    },{
                        id:"storage-registration-grid",
                        closable:false,
                        title:"产品收发记录",
                        autoScroll:true,
                        layout:"fit",
                        items:registrationGrid,
                        iconCls:"icon-storage-registration"
                    }]
            });var updateStoredRegistrationView=function(){
                var record=registrationSm.getSelected();if(record){
                    var tabID=main.id+"-outStoredRegitration-"+record.data.registrationID;var tab=Ext.getCmp(tabID);if(tab){
                        tab.body.getUpdater().update({
                            scripts:true,
                            method:"post",
                            params:{
                                "storedRegistration.registrationID":record.data.registrationID,
                                containerID:tab.body.id
                            },
                            url:"storage/updateStoredRegistrationView.action"
                        })
                    }else{
                        tab=new Ext.Panel({
                            id:tabID,
                            autoScroll:true,
                            iconCls:"icon-offer-edit",
                            title:"更新记录",
                            closable:true
                        });tab.on("render",function(){
                            tab.load({
                                scripts:true,
                                method:"post",
                                params:{
                                    "storedRegistration.registrationID":record.data.registrationID,
                                    containerID:tab.body.id
                                },
                                url:"storage/updateStoredRegistrationView.action"
                            })
                        });main.add(tab)
                    }main.setActiveTab(tab)
                }
            };var removeStoredRegistrationView=function(){
                var record=registrationGrid.getSelectionModel().getSelected();if(record){
                    Ext.MessageBox.confirm("删除记录","您确定要删除选中出入库记录?",function(btn){
                        if(btn=="yes"){
                            Ext.Ajax.request({
                                url:"storage/removeStoredRegistration.action",
                                params:{
                                    "storedRegistration.registrationID":record.data.registrationID
                                },
                                method:"post",
                                success:function(response){
                                    var j=Ext.decode(response.responseText);if(j.success===true){
                                        var tabID=main.id+"-outStoredRegitration-"+record.data.registrationID;registrationStore.remove(record);var tab=main.getComponent(tabID);if(tab){
                                            main.remove(tab)
                                        }
                                    }
                                }
                            })
                        }
                    })
                }
            };var storedProductionContextMenu;grid.on("rowcontextmenu",function(grid,rowindex,e){
                grid.getSelectionModel().selectRow(rowindex,false);if(!storedProductionContextMenu){
                    storedProductionContextMenu=new Ext.menu.Menu([{
                            text:"添加入库记录",
                            handler:inStoredRegistrationView
                        },{
                            text:"添加出库记录",
                            handler:outStoredRegistrationView
                        }])
                }storedProductionContextMenu.showAt(e.getPoint());e.stopEvent()
            });lotGrid.on("rowcontextmenu",function(lotGrid,rowindex,e){
                e.stopEvent()
            });var storedRegistrationContextMenu;registrationGrid.on("rowcontextmenu",function(registrationGrid,rowindex,e){
                registrationGrid.getSelectionModel().selectRow(rowindex,false);if(!storedRegistrationContextMenu){
                    storedRegistrationContextMenu=new Ext.menu.Menu([{
                            text:"更新记录",
                            handler:updateStoredRegistrationView
                        },{
                            text:"删除记录",
                            handler:removeStoredRegistrationView
                        }])
                }storedRegistrationContextMenu.showAt(e.getPoint());e.stopEvent()
            });win=desktop.createWindow({
                id:this.moduleId,
                title:SliverData.storage.title,
                width:winWidth,
                height:winHeight,
                x:desktop.getWinX(winWidth),
                y:desktop.getWinY(winHeight),
                iconCls:"icon-storage",
                shim:false,
                animCollapse:false,
                constrainHeader:true,
                minimizable:true,
                maximizable:true,
                border:false,
                layout:"border",
                items:main,
                taskbuttonTooltip:SliverData.storage.tooltip
            })
        }win.show()
    }
});

